// services/hrWorkflows.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

export type HrWorkflowTemplate = {
  id: string;
  name: string;
  description: string | null;
  category: string | null;
  is_active: boolean;
  created_at: string;
};

export type HrWorkflowInstance = {
  id: string;
  template_id: string;
  employee_id: string;
  status: string;
  start_date: string;
  due_date: string | null;
  completed_at: string | null;
};

export async function listWorkflowTemplates() {
  const { data, error } = await supabase
    .from('hr_workflow_templates')
    .select('*')
    .eq('is_active', true)
    .order('created_at', { ascending: false });

  if (error) throw error;
  return data as HrWorkflowTemplate[];
}

export async function getWorkflowTemplate(id: string) {
  const { data, error } = await supabase
    .from('hr_workflow_templates')
    .select('*, hr_workflow_template_steps(*)')
    .eq('id', id)
    .single();

  if (error) throw error;
  return data;
}

export async function listWorkflowInstancesForEmployee(employeeId: string) {
  const { data, error } = await supabase
    .from('hr_workflow_instances')
    .select('*, hr_workflow_templates(name, category)')
    .eq('employee_id', employeeId)
    .order('start_date', { ascending: false });

  if (error) throw error;
  return data as HrWorkflowInstance[];
}

export async function createWorkflowInstance(params: {
  templateId: string;
  employeeId: string;
  startDate?: string;
}) {
  const { templateId, employeeId, startDate } = params;

  const { data, error } = await supabase
    .rpc('create_hr_workflow_instance', {
      p_template_id: templateId,
      p_employee_id: employeeId,
      p_start_date: startDate ?? new Date().toISOString().slice(0, 10),
    });

  if (error) throw error;
  return data;
}
