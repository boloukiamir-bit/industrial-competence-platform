This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: .cache, node_modules, .next
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
admin/
  competence/
    page.tsx
  positions/
    [id]/
      requirements/
        page.tsx
    page.tsx
api/
  admin/
    audit/
      route.ts
    invite/
      route.ts
    members/
      route.ts
    membership/
      disable/
        route.ts
      role/
        route.ts
  bootstrap/
    route.ts
  cron/
    daily-notifications/
      route.ts
  debug/
    repair-orgid/
      route.ts
    schema/
      route.ts
  gdpr/
    export-employee-data/
      route.ts
  health/
    route.ts
  line-overview/
    assignments/
      [id]/
        route.ts
      route.ts
    demand/
      route.ts
    suggestions/
      route.ts
    week/
      route.ts
    route.ts
  org/
    create/
      route.ts
  spaljisten/
    dashboard/
      route.ts
    export/
      route.ts
    import/
      route.ts
    reset/
      route.ts
    setup/
      route.ts
  workflows/
    route.ts
app/
  admin/
    audit/
      page.tsx
    security/
      page.tsx
    users/
      page.tsx
    page.tsx
  billing/
    page.tsx
  cockpit/
    page.tsx
  competence-matrix/
    page.tsx
  dashboard/
    page.tsx
  debug/
    page.tsx
  demo/
    page.tsx
  demo-center/
    page.tsx
  documents/
    page.tsx
  employees/
    [id]/
      competence/
        page.tsx
      one-to-ones/
        page.tsx
      reviews/
        new/
          page.tsx
      salary/
        new/
          page.tsx
      page.tsx
    new/
      page.tsx
    page.tsx
  equipment/
    page.tsx
  gaps/
    page.tsx
  handbooks/
    page.tsx
  hr/
    analytics/
      page.tsx
    tasks/
      page.tsx
    workflows/
      [id]/
        page.tsx
      page.tsx
  import-employees/
    actions.ts
    ImportForm.tsx
    page.tsx
  line-overview/
    page.tsx
  manager/
    risks/
      page.tsx
  news/
    page.tsx
  one-to-ones/
    [id]/
      page.tsx
    page.tsx
  org/
    overview/
      page.tsx
    select/
      page.tsx
  pricing/
    page.tsx
  safety/
    certificates/
      page.tsx
  settings/
    page.tsx
  setup/
    page.tsx
  spaljisten/
    dashboard/
      page.tsx
    import/
      page.tsx
  tomorrows-gaps/
    page.tsx
  layout.tsx
  page.tsx
competence/
  matrix/
    page.tsx
health/
  page.tsx
lib/
  spaljistenAuth.ts
login/
  page.tsx
pricing/
  page.tsx
signup/
  page.tsx
globals.css
layout.tsx
page.tsx
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="admin/competence/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useAuthGuard } from "@/hooks/useAuthGuard";
import Link from "next/link";
import {
  listCompetenceGroups,
  listCompetences,
  createCompetenceGroup,
  updateCompetenceGroup,
  createCompetence,
  updateCompetence,
  CompetenceGroup,
  Competence,
} from "@/services/adminCompetence";
import { Plus, Pencil, Shield, Check, X } from "lucide-react";

export default function CompetenceAdminPage() {
  const { loading: authLoading } = useAuthGuard();
  const [groups, setGroups] = useState<CompetenceGroup[]>([]);
  const [competences, setCompetences] = useState<Competence[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [selectedGroupFilter, setSelectedGroupFilter] = useState<string>("all");

  const [editingGroupId, setEditingGroupId] = useState<string | null>(null);
  const [groupForm, setGroupForm] = useState({ name: "", description: "" });
  const [showAddGroup, setShowAddGroup] = useState(false);

  const [editingCompetenceId, setEditingCompetenceId] = useState<string | null>(null);
  const [competenceForm, setCompetenceForm] = useState({
    name: "",
    code: "",
    group_id: "",
    description: "",
    is_safety_critical: false,
  });
  const [showAddCompetence, setShowAddCompetence] = useState(false);

  useEffect(() => {
    if (!authLoading) {
      loadData();
    }
  }, [authLoading]);

  async function loadData() {
    try {
      setLoading(true);
      const [groupsData, competencesData] = await Promise.all([
        listCompetenceGroups(),
        listCompetences(),
      ]);
      setGroups(groupsData);
      setCompetences(competencesData);
    } catch (err) {
      setError("Failed to load data");
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  function startEditGroup(group: CompetenceGroup) {
    setEditingGroupId(group.id);
    setGroupForm({ name: group.name, description: group.description || "" });
  }

  function cancelEditGroup() {
    setEditingGroupId(null);
    setGroupForm({ name: "", description: "" });
  }

  async function handleSaveGroup() {
    try {
      if (editingGroupId) {
        await updateCompetenceGroup(editingGroupId, {
          name: groupForm.name,
          description: groupForm.description || null,
        });
        setEditingGroupId(null);
      } else {
        await createCompetenceGroup({
          name: groupForm.name,
          description: groupForm.description || undefined,
        });
        setShowAddGroup(false);
      }
      setGroupForm({ name: "", description: "" });
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to save group");
    }
  }

  function startEditCompetence(comp: Competence) {
    setEditingCompetenceId(comp.id);
    setCompetenceForm({
      name: comp.name,
      code: comp.code || "",
      group_id: comp.group_id || "",
      description: comp.description || "",
      is_safety_critical: comp.is_safety_critical,
    });
  }

  function cancelEditCompetence() {
    setEditingCompetenceId(null);
    setCompetenceForm({ name: "", code: "", group_id: "", description: "", is_safety_critical: false });
  }

  async function handleSaveCompetence() {
    try {
      if (editingCompetenceId) {
        await updateCompetence(editingCompetenceId, {
          name: competenceForm.name,
          code: competenceForm.code || null,
          group_id: competenceForm.group_id || null,
          description: competenceForm.description || null,
          is_safety_critical: competenceForm.is_safety_critical,
        });
        setEditingCompetenceId(null);
      } else {
        await createCompetence({
          name: competenceForm.name,
          code: competenceForm.code || undefined,
          group_id: competenceForm.group_id || null,
          description: competenceForm.description || undefined,
          is_safety_critical: competenceForm.is_safety_critical,
        });
        setShowAddCompetence(false);
      }
      setCompetenceForm({ name: "", code: "", group_id: "", description: "", is_safety_critical: false });
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to save competence");
    }
  }

  async function handleToggleActive(comp: Competence) {
    try {
      await updateCompetence(comp.id, { active: !comp.active });
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to update competence");
    }
  }

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access…</p>
      </main>
    );
  }

  if (loading) {
    return (
      <main className="hr-page">
        <p className="hr-page__subtitle">Loading...</p>
      </main>
    );
  }

  if (error) {
    return (
      <main className="hr-page">
        <p className="hr-error">{error}</p>
      </main>
    );
  }

  const filteredCompetences = selectedGroupFilter === "all"
    ? competences
    : selectedGroupFilter === "ungrouped"
    ? competences.filter((c) => !c.group_id)
    : competences.filter((c) => c.group_id === selectedGroupFilter);

  const getGroupName = (groupId: string | null) => {
    if (!groupId) return "-";
    const group = groups.find((g) => g.id === groupId);
    return group?.name || "-";
  };

  return (
    <main className="hr-page">
      <div className="hr-page__header">
        <div>
          <h1 className="hr-page__title">Competence Admin</h1>
          <p className="hr-page__subtitle">Manage competence groups and competences used in matrices and gaps.</p>
        </div>
      </div>

      <nav className="hr-breadcrumb" style={{ marginBottom: 16 }}>
        <Link href="/app/hr/tasks" className="hr-breadcrumb__link">Dashboard</Link>
        <span className="hr-breadcrumb__separator">/</span>
        <span>Competence Admin</span>
      </nav>

      <div className="admin-grid">
        <div className="hr-card" data-testid="panel-groups">
          <div className="hr-section__title" style={{ padding: "12px 16px", borderBottom: "1px solid var(--hr-border)" }}>
            Groups
          </div>
          <div style={{ padding: 16 }}>
            {groups.map((group) => (
              <div key={group.id} data-testid={`group-row-${group.id}`}>
                {editingGroupId === group.id ? (
                  <div style={{ marginBottom: 12, padding: 12, background: "var(--hr-bg-secondary)", borderRadius: 8 }}>
                    <div className="hr-form-field">
                      <input
                        type="text"
                        className="hr-input"
                        value={groupForm.name}
                        onChange={(e) => setGroupForm({ ...groupForm, name: e.target.value })}
                        placeholder="Group name"
                        data-testid="input-edit-group-name"
                      />
                    </div>
                    <div className="hr-form-field">
                      <input
                        type="text"
                        className="hr-input"
                        value={groupForm.description}
                        onChange={(e) => setGroupForm({ ...groupForm, description: e.target.value })}
                        placeholder="Description (optional)"
                        data-testid="input-edit-group-description"
                      />
                    </div>
                    <div style={{ display: "flex", gap: 8 }}>
                      <button className="hr-button hr-button--primary hr-button--sm" onClick={handleSaveGroup} data-testid="button-save-edit-group">
                        <Check size={14} /> Save
                      </button>
                      <button className="hr-button hr-button--ghost hr-button--sm" onClick={cancelEditGroup}>
                        <X size={14} /> Cancel
                      </button>
                    </div>
                  </div>
                ) : (
                  <div
                    style={{ display: "flex", alignItems: "center", gap: 8, padding: "10px 0", borderBottom: "1px solid var(--hr-border-light)" }}
                  >
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 500 }}>{group.name}</div>
                      {group.description && <div className="hr-muted" style={{ fontSize: 13 }}>{group.description}</div>}
                    </div>
                    <button
                      className="hr-button hr-button--ghost hr-button--sm"
                      onClick={() => startEditGroup(group)}
                      data-testid={`button-edit-group-${group.id}`}
                    >
                      <Pencil size={14} />
                    </button>
                  </div>
                )}
              </div>
            ))}

            {groups.length === 0 && !showAddGroup && (
              <p className="hr-muted" style={{ padding: "12px 0" }}>No groups yet.</p>
            )}

            {showAddGroup ? (
              <div style={{ marginTop: 12, padding: 12, background: "var(--hr-bg-secondary)", borderRadius: 8 }}>
                <div className="hr-form-field">
                  <input
                    type="text"
                    className="hr-input"
                    value={groupForm.name}
                    onChange={(e) => setGroupForm({ ...groupForm, name: e.target.value })}
                    placeholder="Group name"
                    data-testid="input-new-group-name"
                  />
                </div>
                <div className="hr-form-field">
                  <input
                    type="text"
                    className="hr-input"
                    value={groupForm.description}
                    onChange={(e) => setGroupForm({ ...groupForm, description: e.target.value })}
                    placeholder="Description (optional)"
                    data-testid="input-new-group-description"
                  />
                </div>
                <div style={{ display: "flex", gap: 8 }}>
                  <button className="hr-button hr-button--primary hr-button--sm" onClick={handleSaveGroup} data-testid="button-save-new-group">
                    <Check size={14} /> Add
                  </button>
                  <button className="hr-button hr-button--ghost hr-button--sm" onClick={() => { setShowAddGroup(false); setGroupForm({ name: "", description: "" }); }}>
                    <X size={14} /> Cancel
                  </button>
                </div>
              </div>
            ) : (
              <button
                className="hr-button hr-button--secondary hr-button--sm"
                onClick={() => setShowAddGroup(true)}
                style={{ marginTop: 12 }}
                data-testid="button-new-group"
              >
                <Plus size={14} /> Add Group
              </button>
            )}
          </div>
        </div>

        <div className="hr-card" data-testid="panel-competences">
          <div className="hr-section__title" style={{ padding: "12px 16px", borderBottom: "1px solid var(--hr-border)", display: "flex", alignItems: "center", justifyContent: "space-between", gap: 16 }}>
            <span>Competences</span>
            <select
              className="hr-select"
              value={selectedGroupFilter}
              onChange={(e) => setSelectedGroupFilter(e.target.value)}
              style={{ width: "auto", minWidth: 150 }}
              data-testid="select-group-filter"
            >
              <option value="all">All Groups</option>
              <option value="ungrouped">Ungrouped</option>
              {groups.map((g) => (
                <option key={g.id} value={g.id}>{g.name}</option>
              ))}
            </select>
          </div>
          <div style={{ padding: 16 }}>
            <table className="hr-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Code</th>
                  <th>Group</th>
                  <th>Safety</th>
                  <th>Active</th>
                  <th style={{ width: 60 }}>Edit</th>
                </tr>
              </thead>
              <tbody>
                {filteredCompetences.map((comp) => (
                  <tr key={comp.id} data-testid={`competence-row-${comp.id}`}>
                    {editingCompetenceId === comp.id ? (
                      <td colSpan={6}>
                        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, padding: "8px 0" }}>
                          <div className="hr-form-field">
                            <label className="hr-form-label">Name</label>
                            <input
                              type="text"
                              className="hr-input"
                              value={competenceForm.name}
                              onChange={(e) => setCompetenceForm({ ...competenceForm, name: e.target.value })}
                              data-testid="input-edit-competence-name"
                            />
                          </div>
                          <div className="hr-form-field">
                            <label className="hr-form-label">Code</label>
                            <input
                              type="text"
                              className="hr-input"
                              value={competenceForm.code}
                              onChange={(e) => setCompetenceForm({ ...competenceForm, code: e.target.value })}
                              data-testid="input-edit-competence-code"
                            />
                          </div>
                          <div className="hr-form-field">
                            <label className="hr-form-label">Group</label>
                            <select
                              className="hr-select"
                              value={competenceForm.group_id}
                              onChange={(e) => setCompetenceForm({ ...competenceForm, group_id: e.target.value })}
                              data-testid="select-edit-competence-group"
                            >
                              <option value="">No Group</option>
                              {groups.map((g) => (
                                <option key={g.id} value={g.id}>{g.name}</option>
                              ))}
                            </select>
                          </div>
                          <div className="hr-form-field">
                            <label className="hr-form-label">Description</label>
                            <input
                              type="text"
                              className="hr-input"
                              value={competenceForm.description}
                              onChange={(e) => setCompetenceForm({ ...competenceForm, description: e.target.value })}
                              data-testid="input-edit-competence-description"
                            />
                          </div>
                          <div className="hr-form-field hr-form-field--inline">
                            <input
                              type="checkbox"
                              id="edit-safety-critical"
                              checked={competenceForm.is_safety_critical}
                              onChange={(e) => setCompetenceForm({ ...competenceForm, is_safety_critical: e.target.checked })}
                              data-testid="checkbox-edit-safety-critical"
                            />
                            <label htmlFor="edit-safety-critical" className="hr-form-label">Safety Critical</label>
                          </div>
                          <div style={{ display: "flex", gap: 8, alignItems: "flex-end" }}>
                            <button className="hr-button hr-button--primary hr-button--sm" onClick={handleSaveCompetence} data-testid="button-save-edit-competence">
                              <Check size={14} /> Save
                            </button>
                            <button className="hr-button hr-button--ghost hr-button--sm" onClick={cancelEditCompetence}>
                              <X size={14} /> Cancel
                            </button>
                          </div>
                        </div>
                      </td>
                    ) : (
                      <>
                        <td>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            {comp.is_safety_critical && <Shield size={14} className="hr-icon--warning" />}
                            {comp.name}
                          </div>
                        </td>
                        <td>{comp.code || "-"}</td>
                        <td>{getGroupName(comp.group_id)}</td>
                        <td>{comp.is_safety_critical ? "Yes" : "No"}</td>
                        <td>
                          <button
                            className={`hr-toggle ${comp.active ? "hr-toggle--on" : "hr-toggle--off"}`}
                            onClick={() => handleToggleActive(comp)}
                            data-testid={`toggle-active-${comp.id}`}
                            title={comp.active ? "Active" : "Inactive"}
                          >
                            {comp.active ? <Check size={12} /> : <X size={12} />}
                          </button>
                        </td>
                        <td>
                          <button
                            className="hr-button hr-button--ghost hr-button--sm"
                            onClick={() => startEditCompetence(comp)}
                            data-testid={`button-edit-competence-${comp.id}`}
                          >
                            <Pencil size={14} />
                          </button>
                        </td>
                      </>
                    )}
                  </tr>
                ))}
                {filteredCompetences.length === 0 && !showAddCompetence && (
                  <tr>
                    <td colSpan={6} className="hr-muted" style={{ textAlign: "center", padding: 24 }}>
                      No competences found.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>

            {showAddCompetence ? (
              <div style={{ marginTop: 16, padding: 16, background: "var(--hr-bg-secondary)", borderRadius: 8 }}>
                <h4 className="hr-section__title" style={{ marginBottom: 12 }}>Add Competence</h4>
                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                  <div className="hr-form-field">
                    <label className="hr-form-label">Name *</label>
                    <input
                      type="text"
                      className="hr-input"
                      value={competenceForm.name}
                      onChange={(e) => setCompetenceForm({ ...competenceForm, name: e.target.value })}
                      data-testid="input-new-competence-name"
                    />
                  </div>
                  <div className="hr-form-field">
                    <label className="hr-form-label">Code</label>
                    <input
                      type="text"
                      className="hr-input"
                      value={competenceForm.code}
                      onChange={(e) => setCompetenceForm({ ...competenceForm, code: e.target.value })}
                      placeholder="e.g., CNC, WLD"
                      data-testid="input-new-competence-code"
                    />
                  </div>
                  <div className="hr-form-field">
                    <label className="hr-form-label">Group</label>
                    <select
                      className="hr-select"
                      value={competenceForm.group_id}
                      onChange={(e) => setCompetenceForm({ ...competenceForm, group_id: e.target.value })}
                      data-testid="select-new-competence-group"
                    >
                      <option value="">No Group</option>
                      {groups.map((g) => (
                        <option key={g.id} value={g.id}>{g.name}</option>
                      ))}
                    </select>
                  </div>
                  <div className="hr-form-field">
                    <label className="hr-form-label">Description</label>
                    <input
                      type="text"
                      className="hr-input"
                      value={competenceForm.description}
                      onChange={(e) => setCompetenceForm({ ...competenceForm, description: e.target.value })}
                      data-testid="input-new-competence-description"
                    />
                  </div>
                  <div className="hr-form-field hr-form-field--inline">
                    <input
                      type="checkbox"
                      id="new-safety-critical"
                      checked={competenceForm.is_safety_critical}
                      onChange={(e) => setCompetenceForm({ ...competenceForm, is_safety_critical: e.target.checked })}
                      data-testid="checkbox-new-safety-critical"
                    />
                    <label htmlFor="new-safety-critical" className="hr-form-label">Safety Critical</label>
                  </div>
                  <div style={{ display: "flex", gap: 8, alignItems: "flex-end" }}>
                    <button className="hr-button hr-button--primary hr-button--sm" onClick={handleSaveCompetence} data-testid="button-save-new-competence">
                      <Check size={14} /> Add
                    </button>
                    <button className="hr-button hr-button--ghost hr-button--sm" onClick={() => { setShowAddCompetence(false); setCompetenceForm({ name: "", code: "", group_id: "", description: "", is_safety_critical: false }); }}>
                      <X size={14} /> Cancel
                    </button>
                  </div>
                </div>
              </div>
            ) : (
              <button
                className="hr-button hr-button--primary hr-button--sm"
                onClick={() => setShowAddCompetence(true)}
                style={{ marginTop: 16 }}
                data-testid="button-new-competence"
              >
                <Plus size={14} /> Add Competence
              </button>
            )}
          </div>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="admin/positions/[id]/requirements/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuthGuard } from "@/hooks/useAuthGuard";
import Link from "next/link";
import {
  getPositionById,
  listPositionRequirements,
  listCompetences,
  listCompetenceGroups,
  createPositionRequirement,
  updatePositionRequirement,
  deletePositionRequirement,
  PositionAdmin,
  PositionRequirementAdmin,
  Competence,
  CompetenceGroup,
} from "@/services/adminCompetence";
import { Plus, Trash2, X, Check, ArrowLeft, Pencil } from "lucide-react";

type RequirementWithCompetence = PositionRequirementAdmin & {
  competence_name: string;
  competence_code: string | null;
  group_name: string | null;
};

export default function PositionRequirementsPage() {
  const params = useParams();
  const positionId = params.id as string;
  const { loading: authLoading } = useAuthGuard();

  const [position, setPosition] = useState<PositionAdmin | null>(null);
  const [requirements, setRequirements] = useState<RequirementWithCompetence[]>([]);
  const [allCompetences, setAllCompetences] = useState<Competence[]>([]);
  const [groups, setGroups] = useState<CompetenceGroup[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [showAddForm, setShowAddForm] = useState(false);
  const [addForm, setAddForm] = useState({
    competence_id: "",
    required_level: 1,
    mandatory: true,
    notes: "",
  });

  const [editingId, setEditingId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState({
    required_level: 1,
    mandatory: true,
    notes: "",
  });

  useEffect(() => {
    if (!authLoading && positionId) {
      loadData();
    }
  }, [authLoading, positionId]);

  async function loadData() {
    try {
      setLoading(true);
      const [posData, reqData, compData, groupData] = await Promise.all([
        getPositionById(positionId),
        listPositionRequirements(positionId),
        listCompetences(),
        listCompetenceGroups(),
      ]);

      if (!posData) {
        setError("Position not found");
        return;
      }

      setPosition(posData);
      setGroups(groupData);
      setAllCompetences(compData);

      const enrichedReqs: RequirementWithCompetence[] = reqData.map((req) => {
        const comp = compData.find((c) => c.id === req.competence_id);
        const group = comp?.group_id ? groupData.find((g) => g.id === comp.group_id) : null;
        return {
          ...req,
          competence_name: comp?.name || "Unknown",
          competence_code: comp?.code || null,
          group_name: group?.name || null,
        };
      });

      setRequirements(enrichedReqs);
    } catch (err) {
      setError("Failed to load data");
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function handleAddRequirement() {
    if (!addForm.competence_id) {
      alert("Please select a competence");
      return;
    }

    try {
      await createPositionRequirement({
        position_id: positionId,
        competence_id: addForm.competence_id,
        required_level: addForm.required_level,
        mandatory: addForm.mandatory,
        notes: addForm.notes || undefined,
      });
      setShowAddForm(false);
      setAddForm({ competence_id: "", required_level: 1, mandatory: true, notes: "" });
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to add requirement");
    }
  }

  function startEdit(req: RequirementWithCompetence) {
    setEditingId(req.id);
    setEditForm({
      required_level: req.required_level,
      mandatory: req.mandatory,
      notes: req.notes || "",
    });
  }

  function cancelEdit() {
    setEditingId(null);
    setEditForm({ required_level: 1, mandatory: true, notes: "" });
  }

  async function handleSaveEdit() {
    if (!editingId) return;

    try {
      await updatePositionRequirement(editingId, {
        required_level: editForm.required_level,
        mandatory: editForm.mandatory,
        notes: editForm.notes || null,
      });
      setEditingId(null);
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to update requirement");
    }
  }

  async function handleDeleteRequirement(reqId: string) {
    if (!confirm("Remove this competence requirement?")) return;
    try {
      await deletePositionRequirement(reqId);
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to delete requirement");
    }
  }

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access…</p>
      </main>
    );
  }

  if (loading) {
    return (
      <main className="hr-page">
        <p className="hr-page__subtitle">Loading...</p>
      </main>
    );
  }

  if (error || !position) {
    return (
      <main className="hr-page">
        <p className="hr-error">{error || "Position not found"}</p>
        <Link href="/admin/positions" className="hr-button hr-button--secondary" style={{ marginTop: 16 }}>
          Back to Positions
        </Link>
      </main>
    );
  }

  const existingCompetenceIds = new Set(requirements.map((r) => r.competence_id));
  const availableCompetences = allCompetences.filter((c) => c.active && !existingCompetenceIds.has(c.id));

  const groupedAvailable = groups.map((g) => ({
    group: g,
    competences: availableCompetences.filter((c) => c.group_id === g.id),
  })).filter((g) => g.competences.length > 0);

  const ungroupedAvailable = availableCompetences.filter((c) => !c.group_id);

  return (
    <main className="hr-page">
      <div className="hr-page__header">
        <div>
          <Link href="/admin/positions" className="hr-link" style={{ display: "flex", alignItems: "center", gap: 4, marginBottom: 8 }} data-testid="link-back">
            <ArrowLeft size={16} /> Back to positions
          </Link>
          <h1 className="hr-page__title">{position.name} – Requirements</h1>
          <p className="hr-page__subtitle">
            {position.site || "No site"}
            {position.department && ` / ${position.department}`}
          </p>
        </div>
      </div>

      <nav className="hr-breadcrumb" style={{ marginBottom: 16 }}>
        <Link href="/app/hr/tasks" className="hr-breadcrumb__link">Dashboard</Link>
        <span className="hr-breadcrumb__separator">/</span>
        <Link href="/admin/positions" className="hr-breadcrumb__link">Positions</Link>
        <span className="hr-breadcrumb__separator">/</span>
        <span>{position.name} Requirements</span>
      </nav>

      <div className="hr-card">
        <div className="hr-section__title" style={{ padding: "12px 16px", borderBottom: "1px solid var(--hr-border)", display: "flex", alignItems: "center", justifyContent: "space-between", gap: 16 }}>
          <span>Competence Requirements</span>
          {!showAddForm && (
            <button
              className="hr-button hr-button--primary hr-button--sm"
              onClick={() => setShowAddForm(true)}
              disabled={availableCompetences.length === 0}
              data-testid="button-add-requirement"
            >
              <Plus size={14} /> Add Requirement
            </button>
          )}
        </div>

        <div style={{ padding: 16 }}>
          {showAddForm && (
            <div style={{ marginBottom: 16, padding: 16, background: "var(--hr-bg-secondary)", borderRadius: 8 }}>
              <h4 className="hr-section__title" style={{ marginBottom: 12 }}>Add Requirement</h4>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                <div className="hr-form-field">
                  <label className="hr-form-label">Competence *</label>
                  <select
                    className="hr-select"
                    value={addForm.competence_id}
                    onChange={(e) => setAddForm({ ...addForm, competence_id: e.target.value })}
                    data-testid="select-competence"
                  >
                    <option value="">Select a competence...</option>
                    {groupedAvailable.map((g) => (
                      <optgroup key={g.group.id} label={g.group.name}>
                        {g.competences.map((c) => (
                          <option key={c.id} value={c.id}>
                            {c.code ? `[${c.code}] ` : ""}{c.name}
                          </option>
                        ))}
                      </optgroup>
                    ))}
                    {ungroupedAvailable.length > 0 && (
                      <optgroup label="Ungrouped">
                        {ungroupedAvailable.map((c) => (
                          <option key={c.id} value={c.id}>
                            {c.code ? `[${c.code}] ` : ""}{c.name}
                          </option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                </div>
                <div className="hr-form-field">
                  <label className="hr-form-label">Required Level (0-3)</label>
                  <select
                    className="hr-select"
                    value={addForm.required_level}
                    onChange={(e) => setAddForm({ ...addForm, required_level: parseInt(e.target.value) })}
                    data-testid="select-level"
                  >
                    {[0, 1, 2, 3].map((level) => (
                      <option key={level} value={level}>Level {level}</option>
                    ))}
                  </select>
                </div>
                <div className="hr-form-field hr-form-field--inline">
                  <input
                    type="checkbox"
                    id="add-mandatory"
                    checked={addForm.mandatory}
                    onChange={(e) => setAddForm({ ...addForm, mandatory: e.target.checked })}
                    data-testid="checkbox-mandatory"
                  />
                  <label htmlFor="add-mandatory" className="hr-form-label">Mandatory</label>
                </div>
                <div className="hr-form-field">
                  <label className="hr-form-label">Notes</label>
                  <input
                    type="text"
                    className="hr-input"
                    value={addForm.notes}
                    onChange={(e) => setAddForm({ ...addForm, notes: e.target.value })}
                    placeholder="Optional notes"
                    data-testid="input-notes"
                  />
                </div>
              </div>
              <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
                <button className="hr-button hr-button--primary hr-button--sm" onClick={handleAddRequirement} data-testid="button-save-requirement">
                  <Check size={14} /> Add Requirement
                </button>
                <button className="hr-button hr-button--ghost hr-button--sm" onClick={() => { setShowAddForm(false); setAddForm({ competence_id: "", required_level: 1, mandatory: true, notes: "" }); }}>
                  <X size={14} /> Cancel
                </button>
              </div>
            </div>
          )}

          {requirements.length === 0 ? (
            <p className="hr-muted" style={{ textAlign: "center", padding: 24 }}>
              No competence requirements defined for this position.
            </p>
          ) : (
            <table className="hr-table">
              <thead>
                <tr>
                  <th>Competence</th>
                  <th style={{ width: 130 }}>Required Level</th>
                  <th style={{ width: 100 }}>Mandatory</th>
                  <th>Notes</th>
                  <th style={{ width: 100 }}>Actions</th>
                </tr>
              </thead>
              <tbody>
                {requirements.map((req) => (
                  <tr key={req.id} data-testid={`requirement-row-${req.id}`}>
                    {editingId === req.id ? (
                      <>
                        <td>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            {req.competence_code && <span className="hr-code">{req.competence_code}</span>}
                            {req.competence_name}
                          </div>
                          {req.group_name && <div className="hr-muted" style={{ fontSize: 12 }}>{req.group_name}</div>}
                        </td>
                        <td>
                          <select
                            className="hr-select hr-select--sm"
                            value={editForm.required_level}
                            onChange={(e) => setEditForm({ ...editForm, required_level: parseInt(e.target.value) })}
                            data-testid={`select-edit-level-${req.id}`}
                          >
                            {[0, 1, 2, 3].map((level) => (
                              <option key={level} value={level}>Level {level}</option>
                            ))}
                          </select>
                        </td>
                        <td>
                          <input
                            type="checkbox"
                            checked={editForm.mandatory}
                            onChange={(e) => setEditForm({ ...editForm, mandatory: e.target.checked })}
                            data-testid={`checkbox-edit-mandatory-${req.id}`}
                          />
                        </td>
                        <td>
                          <input
                            type="text"
                            className="hr-input hr-input--sm"
                            value={editForm.notes}
                            onChange={(e) => setEditForm({ ...editForm, notes: e.target.value })}
                            placeholder="Notes"
                            data-testid={`input-edit-notes-${req.id}`}
                          />
                        </td>
                        <td>
                          <div style={{ display: "flex", gap: 4 }}>
                            <button
                              className="hr-button hr-button--primary hr-button--sm"
                              onClick={handleSaveEdit}
                              data-testid={`button-save-${req.id}`}
                            >
                              <Check size={14} />
                            </button>
                            <button
                              className="hr-button hr-button--ghost hr-button--sm"
                              onClick={cancelEdit}
                            >
                              <X size={14} />
                            </button>
                          </div>
                        </td>
                      </>
                    ) : (
                      <>
                        <td>
                          <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                            {req.competence_code && <span className="hr-code">{req.competence_code}</span>}
                            {req.competence_name}
                          </div>
                          {req.group_name && <div className="hr-muted" style={{ fontSize: 12 }}>{req.group_name}</div>}
                        </td>
                        <td>Level {req.required_level}</td>
                        <td>{req.mandatory ? "Yes" : "No"}</td>
                        <td className="hr-muted">{req.notes || "-"}</td>
                        <td>
                          <div style={{ display: "flex", gap: 4 }}>
                            <button
                              className="hr-button hr-button--ghost hr-button--sm"
                              onClick={() => startEdit(req)}
                              data-testid={`button-edit-${req.id}`}
                              title="Edit"
                            >
                              <Pencil size={14} />
                            </button>
                            <button
                              className="hr-button hr-button--ghost hr-button--sm"
                              onClick={() => handleDeleteRequirement(req.id)}
                              data-testid={`button-delete-${req.id}`}
                              title="Delete"
                            >
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </td>
                      </>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </main>
  );
}
</file>

<file path="admin/positions/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useAuthGuard } from "@/hooks/useAuthGuard";
import Link from "next/link";
import {
  listPositions,
  createPosition,
  PositionAdmin,
} from "@/services/adminCompetence";
import { Plus, Settings, X } from "lucide-react";

export default function PositionsAdminPage() {
  const { loading: authLoading } = useAuthGuard();
  const [positions, setPositions] = useState<PositionAdmin[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [form, setForm] = useState({
    name: "",
    description: "",
    site: "",
    department: "",
    min_headcount: "",
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (!authLoading) {
      loadData();
    }
  }, [authLoading]);

  async function loadData() {
    try {
      setLoading(true);
      const data = await listPositions();
      setPositions(data);
    } catch (err) {
      setError("Failed to load positions");
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function handleCreatePosition() {
    if (!form.name.trim()) {
      alert("Name is required");
      return;
    }

    try {
      setIsSubmitting(true);
      await createPosition({
        name: form.name,
        description: form.description || undefined,
        site: form.site || undefined,
        department: form.department || undefined,
        min_headcount: form.min_headcount ? parseInt(form.min_headcount) : undefined,
      });
      setForm({ name: "", description: "", site: "", department: "", min_headcount: "" });
      loadData();
    } catch (err) {
      console.error(err);
      alert("Failed to create position");
    } finally {
      setIsSubmitting(false);
    }
  }

  function clearForm() {
    setForm({ name: "", description: "", site: "", department: "", min_headcount: "" });
  }

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access…</p>
      </main>
    );
  }

  if (loading) {
    return (
      <main className="hr-page">
        <p className="hr-page__subtitle">Loading...</p>
      </main>
    );
  }

  if (error) {
    return (
      <main className="hr-page">
        <p className="hr-error">{error}</p>
      </main>
    );
  }

  return (
    <main className="hr-page">
      <div className="hr-page__header">
        <div>
          <h1 className="hr-page__title">Positions</h1>
          <p className="hr-page__subtitle">Define roles, their headcount targets and context (site, department).</p>
        </div>
      </div>

      <nav className="hr-breadcrumb" style={{ marginBottom: 16 }}>
        <Link href="/app/hr/tasks" className="hr-breadcrumb__link">Dashboard</Link>
        <span className="hr-breadcrumb__separator">/</span>
        <span>Positions</span>
      </nav>

      <div className="admin-grid" style={{ gridTemplateColumns: "2fr 1fr" }}>
        <div className="hr-card" data-testid="panel-positions">
          <div className="hr-section__title" style={{ padding: "12px 16px", borderBottom: "1px solid var(--hr-border)" }}>
            Positions
          </div>
          <div style={{ padding: 16 }}>
            {positions.length === 0 ? (
              <p className="hr-muted" style={{ textAlign: "center", padding: 24 }}>
                No positions yet. Create your first position to get started.
              </p>
            ) : (
              <table className="hr-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Site</th>
                    <th>Department</th>
                    <th style={{ width: 100 }}>Min Headcount</th>
                    <th style={{ width: 100 }}>Requirements</th>
                  </tr>
                </thead>
                <tbody>
                  {positions.map((pos) => (
                    <tr key={pos.id} data-testid={`position-row-${pos.id}`}>
                      <td>
                        <div style={{ fontWeight: 500 }}>{pos.name}</div>
                        {pos.description && (
                          <div className="hr-muted" style={{ fontSize: 13 }}>{pos.description}</div>
                        )}
                      </td>
                      <td>{pos.site || "-"}</td>
                      <td>{pos.department || "-"}</td>
                      <td>{pos.min_headcount ?? "-"}</td>
                      <td>
                        <Link href={`/admin/positions/${pos.id}/requirements`}>
                          <button
                            className="hr-button hr-button--secondary hr-button--sm"
                            data-testid={`button-requirements-${pos.id}`}
                          >
                            <Settings size={14} /> Edit
                          </button>
                        </Link>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>

        <div className="hr-card" data-testid="panel-create-position">
          <div className="hr-section__title" style={{ padding: "12px 16px", borderBottom: "1px solid var(--hr-border)" }}>
            Create New Position
          </div>
          <div style={{ padding: 16 }}>
            <div className="hr-form-field">
              <label className="hr-form-label">Name *</label>
              <input
                type="text"
                className="hr-input"
                value={form.name}
                onChange={(e) => setForm({ ...form, name: e.target.value })}
                placeholder="e.g., CNC Operator"
                data-testid="input-position-name"
              />
            </div>
            <div className="hr-form-field">
              <label className="hr-form-label">Description</label>
              <textarea
                className="hr-textarea"
                value={form.description}
                onChange={(e) => setForm({ ...form, description: e.target.value })}
                placeholder="Optional description"
                rows={2}
                data-testid="input-position-description"
              />
            </div>
            <div className="hr-form-field">
              <label className="hr-form-label">Site</label>
              <input
                type="text"
                className="hr-input"
                value={form.site}
                onChange={(e) => setForm({ ...form, site: e.target.value })}
                placeholder="e.g., Gothenburg"
                data-testid="input-position-site"
              />
            </div>
            <div className="hr-form-field">
              <label className="hr-form-label">Department</label>
              <input
                type="text"
                className="hr-input"
                value={form.department}
                onChange={(e) => setForm({ ...form, department: e.target.value })}
                placeholder="e.g., Production"
                data-testid="input-position-department"
              />
            </div>
            <div className="hr-form-field">
              <label className="hr-form-label">Min Headcount</label>
              <input
                type="number"
                className="hr-input"
                value={form.min_headcount}
                onChange={(e) => setForm({ ...form, min_headcount: e.target.value })}
                placeholder="e.g., 2"
                min="0"
                data-testid="input-position-min-headcount"
              />
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
              <button
                className="hr-button hr-button--primary"
                onClick={handleCreatePosition}
                disabled={isSubmitting}
                data-testid="button-create-position"
              >
                <Plus size={14} /> {isSubmitting ? "Creating..." : "Create Position"}
              </button>
              <button
                className="hr-button hr-button--ghost"
                onClick={clearForm}
                disabled={isSubmitting}
              >
                <X size={14} /> Clear
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="api/admin/audit/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

async function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {
  const { data } = await supabase
    .from('memberships')
    .select('role')
    .eq('org_id', orgId)
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();
  
  return data?.role === 'admin';
}

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ 
        error: 'Unauthorized', 
        code: 'AUTH_REQUIRED',
        message: 'Authentication required to access audit logs'
      }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const orgId = searchParams.get('orgId');

    if (!orgId) {
      return NextResponse.json({ 
        error: 'Missing orgId', 
        code: 'MISSING_ORG',
        message: 'Organization ID is required'
      }, { status: 400 });
    }

    const supabase = getServiceSupabase();

    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);
    if (!isAdmin) {
      return NextResponse.json({ 
        error: 'Forbidden', 
        code: 'NOT_ADMIN',
        message: 'Admin access required to view audit logs'
      }, { status: 403 });
    }

    const { data: logs, error: fetchError } = await supabase
      .from('audit_logs')
      .select(`
        id,
        actor_user_id,
        action,
        target_type,
        target_id,
        metadata,
        created_at
      `)
      .eq('org_id', orgId)
      .order('created_at', { ascending: false })
      .limit(100);

    if (fetchError) {
      console.error('Error fetching audit logs:', fetchError);
      return NextResponse.json({ 
        error: 'Database error', 
        code: 'DB_ERROR',
        message: fetchError.message,
        hint: fetchError.hint || null
      }, { status: 500 });
    }

    const actorIds = [...new Set((logs || []).map(l => l.actor_user_id).filter(Boolean))];
    
    let profilesMap: Record<string, string> = {};
    if (actorIds.length > 0) {
      const { data: profiles } = await supabase
        .from('profiles')
        .select('id, email')
        .in('id', actorIds);
      
      if (profiles) {
        profilesMap = Object.fromEntries(profiles.map(p => [p.id, p.email]));
      }
    }

    const enrichedLogs = (logs || []).map(log => ({
      ...log,
      actor_email: profilesMap[log.actor_user_id] || null
    }));

    return NextResponse.json({ 
      success: true, 
      logs: enrichedLogs,
      count: enrichedLogs.length
    });
  } catch (error) {
    console.error('Audit logs error:', error);
    return NextResponse.json({ 
      error: 'Internal server error', 
      code: 'INTERNAL_ERROR',
      message: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}
</file>

<file path="api/admin/invite/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { z } from 'zod';

const inviteSchema = z.object({
  orgId: z.string().uuid(),
  email: z.string().email(),
  role: z.enum(['admin', 'hr', 'manager', 'user']),
});

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

async function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {
  const { data } = await supabase
    .from('memberships')
    .select('role')
    .eq('org_id', orgId)
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();
  
  return data?.role === 'admin';
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const parsed = inviteSchema.safeParse(body);
    
    if (!parsed.success) {
      return NextResponse.json({ error: 'Invalid input', details: parsed.error.errors }, { status: 400 });
    }

    const { orgId, email, role } = parsed.data;
    const supabase = getServiceSupabase();

    // Verify user is org admin
    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);
    if (!isAdmin) {
      return NextResponse.json({ error: 'Forbidden: Admin access required' }, { status: 403 });
    }

    // Check if user is already a member
    const { data: existingUser } = await supabase
      .from('profiles')
      .select('id')
      .eq('email', email.toLowerCase())
      .single();

    if (existingUser) {
      const { data: existingMembership } = await supabase
        .from('memberships')
        .select('user_id')
        .eq('org_id', orgId)
        .eq('user_id', existingUser.id)
        .single();

      if (existingMembership) {
        return NextResponse.json({ error: 'User is already a member of this organization' }, { status: 409 });
      }
    }

    // Check for existing pending invite
    const { data: existingInvite } = await supabase
      .from('invites')
      .select('id')
      .eq('org_id', orgId)
      .ilike('email', email)
      .is('accepted_at', null)
      .single();

    if (existingInvite) {
      return NextResponse.json({ error: 'Pending invite already exists for this email' }, { status: 409 });
    }

    // Create invite
    const { data: invite, error: inviteError } = await supabase
      .from('invites')
      .insert({
        org_id: orgId,
        email: email.toLowerCase(),
        role,
        invited_by: user.id,
      })
      .select()
      .single();

    if (inviteError) {
      console.error('Error creating invite:', inviteError);
      return NextResponse.json({ error: 'Failed to create invite' }, { status: 500 });
    }

    // Write audit log
    await supabase.from('audit_logs').insert({
      org_id: orgId,
      actor_user_id: user.id,
      action: 'user.invited',
      target_type: 'invite',
      target_id: invite.id,
      metadata: { email, role },
    });

    return NextResponse.json({ success: true, invite });
  } catch (error) {
    console.error('Invite error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
</file>

<file path="api/admin/members/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

async function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {
  const { data } = await supabase
    .from('memberships')
    .select('role')
    .eq('org_id', orgId)
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();
  
  return data?.role === 'admin';
}

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ 
        error: 'Unauthorized', 
        code: 'AUTH_REQUIRED',
        message: 'Authentication required'
      }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const orgId = searchParams.get('orgId');

    if (!orgId) {
      return NextResponse.json({ 
        error: 'Missing orgId', 
        code: 'MISSING_ORG',
        message: 'Organization ID is required'
      }, { status: 400 });
    }

    const supabase = getServiceSupabase();

    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);
    if (!isAdmin) {
      return NextResponse.json({ 
        error: 'Forbidden', 
        code: 'NOT_ADMIN',
        message: 'Admin access required'
      }, { status: 403 });
    }

    const { data: members, error: memberError } = await supabase
      .from('memberships')
      .select('user_id, role, status, created_at')
      .eq('org_id', orgId);

    if (memberError) {
      console.error('Error fetching members:', memberError);
      return NextResponse.json({ 
        error: 'Database error', 
        code: 'DB_ERROR',
        message: memberError.message,
        hint: memberError.hint || null
      }, { status: 500 });
    }

    const userIds = (members || []).map(m => m.user_id);
    
    let profilesMap: Record<string, string> = {};
    if (userIds.length > 0) {
      const { data: profiles } = await supabase
        .from('profiles')
        .select('id, email')
        .in('id', userIds);
      
      if (profiles) {
        profilesMap = Object.fromEntries(profiles.map(p => [p.id, p.email]));
      }
    }

    const enrichedMembers = (members || []).map(member => ({
      ...member,
      email: profilesMap[member.user_id] || null
    }));

    const { data: invites, error: inviteError } = await supabase
      .from('invites')
      .select('id, email, role, created_at, expires_at, accepted_at')
      .eq('org_id', orgId)
      .is('accepted_at', null)
      .gt('expires_at', new Date().toISOString());

    if (inviteError) {
      console.error('Error fetching invites:', inviteError);
    }

    return NextResponse.json({ 
      success: true, 
      members: enrichedMembers,
      invites: invites || [],
      counts: {
        total: enrichedMembers.length,
        active: enrichedMembers.filter(m => m.status === 'active').length,
        disabled: enrichedMembers.filter(m => m.status === 'disabled').length,
        pendingInvites: (invites || []).length
      }
    });
  } catch (error) {
    console.error('Members error:', error);
    return NextResponse.json({ 
      error: 'Internal server error', 
      code: 'INTERNAL_ERROR',
      message: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}
</file>

<file path="api/admin/membership/disable/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { z } from 'zod';

const disableSchema = z.object({
  orgId: z.string().uuid(),
  userId: z.string().uuid(),
});

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

async function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {
  const { data } = await supabase
    .from('memberships')
    .select('role')
    .eq('org_id', orgId)
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();
  
  return data?.role === 'admin';
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const parsed = disableSchema.safeParse(body);
    
    if (!parsed.success) {
      return NextResponse.json({ error: 'Invalid input', details: parsed.error.errors }, { status: 400 });
    }

    const { orgId, userId } = parsed.data;
    const supabase = getServiceSupabase();

    // Verify actor is org admin
    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);
    if (!isAdmin) {
      return NextResponse.json({ error: 'Forbidden: Admin access required' }, { status: 403 });
    }

    // Prevent self-disable
    if (userId === user.id) {
      return NextResponse.json({ error: 'Cannot disable your own account' }, { status: 400 });
    }

    // Check if target user is the last admin
    const { data: targetMembership } = await supabase
      .from('memberships')
      .select('role, status')
      .eq('org_id', orgId)
      .eq('user_id', userId)
      .single();

    if (!targetMembership) {
      return NextResponse.json({ error: 'Membership not found' }, { status: 404 });
    }

    if (targetMembership.role === 'admin') {
      const { count } = await supabase
        .from('memberships')
        .select('*', { count: 'exact', head: true })
        .eq('org_id', orgId)
        .eq('role', 'admin')
        .eq('status', 'active');

      if (count && count <= 1) {
        return NextResponse.json({ error: 'Cannot disable the last admin of organization' }, { status: 400 });
      }
    }

    // Disable membership
    const { error: updateError } = await supabase
      .from('memberships')
      .update({ status: 'disabled' })
      .eq('org_id', orgId)
      .eq('user_id', userId);

    if (updateError) {
      console.error('Error disabling membership:', updateError);
      return NextResponse.json({ error: 'Failed to disable membership' }, { status: 500 });
    }

    // Write audit log
    await supabase.from('audit_logs').insert({
      org_id: orgId,
      actor_user_id: user.id,
      action: 'membership.disabled',
      target_type: 'membership',
      target_id: userId,
      metadata: { previous_status: targetMembership.status },
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Disable membership error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
</file>

<file path="api/admin/membership/role/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { z } from 'zod';

const updateRoleSchema = z.object({
  orgId: z.string().uuid(),
  userId: z.string().uuid(),
  role: z.enum(['admin', 'hr', 'manager', 'user']),
});

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

async function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {
  const { data } = await supabase
    .from('memberships')
    .select('role')
    .eq('org_id', orgId)
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();
  
  return data?.role === 'admin';
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const parsed = updateRoleSchema.safeParse(body);
    
    if (!parsed.success) {
      return NextResponse.json({ error: 'Invalid input', details: parsed.error.errors }, { status: 400 });
    }

    const { orgId, userId, role } = parsed.data;
    const supabase = getServiceSupabase();

    // Verify actor is org admin
    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);
    if (!isAdmin) {
      return NextResponse.json({ error: 'Forbidden: Admin access required' }, { status: 403 });
    }

    // Prevent self-demotion from admin (last admin protection)
    if (userId === user.id && role !== 'admin') {
      const { count } = await supabase
        .from('memberships')
        .select('*', { count: 'exact', head: true })
        .eq('org_id', orgId)
        .eq('role', 'admin')
        .eq('status', 'active');

      if (count && count <= 1) {
        return NextResponse.json({ error: 'Cannot remove the last admin from organization' }, { status: 400 });
      }
    }

    // Get current role for audit log
    const { data: currentMembership } = await supabase
      .from('memberships')
      .select('role')
      .eq('org_id', orgId)
      .eq('user_id', userId)
      .single();

    if (!currentMembership) {
      return NextResponse.json({ error: 'Membership not found' }, { status: 404 });
    }

    const oldRole = currentMembership.role;

    // Update role
    const { error: updateError } = await supabase
      .from('memberships')
      .update({ role })
      .eq('org_id', orgId)
      .eq('user_id', userId);

    if (updateError) {
      console.error('Error updating role:', updateError);
      return NextResponse.json({ error: 'Failed to update role' }, { status: 500 });
    }

    // Write audit log
    await supabase.from('audit_logs').insert({
      org_id: orgId,
      actor_user_id: user.id,
      action: 'membership.role_updated',
      target_type: 'membership',
      target_id: userId,
      metadata: { old_role: oldRole, new_role: role },
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Update role error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
</file>

<file path="api/bootstrap/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { getPublicEnv } from "@/lib/env";

/**
 * Admin Bootstrap Route
 * 
 * First user to call this becomes admin, then bootstrap is permanently disabled.
 * Requires authenticated user.
 */
export async function POST(request: NextRequest) {
  try {
    const env = getPublicEnv();
    
    // Get the service role key (server-side only)
    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (!serviceRoleKey) {
      return NextResponse.json(
        { error: "Server configuration error: service role key not set" },
        { status: 500 }
      );
    }

    // Create admin client with service role
    const adminClient = createClient(env.supabaseUrl, serviceRoleKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // Create regular client for auth verification
    const authClient = createClient(env.supabaseUrl, env.supabaseAnonKey, {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    });

    // Get the authorization header
    const authHeader = request.headers.get("authorization");
    if (!authHeader?.startsWith("Bearer ")) {
      return NextResponse.json(
        { error: "Unauthorized: No valid session token" },
        { status: 401 }
      );
    }

    const token = authHeader.substring(7);
    
    // Verify the user's session
    const { data: { user }, error: authError } = await authClient.auth.getUser(token);
    
    if (authError || !user) {
      return NextResponse.json(
        { error: "Unauthorized: Invalid session" },
        { status: 401 }
      );
    }

    // Ensure profiles table exists
    const createTableResult = await adminClient.rpc('create_profiles_table_if_not_exists');
    
    // If RPC doesn't exist, try to create the table directly
    if (createTableResult.error) {
      // Try direct table creation via raw SQL
      await adminClient.from('profiles').select('id').limit(1);
    }

    // Check if any profiles exist
    const { data: existingProfiles, error: countError } = await adminClient
      .from("profiles")
      .select("id")
      .limit(1);

    if (countError) {
      // Table might not exist - create it
      return NextResponse.json(
        { 
          error: "Profiles table not ready. Please create the profiles table in Supabase.",
          details: "Run the SQL migration to create the profiles table."
        },
        { status: 500 }
      );
    }

    // If profiles already exist, bootstrap is disabled
    if (existingProfiles && existingProfiles.length > 0) {
      return NextResponse.json(
        { 
          success: false, 
          message: "Bootstrap disabled: admin user already exists" 
        },
        { status: 403 }
      );
    }

    // Create the admin profile for the current user
    const { error: insertError } = await adminClient
      .from("profiles")
      .insert({
        id: user.id,
        email: user.email,
        role: "admin",
      });

    if (insertError) {
      return NextResponse.json(
        { error: `Failed to create admin profile: ${insertError.message}` },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      message: "Admin bootstrap complete. You are now the admin.",
      user: {
        id: user.id,
        email: user.email,
        role: "admin",
      },
    });

  } catch (error) {
    console.error("Bootstrap error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Bootstrap failed" },
      { status: 500 }
    );
  }
}

export async function GET() {
  return NextResponse.json(
    { error: "Method not allowed. Use POST to run bootstrap." },
    { status: 405 }
  );
}
</file>

<file path="api/cron/daily-notifications/route.ts">
import { NextResponse } from "next/server";
import {
  enqueueDueEventNotifications,
  enqueueUpcomingOneToOnes,
  enqueueOverdueActions,
  enqueueManagerDigestNotifications,
} from "@/services/notifications";

export async function GET() {
  const referenceDate = new Date();

  try {
    const [dueEventCount, upcomingCount, overdueCount, managerDigestCount] = await Promise.all([
      enqueueDueEventNotifications(referenceDate),
      enqueueUpcomingOneToOnes(referenceDate),
      enqueueOverdueActions(referenceDate),
      enqueueManagerDigestNotifications(referenceDate),
    ]);

    return NextResponse.json({
      success: true,
      referenceDate: referenceDate.toISOString(),
      notifications: {
        dueEvents: dueEventCount,
        upcomingOneToOnes: upcomingCount,
        overdueActions: overdueCount,
        managerDigests: managerDigestCount,
        total: dueEventCount + upcomingCount + overdueCount + managerDigestCount,
      },
    });
  } catch (error) {
    console.error("Error running daily notifications:", error);
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : "Unknown error",
      },
      { status: 500 }
    );
  }
}

export async function POST() {
  return GET();
}
</file>

<file path="api/debug/repair-orgid/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { persistSession: false } }
);

export async function POST(request: NextRequest) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    const body = await request.json();
    const { orgId, table, dryRun = true } = body;

    if (!orgId || !table) {
      return NextResponse.json({ error: 'orgId and table required' }, { status: 400 });
    }

    const allowedTables = ['employees', 'org_units'];
    if (!allowedTables.includes(table)) {
      return NextResponse.json({ error: 'Invalid table' }, { status: 400 });
    }

    const { count: nullCount, error: countError } = await supabaseAdmin
      .from(table)
      .select('id', { count: 'exact', head: true })
      .is('org_id', null);

    if (countError) {
      return NextResponse.json({ error: countError.message }, { status: 500 });
    }

    if (dryRun) {
      return NextResponse.json({
        dryRun: true,
        table,
        nullCount: nullCount ?? 0,
        message: `Would update ${nullCount ?? 0} rows with null org_id to org_id=${orgId}`,
      });
    }

    const { data, error: updateError } = await supabaseAdmin
      .from(table)
      .update({ org_id: orgId })
      .is('org_id', null)
      .select('id');

    if (updateError) {
      return NextResponse.json({ error: updateError.message }, { status: 500 });
    }

    return NextResponse.json({
      dryRun: false,
      table,
      updatedCount: data?.length ?? 0,
      message: `Updated ${data?.length ?? 0} rows with org_id=${orgId}`,
    });
  } catch (err) {
    return NextResponse.json(
      { error: err instanceof Error ? err.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
</file>

<file path="api/debug/schema/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { persistSession: false } }
);

export async function GET(request: NextRequest) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const orgId = request.nextUrl.searchParams.get('orgId');
  if (!orgId) {
    return NextResponse.json({ error: 'orgId required' }, { status: 400 });
  }

  const results: {
    tables: Record<string, { exists: boolean; hasOrgId: boolean; rlsEnabled: boolean | null }>;
    nullOrgIdCounts: Record<string, number>;
    errors: string[];
  } = {
    tables: {},
    nullOrgIdCounts: {},
    errors: [],
  };

  const tablesToCheck = ['employees', 'org_units'];

  for (const table of tablesToCheck) {
    try {
      const { data: columnsData, error: columnsError } = await supabaseAdmin.rpc('get_table_columns', {
        table_name: table,
      });

      if (columnsError) {
        const { data: fallbackData, error: fallbackError } = await supabaseAdmin
          .from(table)
          .select('*')
          .limit(1);

        if (fallbackError) {
          if (fallbackError.code === '42P01') {
            results.tables[table] = { exists: false, hasOrgId: false, rlsEnabled: null };
          } else {
            results.errors.push(`${table}: ${fallbackError.message}`);
            results.tables[table] = { exists: true, hasOrgId: false, rlsEnabled: null };
          }
          continue;
        }

        const hasOrgId = fallbackData && fallbackData.length > 0 
          ? 'org_id' in fallbackData[0] 
          : true;
        
        results.tables[table] = { exists: true, hasOrgId, rlsEnabled: null };
      } else {
        const columns = Array.isArray(columnsData) ? columnsData : [];
        const hasOrgId = columns.some((c: { column_name: string }) => c.column_name === 'org_id');
        results.tables[table] = { exists: true, hasOrgId, rlsEnabled: null };
      }

      const { count: nullCount, error: nullError } = await supabaseAdmin
        .from(table)
        .select('id', { count: 'exact', head: true })
        .is('org_id', null);

      if (!nullError && nullCount !== null) {
        results.nullOrgIdCounts[table] = nullCount;
      }
    } catch (err) {
      results.errors.push(`${table}: ${err instanceof Error ? err.message : 'Unknown error'}`);
    }
  }

  try {
    const { data: rlsData, error: rlsError } = await supabaseAdmin.rpc('check_rls_status', {
      table_names: tablesToCheck,
    });

    if (!rlsError && rlsData) {
      for (const row of rlsData) {
        if (results.tables[row.tablename]) {
          results.tables[row.tablename].rlsEnabled = row.rowsecurity;
        }
      }
    }
  } catch {
    for (const table of tablesToCheck) {
      if (results.tables[table]) {
        results.tables[table].rlsEnabled = null;
      }
    }
  }

  return NextResponse.json(results);
}
</file>

<file path="api/gdpr/export-employee-data/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { exportEmployeeData } from "@/services/gdpr";

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const employeeId = searchParams.get("employee_id");

  if (!employeeId) {
    return NextResponse.json({ error: "employee_id is required" }, { status: 400 });
  }

  try {
    const data = await exportEmployeeData(employeeId);
    return NextResponse.json(data);
  } catch (error) {
    console.error("Error exporting employee data:", error);
    return NextResponse.json({ error: "Failed to export data" }, { status: 500 });
  }
}
</file>

<file path="api/health/route.ts">
import { NextResponse } from 'next/server';

export async function GET() {
  return NextResponse.json({ status: 'OK' });
}
</file>

<file path="api/line-overview/assignments/[id]/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { z } from "zod";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const updateAssignmentSchema = z.object({
  startTime: z.string().optional(),
  endTime: z.string().optional(),
  employeeCode: z.string().optional(),
});

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    const { error } = await supabaseAdmin
      .from("pl_assignment_segments")
      .delete()
      .eq("id", id)
      .eq("org_id", DEMO_ORG_ID);

    if (error) throw error;

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Delete assignment error:", error);
    return NextResponse.json({ error: "Failed to delete assignment" }, { status: 500 });
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const body = await request.json();
    const parsed = updateAssignmentSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json({ error: "Invalid input", details: parsed.error.issues }, { status: 400 });
    }

    const updates: Record<string, string> = {};
    if (parsed.data.startTime) updates.start_time = parsed.data.startTime;
    if (parsed.data.endTime) updates.end_time = parsed.data.endTime;
    if (parsed.data.employeeCode) updates.employee_code = parsed.data.employeeCode;

    const { data, error } = await supabaseAdmin
      .from("pl_assignment_segments")
      .update(updates)
      .eq("id", id)
      .eq("org_id", DEMO_ORG_ID)
      .select()
      .single();

    if (error) throw error;

    return NextResponse.json({ success: true, assignment: data });
  } catch (error) {
    console.error("Update assignment error:", error);
    return NextResponse.json({ error: "Failed to update assignment" }, { status: 500 });
  }
}
</file>

<file path="api/line-overview/assignments/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { z } from "zod";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function shiftParamToDbValue(shift: string): string {
  const map: Record<string, string> = {
    day: "Day",
    evening: "Evening",
    night: "Night",
  };
  return map[shift.toLowerCase()] || "Day";
}

const createAssignmentSchema = z.object({
  machineCode: z.string(),
  employeeCode: z.string(),
  date: z.string(),
  shift: z.string(),
  startTime: z.string(),
  endTime: z.string(),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const parsed = createAssignmentSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json({ error: "Invalid input", details: parsed.error.issues }, { status: 400 });
    }

    const { machineCode, employeeCode, date, shift, startTime, endTime } = parsed.data;

    const { data, error } = await supabaseAdmin.from("pl_assignment_segments").insert({
      org_id: DEMO_ORG_ID,
      machine_code: machineCode,
      employee_code: employeeCode,
      plan_date: date,
      shift_type: shiftParamToDbValue(shift),
      start_time: startTime,
      end_time: endTime,
    }).select().single();

    if (error) throw error;

    return NextResponse.json({ success: true, assignment: data });
  } catch (error) {
    console.error("Create assignment error:", error);
    return NextResponse.json({ error: "Failed to create assignment" }, { status: 500 });
  }
}
</file>

<file path="api/line-overview/demand/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function shiftParamToDbValue(shift: string): string {
  const map: Record<string, string> = {
    day: "Day",
    evening: "Evening",
    night: "Night",
  };
  return map[shift.toLowerCase()] || "Day";
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { machineCode, date, shift, requiredHours, priority, comment } = body;

    if (!machineCode || !date || !shift || requiredHours === undefined) {
      return NextResponse.json(
        { error: "Missing required fields: machineCode, date, shift, requiredHours" },
        { status: 400 }
      );
    }

    const shiftType = shiftParamToDbValue(shift);

    const existingCheck = await supabaseAdmin
      .from("pl_machine_demand")
      .select("id")
      .eq("org_id", DEMO_ORG_ID)
      .eq("machine_code", machineCode)
      .eq("plan_date", date)
      .eq("shift_type", shiftType)
      .maybeSingle();

    if (existingCheck.data) {
      const { data, error } = await supabaseAdmin
        .from("pl_machine_demand")
        .update({
          required_hours: requiredHours,
          priority: priority || 1,
          comment: comment || null,
        })
        .eq("id", existingCheck.data.id)
        .select()
        .single();

      if (error) throw error;

      return NextResponse.json({ success: true, demand: data, updated: true });
    }

    const { data, error } = await supabaseAdmin
      .from("pl_machine_demand")
      .insert({
        org_id: DEMO_ORG_ID,
        machine_code: machineCode,
        plan_date: date,
        shift_type: shiftType,
        required_hours: requiredHours,
        priority: priority || 1,
        comment: comment || null,
      })
      .select()
      .single();

    if (error) throw error;

    return NextResponse.json({ success: true, demand: data, created: true });
  } catch (error) {
    console.error("Demand creation error:", error);
    return NextResponse.json({ error: "Failed to create demand" }, { status: 500 });
  }
}

export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const machineCode = searchParams.get("machineCode");
    const date = searchParams.get("date");
    const shift = searchParams.get("shift");

    if (!machineCode || !date || !shift) {
      return NextResponse.json(
        { error: "Missing required params: machineCode, date, shift" },
        { status: 400 }
      );
    }

    const shiftType = shiftParamToDbValue(shift);

    const { error } = await supabaseAdmin
      .from("pl_machine_demand")
      .delete()
      .eq("org_id", DEMO_ORG_ID)
      .eq("machine_code", machineCode)
      .eq("plan_date", date)
      .eq("shift_type", shiftType);

    if (error) throw error;

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Demand deletion error:", error);
    return NextResponse.json({ error: "Failed to delete demand" }, { status: 500 });
  }
}
</file>

<file path="api/line-overview/suggestions/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { z } from "zod";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function shiftParamToDbValue(shift: string): string {
  const map: Record<string, string> = {
    day: "Day",
    evening: "Evening",
    night: "Night",
  };
  return map[shift.toLowerCase()] || "Day";
}

const suggestionsSchema = z.object({
  machineCode: z.string(),
  date: z.string(),
  shift: z.string(),
  hoursNeeded: z.number().positive(),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const parsed = suggestionsSchema.safeParse(body);

    if (!parsed.success) {
      return NextResponse.json({ error: "Invalid input", details: parsed.error.issues }, { status: 400 });
    }

    const { date, shift, hoursNeeded } = parsed.data;
    const shiftType = shiftParamToDbValue(shift);

    const [employeesRes, attendanceRes, assignmentsRes] = await Promise.all([
      supabaseAdmin.from("pl_employees").select("*").eq("org_id", DEMO_ORG_ID),
      supabaseAdmin.from("pl_attendance").select("*").eq("org_id", DEMO_ORG_ID).eq("plan_date", date).eq("shift_type", shiftType),
      supabaseAdmin.from("pl_assignment_segments").select("*").eq("org_id", DEMO_ORG_ID).eq("plan_date", date).eq("shift_type", shiftType),
    ]);

    if (employeesRes.error) throw employeesRes.error;
    if (attendanceRes.error) throw attendanceRes.error;
    if (assignmentsRes.error) throw assignmentsRes.error;

    const employees = employeesRes.data || [];
    const attendance = attendanceRes.data || [];
    const assignments = assignmentsRes.data || [];

    const attendanceMap = new Map(attendance.map((a) => [a.employee_code, a]));

    const suggestions = employees
      .filter((emp) => {
        const att = attendanceMap.get(emp.employee_code);
        return !att || att.status === "present";
      })
      .map((emp) => {
        const empAssignments = assignments.filter((a) => a.employee_code === emp.employee_code);
        let currentHours = 0;
        empAssignments.forEach((a) => {
          const start = new Date(`2000-01-01T${a.start_time}`);
          const end = new Date(`2000-01-01T${a.end_time}`);
          currentHours += (end.getTime() - start.getTime()) / (1000 * 60 * 60);
        });

        const score = 100 - (currentHours / 8) * 50;
        const availableHours = Math.max(0, 8 - currentHours);

        return {
          employee: {
            id: emp.id,
            employeeCode: emp.employee_code,
            fullName: emp.full_name,
          },
          currentHours,
          availableHours,
          score,
        };
      })
      .filter((s) => s.availableHours > 0)
      .sort((a, b) => b.score - a.score)
      .slice(0, 3);

    return NextResponse.json({ suggestions });
  } catch (error) {
    console.error("Suggestions error:", error);
    return NextResponse.json({ error: "Failed to get suggestions" }, { status: 500 });
  }
}
</file>

<file path="api/line-overview/week/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function shiftParamToDbValue(shift: string): string {
  const map: Record<string, string> = {
    day: "Day",
    evening: "Evening",
    night: "Night",
  };
  return map[shift.toLowerCase()] || "Day";
}

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const startDate = searchParams.get("startDate") || new Date().toISOString().split("T")[0];
  const shift = shiftParamToDbValue(searchParams.get("shift") || "day");

  try {
    const dates: string[] = [];
    const start = new Date(startDate);
    for (let i = 0; i < 5; i++) {
      const d = new Date(start);
      d.setDate(d.getDate() + i);
      dates.push(d.toISOString().split("T")[0]);
    }

    const [linesRes, machinesRes, demandRes, assignmentsRes] = await Promise.all([
      supabaseAdmin.from("pl_lines").select("*").eq("org_id", DEMO_ORG_ID).order("line_code"),
      supabaseAdmin.from("pl_machines").select("*").eq("org_id", DEMO_ORG_ID).order("machine_code"),
      supabaseAdmin.from("pl_machine_demand").select("*").eq("org_id", DEMO_ORG_ID).in("plan_date", dates).eq("shift_type", shift),
      supabaseAdmin.from("pl_assignment_segments").select("*").eq("org_id", DEMO_ORG_ID).in("plan_date", dates).eq("shift_type", shift),
    ]);

    if (linesRes.error) throw linesRes.error;
    if (machinesRes.error) throw machinesRes.error;
    if (demandRes.error) throw demandRes.error;
    if (assignmentsRes.error) throw assignmentsRes.error;

    const lines = linesRes.data || [];
    const machines = machinesRes.data || [];
    const demands = demandRes.data || [];
    const assignments = assignmentsRes.data || [];

    let totalRequired = 0;
    let totalAssigned = 0;

    const lineData = lines.map((line) => {
      const lineMachines = machines.filter((m) => m.line_code === line.line_code);

      const machineData = lineMachines.map((machine) => {
        const machineDemands = demands.filter((d) => d.machine_code === machine.machine_code);
        const machineAssigns = assignments.filter((a) => a.machine_code === machine.machine_code);

        const requiredHours = machineDemands.reduce((sum, d) => sum + (d.required_hours || 0), 0);
        let assignedHours = 0;

        machineAssigns.forEach((a) => {
          const start = new Date(`2000-01-01T${a.start_time}`);
          const end = new Date(`2000-01-01T${a.end_time}`);
          assignedHours += (end.getTime() - start.getTime()) / (1000 * 60 * 60);
        });

        const gap = requiredHours - assignedHours;
        totalRequired += requiredHours;
        totalAssigned += assignedHours;

        let status: "ok" | "partial" | "gap" = "ok";
        if (requiredHours > 0) {
          if (assignedHours === 0) status = "gap";
          else if (assignedHours < requiredHours) status = "partial";
        }

        return {
          machine: {
            id: machine.id,
            machineCode: machine.machine_code,
            machineName: machine.machine_name,
            lineCode: machine.line_code,
          },
          requiredHours,
          assignedHours,
          gap,
          status,
          assignedPeople: [],
        };
      });

      return {
        line: {
          id: line.id,
          lineCode: line.line_code,
          lineName: line.line_name,
        },
        machines: machineData,
        totalRequired: machineData.reduce((sum, m) => sum + m.requiredHours, 0),
        totalAssigned: machineData.reduce((sum, m) => sum + m.assignedHours, 0),
        totalGap: machineData.reduce((sum, m) => sum + Math.max(0, m.gap), 0),
      };
    });

    const coveragePercent = totalRequired > 0 ? Math.round((totalAssigned / totalRequired) * 100) : 100;

    return NextResponse.json({
      lines: lineData,
      kpis: {
        coveragePercent,
        gapHours: Math.max(0, totalRequired - totalAssigned),
        overtimeHours: 0,
        presentCount: 0,
        absentCount: 0,
      },
      employees: [],
      weekDates: dates,
    });
  } catch (error) {
    console.error("Week overview fetch error:", error);
    return NextResponse.json({ error: "Failed to fetch week data" }, { status: 500 });
  }
}
</file>

<file path="api/line-overview/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const DEMO_ORG_ID = "f607f244-da91-41d9-a648-d02a1591105c";

const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

function shiftParamToDbValue(shift: string): string {
  const map: Record<string, string> = {
    day: "Day",
    evening: "Evening",
    night: "Night",
  };
  return map[shift.toLowerCase()] || "Day";
}

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const date = searchParams.get("date") || new Date().toISOString().split("T")[0];
  const shift = shiftParamToDbValue(searchParams.get("shift") || "day");

  try {
    const [linesRes, machinesRes, demandRes, assignmentsRes, attendanceRes, employeesRes] = await Promise.all([
      supabaseAdmin.from("pl_lines").select("*").eq("org_id", DEMO_ORG_ID).order("line_code"),
      supabaseAdmin.from("pl_machines").select("*").eq("org_id", DEMO_ORG_ID).order("machine_code"),
      supabaseAdmin.from("pl_machine_demand").select("*").eq("org_id", DEMO_ORG_ID).eq("plan_date", date).eq("shift_type", shift),
      supabaseAdmin.from("pl_assignment_segments").select("*").eq("org_id", DEMO_ORG_ID).eq("plan_date", date).eq("shift_type", shift),
      supabaseAdmin.from("pl_attendance").select("*").eq("org_id", DEMO_ORG_ID).eq("plan_date", date).eq("shift_type", shift),
      supabaseAdmin.from("pl_employees").select("*").eq("org_id", DEMO_ORG_ID),
    ]);

    if (linesRes.error) throw linesRes.error;
    if (machinesRes.error) throw machinesRes.error;
    if (demandRes.error) throw demandRes.error;
    if (assignmentsRes.error) throw assignmentsRes.error;
    if (attendanceRes.error) throw attendanceRes.error;
    if (employeesRes.error) throw employeesRes.error;

    const lines = linesRes.data || [];
    const machines = machinesRes.data || [];
    const demands = demandRes.data || [];
    const assignments = assignmentsRes.data || [];
    const attendance = attendanceRes.data || [];
    const employees = employeesRes.data || [];

    const demandMap = new Map(demands.map((d) => [d.machine_code, d]));
    const employeeMap = new Map(employees.map((e) => [e.employee_code, e]));
    
    const assignmentsByMachine = new Map<string, typeof assignments>();
    assignments.forEach((a) => {
      const list = assignmentsByMachine.get(a.machine_code) || [];
      list.push(a);
      assignmentsByMachine.set(a.machine_code, list);
    });

    const presentCount = attendance.filter((a) => a.status === "present").length;
    const partialCount = attendance.filter((a) => a.status === "partial").length;
    const absentCount = attendance.filter((a) => a.status === "absent").length;

    let totalRequired = 0;
    let totalAssigned = 0;
    let totalGap = 0;
    let totalOverAssigned = 0;

    const lineData = lines.map((line) => {
      const lineMachines = machines.filter((m) => m.line_code === line.line_code);

      const machineData = lineMachines.map((machine) => {
        const demand = demandMap.get(machine.machine_code);
        const machineAssignments = assignmentsByMachine.get(machine.machine_code) || [];

        const requiredHours = demand?.required_hours || 0;
        let assignedHours = 0;
        const assignedPeople: Array<{
          assignmentId: string;
          employeeId: string;
          employeeCode: string;
          employeeName: string;
          startTime: string;
          endTime: string;
          hours: number;
        }> = [];

        machineAssignments.forEach((a) => {
          const start = new Date(`2000-01-01T${a.start_time}`);
          const end = new Date(`2000-01-01T${a.end_time}`);
          const hours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
          assignedHours += hours;

          const emp = employeeMap.get(a.employee_code);
          if (emp) {
            assignedPeople.push({
              assignmentId: a.id,
              employeeId: emp.id,
              employeeCode: emp.employee_code,
              employeeName: emp.full_name,
              startTime: a.start_time,
              endTime: a.end_time,
              hours,
            });
          }
        });

        const gap = requiredHours - assignedHours;
        const overAssigned = assignedHours > requiredHours ? assignedHours - requiredHours : 0;
        totalRequired += requiredHours;
        totalAssigned += assignedHours;
        if (gap > 0) totalGap += gap;
        if (overAssigned > 0) totalOverAssigned += overAssigned;

        let status: "ok" | "partial" | "gap" | "over" | "no_demand" = "no_demand";
        if (requiredHours > 0) {
          if (assignedHours === 0) status = "gap";
          else if (assignedHours < requiredHours) status = "partial";
          else if (assignedHours > requiredHours) status = "over";
          else status = "ok";
        } else if (assignedHours > 0) {
          status = "over";
        }

        const assignments = machineAssignments.map((a) => ({
          id: a.id,
          planDate: a.plan_date,
          shiftType: a.shift_type,
          machineCode: a.machine_code,
          employeeCode: a.employee_code,
          startTime: a.start_time,
          endTime: a.end_time,
          roleNote: a.role_note,
        }));

        return {
          machine: {
            id: machine.id,
            machineCode: machine.machine_code,
            machineName: machine.machine_name,
            lineCode: machine.line_code,
          },
          requiredHours,
          assignedHours,
          gap,
          overAssigned,
          status,
          assignments,
          assignedPeople,
        };
      });

      const lineRequired = machineData.reduce((sum, m) => sum + m.requiredHours, 0);
      const lineAssigned = machineData.reduce((sum, m) => sum + m.assignedHours, 0);
      const lineGap = machineData.reduce((sum, m) => sum + Math.max(0, m.gap), 0);
      const lineOverAssigned = machineData.reduce((sum, m) => sum + m.overAssigned, 0);

      return {
        line: {
          id: line.id,
          lineCode: line.line_code,
          lineName: line.line_name,
        },
        machines: machineData,
        totalRequired: lineRequired,
        totalAssigned: lineAssigned,
        totalGap: lineGap,
        totalOverAssigned: lineOverAssigned,
      };
    });

    const hasDemand = totalRequired > 0;
    const coveragePercent = hasDemand ? Math.min(Math.round((totalAssigned / totalRequired) * 100), 999) : null;

    return NextResponse.json({
      lines: lineData,
      kpis: {
        hasDemand,
        coveragePercent,
        gapHours: hasDemand ? totalGap : null,
        overAssignedHours: totalOverAssigned,
        presentCount,
        partialCount,
        absentCount,
      },
      employees: employees.map((e) => ({
        id: e.id,
        employeeCode: e.employee_code,
        fullName: e.full_name,
      })),
      attendance: attendance.map((a) => ({
        id: a.id,
        employeeCode: a.employee_code,
        planDate: a.plan_date,
        shiftType: a.shift_type,
        status: a.status,
        availableFrom: a.available_from,
        availableTo: a.available_to,
        note: a.note,
      })),
    });
  } catch (error) {
    console.error("Line overview fetch error:", error);
    return NextResponse.json({ error: "Failed to fetch data" }, { status: 500 });
  }
}
</file>

<file path="api/org/create/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { z } from 'zod';

const createOrgSchema = z.object({
  name: z.string().min(1).max(100),
  slug: z.string().min(1).max(50).regex(/^[a-z0-9-]+$/, 'Slug must be lowercase letters, numbers, and hyphens only'),
});

function getServiceSupabase() {
  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;
  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
  
  if (!url || !serviceKey) {
    throw new Error('Missing Supabase configuration');
  }
  
  return createClient(url, serviceKey, {
    auth: { autoRefreshToken: false, persistSession: false }
  });
}

async function getCurrentUser(request: NextRequest) {
  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }
  
  const token = authHeader.substring(7);
  const supabase = getServiceSupabase();
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  if (error || !user) {
    return null;
  }
  
  return user;
}

export async function POST(request: NextRequest) {
  try {
    const user = await getCurrentUser(request);
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const parsed = createOrgSchema.safeParse(body);
    
    if (!parsed.success) {
      return NextResponse.json({ error: 'Invalid input', details: parsed.error.errors }, { status: 400 });
    }

    const { name, slug } = parsed.data;
    const supabase = getServiceSupabase();

    // Check if slug is already taken
    const { data: existing } = await supabase
      .from('organizations')
      .select('id')
      .eq('slug', slug)
      .single();

    if (existing) {
      return NextResponse.json({ error: 'Organization slug already exists' }, { status: 409 });
    }

    // Create organization
    const { data: org, error: orgError } = await supabase
      .from('organizations')
      .insert({
        name,
        slug,
        created_by: user.id,
      })
      .select()
      .single();

    if (orgError) {
      console.error('Error creating org:', orgError);
      return NextResponse.json({ error: 'Failed to create organization' }, { status: 500 });
    }

    // Create admin membership for creator
    const { error: memberError } = await supabase
      .from('memberships')
      .insert({
        org_id: org.id,
        user_id: user.id,
        role: 'admin',
        status: 'active',
      });

    if (memberError) {
      console.error('Error creating membership:', memberError);
      // Rollback org creation
      await supabase.from('organizations').delete().eq('id', org.id);
      return NextResponse.json({ error: 'Failed to create membership' }, { status: 500 });
    }

    // Write audit log
    await supabase.from('audit_logs').insert({
      org_id: org.id,
      actor_user_id: user.id,
      action: 'org.created',
      target_type: 'organization',
      target_id: org.id,
      metadata: { name, slug },
    });

    return NextResponse.json({ success: true, organization: org });
  } catch (error) {
    console.error('Create org error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
</file>

<file path="api/spaljisten/dashboard/route.ts">
import { NextRequest, NextResponse } from "next/server";
import pool from "@/lib/pgClient";

const SPALJISTEN_ORG_ID = "a1b2c3d4-e5f6-7890-abcd-ef1234567890";
const ORG_NAME = "Spaljisten";

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const areaId = searchParams.get("areaId") || undefined;

    const client = await pool.connect();
    try {
      const [areasRes, employeesRes, skillsRes, ratingsRes, stationsRes] = await Promise.all([
        client.query("SELECT id, org_id, area_code, area_name FROM sp_areas WHERE org_id = $1 ORDER BY area_name", [SPALJISTEN_ORG_ID]),
        client.query("SELECT id, org_id, employee_id, employee_name, area_id, is_active FROM sp_employees WHERE org_id = $1 AND is_active = true", [SPALJISTEN_ORG_ID]),
        client.query("SELECT id, org_id, skill_id, skill_name, category, station_id FROM sp_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT id, org_id, employee_id, skill_id, rating FROM sp_employee_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT id, area_id, station_code, station_name FROM sp_stations WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
      ]);

      const areas = areasRes.rows;
      const employees = employeesRes.rows;
      const skills = skillsRes.rows;
      const ratings = ratingsRes.rows;
      const stations = stationsRes.rows;
      
      const stationMap = new Map(stations.map((s) => [s.id, s]));

      const totalEmployees = employees.length;
      const totalSkills = skills.length;
      const totalAreas = areas.length;

      const independentRatings = ratings.filter((r) => r.rating !== null && r.rating >= 3);
      const totalRatings = ratings.filter((r) => r.rating !== null).length;
      const averageIndependentRate = totalRatings > 0 ? Math.round((independentRatings.length / totalRatings) * 100) : 0;

      const kpis = { 
        totalEmployees, 
        totalSkills, 
        totalAreas,
        totalRatings, 
        averageIndependentRate,
        orgName: ORG_NAME,
        orgId: SPALJISTEN_ORG_ID
      };

      const employeeMap = new Map(employees.map((e) => [e.employee_id, { name: e.employee_name, areaId: e.area_id }]));
      const areaMap = new Map(areas.map((a) => [a.id, a.area_name]));

      const getSkillAreaId = (skill: { station_id: string | null }) => {
        if (!skill.station_id) return null;
        const station = stationMap.get(skill.station_id);
        return station?.area_id || null;
      };

      let filteredSkills = skills;
      if (areaId) {
        filteredSkills = skills.filter((skill) => getSkillAreaId(skill) === areaId);
      }

      const skillRisks: { skillId: string; skillName: string; category: string; independentCount: number; totalRated: number; riskLevel: string }[] = [];
      
      for (const skill of filteredSkills) {
        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);
        
        const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;
        const totalRated = skillRatings.filter((r) => r.rating !== null).length;
        
        let riskLevel: "ok" | "warning" | "critical" = "ok";
        if (independentCount === 0) riskLevel = "critical";
        else if (independentCount < 2) riskLevel = "warning";

        skillRisks.push({
          skillId: skill.skill_id,
          skillName: skill.skill_name,
          category: skill.category || "general",
          independentCount,
          totalRated,
          riskLevel,
        });
      }

      const topRiskSkills = skillRisks
        .filter((s) => s.totalRated > 0)
        .sort((a, b) => {
          const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };
          if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];
          return a.independentCount - b.independentCount;
        })
        .slice(0, 10);

      const skillGapData = filteredSkills.map((skill) => {
        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);
        
        const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;
        const totalEmployeesForSkill = skillRatings.length;

        const employeeDetails = skillRatings.map((r) => {
          const emp = employeeMap.get(r.employee_id);
          return {
            employeeId: r.employee_id,
            employeeName: emp?.name || r.employee_id,
            areaName: emp?.areaId ? areaMap.get(emp.areaId) || "Unknown" : "Unknown",
            rating: r.rating,
          };
        });

        let riskLevel: "ok" | "warning" | "critical" = "ok";
        if (independentCount === 0) riskLevel = "critical";
        else if (independentCount < 2) riskLevel = "warning";

        return {
          skillId: skill.skill_id,
          skillName: skill.skill_name,
          category: skill.category || "general",
          independentCount,
          totalEmployees: totalEmployeesForSkill,
          employees: employeeDetails,
          riskLevel,
        };
      })
      .filter((s) => s.totalEmployees > 0)
      .sort((a, b) => {
        const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };
        if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];
        return a.independentCount - b.independentCount;
      });

      const filterOptions = {
        areas: areas.map((a) => ({ id: a.id, areaCode: a.area_code, areaName: a.area_name })),
      };

      return NextResponse.json({ 
        kpis, 
        topRiskSkills, 
        skillGapTable: skillGapData, 
        filterOptions 
      });
    } finally {
      client.release();
    }
  } catch (error) {
    console.error("Dashboard error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Failed to load dashboard" },
      { status: 500 }
    );
  }
}
</file>

<file path="api/spaljisten/export/route.ts">
import { NextRequest, NextResponse } from "next/server";
import pool from "@/lib/pgClient";

const SPALJISTEN_ORG_ID = "a1b2c3d4-e5f6-7890-abcd-ef1234567890";

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const areaId = searchParams.get("areaId") || undefined;
    const stationId = searchParams.get("stationId") || undefined;

    const client = await pool.connect();
    try {
      const [stationsRes, skillsRes, ratingsRes, employeesRes, areasRes] = await Promise.all([
        client.query("SELECT id, area_id, station_code, station_name FROM sp_stations WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT skill_id, skill_name, station_id, category FROM sp_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT employee_id, skill_id, rating FROM sp_employee_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT employee_id, employee_name FROM sp_employees WHERE org_id = $1 AND is_active = true", [SPALJISTEN_ORG_ID]),
        client.query("SELECT id, area_code, area_name FROM sp_areas WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
      ]);

      const stations = stationsRes.rows;
      const skills = skillsRes.rows;
      const ratings = ratingsRes.rows;
      const employees = employeesRes.rows;
      const areas = areasRes.rows;

      const stationMap = new Map(stations.map((s) => [s.id, s]));
      const areaMap = new Map(areas.map((a) => [a.id, a.area_name]));

      const getSkillAreaId = (skill: { station_id: string | null }) => {
        if (!skill.station_id) return null;
        const station = stationMap.get(skill.station_id);
        return station?.area_id || null;
      };

      let filteredSkills = skills;
      if (areaId) {
        filteredSkills = skills.filter((skill) => getSkillAreaId(skill) === areaId);
      }
      if (stationId) {
        filteredSkills = filteredSkills.filter((s) => s.station_id === stationId);
      }

      const employeeMap = new Map(employees.map((e) => [e.employee_id, e.employee_name]));

      const gapData = filteredSkills.map((skill) => {
        const station = stationMap.get(skill.station_id);
        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);
        const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;
        const totalEmployeesForSkill = skillRatings.length;

        const employeeDetails = skillRatings.map((r) => ({
          employeeId: r.employee_id,
          employeeName: employeeMap.get(r.employee_id) || r.employee_id,
          rating: r.rating,
        }));

        let riskLevel: "ok" | "warning" | "critical" = "ok";
        if (independentCount === 0) riskLevel = "critical";
        else if (independentCount < 2) riskLevel = "warning";

        return {
          stationCode: station?.station_code || "N/A",
          stationName: station?.station_name || "Unknown",
          skillId: skill.skill_id,
          skillName: skill.skill_name,
          independentCount,
          totalEmployees: totalEmployeesForSkill,
          employees: employeeDetails,
          riskLevel,
        };
      })
      .filter((s) => s.totalEmployees > 0)
      .sort((a, b) => {
        const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };
        if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];
        return a.independentCount - b.independentCount;
      });

      const headers = [
        "Station Code",
        "Station Name",
        "Skill ID",
        "Skill Name",
        "Independent Count (>=3)",
        "Total Employees",
        "Risk Level",
        "Employee Names",
      ];

      const rows = gapData.map((item) => [
        item.stationCode,
        item.stationName,
        item.skillId,
        item.skillName,
        item.independentCount.toString(),
        item.totalEmployees.toString(),
        item.riskLevel.toUpperCase(),
        item.employees.map((e) => `${e.employeeName} (${e.rating ?? "N"})`).join("; "),
      ]);

      const escapeCsvField = (field: string): string => {
        if (field.includes(",") || field.includes('"') || field.includes("\n")) {
          return `"${field.replace(/"/g, '""')}"`;
        }
        return field;
      };

      const csvContent = [
        headers.map(escapeCsvField).join(","),
        ...rows.map((row) => row.map(escapeCsvField).join(",")),
      ].join("\n");

      const timestamp = new Date().toISOString().split("T")[0];
      const filename = `skill-gap-report-${timestamp}.csv`;

      return new NextResponse(csvContent, {
        status: 200,
        headers: {
          "Content-Type": "text/csv; charset=utf-8",
          "Content-Disposition": `attachment; filename="${filename}"`,
        },
      });
    } finally {
      client.release();
    }
  } catch (error) {
    console.error("Export error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Export failed" },
      { status: 500 }
    );
  }
}
</file>

<file path="api/spaljisten/import/route.ts">
import { NextRequest, NextResponse } from "next/server";
import Papa from "papaparse";
import pool from "@/lib/pgClient";

const SPALJISTEN_ORG_ID = "a1b2c3d4-e5f6-7890-abcd-ef1234567890";

type FailedRow = { line: number; reason: string };
type ImportResult = {
  success: boolean;
  importType: string;
  totalRows: number;
  inserted: number;
  updated: number;
  failed: number;
  failedRows: FailedRow[];
};

async function importAreas(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const rawAreaCode = row["area_code"]?.trim() || row["code"]?.trim() || row["area"]?.trim();
      const areaName = row["area_name"]?.trim() || row["name"]?.trim() || rawAreaCode;

      if (!rawAreaCode) { failedRows.push({ line: lineNum, reason: "Missing area_code or area" }); continue; }

      const areaCode = rawAreaCode.toLowerCase();

      try {
        const result = await client.query(
          `INSERT INTO sp_areas (org_id, area_code, area_name) 
           VALUES ($1, $2, $3) 
           ON CONFLICT (org_id, area_code) DO UPDATE SET area_name = EXCLUDED.area_name
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, areaCode, areaName]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "areas", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importStations(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const stationCode = row["station_code"]?.trim() || row["code"]?.trim() || row["skill_code"]?.trim();
      const stationName = row["station_name"]?.trim() || row["name"]?.trim() || row["skill_name"]?.trim() || stationCode;
      const areaCode = row["area_code"]?.trim() || row["area"]?.trim();

      if (!stationCode) { failedRows.push({ line: lineNum, reason: "Missing station_code" }); continue; }

      try {
        let areaId = null;
        if (areaCode) {
          const normalizedAreaCode = areaCode.toLowerCase();
          const areaRes = await client.query(
            "SELECT id FROM sp_areas WHERE org_id = $1 AND (area_code = $2 OR LOWER(area_name) = $2)", 
            [SPALJISTEN_ORG_ID, normalizedAreaCode]
          );
          areaId = areaRes.rows[0]?.id || null;
        }

        const result = await client.query(
          `INSERT INTO sp_stations (org_id, station_code, station_name, area_id) 
           VALUES ($1, $2, $3, $4) 
           ON CONFLICT (org_id, station_code) DO UPDATE SET station_name = EXCLUDED.station_name, area_id = EXCLUDED.area_id
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, stationCode, stationName, areaId]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "stations", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importEmployees(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const employeeId = row["employee_id"]?.trim();
      const employeeName = row["employee_name"]?.trim() || row["name"]?.trim();
      const email = row["email"]?.trim() || null;
      const areaName = row["source_sheet"]?.trim() || row["area"]?.trim() || row["area_code"]?.trim();

      if (!employeeId) { failedRows.push({ line: lineNum, reason: "Missing employee_id" }); continue; }
      if (!employeeName) { failedRows.push({ line: lineNum, reason: "Missing employee_name" }); continue; }

      try {
        let areaId = null;
        if (areaName) {
          const normalizedAreaCode = areaName.trim().toLowerCase();
          // Upsert area first
          await client.query(
            `INSERT INTO sp_areas (org_id, area_code, area_name) 
             VALUES ($1, $2, $3) 
             ON CONFLICT (org_id, area_code) DO NOTHING`,
            [SPALJISTEN_ORG_ID, normalizedAreaCode, areaName.trim()]
          );
          const areaRes = await client.query(
            "SELECT id FROM sp_areas WHERE org_id = $1 AND area_code = $2",
            [SPALJISTEN_ORG_ID, normalizedAreaCode]
          );
          areaId = areaRes.rows[0]?.id || null;
        }

        const result = await client.query(
          `INSERT INTO sp_employees (org_id, employee_id, employee_name, email, area_id) 
           VALUES ($1, $2, $3, $4, $5) 
           ON CONFLICT (org_id, employee_id) DO UPDATE SET 
             employee_name = EXCLUDED.employee_name, 
             email = EXCLUDED.email, 
             area_id = EXCLUDED.area_id, 
             updated_at = NOW()
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, employeeId, employeeName, email, areaId]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "employees", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importSkillsCatalog(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const skillId = row["skill_id"]?.trim() || row["skill_code"]?.trim();
      const skillName = row["skill_name"]?.trim() || row["name"]?.trim() || skillId;
      const stationCode = row["station"]?.trim() || row["station_code"]?.trim();
      const category = row["category"]?.trim() || row["skill_type"]?.trim() || null;

      if (!skillId) { failedRows.push({ line: lineNum, reason: "Missing skill_id or skill_code" }); continue; }

      try {
        let stationId = null;
        if (stationCode) {
          const stationRes = await client.query("SELECT id FROM sp_stations WHERE org_id = $1 AND station_code = $2", [SPALJISTEN_ORG_ID, stationCode]);
          stationId = stationRes.rows[0]?.id || null;
        }

        const result = await client.query(
          `INSERT INTO sp_skills (org_id, skill_id, skill_name, station_id, category) 
           VALUES ($1, $2, $3, $4, $5) 
           ON CONFLICT (org_id, skill_id) DO UPDATE SET 
             skill_name = EXCLUDED.skill_name, 
             station_id = EXCLUDED.station_id, 
             category = EXCLUDED.category
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, skillId, skillName, stationId, category]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "skills_catalog", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importEmployeeSkillRatings(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const employeeId = row["employee_id"]?.trim();
      const skillId = row["skill_id"]?.trim() || row["skill_code"]?.trim();
      const ratingStr = row["rating"]?.trim();

      if (!employeeId) { failedRows.push({ line: lineNum, reason: "Missing employee_id" }); continue; }
      if (!skillId) { failedRows.push({ line: lineNum, reason: "Missing skill_id or skill_code" }); continue; }

      let rating: number | null = null;
      if (ratingStr && ratingStr.toUpperCase() !== "N" && ratingStr !== "" && ratingStr !== "-") {
        const parsed = parseInt(ratingStr, 10);
        if (isNaN(parsed) || parsed < 0 || parsed > 5) {
          failedRows.push({ line: lineNum, reason: `Invalid rating: ${ratingStr} (must be 0-5 or N)` });
          continue;
        }
        rating = parsed;
      }

      try {
        const result = await client.query(
          `INSERT INTO sp_employee_skills (org_id, employee_id, skill_id, rating) 
           VALUES ($1, $2, $3, $4) 
           ON CONFLICT (org_id, employee_id, skill_id) DO UPDATE SET 
             rating = EXCLUDED.rating, 
             updated_at = NOW()
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, employeeId, skillId, rating]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "employee_skill_ratings", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importAreaLeaders(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const areaName = row["area"]?.trim() || row["area_code"]?.trim();
      const leaderName = row["leader_name"]?.trim() || row["employee_name"]?.trim();

      if (!areaName) { failedRows.push({ line: lineNum, reason: "Missing area" }); continue; }
      if (!leaderName) { failedRows.push({ line: lineNum, reason: "Missing leader_name" }); continue; }

      try {
        const normalizedAreaCode = areaName.toLowerCase();
        const areaRes = await client.query(
          "SELECT id FROM sp_areas WHERE org_id = $1 AND (area_code = $2 OR LOWER(area_name) = $2)", 
          [SPALJISTEN_ORG_ID, normalizedAreaCode]
        );
        if (areaRes.rows.length === 0) {
          failedRows.push({ line: lineNum, reason: `Area not found: ${areaName}` });
          continue;
        }
        const areaId = areaRes.rows[0].id;

        const empRes = await client.query("SELECT employee_id FROM sp_employees WHERE org_id = $1 AND employee_name = $2", [SPALJISTEN_ORG_ID, leaderName]);
        const employeeId = empRes.rows[0]?.employee_id || leaderName;

        const result = await client.query(
          `INSERT INTO sp_area_leaders (org_id, area_id, employee_id, is_primary) 
           VALUES ($1, $2, $3, true) 
           ON CONFLICT (org_id, area_id, employee_id) DO UPDATE SET is_primary = true
           RETURNING (xmax = 0) AS is_insert`,
          [SPALJISTEN_ORG_ID, areaId, employeeId]
        );
        if (result.rows[0]?.is_insert) inserted++; else updated++;
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "area_leaders", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

async function importRatingScales(rows: Record<string, string>[]): Promise<ImportResult> {
  let inserted = 0, updated = 0;
  const failedRows: FailedRow[] = [];
  const client = await pool.connect();

  try {
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const lineNum = i + 2;
      const scaleGroup = row["scale_group"]?.trim() || "default";
      const levelStr = row["level"]?.trim() || row["rating_value"]?.trim();
      const label = row["label"]?.trim() || row["description"]?.trim();
      const description = row["description"]?.trim() || label || "";

      if (!levelStr) { failedRows.push({ line: lineNum, reason: "Missing level or rating_value" }); continue; }

      let level: number | null = null;
      if (levelStr.toUpperCase() === "N") {
        level = null;
      } else {
        const parsed = parseInt(levelStr, 10);
        if (isNaN(parsed)) {
          failedRows.push({ line: lineNum, reason: `Invalid level: ${levelStr}` });
          continue;
        }
        level = parsed;
      }

      try {
        const existing = await client.query("SELECT id FROM sp_rating_scales WHERE org_id = $1 AND level = $2", [SPALJISTEN_ORG_ID, level]);
        if (existing.rows.length > 0) {
          await client.query("UPDATE sp_rating_scales SET label = $1, description = $2 WHERE id = $3", [label || `Level ${level}`, description, existing.rows[0].id]);
          updated++;
        } else if (level !== null) {
          await client.query("INSERT INTO sp_rating_scales (org_id, level, label, description) VALUES ($1, $2, $3, $4)", [SPALJISTEN_ORG_ID, level, label || `Level ${level}`, description]);
          inserted++;
        }
      } catch (err) {
        failedRows.push({ line: lineNum, reason: err instanceof Error ? err.message : "Unknown error" });
      }
    }
  } finally {
    client.release();
  }
  return { success: failedRows.length === 0, importType: "rating_scales", totalRows: rows.length, inserted, updated, failed: failedRows.length, failedRows };
}

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get("file") as File | null;
    const importType = formData.get("importType") as string;

    if (!file) return NextResponse.json({ error: "No file provided" }, { status: 400 });
    if (!importType) return NextResponse.json({ error: "No import type specified" }, { status: 400 });

    const validTypes = ["employees", "skills_catalog", "employee_skill_ratings", "areas", "stations", "area_leaders", "rating_scales"];
    if (!validTypes.includes(importType)) {
      return NextResponse.json({ error: `Invalid import type. Valid types: ${validTypes.join(", ")}` }, { status: 400 });
    }

    const text = await file.text();
    const parsed = Papa.parse<Record<string, string>>(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (h) => h.trim().toLowerCase().replace(/\s+/g, "_"),
    });

    if (parsed.errors.length > 0) {
      return NextResponse.json({ error: "CSV parsing errors", details: parsed.errors.slice(0, 10) }, { status: 400 });
    }

    const rows = parsed.data;
    if (rows.length === 0) return NextResponse.json({ error: "CSV file is empty" }, { status: 400 });

    let result: ImportResult;
    switch (importType) {
      case "areas": result = await importAreas(rows); break;
      case "stations": result = await importStations(rows); break;
      case "employees": result = await importEmployees(rows); break;
      case "skills_catalog": result = await importSkillsCatalog(rows); break;
      case "employee_skill_ratings": result = await importEmployeeSkillRatings(rows); break;
      case "area_leaders": result = await importAreaLeaders(rows); break;
      case "rating_scales": result = await importRatingScales(rows); break;
      default: return NextResponse.json({ error: "Unknown import type" }, { status: 400 });
    }

    return NextResponse.json(result);
  } catch (error) {
    console.error("Import error:", error);
    return NextResponse.json({ error: error instanceof Error ? error.message : "Import failed" }, { status: 500 });
  }
}
</file>

<file path="api/spaljisten/reset/route.ts">
import { NextRequest, NextResponse } from "next/server";
import pool from "@/lib/pgClient";

const SPALJISTEN_ORG_ID = "a1b2c3d4-e5f6-7890-abcd-ef1234567890";

export async function DELETE(request: NextRequest) {
  try {
    const client = await pool.connect();
    try {
      await client.query("BEGIN");
      
      await client.query("DELETE FROM sp_import_logs WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_area_leaders WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_employee_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_employees WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_stations WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      await client.query("DELETE FROM sp_areas WHERE org_id = $1", [SPALJISTEN_ORG_ID]);
      
      await client.query("COMMIT");
      
      return NextResponse.json({ 
        success: true, 
        message: "Spaljisten dataset reset successfully. All areas, employees, skills, ratings cleared." 
      });
    } catch (err) {
      await client.query("ROLLBACK");
      throw err;
    } finally {
      client.release();
    }
  } catch (error) {
    console.error("Reset error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Reset failed" },
      { status: 500 }
    );
  }
}

export async function GET() {
  try {
    const client = await pool.connect();
    try {
      const [areasRes, employeesRes, skillsRes, ratingsRes, stationsRes] = await Promise.all([
        client.query("SELECT COUNT(*) as count FROM sp_areas WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT COUNT(*) as count FROM sp_employees WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT COUNT(*) as count FROM sp_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT COUNT(*) as count FROM sp_employee_skills WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
        client.query("SELECT COUNT(*) as count FROM sp_stations WHERE org_id = $1", [SPALJISTEN_ORG_ID]),
      ]);
      
      return NextResponse.json({
        areas: parseInt(areasRes.rows[0].count),
        stations: parseInt(stationsRes.rows[0].count),
        employees: parseInt(employeesRes.rows[0].count),
        skills: parseInt(skillsRes.rows[0].count),
        ratings: parseInt(ratingsRes.rows[0].count),
      });
    } finally {
      client.release();
    }
  } catch (error) {
    console.error("Status error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Status check failed" },
      { status: 500 }
    );
  }
}
</file>

<file path="api/spaljisten/setup/route.ts">
import { NextRequest, NextResponse } from "next/server";
import pool from "@/lib/pgClient";

const SETUP_SECRET = process.env.SPALJISTEN_SETUP_SECRET || "sp-go-live-2024";

export async function POST(request: NextRequest) {
  try {
    const authHeader = request.headers.get("x-setup-secret");
    const body = await request.json();
    const { email, secret } = body;
    
    const providedSecret = authHeader || secret;
    if (providedSecret !== SETUP_SECRET) {
      return NextResponse.json({ error: "Unauthorized: Invalid setup secret" }, { status: 401 });
    }
    
    if (!email || email.toLowerCase() !== "daniel.buhre@spaljisten.se") {
      return NextResponse.json({ error: "Invalid setup request: Only daniel.buhre@spaljisten.se can be set up" }, { status: 400 });
    }

    const client = await pool.connect();
    try {
      const result = await client.query("SELECT sp_setup_daniel_admin() as result");
      const setupResult = result.rows[0]?.result;
      
      if (!setupResult?.success) {
        return NextResponse.json({ error: setupResult?.error || "Setup failed" }, { status: 400 });
      }

      return NextResponse.json({
        success: true,
        message: "Daniel Buhre has been set up as Customer Admin + Data Owner for Spaljisten",
        details: setupResult,
      });
    } finally {
      client.release();
    }
  } catch (error) {
    console.error("Setup error:", error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Setup failed" },
      { status: 500 }
    );
  }
}

export async function GET() {
  return NextResponse.json({
    message: "Spaljisten Go-Live Setup API",
    instructions: [
      "1. Daniel signs up at /login with email: daniel.buhre@spaljisten.se",
      "2. POST to this endpoint with { email: 'daniel.buhre@spaljisten.se', secret: '<setup-secret>' }",
      "3. Or run SQL directly: SELECT sp_setup_daniel_admin();",
      "4. Daniel can then access /app/spaljisten/import and /app/spaljisten/dashboard",
    ],
    note: "This endpoint requires a setup secret for security",
  });
}
</file>

<file path="api/workflows/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { supabase } from "@/lib/supabaseClient";
import { WORKFLOW_TEMPLATES } from "@/services/hrWorkflows";
import type { HRWorkflowInstance, HRWorkflowStep, HRWorkflowTemplateId } from "@/types/domain";

const workflowInstances: HRWorkflowInstance[] = [];

export async function GET() {
  return NextResponse.json(workflowInstances);
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { templateId, employeeId } = body;

    if (!templateId || !employeeId) {
      return NextResponse.json(
        { error: "templateId and employeeId are required" },
        { status: 400 }
      );
    }

    const template = WORKFLOW_TEMPLATES.find((t) => t.id === templateId);
    if (!template) {
      return NextResponse.json(
        { error: "Template not found" },
        { status: 404 }
      );
    }

    const { data: employee } = await supabase
      .from("employees")
      .select("name")
      .eq("id", employeeId)
      .single();

    const now = new Date();
    const steps: HRWorkflowStep[] = template.defaultSteps.map((step, index) => ({
      id: `step-${index + 1}`,
      title: step.title,
      description: step.description,
      daysFromStart: step.daysFromStart,
      responsibleRole: step.responsibleRole,
      isCompleted: false,
    }));

    const id = `wf-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    const instance: HRWorkflowInstance = {
      id,
      templateId: templateId as HRWorkflowTemplateId,
      templateName: template.name,
      employeeId,
      employeeName: employee?.name,
      status: "active",
      startedAt: now.toISOString(),
      steps,
    };

    workflowInstances.push(instance);

    const personEvents = template.defaultSteps.map((step) => {
      const dueDate = new Date(now.getTime() + step.daysFromStart * 24 * 60 * 60 * 1000);
      return {
        employee_id: employeeId,
        event_type: "training",
        title: `[${template.name}] ${step.title}`,
        description: step.description,
        due_date: dueDate.toISOString().split("T")[0],
        status: "pending",
      };
    });

    const { error: eventsError } = await supabase
      .from("person_events")
      .insert(personEvents);

    if (eventsError) {
      console.warn("Failed to create person_events:", eventsError.message);
    }

    return NextResponse.json(instance);
  } catch (err) {
    console.error("Workflow creation error:", err);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/admin/audit/page.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useOrg } from '@/hooks/useOrg';
import { OrgGuard } from '@/components/OrgGuard';
import { supabase } from '@/lib/supabaseClient';
import { DataState, useDataState } from '@/components/DataState';
import { logDebugError } from '@/lib/debugStore';
import { apiGet } from '@/lib/apiClient';
import { 
  ScrollText, 
  Filter,
  User,
  Building2,
  UserPlus,
  Shield,
  UserX
} from 'lucide-react';

interface AuditLog {
  id: number;
  actor_user_id: string;
  action: string;
  target_type: string | null;
  target_id: string | null;
  metadata: Record<string, unknown>;
  created_at: string;
  actor_email?: string | null;
}

interface ApiError {
  message: string;
  code?: string;
  hint?: string;
}

const ACTION_ICONS: Record<string, typeof Building2> = {
  'org.created': Building2,
  'user.invited': UserPlus,
  'membership.role_updated': Shield,
  'membership.disabled': UserX,
};

const ACTION_LABELS: Record<string, string> = {
  'org.created': 'Organization Created',
  'user.invited': 'User Invited',
  'membership.role_updated': 'Role Changed',
  'membership.disabled': 'User Disabled',
};

function AdminAuditContent() {
  const { currentOrg } = useOrg();
  const [logs, setLogs] = useState<AuditLog[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<ApiError | null>(null);
  const [actionFilter, setActionFilter] = useState<string>('');

  const fetchLogs = useCallback(async () => {
    if (!currentOrg) return;
    
    setLoading(true);
    setError(null);

    try {
      const data = await apiGet<{ logs: AuditLog[] }>(`/api/admin/audit?orgId=${currentOrg.id}`);
      let filteredLogs = data.logs || [];
      if (actionFilter) {
        filteredLogs = filteredLogs.filter((l: AuditLog) => l.action === actionFilter);
      }
      setLogs(filteredLogs);
    } catch (err) {
      console.error('Fetch error:', err);
      const apiError = { 
        message: err instanceof Error ? err.message : 'Failed to load audit logs',
        code: 'NETWORK_ERROR'
      };
      setError(apiError);
    } finally {
      setLoading(false);
    }
  }, [currentOrg, actionFilter]);

  useEffect(() => {
    fetchLogs();
  }, [fetchLogs]);

  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const formatMetadata = (metadata: Record<string, unknown>) => {
    const entries = Object.entries(metadata);
    if (entries.length === 0) return null;
    
    return entries.map(([key, value]) => (
      <span key={key} className="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-muted text-muted-foreground text-xs mr-1">
        {key}: {String(value)}
      </span>
    ));
  };

  const uniqueActions = [...new Set(logs.map(l => l.action))];
  const dataStatus = useDataState(logs, loading, error);

  return (
    <div className="p-6 max-w-6xl mx-auto space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-semibold text-foreground" data-testid="text-page-title">
            Audit Log
          </h1>
          <p className="text-muted-foreground mt-1">
            Activity history for {currentOrg?.name}
          </p>
        </div>
        
        {dataStatus === 'ready' && (
          <div className="flex items-center gap-2">
            <Filter className="w-4 h-4 text-muted-foreground" />
            <select
              value={actionFilter}
              onChange={(e) => setActionFilter(e.target.value)}
              className="px-3 py-2 rounded-md border border-input bg-background text-foreground text-sm"
              data-testid="select-action-filter"
            >
              <option value="">All Actions</option>
              {uniqueActions.map(action => (
                <option key={action} value={action}>
                  {ACTION_LABELS[action] || action}
                </option>
              ))}
            </select>
          </div>
        )}
      </div>

      <DataState
        status={dataStatus}
        error={error}
        onRetry={fetchLogs}
        emptyTitle="No audit events yet"
        emptyMessage="Activity will appear here as users take actions in the organization."
        emptyIcon={<ScrollText className="w-8 h-8 text-muted-foreground" />}
      >
        <div className="space-y-2">
          {logs.map((log) => {
            const IconComponent = ACTION_ICONS[log.action] || ScrollText;
            
            return (
              <div 
                key={log.id} 
                className="p-4 rounded-lg border border-border bg-card flex items-start gap-4"
                data-testid={`row-audit-${log.id}`}
              >
                <div className="p-2 rounded-md bg-muted">
                  <IconComponent className="w-4 h-4 text-muted-foreground" />
                </div>
                
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="font-medium text-foreground">
                      {ACTION_LABELS[log.action] || log.action}
                    </span>
                    {log.target_type && (
                      <span className="text-muted-foreground text-sm">
                        on {log.target_type}
                      </span>
                    )}
                  </div>
                  
                  <div className="flex items-center gap-2 mt-1 text-sm text-muted-foreground">
                    <User className="w-3 h-3" />
                    <span>{log.actor_email || 'System'}</span>
                    <span>at {formatDate(log.created_at)}</span>
                  </div>
                  
                  {Object.keys(log.metadata).length > 0 && (
                    <div className="mt-2">
                      {formatMetadata(log.metadata)}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </DataState>
    </div>
  );
}

export default function AdminAuditPage() {
  return (
    <OrgGuard requireAdmin>
      <AdminAuditContent />
    </OrgGuard>
  );
}
</file>

<file path="app/admin/security/page.tsx">
'use client';

import { Shield, Key, Lock, Eye } from 'lucide-react';

export default function SecuritySettingsPage() {
  return (
    <div className="p-6 max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900 dark:text-white" data-testid="text-page-title">
          Security Settings
        </h1>
        <p className="text-gray-600 dark:text-gray-400 mt-1">
          Configure authentication and access control policies
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Key className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Password Policy</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Set minimum password requirements and expiration rules
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Lock className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Two-Factor Authentication</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Require 2FA for all users or specific roles
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Shield className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Session Management</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Configure session timeout and concurrent login settings
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Eye className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Access Logs</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                View login attempts and security events
              </p>
            </div>
          </div>
        </div>
      </div>

      <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
        <p className="text-sm text-gray-500 dark:text-gray-400">
          Security settings are managed through Supabase. Advanced configuration coming soon.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/admin/users/page.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useOrg } from '@/hooks/useOrg';
import { OrgGuard } from '@/components/OrgGuard';
import { supabase } from '@/lib/supabaseClient';
import { DataState, useDataState } from '@/components/DataState';
import { apiGet, apiPost } from '@/lib/apiClient';
import { 
  Users, 
  UserPlus, 
  Shield, 
  UserX,
  Loader2,
  Mail,
  Clock,
  Check,
  X
} from 'lucide-react';

interface Member {
  user_id: string;
  role: 'admin' | 'hr' | 'manager' | 'user';
  status: 'active' | 'disabled';
  created_at: string;
  email?: string | null;
}

interface Invite {
  id: string;
  email: string;
  role: string;
  created_at: string;
  expires_at: string;
  accepted_at: string | null;
}

interface ApiError {
  message: string;
  code?: string;
  hint?: string;
}

function AdminUsersContent() {
  const { currentOrg, isAdmin } = useOrg();
  const [members, setMembers] = useState<Member[]>([]);
  const [invites, setInvites] = useState<Invite[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<ApiError | null>(null);
  
  const [showInvite, setShowInvite] = useState(false);
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteRole, setInviteRole] = useState<'admin' | 'hr' | 'manager' | 'user'>('user');
  const [inviting, setInviting] = useState(false);
  const [inviteError, setInviteError] = useState<string | null>(null);

  const [changingRole, setChangingRole] = useState<string | null>(null);

  const fetchData = useCallback(async () => {
    if (!currentOrg) return;
    
    setLoading(true);
    setError(null);

    try {
      const data = await apiGet<{ members: Member[]; invites: Invite[] }>(`/api/admin/members?orgId=${currentOrg.id}`);
      setMembers(data.members || []);
      setInvites(data.invites || []);
    } catch (err) {
      console.error('Fetch error:', err);
      const apiError = { 
        message: err instanceof Error ? err.message : 'Failed to load members',
        code: 'NETWORK_ERROR'
      };
      setError(apiError);
    } finally {
      setLoading(false);
    }
  }, [currentOrg]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const handleInvite = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!currentOrg) return;

    setInviting(true);
    setInviteError(null);

    try {
      await apiPost('/api/admin/invite', {
        orgId: currentOrg.id,
        email: inviteEmail,
        role: inviteRole,
      });

      setInviteEmail('');
      setInviteRole('user');
      setShowInvite(false);
      await fetchData();
    } catch (err) {
      console.error('Invite error:', err);
      setInviteError(err instanceof Error ? err.message : 'Failed to send invite');
    } finally {
      setInviting(false);
    }
  };

  const handleRoleChange = async (userId: string, newRole: 'admin' | 'hr' | 'manager' | 'user') => {
    if (!currentOrg) return;

    setChangingRole(userId);

    try {
      await apiPost('/api/admin/membership/role', {
        orgId: currentOrg.id,
        userId,
        role: newRole,
      });
      await fetchData();
    } catch (err) {
      console.error('Role change error:', err);
    } finally {
      setChangingRole(null);
    }
  };

  const handleDisable = async (userId: string) => {
    if (!currentOrg) return;
    if (!confirm('Are you sure you want to disable this user?')) return;

    try {
      await apiPost('/api/admin/membership/disable', {
        orgId: currentOrg.id,
        userId,
      });
      await fetchData();
    } catch (err) {
      console.error('Disable error:', err);
    }
  };

  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  const dataStatus = useDataState(members, loading, error);

  return (
    <div className="p-6 max-w-6xl mx-auto space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-semibold text-foreground" data-testid="text-page-title">
            User Management
          </h1>
          <p className="text-muted-foreground mt-1">
            Manage members and invites for {currentOrg?.name}
          </p>
        </div>
        {isAdmin && dataStatus !== 'error' && (
          <button
            onClick={() => setShowInvite(!showInvite)}
            className="px-4 py-2 rounded-md bg-primary text-primary-foreground flex items-center gap-2"
            data-testid="button-invite-user"
          >
            <UserPlus className="w-4 h-4" />
            Invite User
          </button>
        )}
      </div>

      {showInvite && (
        <div className="p-4 rounded-lg border border-border bg-card">
          {inviteError && (
            <div className="mb-4 p-3 rounded-md bg-destructive/10 text-destructive text-sm">
              {inviteError}
            </div>
          )}
          <form onSubmit={handleInvite} className="flex flex-wrap gap-4 items-end">
            <div className="flex-1 min-w-[200px]">
              <label htmlFor="invite-email" className="block text-sm font-medium text-foreground mb-1">
                Email Address
              </label>
              <input
                id="invite-email"
                type="email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                placeholder="user@example.com"
                className="w-full px-3 py-2 rounded-md border border-input bg-background text-foreground"
                required
                data-testid="input-invite-email"
              />
            </div>
            <div className="w-40">
              <label htmlFor="invite-role" className="block text-sm font-medium text-foreground mb-1">
                Role
              </label>
              <select
                id="invite-role"
                value={inviteRole}
                onChange={(e) => setInviteRole(e.target.value as typeof inviteRole)}
                className="w-full px-3 py-2 rounded-md border border-input bg-background text-foreground"
                data-testid="select-invite-role"
              >
                <option value="user">User</option>
                <option value="manager">Manager</option>
                <option value="hr">HR</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div className="flex gap-2">
              <button
                type="button"
                onClick={() => setShowInvite(false)}
                className="px-4 py-2 rounded-md border border-border text-foreground"
                data-testid="button-cancel-invite"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={inviting}
                className="px-4 py-2 rounded-md bg-primary text-primary-foreground disabled:opacity-50 flex items-center gap-2"
                data-testid="button-send-invite"
              >
                {inviting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Mail className="w-4 h-4" />}
                Send Invite
              </button>
            </div>
          </form>
        </div>
      )}

      <DataState
        status={dataStatus}
        error={error}
        onRetry={fetchData}
        emptyTitle="No members yet"
        emptyMessage="Invite users to join your organization."
        emptyIcon={<Users className="w-8 h-8 text-muted-foreground" />}
        emptyCta={{
          label: 'Invite User',
          onClick: () => setShowInvite(true),
        }}
      >
        <>
          {invites.length > 0 && (
            <div className="rounded-lg border border-border bg-card">
              <div className="p-4 border-b border-border">
                <h2 className="font-medium text-foreground flex items-center gap-2">
                  <Clock className="w-4 h-4" />
                  Pending Invites ({invites.length})
                </h2>
              </div>
              <div className="divide-y divide-border">
                {invites.map((invite) => (
                  <div key={invite.id} className="p-4 flex items-center justify-between" data-testid={`row-invite-${invite.id}`}>
                    <div>
                      <div className="text-foreground">{invite.email}</div>
                      <div className="text-sm text-muted-foreground">
                        Invited as {invite.role} - Expires {formatDate(invite.expires_at)}
                      </div>
                    </div>
                    <span className="px-2 py-1 rounded text-xs bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200">
                      Pending
                    </span>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="rounded-lg border border-border bg-card">
            <div className="p-4 border-b border-border">
              <h2 className="font-medium text-foreground flex items-center gap-2">
                <Users className="w-4 h-4" />
                Members ({members.filter(m => m.status === 'active').length})
              </h2>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-border bg-muted/50">
                    <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Email</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Role</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Status</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Joined</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-muted-foreground">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-border">
                  {members.map((member) => (
                    <tr key={member.user_id} className="hover:bg-muted/30" data-testid={`row-member-${member.user_id}`}>
                      <td className="px-4 py-3 text-foreground">
                        {member.email || 'Unknown'}
                      </td>
                      <td className="px-4 py-3">
                        {isAdmin && changingRole !== member.user_id ? (
                          <select
                            value={member.role}
                            onChange={(e) => handleRoleChange(member.user_id, e.target.value as typeof member.role)}
                            className="px-2 py-1 rounded border border-input bg-background text-foreground text-sm"
                            data-testid={`select-role-${member.user_id}`}
                          >
                            <option value="user">User</option>
                            <option value="manager">Manager</option>
                            <option value="hr">HR</option>
                            <option value="admin">Admin</option>
                          </select>
                        ) : changingRole === member.user_id ? (
                          <Loader2 className="w-4 h-4 animate-spin text-muted-foreground" />
                        ) : (
                          <span className="capitalize">{member.role}</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {member.status === 'active' ? (
                          <span className="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                            <Check className="w-3 h-3" />
                            Active
                          </span>
                        ) : (
                          <span className="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                            <X className="w-3 h-3" />
                            Disabled
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-muted-foreground text-sm">
                        {formatDate(member.created_at)}
                      </td>
                      <td className="px-4 py-3 text-right">
                        {isAdmin && member.status === 'active' && (
                          <button
                            onClick={() => handleDisable(member.user_id)}
                            className="p-2 rounded text-muted-foreground hover:text-destructive"
                            title="Disable user"
                            data-testid={`button-disable-${member.user_id}`}
                          >
                            <UserX className="w-4 h-4" />
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </>
      </DataState>
    </div>
  );
}

export default function AdminUsersPage() {
  return (
    <OrgGuard requireAdmin>
      <AdminUsersContent />
    </OrgGuard>
  );
}
</file>

<file path="app/admin/page.tsx">
"use client";

import Link from "next/link";
import { useProfile } from "@/hooks/useProfile";
import { 
  Wrench, 
  Briefcase, 
  Users, 
  Shield, 
  Settings,
  ChevronRight,
  AlertCircle,
  Building2,
  ClipboardList
} from "lucide-react";

interface AdminCard {
  title: string;
  description: string;
  href: string;
  icon: React.ComponentType<{ className?: string }>;
}

const adminCards: AdminCard[] = [
  {
    title: "Organizations",
    description: "Create and manage organizations. Switch between organizations.",
    href: "/app/org/select",
    icon: Building2,
  },
  {
    title: "User Management",
    description: "Invite users, manage roles, and control team access.",
    href: "/app/admin/users",
    icon: Users,
  },
  {
    title: "Audit Log",
    description: "View activity history and track admin actions.",
    href: "/app/admin/audit",
    icon: ClipboardList,
  },
  {
    title: "Competence Admin",
    description: "Manage competence groups and competences used in matrices and gap analysis.",
    href: "/admin/competence",
    icon: Wrench,
  },
  {
    title: "Positions Admin",
    description: "Configure positions and their competence requirements.",
    href: "/admin/positions",
    icon: Briefcase,
  },
  {
    title: "Security Settings",
    description: "Configure authentication and access control policies.",
    href: "/app/admin/security",
    icon: Shield,
  },
  {
    title: "System Settings",
    description: "Configure platform-wide settings and integrations.",
    href: "/app/admin/settings",
    icon: Settings,
  },
];

export default function AdminDashboard() {
  const { profile, loading } = useProfile();

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse">
          <div className="h-8 w-48 bg-gray-200 dark:bg-gray-700 rounded mb-4" />
          <div className="h-4 w-96 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  const isAdmin = profile?.role === "admin";

  return (
    <div className="p-6 max-w-5xl mx-auto">
      <div className="mb-8">
        <h1 className="text-2xl font-semibold text-gray-900 dark:text-white mb-2">
          Admin Dashboard
        </h1>
        <p className="text-gray-600 dark:text-gray-400">
          Manage platform configuration and settings.
        </p>
      </div>

      {!isAdmin && (
        <div className="mb-6 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg flex items-start gap-3">
          <AlertCircle className="w-5 h-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5" />
          <div>
            <p className="text-sm font-medium text-amber-800 dark:text-amber-200">
              Limited Access
            </p>
            <p className="text-sm text-amber-700 dark:text-amber-300 mt-1">
              You are viewing this page but may not have full admin privileges.
              Contact an administrator if you need elevated access.
            </p>
          </div>
        </div>
      )}

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {adminCards.map((card) => {
          const Icon = card.icon;
          return (
            <Link
              key={card.href}
              href={card.href}
              className="group block p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:border-gray-300 dark:hover:border-gray-600 transition-colors"
              data-testid={`card-${card.title.toLowerCase().replace(/\s+/g, "-")}`}
            >
              <div className="flex items-start justify-between">
                <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                  <Icon className="w-5 h-5 text-gray-600 dark:text-gray-300" />
                </div>
                <ChevronRight className="w-4 h-4 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors" />
              </div>
              <h3 className="mt-4 text-base font-medium text-gray-900 dark:text-white">
                {card.title}
              </h3>
              <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">
                {card.description}
              </p>
            </Link>
          );
        })}
      </div>

      {profile && (
        <div className="mt-8 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
          <p className="text-sm text-gray-500 dark:text-gray-400">
            Signed in as{" "}
            <span className="font-medium text-gray-700 dark:text-gray-300">
              {profile.email}
            </span>
            {" "}with role{" "}
            <span className="font-mono text-xs bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded">
              {profile.role || "not set"}
            </span>
          </p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/billing/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Check, CreditCard } from "lucide-react";
import { getCurrentUser, type CurrentUser } from "@/lib/auth";
import { pricingConfig, calculateYearlyCost, type PlanId } from "@/lib/pricing";
import { supabase } from "@/lib/supabaseClient";

export default function BillingPage() {
  const [user, setUser] = useState<CurrentUser | null>(null);
  const [headcount, setHeadcount] = useState(0);
  const [loading, setLoading] = useState(true);

  const currentPlan: PlanId = "enterprise";

  useEffect(() => {
    async function loadData() {
      const [userData, headcountRes] = await Promise.all([
        getCurrentUser(),
        supabase.from("employees").select("id", { count: "exact", head: true }).eq("is_active", true),
      ]);
      setUser(userData);
      setHeadcount(headcountRes.count || 0);
      setLoading(false);
    }
    loadData();
  }, []);

  if (loading) {
    return (
      <div className="p-8">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  if (user?.role !== "HR_ADMIN") {
    return (
      <div className="p-8">
        <Card>
          <CardContent className="pt-6">
            <div className="text-center py-12">
              <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">Access Denied</h2>
              <p className="text-gray-500 dark:text-gray-400">Only HR administrators can access billing settings.</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const plan = pricingConfig[currentPlan];
  const yearlyCost = calculateYearlyCost(currentPlan, headcount);
  const monthlyCost = Math.round(yearlyCost / 12);
  const perEmployeeCost = headcount > 0 ? Math.round(yearlyCost / headcount / 12) : 0;

  return (
    <div className="p-8 max-w-4xl" data-testid="billing-page">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Billing</h1>
        <p className="text-gray-500 dark:text-gray-400 mt-1">Manage your subscription and billing details</p>
      </div>

      <div className="grid gap-6">
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <CreditCard className="h-5 w-5 text-gray-400" />
                <CardTitle>Current Plan</CardTitle>
              </div>
              <Badge variant="default" data-testid="badge-current-plan">
                {currentPlan.charAt(0).toUpperCase() + currentPlan.slice(1)}
              </Badge>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">Active Employees</p>
                <p className="text-2xl font-bold text-gray-900 dark:text-white" data-testid="text-headcount">{headcount}</p>
              </div>
              <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">Estimated Yearly Cost</p>
                <p className="text-2xl font-bold text-gray-900 dark:text-white" data-testid="text-yearly-cost">{yearlyCost.toLocaleString()} SEK</p>
              </div>
              <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">Per Employee / Month</p>
                <p className="text-2xl font-bold text-gray-900 dark:text-white" data-testid="text-per-employee">{perEmployeeCost} SEK</p>
              </div>
            </div>

            <div className="border-t border-gray-200 dark:border-gray-700 pt-6">
              <h3 className="text-sm font-medium text-gray-900 dark:text-white mb-4">Included Features</h3>
              <ul className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {plan.features.map((feature, index) => (
                  <li key={index} className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                    <Check className="h-4 w-4 text-green-500" />
                    {feature}
                  </li>
                ))}
              </ul>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Billing Details</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
              <p className="text-sm text-blue-800 dark:text-blue-200">
                Billing is currently handled manually. For invoices, payment questions, or plan changes, 
                please contact your account representative or email billing@industrialcompetence.app.
              </p>
            </div>

            <div className="mt-6 space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <span className="text-sm text-gray-600 dark:text-gray-300">Billing Cycle</span>
                <span className="text-sm font-medium text-gray-900 dark:text-white">Annual</span>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <span className="text-sm text-gray-600 dark:text-gray-300">Base Fee</span>
                <span className="text-sm font-medium text-gray-900 dark:text-white">{plan.baseYearlySEK.toLocaleString()} SEK / year</span>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <span className="text-sm text-gray-600 dark:text-gray-300">Per Employee (after {plan.maxIncludedEmployees})</span>
                <span className="text-sm font-medium text-gray-900 dark:text-white">{plan.perEmployeeMonthlySEK} SEK / month</span>
              </div>
              <div className="flex items-center justify-between py-3">
                <span className="text-sm font-medium text-gray-900 dark:text-white">Estimated Monthly Total</span>
                <span className="text-lg font-bold text-gray-900 dark:text-white">{monthlyCost.toLocaleString()} SEK</span>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="app/cockpit/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { format } from "date-fns";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { CalendarDays } from "lucide-react";
import { PriorityFixesWidget } from "@/components/cockpit/PriorityFixesWidget";
import { ActionsWidget } from "@/components/cockpit/ActionsWidget";
import { StaffingWidget } from "@/components/cockpit/StaffingWidget";
import { ComplianceWidget } from "@/components/cockpit/ComplianceWidget";
import { SafetyWidget } from "@/components/cockpit/SafetyWidget";
import { PlanActualWidget } from "@/components/cockpit/PlanActualWidget";
import { HandoverWidget } from "@/components/cockpit/HandoverWidget";
import { ActionDrawer } from "@/components/cockpit/ActionDrawer";
import { StaffingSuggestModal } from "@/components/cockpit/StaffingSuggestModal";
import { isDemoMode } from "@/lib/demoRuntime";
import {
  DEMO_ACTIONS,
  DEMO_COMPLIANCE,
  DEMO_SAFETY_OBSERVATIONS,
  DEMO_SHIFTS,
  DEMO_STATIONS,
  DEMO_EMPLOYEES_COCKPIT,
  getDemoStaffingCards,
  getDemoCockpitMetrics,
  getDemoPlanVsActual,
  getDemoPriorityItems,
  getDemoActivityLog,
  getDemoEmployeeSuggestions,
  getDemoHandoverItems,
} from "@/lib/cockpitDemo";
import type {
  Action,
  ComplianceItem,
  SafetyObservation,
  Shift,
  Station,
  StationStaffingCard,
  CockpitMetrics,
  PlanVsActual,
  PriorityItem,
  ActivityLogEntry,
  EmployeeSuggestion,
  HandoverItem,
} from "@/types/cockpit";
import { useToast } from "@/hooks/use-toast";

function CockpitSkeleton() {
  return (
    <div className="p-6 max-w-[1600px] mx-auto animate-pulse">
      <div className="h-8 w-48 bg-muted rounded mb-2" />
      <div className="h-4 w-32 bg-muted rounded mb-6" />
      <div className="h-32 bg-muted rounded-lg mb-6" />
      <div className="grid grid-cols-4 gap-4 mb-6">
        {[1, 2, 3, 4].map(i => (
          <div key={i} className="h-24 bg-muted rounded-lg" />
        ))}
      </div>
      <div className="grid grid-cols-12 gap-6">
        <div className="col-span-4 h-64 bg-muted rounded-lg" />
        <div className="col-span-8 h-64 bg-muted rounded-lg" />
      </div>
    </div>
  );
}

export default function CockpitPage() {
  const { toast } = useToast();
  const [isDemo, setIsDemo] = useState(false);
  const [selectedShift, setSelectedShift] = useState("shift-day");
  const [selectedLine, setSelectedLine] = useState("all");
  
  const [actions, setActions] = useState<Action[]>([]);
  const [staffingCards, setStaffingCards] = useState<StationStaffingCard[]>([]);
  const [complianceItems, setComplianceItems] = useState<ComplianceItem[]>([]);
  const [safetyObservations, setSafetyObservations] = useState<SafetyObservation[]>([]);
  const [shifts, setShifts] = useState<Shift[]>([]);
  const [metrics, setMetrics] = useState<CockpitMetrics | null>(null);
  const [planVsActual, setPlanVsActual] = useState<PlanVsActual[]>([]);
  const [priorityItems, setPriorityItems] = useState<PriorityItem[]>([]);
  const [handoverData, setHandoverData] = useState<{ openLoops: HandoverItem[]; decisions: HandoverItem[]; risks: HandoverItem[] }>({ openLoops: [], decisions: [], risks: [] });
  const [loading, setLoading] = useState(true);

  const [selectedAction, setSelectedAction] = useState<Action | null>(null);
  const [actionDrawerOpen, setActionDrawerOpen] = useState(false);
  const [activityLog, setActivityLog] = useState<ActivityLogEntry[]>([]);

  const [selectedStation, setSelectedStation] = useState<Station | null>(null);
  const [suggestModalOpen, setSuggestModalOpen] = useState(false);
  const [suggestions, setSuggestions] = useState<EmployeeSuggestion[]>([]);

  useEffect(() => {
    const demo = isDemoMode();
    setIsDemo(demo);
    
    if (demo) {
      setTimeout(() => {
        setActions(DEMO_ACTIONS.filter(a => a.status === "open"));
        setStaffingCards(getDemoStaffingCards());
        setComplianceItems(DEMO_COMPLIANCE.filter(c => c.status === "expired" || c.status === "expiring_soon"));
        setSafetyObservations(DEMO_SAFETY_OBSERVATIONS);
        setShifts(DEMO_SHIFTS);
        setMetrics(getDemoCockpitMetrics());
        setPlanVsActual(getDemoPlanVsActual());
        setPriorityItems(getDemoPriorityItems());
        setHandoverData(getDemoHandoverItems());
        setLoading(false);
      }, 300);
    } else {
      setLoading(false);
    }
  }, []);

  const openActionDrawer = (action: Action) => {
    setSelectedAction(action);
    setActivityLog(getDemoActivityLog(action.id));
    setActionDrawerOpen(true);
  };

  const handleMarkActionDone = (actionId: string) => {
    setActions(prev => prev.filter(a => a.id !== actionId));
    setPriorityItems(prev => prev.filter(p => p.actionId !== actionId));
    setActionDrawerOpen(false);
    toast({ title: "Action completed", description: "The action has been marked as done." });
  };

  const handleReassign = (actionId: string, newOwnerId: string, newOwnerName: string) => {
    setActions(prev => prev.map(a => 
      a.id === actionId ? { ...a, ownerId: newOwnerId, ownerName: newOwnerName } : a
    ));
    setActivityLog(prev => [{
      id: `log-${Date.now()}`,
      actionId,
      type: "reassigned",
      description: `Reassigned to ${newOwnerName}`,
      userName: "You",
      createdAt: new Date().toISOString(),
    }, ...prev]);
    toast({ title: "Action reassigned", description: `Assigned to ${newOwnerName}` });
  };

  const handleChangeDueDate = (actionId: string, newDate: string) => {
    setActions(prev => prev.map(a => 
      a.id === actionId ? { ...a, dueDate: newDate } : a
    ));
    setActivityLog(prev => [{
      id: `log-${Date.now()}`,
      actionId,
      type: "due_date_changed",
      description: `Due date changed to ${format(new Date(newDate), "MMM d, yyyy")}`,
      userName: "You",
      createdAt: new Date().toISOString(),
    }, ...prev]);
    toast({ title: "Due date updated" });
  };

  const handleResolvePriority = (item: PriorityItem) => {
    const action = actions.find(a => 
      (item.type === 'staffing' && a.relatedStationId === item.linkedEntity?.id) ||
      (item.type === 'compliance' && a.relatedEmployeeId === item.linkedEntity?.id) ||
      (item.type === 'safety' && a.id === item.actionId)
    );
    
    if (action) {
      openActionDrawer(action);
    } else if (item.type === 'staffing' && item.linkedEntity) {
      const station = DEMO_STATIONS.find(s => s.id === item.linkedEntity?.id);
      if (station) {
        handleSuggestReplacement(station.id);
      }
    } else {
      toast({ title: "Opening resolution...", description: item.title });
    }
  };

  const handleSuggestReplacement = (stationId: string) => {
    const station = DEMO_STATIONS.find(s => s.id === stationId);
    if (station) {
      setSelectedStation(station);
      setSuggestions(getDemoEmployeeSuggestions(stationId));
      setSuggestModalOpen(true);
    }
  };

  const handleApplySuggestion = (stationId: string, employeeId: string, employeeName: string) => {
    setStaffingCards(prev => prev.map(card => {
      if (card.station.id === stationId) {
        return {
          ...card,
          assignment: card.assignment ? { ...card.assignment, employeeId, employeeName, status: "assigned" as const } : undefined,
          employee: { id: employeeId, name: employeeName },
          complianceStatus: "green" as const,
        };
      }
      return card;
    }));
    setPriorityItems(prev => prev.filter(p => p.linkedEntity?.id !== stationId || p.type !== 'staffing'));
    setSuggestModalOpen(false);
    toast({ title: "Assignment updated", description: `${employeeName} assigned to ${selectedStation?.name}` });
  };

  const handleCreateComplianceAction = (item: ComplianceItem) => {
    toast({ title: "Action created", description: `Renewal action created for ${item.employeeName}'s ${item.title}` });
  };

  const handleCreateObservation = () => {
    toast({ title: "Report observation", description: "Safety observation form would open here." });
  };

  const handleGenerateHandover = () => {
    toast({ title: "Handover report generated", description: "PDF ready for download" });
  };

  const today = format(new Date(), "EEEE, MMMM d, yyyy");

  const filteredStaffingCards = selectedLine === "all"
    ? staffingCards
    : staffingCards.filter(c => c.station.line === selectedLine);

  const lines = [...new Set(staffingCards.map(c => c.station.line).filter(Boolean))];

  if (loading) {
    return <CockpitSkeleton />;
  }

  return (
    <div className="p-4 sm:p-6 max-w-[1600px] mx-auto">
      <header className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
        <div>
          <h1 className="text-2xl font-bold tracking-tight text-foreground" data-testid="heading-cockpit">
            Today
          </h1>
          <p className="text-muted-foreground flex items-center gap-2 mt-1 text-sm">
            <CalendarDays className="h-4 w-4" />
            {today}
          </p>
        </div>

        <div className="flex items-center gap-2">
          <Select value={selectedShift} onValueChange={setSelectedShift}>
            <SelectTrigger className="w-[130px]" data-testid="select-shift">
              <SelectValue placeholder="Shift" />
            </SelectTrigger>
            <SelectContent>
              {shifts.map((shift) => (
                <SelectItem key={shift.id} value={shift.id}>
                  {shift.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          <Select value={selectedLine} onValueChange={setSelectedLine}>
            <SelectTrigger className="w-[130px]" data-testid="select-line">
              <SelectValue placeholder="Line" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Lines</SelectItem>
              {lines.map((line) => (
                <SelectItem key={line} value={line as string}>
                  {line}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </header>

      <div className="mb-6">
        <PriorityFixesWidget
          items={priorityItems}
          onResolve={handleResolvePriority}
        />
      </div>

      {metrics && (
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
          <div className="bg-card border rounded-lg p-4">
            <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Open Actions</p>
            <div className="flex items-baseline gap-2 mt-1">
              <p className="text-2xl font-bold tabular-nums">{metrics.openActions}</p>
              {metrics.criticalActions > 0 && (
                <Badge variant="destructive" className="text-[10px]">
                  {metrics.criticalActions} critical
                </Badge>
              )}
            </div>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Staffing</p>
            <div className="flex items-baseline gap-1 mt-1">
              <p className="text-2xl font-bold tabular-nums">{metrics.staffedStations}</p>
              <p className="text-lg text-muted-foreground">/ {metrics.totalStations}</p>
            </div>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Compliance</p>
            <div className="flex items-baseline gap-2 mt-1">
              <p className="text-2xl font-bold tabular-nums text-orange-500">{metrics.expiringCompliance + metrics.overdueCompliance}</p>
              <span className="text-xs text-muted-foreground">
                {metrics.overdueCompliance} overdue
              </span>
            </div>
          </div>
          <div className="bg-card border rounded-lg p-4">
            <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Safety</p>
            <div className="flex items-baseline gap-2 mt-1">
              <p className="text-2xl font-bold tabular-nums">{metrics.safetyObservationsThisWeek}</p>
              <span className="text-xs text-muted-foreground">this week</span>
            </div>
          </div>
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6">
        <div className="lg:col-span-4 space-y-4 lg:space-y-6">
          <ActionsWidget
            actions={actions}
            onMarkDone={handleMarkActionDone}
            onActionClick={openActionDrawer}
          />
          <HandoverWidget
            openLoops={handoverData.openLoops}
            decisions={handoverData.decisions}
            risks={handoverData.risks}
            onGenerateHandover={handleGenerateHandover}
          />
        </div>

        <div className="lg:col-span-8 space-y-4 lg:space-y-6">
          <StaffingWidget
            staffingCards={filteredStaffingCards}
            onSuggestReplacement={handleSuggestReplacement}
          />

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <ComplianceWidget
              items={complianceItems}
              onCreateAction={handleCreateComplianceAction}
            />
            <SafetyWidget
              observations={safetyObservations}
              openActionsCount={metrics?.openSafetyActions || 0}
              onCreateObservation={handleCreateObservation}
            />
            <PlanActualWidget data={planVsActual} />
          </div>
        </div>
      </div>

      <ActionDrawer
        action={selectedAction}
        open={actionDrawerOpen}
        onClose={() => setActionDrawerOpen(false)}
        onMarkDone={handleMarkActionDone}
        onReassign={handleReassign}
        onChangeDueDate={handleChangeDueDate}
        activityLog={activityLog}
        availableOwners={DEMO_EMPLOYEES_COCKPIT}
      />

      <StaffingSuggestModal
        station={selectedStation}
        open={suggestModalOpen}
        onClose={() => setSuggestModalOpen(false)}
        suggestions={suggestions}
        onApply={handleApplySuggestion}
      />
    </div>
  );
}
</file>

<file path="app/competence-matrix/page.tsx">
import type { CompetenceLevel } from "@/types/domain";
import { seedDemoDataIfEmpty, getEmployeesWithSkills, getFilterOptions } from "@/services/competenceService";
import { ExportCSVButton } from "@/components/ExportCSVButton";

export const dynamic = "force-dynamic";

const competenceLevels: CompetenceLevel[] = [
  { value: 0, label: "None", description: "No experience or training" },
  { value: 1, label: "Basic", description: "Theoretical knowledge, needs supervision" },
  { value: 2, label: "Intermediate", description: "Can perform with occasional guidance" },
  { value: 3, label: "Advanced", description: "Fully independent, can train others" },
  { value: 4, label: "Expert", description: "Subject matter expert, defines standards" },
];

function getLevelColor(level: CompetenceLevel["value"]): string {
  switch (level) {
    case 0:
      return "bg-gray-200 dark:bg-gray-600";
    case 1:
      return "bg-red-400 dark:bg-red-600";
    case 2:
      return "bg-yellow-400 dark:bg-yellow-500";
    case 3:
      return "bg-green-300 dark:bg-green-500";
    case 4:
      return "bg-green-600 dark:bg-green-700";
    default:
      return "bg-gray-200 dark:bg-gray-600";
  }
}

interface PageProps {
  searchParams: Promise<{ line?: string; team?: string }>;
}

export default async function CompetenceMatrixPage({ searchParams }: PageProps) {
  const params = await searchParams;
  const selectedLine = params.line || "";
  const selectedTeam = params.team || "";

  await seedDemoDataIfEmpty();
  
  const [{ employees, skills, employeeSkills }, filterOptions] = await Promise.all([
    getEmployeesWithSkills({
      line: selectedLine || undefined,
      team: selectedTeam || undefined,
    }),
    getFilterOptions(),
  ]);

  function getSkillLevel(employeeId: string, skillId: string): CompetenceLevel["value"] {
    const found = employeeSkills.find(
      (es) => es.employeeId === employeeId && es.skillId === skillId
    );
    return found ? found.level : 0;
  }

  return (
    <div>
      <div className="flex items-center justify-between mb-6 gap-4 flex-wrap">
        <h1 className="text-2xl font-bold text-gray-900 dark:text-white" data-testid="heading-competence-matrix">
          Competence Matrix
        </h1>
        <div className="flex items-center gap-2">
          <a
            href="/app/admin/competence"
            className="px-4 py-2 text-sm font-medium border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
            data-testid="button-edit-requirements"
          >
            Edit Requirements
          </a>
          <ExportCSVButton
            headers={["Employee", ...skills.map(s => s.code)]}
            rows={employees.map(emp => [
              emp.name,
              ...skills.map(s => getSkillLevel(emp.id, s.id).toString())
            ])}
            filename={`competence-matrix-${new Date().toISOString().slice(0, 10)}.csv`}
          />
        </div>
      </div>

      <div className="mb-6 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 p-4">
        <h2 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
          Filters
        </h2>
        <form method="GET" className="flex flex-wrap items-end gap-4">
          <div>
            <label
              htmlFor="line-filter"
              className="block text-xs text-gray-500 dark:text-gray-400 mb-1"
            >
              Line
            </label>
            <select
              id="line-filter"
              name="line"
              defaultValue={selectedLine}
              className="block w-40 px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              data-testid="select-line-filter"
            >
              <option value="">All Lines</option>
              {filterOptions.lines.map((line) => (
                <option key={line} value={line}>
                  {line}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label
              htmlFor="team-filter"
              className="block text-xs text-gray-500 dark:text-gray-400 mb-1"
            >
              Team
            </label>
            <select
              id="team-filter"
              name="team"
              defaultValue={selectedTeam}
              className="block w-40 px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              data-testid="select-team-filter"
            >
              <option value="">All Teams</option>
              {filterOptions.teams.map((team) => (
                <option key={team} value={team}>
                  {team}
                </option>
              ))}
            </select>
          </div>

          <button
            type="submit"
            className="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            data-testid="button-apply-filters"
          >
            Apply Filters
          </button>

          {(selectedLine || selectedTeam) && (
            <a
              href="/app/competence-matrix"
              className="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors"
              data-testid="link-clear-filters"
            >
              Clear Filters
            </a>
          )}
        </form>
      </div>

      <div className="mb-6 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 p-4">
        <h2 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
          Legend
        </h2>
        <div className="flex flex-wrap gap-4">
          {competenceLevels.map((level) => (
            <div key={level.value} className="flex items-center gap-2">
              <div
                className={`w-6 h-6 rounded ${getLevelColor(level.value)}`}
                data-testid={`legend-level-${level.value}`}
              />
              <div className="text-sm">
                <span className="font-medium text-gray-900 dark:text-white">
                  {level.value} - {level.label}
                </span>
                <span className="text-gray-500 dark:text-gray-400 ml-1">
                  ({level.description})
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full" data-testid="competence-matrix-table">
            <thead>
              <tr className="border-b border-gray-200 dark:border-gray-700">
                <th className="text-left p-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50">
                  Employee
                </th>
                {skills.map((skill) => (
                  <th
                    key={skill.id}
                    className="text-center p-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700/50 min-w-[100px]"
                  >
                    <div>{skill.code}</div>
                    <div className="text-xs font-normal text-gray-500 dark:text-gray-400">
                      {skill.name}
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {employees.length === 0 ? (
                <tr>
                  <td
                    colSpan={skills.length + 1}
                    className="p-6 text-center text-gray-500 dark:text-gray-400"
                    data-testid="no-results-message"
                  >
                    No employees match the selected filters.
                  </td>
                </tr>
              ) : (
                employees.map((employee, index) => (
                  <tr
                    key={employee.id}
                    className={
                      index < employees.length - 1
                        ? "border-b border-gray-200 dark:border-gray-700"
                        : ""
                    }
                    data-testid={`row-employee-${employee.id}`}
                  >
                    <td className="p-3">
                      <div className="text-sm font-medium text-gray-900 dark:text-white">
                        {employee.name}
                      </div>
                      <div className="text-xs text-gray-500 dark:text-gray-400">
                        {employee.role} - {employee.team}
                      </div>
                    </td>
                    {skills.map((skill) => {
                      const level = getSkillLevel(employee.id, skill.id);
                      return (
                        <td key={skill.id} className="p-3 text-center">
                          <div
                            className={`inline-flex items-center justify-center w-8 h-8 rounded text-sm font-medium text-gray-900 dark:text-white ${getLevelColor(level)}`}
                            data-testid={`cell-${employee.id}-${skill.id}`}
                          >
                            {level}
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { getCurrentUser, type CurrentUser } from "@/lib/auth";
import { HrDashboard } from "@/components/dashboard/HrDashboard";
import { ManagerDashboard } from "@/components/dashboard/ManagerDashboard";
import { EmployeeDashboard } from "@/components/dashboard/EmployeeDashboard";

export default function DashboardPage() {
  const [user, setUser] = useState<CurrentUser | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    getCurrentUser().then((u) => {
      setUser(u);
      setLoading(false);
    });
  }, []);

  if (loading) {
    return (
      <div className="p-8">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-32 bg-gray-200 dark:bg-gray-700 rounded" />
            ))}
          </div>
        </div>
      </div>
    );
  }

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
  };

  const getRoleLabel = () => {
    switch (user?.role) {
      case "HR_ADMIN":
        return "HR Administrator";
      case "MANAGER":
        return "Manager";
      case "EMPLOYEE":
        return "Employee";
      default:
        return "";
    }
  };

  return (
    <div className="p-8" data-testid="dashboard-page">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 dark:text-white">
          {getGreeting()}
        </h1>
        <p className="text-gray-500 dark:text-gray-400 mt-1">
          {getRoleLabel()} Dashboard
        </p>
      </div>

      {user?.role === "HR_ADMIN" && <HrDashboard />}
      {user?.role === "MANAGER" && <ManagerDashboard user={user} />}
      {user?.role === "EMPLOYEE" && <EmployeeDashboard user={user} />}
      {!user?.role && (
        <div className="text-center py-12 text-gray-500 dark:text-gray-400">
          Unable to determine user role. Please contact support.
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/debug/page.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useOrg } from '@/hooks/useOrg';
import { useAuth } from '@/hooks/useAuth';
import { supabase } from '@/lib/supabaseClient';
import { isDemoMode, DEMO_EMPLOYEES, DEMO_ORG_UNITS, DEMO_SKILLS, DEMO_POSITIONS } from '@/lib/demoData';
import { subscribe, getState, setFlag, clearErrors, type DebugState, type DebugError } from '@/lib/debugStore';
import { safeCount } from '@/lib/supabaseSafe';
import { 
  Bug, 
  Copy, 
  Check, 
  Database, 
  User, 
  Building2, 
  AlertTriangle,
  RefreshCw,
  Loader2,
  Shield,
  Trash2,
  Radio,
  Clock,
  Search,
  Wrench,
  CheckCircle,
  XCircle
} from 'lucide-react';
import { apiGet, apiPost } from '@/lib/apiClient';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface Counts {
  employees: number | 'denied' | null;
  units: number | 'denied' | null;
  skills: number | 'denied' | null;
  positions: number | 'denied' | null;
}

interface SchemaCheckResult {
  tables: Record<string, { exists: boolean; hasOrgId: boolean; rlsEnabled: boolean | null }>;
  nullOrgIdCounts: Record<string, number>;
  errors: string[];
}

export default function DebugPage() {
  const { currentOrg, currentRole, memberships, isLoading: orgLoading, error: orgError } = useOrg();
  const { user: authUser, isAuthenticated } = useAuth();
  const [counts, setCounts] = useState<Counts>({ employees: null, units: null, skills: null, positions: null });
  const [loadingCounts, setLoadingCounts] = useState(false);
  const [copied, setCopied] = useState(false);
  const [debugState, setDebugState] = useState<DebugState>(getState());
  const [loadingStartTime, setLoadingStartTime] = useState<number | null>(null);
  const [schemaCheck, setSchemaCheck] = useState<SchemaCheckResult | null>(null);
  const [loadingSchema, setLoadingSchema] = useState(false);
  const [repairResult, setRepairResult] = useState<string | null>(null);
  const [repairing, setRepairing] = useState(false);

  useEffect(() => {
    const unsubscribe = subscribe((state) => {
      setDebugState(state);
    });
    return unsubscribe;
  }, []);

  useEffect(() => {
    if (orgLoading) {
      setLoadingStartTime(Date.now());
    } else {
      setLoadingStartTime(null);
      setFlag('loadingTimeout', false);
    }
  }, [orgLoading]);

  useEffect(() => {
    if (!loadingStartTime) return;
    
    const timeoutId = setTimeout(() => {
      if (orgLoading) {
        setFlag('loadingTimeout', true);
      }
    }, 5000);
    
    return () => clearTimeout(timeoutId);
  }, [loadingStartTime, orgLoading]);

  useEffect(() => {
    setFlag('orgMissing', !currentOrg && !orgLoading);
  }, [currentOrg, orgLoading]);

  const fetchCounts = useCallback(async () => {
    if (isDemoMode()) {
      setCounts({
        employees: DEMO_EMPLOYEES.length,
        units: DEMO_ORG_UNITS.length,
        skills: DEMO_SKILLS.length,
        positions: DEMO_POSITIONS.length,
      });
      return;
    }

    if (!currentOrg) {
      setCounts({ employees: null, units: null, skills: null, positions: null });
      return;
    }
    
    setLoadingCounts(true);
    try {
      const [employeesCount, unitsCount, skillsCount, positionsCount] = await Promise.all([
        safeCount(
          async () => await supabase.from('employees').select('id', { count: 'exact', head: true }).eq('org_id', currentOrg.id),
          'employees'
        ),
        safeCount(
          async () => await supabase.from('org_units').select('id', { count: 'exact', head: true }).eq('org_id', currentOrg.id),
          'org_units'
        ),
        safeCount(
          async () => await supabase.from('competences').select('id', { count: 'exact', head: true }),
          'competences (global)'
        ),
        safeCount(
          async () => await supabase.from('positions').select('id', { count: 'exact', head: true }),
          'positions (global)'
        ),
      ]);

      setCounts({
        employees: employeesCount,
        units: unitsCount,
        skills: skillsCount,
        positions: positionsCount,
      });
    } catch (err) {
      console.error('Error fetching counts:', err);
    } finally {
      setLoadingCounts(false);
    }
  }, [currentOrg]);

  useEffect(() => {
    fetchCounts();
  }, [fetchCounts]);

  const runSchemaCheck = useCallback(async () => {
    if (!currentOrg || isDemoMode()) return;
    
    setLoadingSchema(true);
    setSchemaCheck(null);
    
    try {
      const result = await apiGet<SchemaCheckResult>(`/api/debug/schema?orgId=${currentOrg.id}`);
      setSchemaCheck(result);
    } catch (err) {
      console.error('Schema check error:', err);
    } finally {
      setLoadingSchema(false);
    }
  }, [currentOrg]);

  const handleRepair = async (table: string, dryRun: boolean) => {
    if (!currentOrg) return;
    
    setRepairing(true);
    setRepairResult(null);
    
    try {
      const result = await apiPost<{ message: string; updatedCount?: number; nullCount?: number }>('/api/debug/repair-orgid', {
        orgId: currentOrg.id,
        table,
        dryRun,
      });
      setRepairResult(result.message);
      if (!dryRun) {
        await runSchemaCheck();
        await fetchCounts();
      }
    } catch (err) {
      setRepairResult(err instanceof Error ? err.message : 'Repair failed');
    } finally {
      setRepairing(false);
    }
  };

  const getOrgSource = () => {
    if (!currentOrg) return 'none';
    const stored = typeof window !== 'undefined' ? localStorage.getItem('nadiplan_current_org') : null;
    if (stored === currentOrg.id) return 'localStorage';
    if (memberships.length === 1) return 'auto-selected (single org)';
    return 'selected';
  };

  const generateReport = () => {
    const report = {
      timestamp: new Date().toISOString(),
      demoMode: isDemoMode(),
      user: {
        email: authUser?.email || 'not authenticated',
        id: authUser?.id || null,
        authenticated: isAuthenticated,
      },
      organization: {
        id: currentOrg?.id || null,
        name: currentOrg?.name || null,
        slug: currentOrg?.slug || null,
        source: getOrgSource(),
        role: currentRole,
      },
      memberships: memberships.map(m => ({
        orgId: m.org_id,
        orgName: m.organization?.name,
        role: m.role,
        status: m.status,
      })),
      counts,
      flags: debugState.flags,
      errors: debugState.errors.slice(0, 10),
      lastApiCalls: debugState.lastApiCalls,
      orgLoadingState: {
        isLoading: orgLoading,
        error: orgError,
      },
    };
    return JSON.stringify(report, null, 2);
  };

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(generateReport());
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const formatCountValue = (value: number | 'denied' | null): string => {
    if (value === 'denied') return 'Denied';
    if (value === null) return '-';
    return String(value);
  };

  const hasWarnings = debugState.flags.orgMissing || debugState.flags.rlsBlocked || debugState.flags.loadingTimeout || !currentRole;

  return (
    <div className="p-6 max-w-4xl mx-auto space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-semibold text-foreground flex items-center gap-2" data-testid="text-page-title">
            <Bug className="w-6 h-6" />
            Debug Cockpit
            <span className="ml-2 flex items-center gap-1 text-sm font-normal text-green-600">
              <Radio className="w-3 h-3 animate-pulse" />
              Live
            </span>
          </h1>
          <p className="text-muted-foreground mt-1">
            System state and diagnostics
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={() => clearErrors()} data-testid="button-clear-errors">
            <Trash2 className="w-4 h-4 mr-2" />
            Clear Errors
          </Button>
          <Button onClick={handleCopy} data-testid="button-copy-report">
            {copied ? <Check className="w-4 h-4 mr-2" /> : <Copy className="w-4 h-4 mr-2" />}
            {copied ? 'Copied!' : 'Copy Debug Report'}
          </Button>
        </div>
      </div>

      {hasWarnings && (
        <div className="p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 space-y-2">
          <p className="font-medium text-red-800 dark:text-red-200 flex items-center gap-2">
            <AlertTriangle className="w-5 h-5" />
            System Warnings
          </p>
          <ul className="text-sm text-red-700 dark:text-red-300 space-y-1 ml-7">
            {debugState.flags.orgMissing && <li>No organization selected</li>}
            {!currentRole && currentOrg && <li>Current role is null (permissions issue)</li>}
            {debugState.flags.rlsBlocked && <li>RLS (Row Level Security) blocked some queries</li>}
            {debugState.flags.loadingTimeout && <li>Organization loading took longer than 5 seconds</li>}
          </ul>
        </div>
      )}

      {isDemoMode() && (
        <div className="p-4 rounded-md bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800">
          <p className="text-sm text-amber-800 dark:text-amber-200 flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            Demo mode is active. Counts reflect demo data, not database.
          </p>
        </div>
      )}

      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base flex items-center gap-2">
            <Shield className="w-4 h-4" />
            System Flags
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="text-center p-3 rounded-md bg-muted/50">
              <div className={`text-lg font-semibold ${debugState.flags.rlsBlocked ? 'text-red-600' : 'text-green-600'}`}>
                {debugState.flags.rlsBlocked ? 'YES' : 'NO'}
              </div>
              <div className="text-xs text-muted-foreground">RLS Blocked</div>
            </div>
            <div className="text-center p-3 rounded-md bg-muted/50">
              <div className={`text-lg font-semibold ${debugState.flags.orgMissing ? 'text-red-600' : 'text-green-600'}`}>
                {debugState.flags.orgMissing ? 'YES' : 'NO'}
              </div>
              <div className="text-xs text-muted-foreground">Org Missing</div>
            </div>
            <div className="text-center p-3 rounded-md bg-muted/50">
              <div className={`text-lg font-semibold ${debugState.flags.loadingTimeout ? 'text-red-600' : 'text-green-600'}`}>
                {debugState.flags.loadingTimeout ? 'YES' : 'NO'}
              </div>
              <div className="text-xs text-muted-foreground">Loading Timeout</div>
            </div>
            <div className="text-center p-3 rounded-md bg-muted/50">
              <div className={`text-lg font-semibold ${isDemoMode() ? 'text-amber-600' : 'text-foreground'}`}>
                {isDemoMode() ? 'YES' : 'NO'}
              </div>
              <div className="text-xs text-muted-foreground">Demo Mode</div>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="grid md:grid-cols-2 gap-4">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center gap-2">
              <User className="w-4 h-4" />
              Current User
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Email:</span>
              <span className="font-mono text-foreground" data-testid="text-user-email">
                {authUser?.email || 'Not authenticated'}
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">User ID:</span>
              <span className="font-mono text-foreground text-xs truncate max-w-[200px]">
                {authUser?.id || '-'}
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Authenticated:</span>
              <span className={isAuthenticated ? 'text-green-600' : 'text-red-600'}>
                {isAuthenticated ? 'Yes' : 'No'}
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center gap-2">
              <Building2 className="w-4 h-4" />
              Current Organization
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Name:</span>
              <span className="font-medium text-foreground" data-testid="text-org-name">
                {currentOrg?.name || 'None selected'}
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Org ID:</span>
              <span className="font-mono text-foreground text-xs truncate max-w-[200px]" data-testid="text-org-id">
                {currentOrg?.id || '-'}
              </span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Source:</span>
              <span className="text-foreground">{getOrgSource()}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Role:</span>
              <span className={`capitalize ${currentRole ? 'text-foreground' : 'text-red-600'}`}>
                {currentRole || 'null (!)'}
              </span>
            </div>
            {orgLoading && (
              <div className="text-sm text-muted-foreground flex items-center gap-1">
                <Loader2 className="w-3 h-3 animate-spin" /> Loading org...
              </div>
            )}
            {orgError && (
              <div className="text-sm text-destructive">{orgError}</div>
            )}
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader className="pb-3 flex flex-row items-center justify-between gap-2">
          <CardTitle className="text-base flex items-center gap-2">
            <Database className="w-4 h-4" />
            Data Counts {isDemoMode() ? '(Demo)' : currentOrg ? '(Org-scoped)' : ''}
          </CardTitle>
          <Button variant="ghost" size="sm" onClick={fetchCounts} disabled={loadingCounts}>
            <RefreshCw className={`w-4 h-4 ${loadingCounts ? 'animate-spin' : ''}`} />
          </Button>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
              { label: 'Employees', value: counts.employees },
              { label: 'Org Units', value: counts.units },
              { label: 'Skills (Global)', value: counts.skills },
              { label: 'Positions (Global)', value: counts.positions },
            ].map(item => (
              <div key={item.label} className="text-center p-3 rounded-md bg-muted/50">
                <div className={`text-2xl font-semibold ${item.value === 'denied' ? 'text-red-600' : 'text-foreground'}`}>
                  {formatCountValue(item.value)}
                </div>
                <div className="text-xs text-muted-foreground">{item.label}</div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {!isDemoMode() && (
        <Card>
          <CardHeader className="pb-3 flex flex-row items-center justify-between gap-2">
            <CardTitle className="text-base flex items-center gap-2">
              <Search className="w-4 h-4" />
              Schema Check
            </CardTitle>
            <Button variant="outline" size="sm" onClick={runSchemaCheck} disabled={loadingSchema || !currentOrg}>
              {loadingSchema ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
              <span className="ml-2">Run Check</span>
            </Button>
          </CardHeader>
          <CardContent>
            {!schemaCheck ? (
              <p className="text-sm text-muted-foreground text-center py-4">
                Click "Run Check" to validate database schema and RLS
              </p>
            ) : (
              <div className="space-y-4">
                {schemaCheck.errors.length > 0 && (
                  <div className="p-3 rounded-md bg-destructive/10 border border-destructive/20">
                    <p className="text-sm font-medium text-destructive mb-1">Errors:</p>
                    {schemaCheck.errors.map((e, i) => (
                      <p key={i} className="text-xs text-destructive">{e}</p>
                    ))}
                  </div>
                )}
                
                <div className="grid gap-2">
                  {Object.entries(schemaCheck.tables).map(([table, info]) => (
                    <div key={table} className="p-3 rounded-md bg-muted/50 space-y-2">
                      <div className="flex items-center justify-between">
                        <span className="font-medium text-sm">{table}</span>
                        <div className="flex items-center gap-2">
                          {info.exists ? (
                            <span className="text-xs text-green-600 flex items-center gap-1">
                              <CheckCircle className="w-3 h-3" /> Exists
                            </span>
                          ) : (
                            <span className="text-xs text-red-600 flex items-center gap-1">
                              <XCircle className="w-3 h-3" /> Missing
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="flex flex-wrap gap-2 text-xs">
                        <span className={info.hasOrgId ? 'text-green-600' : 'text-red-600'}>
                          org_id: {info.hasOrgId ? 'Yes' : 'No'}
                        </span>
                        <span className={info.rlsEnabled === true ? 'text-green-600' : info.rlsEnabled === false ? 'text-red-600' : 'text-muted-foreground'}>
                          RLS: {info.rlsEnabled === true ? 'Enabled' : info.rlsEnabled === false ? 'Disabled' : 'Unknown'}
                        </span>
                        {schemaCheck.nullOrgIdCounts[table] !== undefined && (
                          <span className={schemaCheck.nullOrgIdCounts[table] > 0 ? 'text-amber-600' : 'text-green-600'}>
                            Null org_id: {schemaCheck.nullOrgIdCounts[table]}
                          </span>
                        )}
                      </div>
                      
                      {schemaCheck.nullOrgIdCounts[table] > 0 && (
                        <div className="pt-2 border-t border-border flex items-center gap-2">
                          <Button 
                            variant="outline" 
                            size="sm" 
                            onClick={() => handleRepair(table, true)}
                            disabled={repairing}
                          >
                            <Wrench className="w-3 h-3 mr-1" />
                            Preview Repair
                          </Button>
                          <Button 
                            variant="destructive" 
                            size="sm" 
                            onClick={() => {
                              if (confirm(`This will update all ${schemaCheck.nullOrgIdCounts[table]} rows with null org_id to the current org. Continue?`)) {
                                handleRepair(table, false);
                              }
                            }}
                            disabled={repairing}
                          >
                            {repairing ? <Loader2 className="w-3 h-3 animate-spin mr-1" /> : <Wrench className="w-3 h-3 mr-1" />}
                            Apply Repair
                          </Button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
                
                {repairResult && (
                  <div className="p-3 rounded-md bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
                    <p className="text-sm text-blue-800 dark:text-blue-200">{repairResult}</p>
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {debugState.lastApiCalls.length > 0 && (
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-base flex items-center gap-2">
              <Clock className="w-4 h-4" />
              Last API Calls ({debugState.lastApiCalls.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-1 max-h-[200px] overflow-y-auto">
              {debugState.lastApiCalls.map((call, idx) => (
                <div key={idx} className="flex items-center gap-2 text-sm p-2 rounded bg-muted/30">
                  <span className={`px-1.5 py-0.5 rounded text-xs font-mono ${
                    call.status >= 200 && call.status < 300 
                      ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                      : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                  }`}>
                    {call.status}
                  </span>
                  <span className="font-mono text-xs text-muted-foreground truncate flex-1">
                    {call.endpoint}
                  </span>
                  <span className="text-xs text-muted-foreground">
                    {new Date(call.timestamp).toLocaleTimeString()}
                  </span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base flex items-center gap-2">
            <AlertTriangle className="w-4 h-4" />
            Recent Errors ({debugState.errors.length})
            <span className="ml-auto text-xs font-normal text-muted-foreground flex items-center gap-1">
              <Radio className="w-3 h-3 animate-pulse text-green-500" />
              Auto-updating
            </span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          {debugState.errors.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-4">
              No errors logged in this session
            </p>
          ) : (
            <div className="space-y-2 max-h-[300px] overflow-y-auto">
              {debugState.errors.map((error, idx) => (
                <div key={idx} className="p-3 rounded-md bg-destructive/5 border border-destructive/20 text-sm">
                  <div className="flex items-center gap-2 mb-1">
                    <span className={`px-1.5 py-0.5 rounded text-xs uppercase ${
                      error.type === 'supabase' 
                        ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
                        : error.type === 'client'
                        ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'
                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                    }`}>
                      {error.type}
                    </span>
                    {error.endpoint && (
                      <span className="font-mono text-xs text-muted-foreground">{error.endpoint}</span>
                    )}
                    {error.status && (
                      <span className="text-xs text-muted-foreground">Status: {error.status}</span>
                    )}
                  </div>
                  <p className="text-foreground">{error.message}</p>
                  {error.code && (
                    <p className="text-xs text-muted-foreground mt-1">Code: {error.code}</p>
                  )}
                  {error.hint && (
                    <p className="text-xs text-muted-foreground">Hint: {error.hint}</p>
                  )}
                  <p className="text-xs text-muted-foreground mt-1">
                    {new Date(error.timestamp).toLocaleString()}
                  </p>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">All Memberships</CardTitle>
        </CardHeader>
        <CardContent>
          {memberships.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-4">
              No organization memberships found
            </p>
          ) : (
            <div className="space-y-2">
              {memberships.map((m, idx) => (
                <div 
                  key={idx} 
                  className={`p-3 rounded-md border ${
                    m.org_id === currentOrg?.id 
                      ? 'border-primary bg-primary/5' 
                      : 'border-border bg-muted/30'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <span className="font-medium text-foreground">
                      {m.organization?.name || m.org_id}
                    </span>
                    <span className="text-xs px-2 py-1 rounded bg-muted text-muted-foreground capitalize">
                      {m.role}
                    </span>
                  </div>
                  <div className="text-xs text-muted-foreground mt-1 font-mono">
                    {m.org_id}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/demo/page.tsx">
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { 
  LogIn, 
  Building2, 
  Table2, 
  TrendingUp, 
  Download, 
  CheckCircle,
  ArrowRight
} from "lucide-react";
import Link from "next/link";

const demoSteps = [
  {
    step: 1,
    title: "Login",
    description: "Sign in with your demo credentials or create a new account.",
    icon: LogIn,
    link: "/login",
    linkText: "Go to Login",
  },
  {
    step: 2,
    title: "Select Organization",
    description: "Choose your organization or create a new one to get started.",
    icon: Building2,
    link: "/app/org/select",
    linkText: "Select Org",
  },
  {
    step: 3,
    title: "Open Competence Matrix",
    description: "View the skill matrix showing all employees and their competency levels with color-coded status badges.",
    icon: Table2,
    link: "/app/competence-matrix?demo=true",
    linkText: "View Matrix",
  },
  {
    step: 4,
    title: "Generate Tomorrow's Gaps",
    description: "Click 'Generate Gaps' to analyze skill shortages for tomorrow's shift. See the summary card with top missing skills and recommendations.",
    icon: TrendingUp,
    link: "/app/gaps?demo=true",
    linkText: "Open Gaps",
  },
  {
    step: 5,
    title: "Export Action Plan",
    description: "Download the gaps table as CSV to share with your team or import into your planning system.",
    icon: Download,
    link: "/app/gaps?demo=true",
    linkText: "Export CSV",
  },
];

export default function DemoScriptPage() {
  return (
    <div className="p-6 max-w-4xl mx-auto">
      <div className="mb-8">
        <Badge className="mb-4">Demo Script</Badge>
        <h1 className="text-2xl font-bold mb-2" data-testid="heading-demo-script">
          Nadiplan Product Demo
        </h1>
        <p className="text-muted-foreground">
          Follow these 5 steps to demonstrate the key features of the Industrial Competence Platform.
        </p>
      </div>

      <div className="space-y-4">
        {demoSteps.map((item, index) => (
          <Card key={item.step} className="relative" data-testid={`card-step-${item.step}`}>
            <CardHeader className="pb-2">
              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                  <item.icon className="h-5 w-5 text-primary" />
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <Badge variant="outline" className="text-xs">
                      Step {item.step}
                    </Badge>
                    <CardTitle className="text-lg">{item.title}</CardTitle>
                  </div>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="ml-14">
                <p className="text-sm text-muted-foreground mb-3">
                  {item.description}
                </p>
                <Link
                  href={item.link}
                  className="inline-flex items-center gap-1 text-sm text-primary hover:underline"
                  data-testid={`link-step-${item.step}`}
                >
                  {item.linkText}
                  <ArrowRight className="h-3 w-3" />
                </Link>
              </div>
            </CardContent>
            {index < demoSteps.length - 1 && (
              <div className="absolute left-9 top-[72px] w-0.5 h-[calc(100%-48px)] bg-border" />
            )}
          </Card>
        ))}
      </div>

      <Card className="mt-8 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950">
        <CardContent className="pt-6">
          <div className="flex items-start gap-3">
            <CheckCircle className="h-5 w-5 text-green-600 flex-shrink-0 mt-0.5" />
            <div>
              <h3 className="font-semibold text-green-800 dark:text-green-200 mb-1">
                Demo Complete
              </h3>
              <p className="text-sm text-green-700 dark:text-green-300">
                After completing these steps, your customer has seen the core value proposition:
                visualize competence gaps and take action before they impact operations.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="mt-8 text-center">
        <p className="text-sm text-muted-foreground mb-4">
          Need to reset demo data or start fresh?
        </p>
        <Link
          href="/app/dashboard"
          className="inline-flex items-center gap-2 text-sm text-primary hover:underline"
          data-testid="link-back-dashboard"
        >
          Back to Dashboard
          <ArrowRight className="h-3 w-3" />
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="app/demo-center/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Play,
  RefreshCw,
  Copy,
  CheckCircle,
  Circle,
  Shield,
  ExternalLink,
} from "lucide-react";
import {
  isDemoMode,
  enableDemoMode,
  disableDemoMode,
  getDemoScript,
  getDemoMetrics,
  DEMO_CHECKLIST,
} from "@/lib/demoRuntime";
import Link from "next/link";

export default function DemoCenterPage() {
  const [demoActive, setDemoActive] = useState(false);
  const [checkedSteps, setCheckedSteps] = useState<number[]>([]);
  const [copySuccess, setCopySuccess] = useState(false);
  const metrics = getDemoMetrics();

  useEffect(() => {
    setDemoActive(isDemoMode());
  }, []);

  const handleEnableDemo = () => {
    enableDemoMode();
    setDemoActive(true);
    window.location.reload();
  };

  const handleDisableDemo = () => {
    disableDemoMode();
    setDemoActive(false);
    window.location.reload();
  };

  const handleCopyScript = () => {
    navigator.clipboard.writeText(getDemoScript());
    setCopySuccess(true);
    setTimeout(() => setCopySuccess(false), 2000);
  };

  const toggleStep = (step: number) => {
    setCheckedSteps((prev) =>
      prev.includes(step) ? prev.filter((s) => s !== step) : [...prev, step]
    );
  };

  const completedCount = checkedSteps.length;
  const totalSteps = DEMO_CHECKLIST.length;
  const progress = Math.round((completedCount / totalSteps) * 100);

  return (
    <div className="container mx-auto py-6 px-4 max-w-4xl">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold" data-testid="text-page-title">
            Demo Control Center
          </h1>
          <p className="text-muted-foreground">
            Prepare and execute a flawless product demo
          </p>
        </div>
        <Badge
          variant={demoActive ? "default" : "secondary"}
          className="text-sm px-3 py-1"
          data-testid="badge-demo-status"
        >
          <Shield className="h-4 w-4 mr-1" />
          {demoActive ? "Demo Active" : "Demo Inactive"}
        </Badge>
      </div>

      <div className="grid gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Play className="h-5 w-5" />
              Demo Mode Controls
            </CardTitle>
            <CardDescription>
              Enable demo mode to use pre-configured demo data without Supabase calls
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-3">
              {demoActive ? (
                <Button
                  variant="outline"
                  onClick={handleDisableDemo}
                  data-testid="button-disable-demo"
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Disable Demo Mode
                </Button>
              ) : (
                <Button onClick={handleEnableDemo} data-testid="button-enable-demo">
                  <Play className="h-4 w-4 mr-2" />
                  Enable Demo Mode
                </Button>
              )}
              <Button
                variant="secondary"
                onClick={() => window.location.reload()}
                data-testid="button-reset-demo"
              >
                <RefreshCw className="h-4 w-4 mr-2" />
                Reset Demo Data
              </Button>
              <Button
                variant="outline"
                onClick={handleCopyScript}
                data-testid="button-copy-script"
              >
                {copySuccess ? (
                  <CheckCircle className="h-4 w-4 mr-2" />
                ) : (
                  <Copy className="h-4 w-4 mr-2" />
                )}
                {copySuccess ? "Copied!" : "Copy Demo Script"}
              </Button>
            </div>

            {demoActive && (
              <div className="mt-4 p-3 bg-muted rounded-md">
                <p className="text-sm text-muted-foreground">
                  Demo mode is active. All data shown is pre-configured demo data.
                  Navigate to any page to see demo content.
                </p>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Demo Metrics Preview</CardTitle>
            <CardDescription>
              These metrics will be shown on the Dashboard in demo mode
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="text-center p-3 bg-muted rounded-md">
                <div className="text-2xl font-bold" data-testid="text-demo-employees">
                  {metrics.totalEmployees}
                </div>
                <div className="text-sm text-muted-foreground">Employees</div>
              </div>
              <div className="text-center p-3 bg-muted rounded-md">
                <div className="text-2xl font-bold text-amber-600" data-testid="text-demo-at-risk">
                  {metrics.atRiskCount}
                </div>
                <div className="text-sm text-muted-foreground">At Risk</div>
              </div>
              <div className="text-center p-3 bg-muted rounded-md">
                <div className="text-2xl font-bold" data-testid="text-demo-readiness">
                  {metrics.avgReadiness}%
                </div>
                <div className="text-sm text-muted-foreground">Readiness</div>
              </div>
              <div className="text-center p-3 bg-muted rounded-md">
                <div className="text-2xl font-bold" data-testid="text-demo-gaps">
                  {metrics.gapCount}
                </div>
                <div className="text-sm text-muted-foreground">Skill Gaps</div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Demo Checklist</CardTitle>
            <CardDescription>
              Follow these steps to deliver a flawless demo ({completedCount}/{totalSteps} complete - {progress}%)
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {DEMO_CHECKLIST.map((item) => {
                const isChecked = checkedSteps.includes(item.step);
                return (
                  <div
                    key={item.step}
                    className="flex items-start gap-3 p-2 rounded-md hover-elevate cursor-pointer"
                    onClick={() => toggleStep(item.step)}
                  >
                    <Checkbox
                      checked={isChecked}
                      onCheckedChange={() => toggleStep(item.step)}
                      data-testid={`checkbox-step-${item.step}`}
                    />
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        {isChecked ? (
                          <CheckCircle className="h-4 w-4 text-green-600" />
                        ) : (
                          <Circle className="h-4 w-4 text-muted-foreground" />
                        )}
                        <span className={`font-medium ${isChecked ? "line-through text-muted-foreground" : ""}`}>
                          Step {item.step}: {item.title}
                        </span>
                      </div>
                      <p className="text-sm text-muted-foreground ml-6">
                        {item.description}
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Quick Navigation</CardTitle>
            <CardDescription>
              Jump directly to demo pages
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/dashboard" data-testid="link-demo-dashboard">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Dashboard
                </Link>
              </Button>
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/employees" data-testid="link-demo-employees">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Employees
                </Link>
              </Button>
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/org/overview" data-testid="link-demo-org">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Organization
                </Link>
              </Button>
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/competence/matrix" data-testid="link-demo-matrix">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Competence Matrix
                </Link>
              </Button>
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/gaps" data-testid="link-demo-gaps">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Tomorrow&apos;s Gaps
                </Link>
              </Button>
              <Button asChild variant="outline" className="justify-start">
                <Link href="/app/admin/users" data-testid="link-demo-users">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Admin Users
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="app/documents/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Plus, FileText, ExternalLink, Loader2 } from "lucide-react";
import type { Document } from "@/types/domain";

export default function DocumentsPage() {
  const [documents, setDocuments] = useState<Document[]>([]);
  const [loading, setLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newDoc, setNewDoc] = useState({ title: "", type: "handbook", url: "" });

  const fetchDocuments = async () => {
    setLoading(true);
    const { data } = await supabase
      .from("documents")
      .select("*")
      .is("employee_id", null)
      .order("created_at", { ascending: false });

    setDocuments(
      (data || []).map((d: any) => ({
        id: d.id,
        employeeId: d.employee_id,
        title: d.title,
        type: d.type,
        url: d.url,
        createdAt: d.created_at,
        validTo: d.valid_to,
      }))
    );
    setLoading(false);
  };

  useEffect(() => {
    fetchDocuments();
  }, []);

  const handleAddDocument = async () => {
    if (!newDoc.title || !newDoc.url) return;

    await supabase.from("documents").insert({
      title: newDoc.title,
      type: newDoc.type,
      url: newDoc.url,
      employee_id: null,
    });

    setNewDoc({ title: "", type: "handbook", url: "" });
    setShowAddForm(false);
    fetchDocuments();
  };

  const typeLabels: Record<string, string> = {
    contract: "Contract",
    handbook: "Handbook",
    policy: "Policy",
    certificate: "Certificate",
    other: "Other",
  };

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-semibold">Company Documents</h1>
        <Button onClick={() => setShowAddForm(!showAddForm)} data-testid="button-add-document">
          <Plus className="h-4 w-4 mr-2" />
          Add Document
        </Button>
      </div>

      {showAddForm && (
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="text-lg">Add Document</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <Input
                placeholder="Title"
                value={newDoc.title}
                onChange={(e) => setNewDoc({ ...newDoc, title: e.target.value })}
                data-testid="input-doc-title"
              />
              <Select
                value={newDoc.type}
                onValueChange={(value: string) => setNewDoc({ ...newDoc, type: value })}
              >
                <SelectTrigger data-testid="select-doc-type">
                  <SelectValue placeholder="Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="handbook">Handbook</SelectItem>
                  <SelectItem value="policy">Policy</SelectItem>
                  <SelectItem value="contract">Contract Template</SelectItem>
                  <SelectItem value="certificate">Certificate</SelectItem>
                  <SelectItem value="other">Other</SelectItem>
                </SelectContent>
              </Select>
              <Input
                placeholder="URL"
                value={newDoc.url}
                onChange={(e) => setNewDoc({ ...newDoc, url: e.target.value })}
                data-testid="input-doc-url"
              />
            </div>
            <Button className="mt-4" onClick={handleAddDocument} data-testid="button-save-document">
              Save Document
            </Button>
          </CardContent>
        </Card>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {documents.map((doc) => (
          <Card key={doc.id} data-testid={`card-document-${doc.id}`}>
            <CardHeader className="pb-2">
              <div className="flex items-start justify-between gap-2">
                <CardTitle className="text-base flex items-center gap-2">
                  <FileText className="h-4 w-4" />
                  {doc.title}
                </CardTitle>
                <Badge variant="outline">{typeLabels[doc.type] || doc.type}</Badge>
              </div>
            </CardHeader>
            <CardContent>
              <a
                href={doc.url}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-primary flex items-center gap-1 hover:underline"
                data-testid={`link-document-${doc.id}`}
              >
                <ExternalLink className="h-3 w-3" />
                Open Document
              </a>
            </CardContent>
          </Card>
        ))}

        {documents.length === 0 && (
          <div className="col-span-full text-center py-12 text-muted-foreground">
            No documents yet. Click &quot;Add Document&quot; to upload your first document.
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/employees/[id]/competence/page.tsx">
// app/employees/[id]/competence/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import {
  getEmployeeCompetenceProfile,
  EmployeeCompetenceProfile,
  EmployeeCompetenceItem,
} from "@/services/competence";
import { useAuthGuard } from "@/hooks/useAuthGuard";

export default function EmployeeCompetencePage({
  params,
}: {
  params: { id: string };
}) {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access...</p>
      </main>
    );
  }

  return <EmployeeCompetenceContent params={params} />;
}

function EmployeeCompetenceContent({
  params,
}: {
  params: { id: string };
}) {
  const employeeId = params.id;
  const router = useRouter();

  const [profile, setProfile] = useState<EmployeeCompetenceProfile | null>(
    null,
  );
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [actionMessage, setActionMessage] = useState<string | null>(null);

  useEffect(() => {
    async function load() {
      try {
        const data = await getEmployeeCompetenceProfile(employeeId);
        setProfile(data);
      } catch (err) {
        console.error(err);
        setError("Kunde inte ladda kompetensprofil.");
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [employeeId]);

  return (
    <main className="hr-page">
      <button className="hr-link" onClick={() => router.back()}>
        ← Tillbaka
      </button>

      {loading && <p>Laddar kompetensprofil…</p>}
      {error && <p className="hr-error">{error}</p>}

      {!loading && !error && profile && (
        <>
          <header className="hr-emp-header">
            <div>
              <h1 className="hr-page__title">{profile.employee.name}</h1>
              <p className="hr-page__subtitle">
                {profile.employee.positionName
                  ? profile.employee.positionName
                  : "Ingen position kopplad ännu"}
              </p>
            </div>
            <div className="hr-emp-header__badge">
              <span
                className={`hr-risk-pill hr-risk-pill--${profile.summary.riskLevel.toLowerCase()}`}
              >
                Risk: {profile.summary.riskLevel}
              </span>
            </div>
          </header>

          <section className="hr-emp-summary-grid">
            <SummaryCard
              label="Obligatoriska kompetenser"
              value={profile.summary.totalRequired}
            />
            <SummaryCard
              label="Kompetens-gaps"
              value={profile.summary.gapCount}
            />
            <SummaryCard
              label="Täckningsgrad"
              value={`${profile.summary.coveragePercent}%`}
            />
            <SummaryCard
              label="Utgångna kompetenser"
              value={profile.summary.expiredCount}
            />
          </section>

          {actionMessage && (
            <p className="hr-action-message">{actionMessage}</p>
          )}

          <section className="hr-competence-section">
            <h2 className="hr-section__title">Kompetenser</h2>
            <p className="hr-task-section__description">
              Krav baserat på roll samt faktiska kompetenser per person.
            </p>

            <div className="hr-competence-table-wrapper">
              <table className="hr-competence-table">
                <thead>
                  <tr>
                    <th>Grupp</th>
                    <th>Kompetens</th>
                    <th>Krav (nivå)</th>
                    <th>Har (nivå)</th>
                    <th>Giltig t.o.m.</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {profile.items.map((item) => (
                    <CompetenceRow
                      key={item.competenceId}
                      item={item}
                      onTriggerAction={(msg) => setActionMessage(msg)}
                    />
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        </>
      )}
    </main>
  );
}

function SummaryCard({
  label,
  value,
}: {
  label: string;
  value: string | number;
}) {
  return (
    <div className="hr-emp-summary-card">
      <div className="hr-emp-summary-label">{label}</div>
      <div className="hr-emp-summary-value">{value}</div>
    </div>
  );
}

function CompetenceRow({
  item,
  onTriggerAction,
}: {
  item: EmployeeCompetenceItem;
  onTriggerAction: (msg: string) => void;
}) {
  const levelLabel = (lvl: number | null | undefined) => {
    if (lvl == null) return "-";
    return lvl.toString();
  };

  const statusClass =
    item.status === "OK"
      ? "hr-status-badge--ok"
      : item.status === "RISK"
        ? "hr-status-badge--risk"
        : "hr-status-badge--na";

  const dueLabel = item.validTo
    ? new Date(item.validTo).toLocaleDateString()
    : "-";

  const showAction = item.status === "RISK";

  // Här kan vi senare koppla "Starta utbildning"-workflow.
  function handleClick() {
    onTriggerAction(
      `Åtgärd behövs för kompetens "${item.competenceName}". (Koppla till utbildnings-workflow när template är satt.)`,
    );
  }

  return (
    <tr>
      <td>{item.groupName ?? "-"}</td>
      <td>
        <div className="hr-competence-name">
          {item.competenceName}
          {item.isSafetyCritical && (
            <span className="hr-competence-chip">Safety</span>
          )}
        </div>
      </td>
      <td>
        <span className="hr-level-chip">{levelLabel(item.requiredLevel)}</span>
      </td>
      <td>
        <span className="hr-level-chip hr-level-chip--owned">
          {levelLabel(item.employeeLevel)}
        </span>
      </td>
      <td>{dueLabel}</td>
      <td>
        <span className={`hr-status-badge ${statusClass}`}>{item.status}</span>
        {item.riskReason && (
          <div className="hr-status-reason">{item.riskReason}</div>
        )}
      </td>
      <td>
        {showAction && (
          <button
            type="button"
            className="hr-button hr-button--secondary hr-button--dense"
            onClick={handleClick}
          >
            Åtgärda
          </button>
        )}
      </td>
    </tr>
  );
}
</file>

<file path="app/employees/[id]/one-to-ones/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ArrowLeft, Plus, Calendar, Clock, MapPin, X } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { getMeetingsForEmployee, createMeeting } from "@/services/oneToOne";
import type { OneToOneMeeting, Employee } from "@/types/domain";

export default function EmployeeOneToOnesPage() {
  const params = useParams();
  const router = useRouter();
  const employeeId = params.id as string;

  const [employee, setEmployee] = useState<Employee | null>(null);
  const [meetings, setMeetings] = useState<OneToOneMeeting[]>([]);
  const [loading, setLoading] = useState(true);
  const [showNewForm, setShowNewForm] = useState(false);
  const [managers, setManagers] = useState<{ id: string; name: string }[]>([]);
  const [saving, setSaving] = useState(false);

  const [formData, setFormData] = useState({
    managerId: "",
    scheduledAt: "",
    durationMinutes: 60,
    location: "",
    templateName: "",
    sharedAgenda: "",
  });

  useEffect(() => {
    async function loadData() {
      const [empRes, meetingsData, managersRes] = await Promise.all([
        supabase.from("employees").select("*").eq("id", employeeId).single(),
        getMeetingsForEmployee(employeeId),
        supabase.from("employees").select("id, name").eq("is_active", true).order("name"),
      ]);

      if (empRes.data) {
        setEmployee({
          id: empRes.data.id,
          name: empRes.data.name || "",
          employeeNumber: empRes.data.employee_number || "",
          role: empRes.data.role || "",
          line: empRes.data.line || "",
          team: empRes.data.team || "",
          employmentType: empRes.data.employment_type || "permanent",
          isActive: empRes.data.is_active ?? true,
          managerId: empRes.data.manager_id || undefined,
        });
        if (empRes.data.manager_id) {
          setFormData((prev) => ({ ...prev, managerId: empRes.data.manager_id }));
        }
      }

      setMeetings(meetingsData);
      setManagers((managersRes.data || []).map((m) => ({ id: m.id, name: m.name })));
      setLoading(false);
    }
    loadData();
  }, [employeeId]);

  async function handleCreate() {
    if (!formData.managerId || !formData.scheduledAt) return;

    setSaving(true);
    const result = await createMeeting({
      employeeId,
      managerId: formData.managerId,
      scheduledAt: new Date(formData.scheduledAt).toISOString(),
      durationMinutes: formData.durationMinutes || undefined,
      location: formData.location || undefined,
      templateName: formData.templateName || undefined,
      sharedAgenda: formData.sharedAgenda || undefined,
    });

    if (result) {
      setMeetings([result, ...meetings]);
      setShowNewForm(false);
      setFormData({
        managerId: employee?.managerId || "",
        scheduledAt: "",
        durationMinutes: 60,
        location: "",
        templateName: "",
        sharedAgenda: "",
      });
    }
    setSaving(false);
  }

  function getStatusBadge(status: string) {
    const variants: Record<string, "default" | "secondary" | "destructive" | "outline"> = {
      planned: "outline",
      in_progress: "default",
      completed: "secondary",
      cancelled: "destructive",
    };
    return <Badge variant={variants[status] || "outline"}>{status}</Badge>;
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-1/3" />
          <div className="h-64 bg-muted rounded" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center gap-4">
        <Link href={`/app/employees/${employeeId}`}>
          <Button variant="ghost" size="icon" data-testid="button-back">
            <ArrowLeft className="h-4 w-4" />
          </Button>
        </Link>
        <div>
          <h1 className="text-2xl font-bold" data-testid="text-page-title">
            1:1 Meetings
          </h1>
          <p className="text-muted-foreground">{employee?.name}</p>
        </div>
      </div>

      <div className="flex justify-end">
        <Button onClick={() => setShowNewForm(true)} data-testid="button-schedule-new">
          <Plus className="h-4 w-4 mr-2" />
          Schedule New 1:1
        </Button>
      </div>

      {showNewForm && (
        <Card>
          <CardHeader className="flex flex-row items-center justify-between gap-4">
            <CardTitle>Schedule New Meeting</CardTitle>
            <Button
              variant="ghost"
              size="icon"
              onClick={() => setShowNewForm(false)}
              data-testid="button-close-form"
            >
              <X className="h-4 w-4" />
            </Button>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <label className="text-sm font-medium">Manager</label>
                <Select
                  value={formData.managerId}
                  onValueChange={(v) => setFormData({ ...formData, managerId: v })}
                >
                  <SelectTrigger data-testid="select-manager">
                    <SelectValue placeholder="Select manager" />
                  </SelectTrigger>
                  <SelectContent>
                    {managers.map((m) => (
                      <SelectItem key={m.id} value={m.id}>
                        {m.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Date & Time</label>
                <Input
                  type="datetime-local"
                  value={formData.scheduledAt}
                  onChange={(e) => setFormData({ ...formData, scheduledAt: e.target.value })}
                  data-testid="input-scheduled-at"
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Duration (minutes)</label>
                <Input
                  type="number"
                  value={formData.durationMinutes}
                  onChange={(e) => setFormData({ ...formData, durationMinutes: parseInt(e.target.value) || 60 })}
                  data-testid="input-duration"
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Location</label>
                <Input
                  value={formData.location}
                  onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                  placeholder="Meeting room, online, etc."
                  data-testid="input-location"
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium">Template</label>
                <Select
                  value={formData.templateName}
                  onValueChange={(v) => setFormData({ ...formData, templateName: v })}
                >
                  <SelectTrigger data-testid="select-template">
                    <SelectValue placeholder="Select type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Medarbetarsamtal">Medarbetarsamtal</SelectItem>
                    <SelectItem value="Lönesamtal">Lönesamtal</SelectItem>
                    <SelectItem value="Uppföljning">Uppföljning</SelectItem>
                    <SelectItem value="Check-in">Check-in</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-medium">Shared Agenda</label>
              <Textarea
                value={formData.sharedAgenda}
                onChange={(e) => setFormData({ ...formData, sharedAgenda: e.target.value })}
                placeholder="Topics to discuss..."
                rows={3}
                data-testid="input-agenda"
              />
            </div>
            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => setShowNewForm(false)} data-testid="button-cancel">
                Cancel
              </Button>
              <Button
                onClick={handleCreate}
                disabled={saving || !formData.managerId || !formData.scheduledAt}
                data-testid="button-create-meeting"
              >
                {saving ? "Creating..." : "Create Meeting"}
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {meetings.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center text-muted-foreground">
            No 1:1 meetings scheduled yet
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-3">
          {meetings.map((meeting) => (
            <Link key={meeting.id} href={`/app/one-to-ones/${meeting.id}`}>
              <Card className="hover-elevate cursor-pointer">
                <CardContent className="py-4">
                  <div className="flex items-center justify-between gap-4 flex-wrap">
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2 text-muted-foreground">
                        <Calendar className="h-4 w-4" />
                        <span data-testid={`text-meeting-date-${meeting.id}`}>
                          {new Date(meeting.scheduledAt).toLocaleDateString("sv-SE")}
                        </span>
                      </div>
                      <div className="flex items-center gap-2 text-muted-foreground">
                        <Clock className="h-4 w-4" />
                        <span>
                          {new Date(meeting.scheduledAt).toLocaleTimeString("sv-SE", {
                            hour: "2-digit",
                            minute: "2-digit",
                          })}
                        </span>
                      </div>
                      {meeting.location && (
                        <div className="flex items-center gap-2 text-muted-foreground">
                          <MapPin className="h-4 w-4" />
                          <span>{meeting.location}</span>
                        </div>
                      )}
                    </div>
                    <div className="flex items-center gap-3">
                      {meeting.templateName && (
                        <span className="text-sm text-muted-foreground">{meeting.templateName}</span>
                      )}
                      <span className="text-sm">with {meeting.managerName || "Manager"}</span>
                      {getStatusBadge(meeting.status)}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/employees/[id]/reviews/new/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { ArrowLeft, Plus, Trash2 } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import type { ReviewTemplate, ReviewGoal } from "@/types/domain";

export default function NewReviewPage() {
  const params = useParams();
  const router = useRouter();
  const employeeId = params.id as string;

  const [templates, setTemplates] = useState<ReviewTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [employeeName, setEmployeeName] = useState("");

  const [formData, setFormData] = useState({
    templateId: "",
    reviewDate: new Date().toISOString().split("T")[0],
    periodStart: "",
    periodEnd: "",
    overallRating: 0,
    summary: "",
    notes: "",
  });
  const [goals, setGoals] = useState<ReviewGoal[]>([]);

  useEffect(() => {
    async function load() {
      const [templatesRes, employeeRes] = await Promise.all([
        supabase.from("review_templates").select("*").eq("is_active", true).order("name"),
        supabase.from("employees").select("name").eq("id", employeeId).single(),
      ]);

      setTemplates(
        (templatesRes.data || []).map((t) => ({
          id: t.id,
          name: t.name,
          description: t.description,
          audience: t.audience,
          isActive: t.is_active,
          createdAt: t.created_at,
        }))
      );
      setEmployeeName(employeeRes.data?.name || "");
      setLoading(false);
    }
    load();
  }, [employeeId]);

  function addGoal() {
    setGoals([
      ...goals,
      { id: crypto.randomUUID(), text: "", status: "pending" },
    ]);
  }

  function updateGoal(id: string, text: string) {
    setGoals(goals.map((g) => (g.id === id ? { ...g, text } : g)));
  }

  function removeGoal(id: string) {
    setGoals(goals.filter((g) => g.id !== id));
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSaving(true);

    try {
      await supabase.from("employee_reviews").insert({
        employee_id: employeeId,
        template_id: formData.templateId || null,
        review_date: formData.reviewDate,
        period_start: formData.periodStart || null,
        period_end: formData.periodEnd || null,
        overall_rating: formData.overallRating || null,
        summary: formData.summary || null,
        goals: goals.filter((g) => g.text.trim()).length > 0 ? goals.filter((g) => g.text.trim()) : null,
        notes: formData.notes || null,
      });
      router.push(`/app/employees/${employeeId}`);
    } catch (error) {
      console.error("Error creating review:", error);
      setSaving(false);
    }
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse h-64 bg-gray-200 dark:bg-gray-700 rounded" />
      </div>
    );
  }

  return (
    <div className="p-6 max-w-2xl">
      <div className="flex items-center gap-4 mb-6">
        <button
          onClick={() => router.back()}
          className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"
          data-testid="button-back"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <div>
          <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
            New Review
          </h1>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            For {employeeName}
          </p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Template
            </label>
            <select
              value={formData.templateId}
              onChange={(e) => setFormData({ ...formData, templateId: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
              data-testid="select-template"
            >
              <option value="">Select template...</option>
              {templates.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.name}
                </option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Review Date *
              </label>
              <input
                type="date"
                value={formData.reviewDate}
                onChange={(e) => setFormData({ ...formData, reviewDate: e.target.value })}
                required
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                data-testid="input-review-date"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Period Start
              </label>
              <input
                type="date"
                value={formData.periodStart}
                onChange={(e) => setFormData({ ...formData, periodStart: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                data-testid="input-period-start"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Period End
              </label>
              <input
                type="date"
                value={formData.periodEnd}
                onChange={(e) => setFormData({ ...formData, periodEnd: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                data-testid="input-period-end"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Overall Rating (1-5)
            </label>
            <div className="flex gap-2">
              {[1, 2, 3, 4, 5].map((rating) => (
                <button
                  key={rating}
                  type="button"
                  onClick={() => setFormData({ ...formData, overallRating: rating })}
                  className={`w-10 h-10 rounded-md font-medium transition-colors ${
                    formData.overallRating === rating
                      ? "bg-blue-600 text-white"
                      : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"
                  }`}
                  data-testid={`button-rating-${rating}`}
                >
                  {rating}
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Summary
            </label>
            <textarea
              value={formData.summary}
              onChange={(e) => setFormData({ ...formData, summary: e.target.value })}
              rows={4}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none"
              placeholder="Overall feedback and observations..."
              data-testid="textarea-summary"
            />
          </div>

          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Goals
              </label>
              <button
                type="button"
                onClick={addGoal}
                className="flex items-center gap-1 text-sm text-blue-600 dark:text-blue-400 hover:underline"
                data-testid="button-add-goal"
              >
                <Plus className="h-4 w-4" />
                Add Goal
              </button>
            </div>
            {goals.length === 0 ? (
              <p className="text-sm text-gray-500 dark:text-gray-400">No goals added</p>
            ) : (
              <div className="space-y-2">
                {goals.map((goal) => (
                  <div key={goal.id} className="flex items-center gap-2">
                    <input
                      type="text"
                      value={goal.text}
                      onChange={(e) => updateGoal(goal.id, e.target.value)}
                      placeholder="Goal description..."
                      className="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                      data-testid={`input-goal-${goal.id}`}
                    />
                    <button
                      type="button"
                      onClick={() => removeGoal(goal.id)}
                      className="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md"
                      data-testid={`button-remove-goal-${goal.id}`}
                    >
                      <Trash2 className="h-4 w-4" />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Notes
            </label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none"
              placeholder="Additional notes..."
              data-testid="textarea-notes"
            />
          </div>
        </div>

        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={() => router.back()}
            className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700"
            data-testid="button-cancel"
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-md"
            data-testid="button-save-review"
          >
            {saving ? "Saving..." : "Save Review"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="app/employees/[id]/salary/new/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { ArrowLeft } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function NewSalaryRevisionPage() {
  const params = useParams();
  const router = useRouter();
  const employeeId = params.id as string;

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [employeeName, setEmployeeName] = useState("");

  const [formData, setFormData] = useState({
    revisionDate: new Date().toISOString().split("T")[0],
    previousSalary: 0,
    newSalary: 0,
    salaryType: "monthly" as "monthly" | "hourly",
    reason: "",
  });

  useEffect(() => {
    async function load() {
      const [employeeRes, salaryRes] = await Promise.all([
        supabase.from("employees").select("name").eq("id", employeeId).single(),
        supabase
          .from("salary_records")
          .select("salary_amount_sek, salary_type")
          .eq("employee_id", employeeId)
          .order("effective_from", { ascending: false })
          .limit(1),
      ]);

      setEmployeeName(employeeRes.data?.name || "");

      if (salaryRes.data && salaryRes.data.length > 0) {
        setFormData((prev) => ({
          ...prev,
          previousSalary: parseFloat(salaryRes.data[0].salary_amount_sek),
          newSalary: parseFloat(salaryRes.data[0].salary_amount_sek),
          salaryType: salaryRes.data[0].salary_type || "monthly",
        }));
      }

      setLoading(false);
    }
    load();
  }, [employeeId]);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSaving(true);

    try {
      await supabase.from("salary_revisions").insert({
        employee_id: employeeId,
        revision_date: formData.revisionDate,
        previous_salary_sek: formData.previousSalary,
        new_salary_sek: formData.newSalary,
        salary_type: formData.salaryType,
        reason: formData.reason || null,
      });

      await supabase.from("salary_records").insert({
        employee_id: employeeId,
        effective_from: formData.revisionDate,
        salary_amount_sek: formData.newSalary,
        salary_type: formData.salaryType,
      });

      router.push(`/app/employees/${employeeId}`);
    } catch (error) {
      console.error("Error creating salary revision:", error);
      setSaving(false);
    }
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse h-64 bg-gray-200 dark:bg-gray-700 rounded" />
      </div>
    );
  }

  const changePercent =
    formData.previousSalary > 0
      ? (((formData.newSalary - formData.previousSalary) / formData.previousSalary) * 100).toFixed(1)
      : 0;

  return (
    <div className="p-6 max-w-xl">
      <div className="flex items-center gap-4 mb-6">
        <button
          onClick={() => router.back()}
          className="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"
          data-testid="button-back"
        >
          <ArrowLeft className="h-5 w-5" />
        </button>
        <div>
          <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
            New Salary Revision
          </h1>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            For {employeeName}
          </p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Revision Date *
            </label>
            <input
              type="date"
              value={formData.revisionDate}
              onChange={(e) => setFormData({ ...formData, revisionDate: e.target.value })}
              required
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
              data-testid="input-revision-date"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Salary Type
            </label>
            <select
              value={formData.salaryType}
              onChange={(e) =>
                setFormData({ ...formData, salaryType: e.target.value as "monthly" | "hourly" })
              }
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
              data-testid="select-salary-type"
            >
              <option value="monthly">Monthly</option>
              <option value="hourly">Hourly</option>
            </select>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Previous Salary (SEK)
              </label>
              <input
                type="number"
                value={formData.previousSalary}
                onChange={(e) =>
                  setFormData({ ...formData, previousSalary: parseFloat(e.target.value) || 0 })
                }
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                data-testid="input-previous-salary"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                New Salary (SEK) *
              </label>
              <input
                type="number"
                value={formData.newSalary}
                onChange={(e) =>
                  setFormData({ ...formData, newSalary: parseFloat(e.target.value) || 0 })
                }
                required
                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                data-testid="input-new-salary"
              />
            </div>
          </div>

          {formData.previousSalary > 0 && formData.newSalary !== formData.previousSalary && (
            <div
              className={`p-3 rounded-md ${
                formData.newSalary > formData.previousSalary
                  ? "bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400"
                  : "bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400"
              }`}
            >
              Change: {formData.newSalary > formData.previousSalary ? "+" : ""}
              {(formData.newSalary - formData.previousSalary).toLocaleString("sv-SE")} SEK (
              {formData.newSalary > formData.previousSalary ? "+" : ""}
              {changePercent}%)
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Reason
            </label>
            <textarea
              value={formData.reason}
              onChange={(e) => setFormData({ ...formData, reason: e.target.value })}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-none"
              placeholder="Annual salary review, promotion, etc."
              data-testid="textarea-reason"
            />
          </div>
        </div>

        <div className="flex justify-end gap-3">
          <button
            type="button"
            onClick={() => router.back()}
            className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700"
            data-testid="button-cancel"
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={saving}
            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded-md"
            data-testid="button-save-revision"
          >
            {saving ? "Saving..." : "Save Revision"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="app/employees/[id]/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import {
  User,
  Mail,
  Phone,
  MapPin,
  Calendar,
  Briefcase,
  ArrowLeft,
  FileText,
  Package,
  AlertTriangle,
  Star,
  Banknote,
  Plus,
  Download,
  Shield,
  MessageSquare,
  Building2,
} from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import type {
  Employee,
  EmployeeSkill,
  PersonEvent,
  Document,
  EmployeeEquipment,
  EmployeeReview,
  SalaryRecord,
  SalaryRevision,
  OneToOneMeeting,
} from "@/types/domain";
import { logEmployeeAccess } from "@/services/gdpr";
import { getMeetingsForEmployee } from "@/services/oneToOne";

type TabId = "personal" | "contact" | "organisation" | "employment" | "compensation" | "competence" | "one-to-ones" | "documents" | "events" | "equipment";

type EmployeeData = {
  employee: Employee | null;
  skills: EmployeeSkill[];
  events: PersonEvent[];
  documents: Document[];
  equipment: EmployeeEquipment[];
  reviews: EmployeeReview[];
  currentSalary: SalaryRecord | null;
  salaryRevisions: SalaryRevision[];
  meetings: OneToOneMeeting[];
};

function InfoRow({ icon: Icon, label, value }: { icon: React.ElementType; label: string; value: string }) {
  return (
    <div className="flex items-start gap-3" data-testid={`info-${label.toLowerCase().replace(/\s+/g, "-")}`}>
      <Icon className="h-4 w-4 text-muted-foreground mt-0.5" />
      <div>
        <p className="text-sm text-muted-foreground">{label}</p>
        <p className="font-medium">{value}</p>
      </div>
    </div>
  );
}

export default function EmployeeDetailPage() {
  const params = useParams();
  const router = useRouter();
  const id = params.id as string;

  const [data, setData] = useState<EmployeeData>({
    employee: null,
    skills: [],
    events: [],
    documents: [],
    equipment: [],
    reviews: [],
    currentSalary: null,
    salaryRevisions: [],
    meetings: [],
  });
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<TabId>("personal");

  useEffect(() => {
    async function loadData() {
      const [
        employeeRes,
        skillsRes,
        eventsRes,
        docsRes,
        equipRes,
        reviewsRes,
        salaryRes,
        revisionsRes,
        meetingsData,
      ] = await Promise.all([
        supabase.from("employees").select("*, manager:manager_id(name)").eq("id", id).single(),
        supabase.from("employee_skills").select("*, skills(*)").eq("employee_id", id),
        supabase.from("person_events").select("*").eq("employee_id", id).order("due_date"),
        supabase.from("documents").select("*").eq("employee_id", id).order("created_at", { ascending: false }),
        supabase.from("employee_equipment").select("*, equipment(*)").eq("employee_id", id).eq("status", "assigned"),
        supabase.from("employee_reviews").select("*, manager:manager_id(name), template:template_id(name)").eq("employee_id", id).order("review_date", { ascending: false }),
        supabase.from("salary_records").select("*").eq("employee_id", id).order("effective_from", { ascending: false }).limit(1),
        supabase.from("salary_revisions").select("*, manager:decided_by_manager_id(name)").eq("employee_id", id).order("revision_date", { ascending: false }),
        getMeetingsForEmployee(id),
      ]);

      if (employeeRes.data) {
        try {
          await logEmployeeAccess(id, "view_profile");
        } catch (e) {
          console.error("Error logging access:", e);
        }
      }

      const empData = employeeRes.data;
      const managerData = empData?.manager as { name: string } | null;
      
      setData({
        employee: empData
          ? {
              id: empData.id,
              name: empData.name || "",
              firstName: empData.first_name || undefined,
              lastName: empData.last_name || undefined,
              employeeNumber: empData.employee_number || "",
              email: empData.email || undefined,
              phone: empData.phone || undefined,
              dateOfBirth: empData.date_of_birth || undefined,
              role: empData.role || "",
              line: empData.line || "",
              team: empData.team || "",
              employmentType: empData.employment_type || "permanent",
              startDate: empData.start_date || undefined,
              contractEndDate: empData.contract_end_date || undefined,
              managerId: empData.manager_id || undefined,
              managerName: managerData?.name || undefined,
              address: empData.address || undefined,
              city: empData.city || undefined,
              postalCode: empData.postal_code || undefined,
              country: empData.country || "Sweden",
              isActive: empData.is_active ?? true,
            }
          : null,
        skills: (skillsRes.data || []).map((row) => {
          const skill = row.skills as { name: string; code: string; category: string } | null;
          return {
            employeeId: row.employee_id,
            skillId: row.skill_id,
            level: row.level,
            skillName: skill?.name,
            skillCode: skill?.code,
            skillCategory: skill?.category,
          };
        }),
        events: (eventsRes.data || []).map((row) => ({
          id: row.id,
          employeeId: row.employee_id,
          category: row.category,
          title: row.title,
          description: row.description,
          dueDate: row.due_date,
          completedDate: row.completed_date,
          recurrence: row.recurrence,
          ownerManagerId: row.owner_manager_id,
          status: row.status,
          notes: row.notes,
        })),
        documents: (docsRes.data || []).map((row) => ({
          id: row.id,
          employeeId: row.employee_id,
          title: row.title,
          type: row.type,
          url: row.url,
          createdAt: row.created_at,
          validTo: row.valid_to,
        })),
        equipment: (equipRes.data || []).map((row) => {
          const equip = row.equipment as { name: string; serial_number: string } | null;
          return {
            id: row.id,
            employeeId: row.employee_id,
            equipmentId: row.equipment_id,
            equipmentName: equip?.name,
            serialNumber: equip?.serial_number,
            assignedDate: row.assigned_date,
            returnDate: row.return_date,
            status: row.status,
          };
        }),
        reviews: (reviewsRes.data || []).map((row) => {
          const manager = row.manager as { name: string } | null;
          const template = row.template as { name: string } | null;
          return {
            id: row.id,
            employeeId: row.employee_id,
            managerId: row.manager_id,
            managerName: manager?.name,
            templateId: row.template_id,
            templateName: template?.name,
            reviewDate: row.review_date,
            periodStart: row.period_start,
            periodEnd: row.period_end,
            overallRating: row.overall_rating,
            summary: row.summary,
            goals: row.goals,
            notes: row.notes,
            createdAt: row.created_at,
            updatedAt: row.updated_at,
          };
        }),
        currentSalary:
          salaryRes.data && salaryRes.data.length > 0
            ? {
                id: salaryRes.data[0].id,
                employeeId: salaryRes.data[0].employee_id,
                effectiveFrom: salaryRes.data[0].effective_from,
                salaryAmountSek: parseFloat(salaryRes.data[0].salary_amount_sek) || 0,
                salaryType: salaryRes.data[0].salary_type || "monthly",
                positionTitle: salaryRes.data[0].position_title || undefined,
                notes: salaryRes.data[0].notes || undefined,
                createdAt: salaryRes.data[0].created_at,
                createdBy: salaryRes.data[0].created_by || undefined,
              }
            : null,
        salaryRevisions: (revisionsRes.data || []).map((row) => {
          const manager = row.manager as { name: string } | null;
          return {
            id: row.id,
            employeeId: row.employee_id,
            revisionDate: row.revision_date,
            previousSalarySek: parseFloat(row.previous_salary_sek) || 0,
            newSalarySek: parseFloat(row.new_salary_sek) || 0,
            salaryType: row.salary_type || "monthly",
            reason: row.reason || undefined,
            decidedByManagerId: row.decided_by_manager_id || undefined,
            decidedByManagerName: manager?.name || undefined,
            documentId: row.document_id,
            createdAt: row.created_at,
          };
        }),
        meetings: meetingsData,
      });
      setLoading(false);
    }
    if (id) loadData();
  }, [id]);

  async function handleExportData() {
    const response = await fetch(`/api/gdpr/export-employee-data?employee_id=${id}`);
    const exportData = await response.json();
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `employee-data-${data.employee?.employeeNumber || id}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-48" />
          <div className="h-64 bg-muted rounded" />
        </div>
      </div>
    );
  }

  if (!data.employee) {
    return (
      <div className="p-6">
        <p className="text-muted-foreground">Employee not found</p>
        <Link href="/app/employees" className="text-primary hover:underline mt-2 inline-block">
          Back to employees
        </Link>
      </div>
    );
  }

  const { employee, skills, events, documents, equipment, reviews, currentSalary, salaryRevisions, meetings } = data;

  const navItems: { id: TabId; label: string; icon: React.ElementType; count?: number }[] = [
    { id: "personal", label: "Personal Data", icon: User },
    { id: "contact", label: "Contact Information", icon: Mail },
    { id: "organisation", label: "Organisation", icon: Building2 },
    { id: "employment", label: "Job & Employment", icon: Briefcase },
    { id: "compensation", label: "Compensation", icon: Banknote },
    { id: "competence", label: "Competence", icon: Star, count: skills.length },
    { id: "one-to-ones", label: "1:1 / Medarbetarsamtal", icon: MessageSquare, count: meetings.length },
    { id: "documents", label: "Documents", icon: FileText, count: documents.length },
    { id: "events", label: "People Risk & Tasks", icon: AlertTriangle, count: events.filter((e) => e.status !== "completed").length },
    { id: "equipment", label: "Equipment", icon: Package, count: equipment.length },
  ];

  const levelLabels = ["Not trained", "In training", "Can assist", "Trained", "Can train others"];

  const categoryLabels: Record<string, string> = {
    contract: "Contract",
    medical_check: "Medical Check",
    training: "Training",
    onboarding: "Onboarding",
    offboarding: "Offboarding",
    work_env_delegation: "Work Env Delegation",
    equipment: "Equipment",
  };

  const statusVariants: Record<string, "default" | "secondary" | "destructive" | "outline"> = {
    upcoming: "outline",
    due_soon: "default",
    overdue: "destructive",
    completed: "secondary",
  };

  return (
    <div className="flex h-full">
      <aside className="w-64 border-r bg-muted/30 p-4 flex flex-col">
        <div className="mb-6">
          <Button variant="ghost" size="sm" onClick={() => router.push("/app/employees")} data-testid="button-back">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
        </div>
        
        <div className="mb-6 px-2">
          <div className="flex items-center gap-3 mb-2">
            <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <User className="h-6 w-6 text-primary" />
            </div>
            <div>
              <h2 className="font-semibold" data-testid="text-employee-name">{employee.name}</h2>
              <p className="text-sm text-muted-foreground">{employee.role || "No role"}</p>
            </div>
          </div>
          <p className="text-xs text-muted-foreground px-1">{employee.employeeNumber}</p>
        </div>

        <nav className="flex-1 space-y-1">
          {navItems.map((item) => {
            const Icon = item.icon;
            const isActive = activeTab === item.id;
            return (
              <button
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={`w-full flex items-center justify-between gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                  isActive
                    ? "bg-primary text-primary-foreground"
                    : "text-muted-foreground hover-elevate"
                }`}
                data-testid={`nav-${item.id}`}
              >
                <span className="flex items-center gap-2">
                  <Icon className="h-4 w-4" />
                  {item.label}
                </span>
                {item.count !== undefined && item.count > 0 && (
                  <Badge variant={isActive ? "secondary" : "outline"} className="text-xs">
                    {item.count}
                  </Badge>
                )}
              </button>
            );
          })}
        </nav>

        <div className="mt-4 pt-4 border-t">
          <Button variant="outline" size="sm" className="w-full" onClick={handleExportData} data-testid="button-export-gdpr">
            <Shield className="h-4 w-4 mr-2" />
            Export Data (GDPR)
          </Button>
        </div>
      </aside>

      <main className="flex-1 overflow-auto p-6">
        {activeTab === "personal" && (
          <Card>
            <CardHeader>
              <CardTitle>Personal Data</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InfoRow icon={User} label="Full Name" value={employee.name} />
                <InfoRow icon={User} label="First Name" value={employee.firstName || "-"} />
                <InfoRow icon={User} label="Last Name" value={employee.lastName || "-"} />
                <InfoRow icon={Calendar} label="Date of Birth" value={employee.dateOfBirth ? new Date(employee.dateOfBirth).toLocaleDateString("sv-SE") : "-"} />
                <InfoRow icon={User} label="Employee Number" value={employee.employeeNumber} />
              </div>
            </CardContent>
          </Card>
        )}

        {activeTab === "contact" && (
          <Card>
            <CardHeader>
              <CardTitle>Contact Information</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InfoRow icon={Mail} label="Email" value={employee.email || "-"} />
                <InfoRow icon={Phone} label="Phone" value={employee.phone || "-"} />
                <InfoRow icon={MapPin} label="Address" value={employee.address || "-"} />
                <InfoRow icon={MapPin} label="City" value={employee.city || "-"} />
                <InfoRow icon={MapPin} label="Postal Code" value={employee.postalCode || "-"} />
                <InfoRow icon={MapPin} label="Country" value={employee.country || "Sweden"} />
              </div>
            </CardContent>
          </Card>
        )}

        {activeTab === "organisation" && (
          <Card>
            <CardHeader>
              <CardTitle>Organisation</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InfoRow icon={Building2} label="Line" value={employee.line || "-"} />
                <InfoRow icon={Building2} label="Team" value={employee.team || "-"} />
                <InfoRow icon={User} label="Manager" value={employee.managerName || "-"} />
              </div>
            </CardContent>
          </Card>
        )}

        {activeTab === "employment" && (
          <Card>
            <CardHeader>
              <CardTitle>Job & Employment</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InfoRow icon={Briefcase} label="Role" value={employee.role || "-"} />
                <InfoRow icon={Briefcase} label="Employment Type" value={employee.employmentType} />
                <InfoRow icon={Calendar} label="Start Date" value={employee.startDate ? new Date(employee.startDate).toLocaleDateString("sv-SE") : "-"} />
                <InfoRow icon={Calendar} label="Contract End Date" value={employee.contractEndDate ? new Date(employee.contractEndDate).toLocaleDateString("sv-SE") : "-"} />
                <InfoRow icon={User} label="Status" value={employee.isActive ? "Active" : "Inactive"} />
              </div>
            </CardContent>
          </Card>
        )}

        {activeTab === "compensation" && (
          <div className="space-y-6">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between gap-4">
                <CardTitle>Current Salary</CardTitle>
                <Link href={`/app/employees/${id}/salary/new`}>
                  <Button size="sm" data-testid="button-new-salary">
                    <Plus className="h-4 w-4 mr-2" />
                    New Revision
                  </Button>
                </Link>
              </CardHeader>
              <CardContent>
                {currentSalary ? (
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                      <p className="text-sm text-muted-foreground">Amount</p>
                      <p className="text-2xl font-bold">{currentSalary.salaryAmountSek.toLocaleString("sv-SE")} SEK</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Type</p>
                      <p className="font-medium capitalize">{currentSalary.salaryType}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Effective From</p>
                      <p className="font-medium">{new Date(currentSalary.effectiveFrom).toLocaleDateString("sv-SE")}</p>
                    </div>
                  </div>
                ) : (
                  <p className="text-muted-foreground">No salary record</p>
                )}
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Salary History</CardTitle>
              </CardHeader>
              <CardContent>
                {salaryRevisions.length === 0 ? (
                  <p className="text-muted-foreground text-center py-4">No salary revisions</p>
                ) : (
                  <div className="space-y-3">
                    {salaryRevisions.map((rev) => (
                      <div key={rev.id} className="flex items-center justify-between p-3 border rounded-md">
                        <div>
                          <p className="font-medium">
                            {rev.previousSalarySek.toLocaleString("sv-SE")} → {rev.newSalarySek.toLocaleString("sv-SE")} SEK
                          </p>
                          <p className="text-sm text-muted-foreground">{rev.reason || "No reason"}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm">{new Date(rev.revisionDate).toLocaleDateString("sv-SE")}</p>
                          {rev.decidedByManagerName && (
                            <p className="text-xs text-muted-foreground">by {rev.decidedByManagerName}</p>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        )}

        {activeTab === "competence" && (
          <Card>
            <CardHeader className="flex flex-row items-center justify-between gap-4">
              <CardTitle>Competence</CardTitle>
              <Link href={`/app/employees/${id}/competence`} className="hr-link" data-testid="link-competence-profile">
                Visa kompetensprofil →
              </Link>
            </CardHeader>
            <CardContent>
              {skills.length === 0 ? (
                <p className="text-muted-foreground text-center py-8">No competencies registered</p>
              ) : (
                <div className="space-y-3">
                  {skills.map((skill) => (
                    <div key={skill.skillId} className="flex items-center justify-between p-3 border rounded-md">
                      <div>
                        <p className="font-medium">{skill.skillName || "Unknown"}</p>
                        <p className="text-sm text-muted-foreground">{skill.skillCategory || "Uncategorized"}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="flex gap-1">
                          {[0, 1, 2, 3, 4].map((l) => (
                            <div
                              key={l}
                              className={`w-3 h-3 rounded-full ${l <= skill.level ? "bg-primary" : "bg-muted"}`}
                            />
                          ))}
                        </div>
                        <span className="text-sm text-muted-foreground w-24 text-right">
                          {levelLabels[skill.level]}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {activeTab === "one-to-ones" && (
          <Card>
            <CardHeader className="flex flex-row items-center justify-between gap-4">
              <CardTitle>1:1 Meetings / Medarbetarsamtal</CardTitle>
              <Link href={`/app/employees/${id}/one-to-ones`}>
                <Button size="sm" data-testid="button-view-all-meetings">
                  View All
                </Button>
              </Link>
            </CardHeader>
            <CardContent>
              {meetings.length === 0 ? (
                <div className="text-center py-8">
                  <p className="text-muted-foreground mb-4">No 1:1 meetings scheduled</p>
                  <Link href={`/app/employees/${id}/one-to-ones`}>
                    <Button data-testid="button-schedule-meeting">
                      <Plus className="h-4 w-4 mr-2" />
                      Schedule Meeting
                    </Button>
                  </Link>
                </div>
              ) : (
                <div className="space-y-3">
                  {meetings.slice(0, 5).map((meeting) => (
                    <Link key={meeting.id} href={`/app/one-to-ones/${meeting.id}`}>
                      <div className="flex items-center justify-between p-3 border rounded-md hover-elevate cursor-pointer">
                        <div>
                          <p className="font-medium">{meeting.templateName || "1:1 Meeting"}</p>
                          <p className="text-sm text-muted-foreground">
                            {new Date(meeting.scheduledAt).toLocaleDateString("sv-SE")} with {meeting.managerName}
                          </p>
                        </div>
                        <Badge variant={statusVariants[meeting.status] || "outline"}>
                          {meeting.status.replace("_", " ")}
                        </Badge>
                      </div>
                    </Link>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {activeTab === "documents" && (
          <Card>
            <CardHeader>
              <CardTitle>Documents</CardTitle>
            </CardHeader>
            <CardContent>
              {documents.length === 0 ? (
                <p className="text-muted-foreground text-center py-8">No documents</p>
              ) : (
                <div className="space-y-3">
                  {documents.map((doc) => (
                    <div key={doc.id} className="flex items-center justify-between p-3 border rounded-md">
                      <div className="flex items-center gap-3">
                        <FileText className="h-5 w-5 text-muted-foreground" />
                        <div>
                          <p className="font-medium">{doc.title}</p>
                          <p className="text-sm text-muted-foreground capitalize">{doc.type.replace("_", " ")}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        {doc.validTo && (
                          <span className="text-sm text-muted-foreground">
                            Valid to: {new Date(doc.validTo).toLocaleDateString("sv-SE")}
                          </span>
                        )}
                        <a href={doc.url} target="_blank" rel="noopener noreferrer">
                          <Button size="icon" variant="ghost">
                            <Download className="h-4 w-4" />
                          </Button>
                        </a>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {activeTab === "events" && (
          <Card>
            <CardHeader>
              <CardTitle>People Risk & Tasks</CardTitle>
            </CardHeader>
            <CardContent>
              {events.length === 0 ? (
                <p className="text-muted-foreground text-center py-8">No events or tasks</p>
              ) : (
                <div className="space-y-3">
                  {events.map((event) => (
                    <div key={event.id} className="flex items-center justify-between p-3 border rounded-md">
                      <div>
                        <p className="font-medium">{event.title}</p>
                        <p className="text-sm text-muted-foreground">
                          {categoryLabels[event.category] || event.category} &middot; Due: {new Date(event.dueDate).toLocaleDateString("sv-SE")}
                        </p>
                      </div>
                      <Badge variant={statusVariants[event.status] || "outline"}>
                        {event.status.replace("_", " ")}
                      </Badge>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {activeTab === "equipment" && (
          <Card>
            <CardHeader>
              <CardTitle>Equipment</CardTitle>
            </CardHeader>
            <CardContent>
              {equipment.length === 0 ? (
                <p className="text-muted-foreground text-center py-8">No equipment assigned</p>
              ) : (
                <div className="space-y-3">
                  {equipment.map((eq) => (
                    <div key={eq.id} className="flex items-center justify-between p-3 border rounded-md">
                      <div className="flex items-center gap-3">
                        <Package className="h-5 w-5 text-muted-foreground" />
                        <div>
                          <p className="font-medium">{eq.equipmentName || "Unknown"}</p>
                          <p className="text-sm text-muted-foreground">{eq.serialNumber}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <Badge variant="secondary">{eq.status}</Badge>
                        <p className="text-xs text-muted-foreground mt-1">
                          Assigned: {new Date(eq.assignedDate).toLocaleDateString("sv-SE")}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        )}
      </main>
    </div>
  );
}
</file>

<file path="app/employees/new/page.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { ArrowLeft, UserPlus, Loader2, AlertCircle } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { isDemoMode } from "@/lib/demoData";

export default function NewEmployeePage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showDemoMessage, setShowDemoMessage] = useState(false);
  const [formData, setFormData] = useState({
    firstName: "",
    lastName: "",
    email: "",
    employeeNumber: "",
    role: "",
    line: "",
    team: "",
    employmentType: "permanent",
    startDate: new Date().toISOString().split("T")[0],
  });

  const handleChange = (field: string, value: string) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    setError(null);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    
    if (!formData.firstName || !formData.lastName) {
      setError("Please enter first name and last name.");
      return;
    }

    if (isDemoMode()) {
      setShowDemoMessage(true);
      return;
    }

    setLoading(true);

    try {
      // Use only columns that exist in Supabase schema
      const { error: dbError } = await supabase.from("employees").insert({
        name: `${formData.firstName} ${formData.lastName}`,
        email: formData.email || null,
        employee_number: formData.employeeNumber || `EMP-${Date.now()}`,
        role: formData.role || "Employee",
        line: formData.line || null,
        team: formData.team || null,
        is_active: true,
      });

      if (dbError) throw dbError;

      router.push("/app/employees");
    } catch (err) {
      console.error("Error creating employee:", err);
      setError("Failed to create employee. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <Button
        variant="ghost"
        onClick={() => router.push("/app/employees")}
        className="mb-4"
        data-testid="button-back"
      >
        <ArrowLeft className="h-4 w-4 mr-2" />
        Back to Employees
      </Button>

      {showDemoMessage && (
        <Card className="mb-4 border-amber-200 bg-amber-50 dark:border-amber-800 dark:bg-amber-900/20">
          <CardContent className="py-4">
            <div className="flex items-start gap-3">
              <AlertCircle className="h-5 w-5 text-amber-600 dark:text-amber-400 mt-0.5" />
              <div>
                <p className="font-medium text-amber-800 dark:text-amber-200">Demo Mode</p>
                <p className="text-sm text-amber-700 dark:text-amber-300">
                  Employee creation is disabled in demo mode. Sign up for a full account to add employees.
                </p>
                <div className="flex gap-2 mt-3">
                  <Button size="sm" onClick={() => router.push("/signup")}>Sign Up</Button>
                  <Button size="sm" variant="outline" onClick={() => setShowDemoMessage(false)}>Dismiss</Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <UserPlus className="h-5 w-5" />
            Add New Employee
          </CardTitle>
        </CardHeader>
        <CardContent>
          {error && (
            <div className="mb-4 p-3 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
              <p className="text-sm text-red-700 dark:text-red-300 flex items-center gap-2">
                <AlertCircle className="h-4 w-4" />
                {error}
              </p>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="firstName">First Name *</Label>
                <Input
                  id="firstName"
                  value={formData.firstName}
                  onChange={(e) => handleChange("firstName", e.target.value)}
                  placeholder="Enter first name"
                  required
                  data-testid="input-first-name"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="lastName">Last Name *</Label>
                <Input
                  id="lastName"
                  value={formData.lastName}
                  onChange={(e) => handleChange("lastName", e.target.value)}
                  placeholder="Enter last name"
                  required
                  data-testid="input-last-name"
                />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                value={formData.email}
                onChange={(e) => handleChange("email", e.target.value)}
                placeholder="email@company.com"
                data-testid="input-email"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="employeeNumber">Employee Number</Label>
                <Input
                  id="employeeNumber"
                  value={formData.employeeNumber}
                  onChange={(e) => handleChange("employeeNumber", e.target.value)}
                  placeholder="EMP-001"
                  data-testid="input-employee-number"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="role">Role</Label>
                <Input
                  id="role"
                  value={formData.role}
                  onChange={(e) => handleChange("role", e.target.value)}
                  placeholder="e.g., Operator, Technician"
                  data-testid="input-role"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="line">Line</Label>
                <Input
                  id="line"
                  value={formData.line}
                  onChange={(e) => handleChange("line", e.target.value)}
                  placeholder="e.g., Production Line 1"
                  data-testid="input-line"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="team">Team</Label>
                <Input
                  id="team"
                  value={formData.team}
                  onChange={(e) => handleChange("team", e.target.value)}
                  placeholder="e.g., Assembly Team"
                  data-testid="input-team"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="employmentType">Employment Type</Label>
                <Select
                  value={formData.employmentType}
                  onValueChange={(value) => handleChange("employmentType", value)}
                >
                  <SelectTrigger data-testid="select-employment-type">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="permanent">Permanent</SelectItem>
                    <SelectItem value="temporary">Temporary</SelectItem>
                    <SelectItem value="consultant">Consultant</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label htmlFor="startDate">Start Date</Label>
                <Input
                  id="startDate"
                  type="date"
                  value={formData.startDate}
                  onChange={(e) => handleChange("startDate", e.target.value)}
                  data-testid="input-start-date"
                />
              </div>
            </div>

            <div className="flex gap-3 pt-4">
              <Button type="submit" disabled={loading} data-testid="button-save">
                {loading ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <UserPlus className="h-4 w-4 mr-2" />
                    Add Employee
                  </>
                )}
              </Button>
              <Button
                type="button"
                variant="outline"
                onClick={() => router.push("/app/employees")}
                data-testid="button-cancel"
              >
                Cancel
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/employees/page.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { Users, Search, ChevronRight, Upload, UserPlus } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { COPY } from "@/lib/copy";
import { isDemoMode, getDemoEmployees } from "@/lib/demoRuntime";
import { useOrg } from "@/hooks/useOrg";
import type { Employee } from "@/types/domain";

export default function EmployeesPage() {
  const router = useRouter();
  const { currentOrg } = useOrg();
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [lineFilter, setLineFilter] = useState<string>("");

  useEffect(() => {
    async function loadEmployees() {
      if (isDemoMode()) {
        setEmployees(getDemoEmployees());
        setLoading(false);
        return;
      }

      if (!currentOrg) {
        setLoading(false);
        return;
      }

      // Note: org_id filtering disabled until Supabase schema is updated
      const { data, error } = await supabase
        .from("employees")
        .select("*")
        .eq("is_active", true)
        .order("name");

      if (!error && data) {
        setEmployees(
          data.map((row) => ({
            id: row.id,
            name: row.name || "",
            firstName: row.first_name || undefined,
            lastName: row.last_name || undefined,
            employeeNumber: row.employee_number || "",
            email: row.email || undefined,
            phone: row.phone || undefined,
            dateOfBirth: row.date_of_birth || undefined,
            role: row.role || "",
            line: row.line || "",
            team: row.team || "",
            employmentType: row.employment_type || "permanent",
            startDate: row.start_date || undefined,
            contractEndDate: row.contract_end_date || undefined,
            managerId: row.manager_id || undefined,
            managerName: undefined,
            address: row.address || undefined,
            city: row.city || undefined,
            postalCode: row.postal_code || undefined,
            country: row.country || "Sweden",
            isActive: row.is_active ?? true,
          }))
        );
      } else if (error) {
        console.error("Error loading employees:", error);
      }
      setLoading(false);
    }
    loadEmployees();
  }, [currentOrg]);

  const lines = [...new Set(employees.map((e) => e.line).filter(Boolean))].sort();

  const filteredEmployees = employees.filter((e) => {
    const matchesSearch =
      !searchTerm ||
      e.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      e.employeeNumber.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesLine = !lineFilter || e.line === lineFilter;
    return matchesSearch && matchesLine;
  });

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  if (employees.length === 0) {
    return (
      <div className="p-6">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <Users className="h-6 w-6 text-gray-600 dark:text-gray-400" />
            <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
              Employees
            </h1>
          </div>
          <div className="flex items-center gap-2">
            <Button onClick={() => router.push("/app/import-employees")} data-testid="button-import-csv">
              <Upload className="h-4 w-4 mr-2" />
              {COPY.actions.importCsv}
            </Button>
            <Button variant="outline" onClick={() => router.push("/app/employees/new")} data-testid="button-add-employee">
              <UserPlus className="h-4 w-4 mr-2" />
              {COPY.actions.addEmployee}
            </Button>
          </div>
        </div>

        <Card>
          <CardContent className="py-12 text-center">
            <Users className="h-12 w-12 mx-auto text-gray-400 mb-4" />
            <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
              {COPY.emptyStates.employees.title}
            </h2>
            <p className="text-gray-500 dark:text-gray-400 mb-6 max-w-md mx-auto">
              {COPY.emptyStates.employees.description}
            </p>
            <div className="flex items-center justify-center gap-3">
              <Button onClick={() => router.push("/app/import-employees")} data-testid="button-import-csv-empty">
                <Upload className="h-4 w-4 mr-2" />
                {COPY.actions.importCsv}
              </Button>
              <Button variant="outline" onClick={() => router.push("/app/employees/new")} data-testid="button-add-employee-empty">
                <UserPlus className="h-4 w-4 mr-2" />
                {COPY.actions.addEmployee}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6 gap-4 flex-wrap">
        <div className="flex items-center gap-3">
          <Users className="h-6 w-6 text-gray-600 dark:text-gray-400" />
          <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
            Employees
          </h1>
          <span className="text-sm text-gray-500 dark:text-gray-400">
            ({filteredEmployees.length})
          </span>
        </div>
        <div className="flex items-center gap-2">
          <Button onClick={() => router.push("/app/import-employees")} data-testid="button-import-csv">
            <Upload className="h-4 w-4 mr-2" />
            {COPY.actions.importCsv}
          </Button>
          <Button variant="outline" onClick={() => router.push("/app/employees/new")} data-testid="button-add-employee">
            <UserPlus className="h-4 w-4 mr-2" />
            {COPY.actions.addEmployee}
          </Button>
        </div>
      </div>

      <div className="flex flex-wrap gap-3 mb-6">
        <div className="relative flex-1 min-w-[200px] max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
          <input
            type="text"
            placeholder="Search by name or employee number..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            data-testid="input-search-employees"
          />
        </div>
        <select
          value={lineFilter}
          onChange={(e) => setLineFilter(e.target.value)}
          className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          data-testid="select-line-filter"
        >
          <option value="">All Lines</option>
          {lines.map((line) => (
            <option key={line} value={line}>
              {line}
            </option>
          ))}
        </select>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Name
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Employee No
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Line
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Team
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Role
              </th>
              <th className="w-10" />
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
            {filteredEmployees.map((employee) => (
              <tr
                key={employee.id}
                className="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                data-testid={`row-employee-${employee.id}`}
              >
                <td className="px-4 py-3">
                  <Link
                    href={`/app/employees/${employee.id}`}
                    className="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400"
                    data-testid={`link-employee-${employee.id}`}
                  >
                    {employee.name}
                  </Link>
                </td>
                <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                  {employee.employeeNumber}
                </td>
                <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                  {employee.line || "-"}
                </td>
                <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                  {employee.team || "-"}
                </td>
                <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                  {employee.role || "-"}
                </td>
                <td className="px-4 py-3">
                  <Link
                    href={`/app/employees/${employee.id}`}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    <ChevronRight className="h-4 w-4" />
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="app/equipment/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Plus, Package, CheckCircle, Loader2 } from "lucide-react";
import type { Equipment, Employee } from "@/types/domain";

interface EquipmentWithAssignment extends Equipment {
  assignedTo?: string;
  assignmentId?: string;
  assignmentStatus?: string;
}

export default function EquipmentPage() {
  const [equipment, setEquipment] = useState<EquipmentWithAssignment[]>([]);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newEquipment, setNewEquipment] = useState({ name: "", serialNumber: "", category: "" });

  const fetchData = async () => {
    setLoading(true);

    const { data: equipmentData } = await supabase.from("equipment").select("*");
    const { data: assignmentsData } = await supabase
      .from("employee_equipment")
      .select("*, employees:employee_id(name)")
      .eq("status", "assigned");
    const { data: employeesData } = await supabase
      .from("employees")
      .select("id, name, employee_number, role, line, team, is_active")
      .eq("is_active", true);

    const equipmentWithAssignments: EquipmentWithAssignment[] = (equipmentData || []).map((eq: any) => {
      const assignment = (assignmentsData || []).find((a: any) => a.equipment_id === eq.id);
      return {
        id: eq.id,
        name: eq.name,
        serialNumber: eq.serial_number,
        category: eq.category,
        requiredForRole: eq.required_for_role,
        assignedTo: assignment?.employees?.name,
        assignmentId: assignment?.id,
        assignmentStatus: assignment?.status,
      };
    });

    setEquipment(equipmentWithAssignments);
    setEmployees((employeesData || []).map((e: any) => ({
      id: e.id,
      name: e.name,
      employeeNumber: e.employee_number,
      role: e.role,
      line: e.line,
      team: e.team,
      employmentType: 'permanent',
      isActive: e.is_active,
    })));
    setLoading(false);
  };

  useEffect(() => {
    fetchData();
  }, []);

  const handleAddEquipment = async () => {
    if (!newEquipment.name || !newEquipment.serialNumber) return;

    await supabase.from("equipment").insert({
      name: newEquipment.name,
      serial_number: newEquipment.serialNumber,
      category: newEquipment.category || null,
    });

    setNewEquipment({ name: "", serialNumber: "", category: "" });
    setShowAddForm(false);
    fetchData();
  };

  const handleAssignEquipment = async (equipmentId: string, employeeId: string) => {
    const returnDate = new Date();
    returnDate.setFullYear(returnDate.getFullYear() + 1);

    await supabase.from("employee_equipment").insert({
      equipment_id: equipmentId,
      employee_id: employeeId,
      assigned_date: new Date().toISOString().slice(0, 10),
      return_date: returnDate.toISOString().slice(0, 10),
      status: "assigned",
    });

    fetchData();
  };

  const handleReturnEquipment = async (assignmentId: string) => {
    await supabase
      .from("employee_equipment")
      .update({ status: "returned", return_date: new Date().toISOString().slice(0, 10) })
      .eq("id", assignmentId);

    fetchData();
  };

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-semibold">Equipment Management</h1>
        <Button onClick={() => setShowAddForm(!showAddForm)} data-testid="button-add-equipment">
          <Plus className="h-4 w-4 mr-2" />
          Add Equipment
        </Button>
      </div>

      {showAddForm && (
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="text-lg">Add New Equipment</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <Input
                placeholder="Name"
                value={newEquipment.name}
                onChange={(e) => setNewEquipment({ ...newEquipment, name: e.target.value })}
                data-testid="input-equipment-name"
              />
              <Input
                placeholder="Serial Number"
                value={newEquipment.serialNumber}
                onChange={(e) => setNewEquipment({ ...newEquipment, serialNumber: e.target.value })}
                data-testid="input-equipment-serial"
              />
              <Input
                placeholder="Category"
                value={newEquipment.category}
                onChange={(e) => setNewEquipment({ ...newEquipment, category: e.target.value })}
                data-testid="input-equipment-category"
              />
            </div>
            <Button className="mt-4" onClick={handleAddEquipment} data-testid="button-save-equipment">
              Save Equipment
            </Button>
          </CardContent>
        </Card>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {equipment.map((eq) => (
          <Card key={eq.id} data-testid={`card-equipment-${eq.id}`}>
            <CardHeader className="pb-2">
              <div className="flex items-start justify-between gap-2">
                <CardTitle className="text-base flex items-center gap-2">
                  <Package className="h-4 w-4" />
                  {eq.name}
                </CardTitle>
                {eq.assignedTo ? (
                  <Badge variant="secondary">Assigned</Badge>
                ) : (
                  <Badge variant="outline">Available</Badge>
                )}
              </div>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground mb-2">S/N: {eq.serialNumber}</p>
              {eq.category && <p className="text-sm text-muted-foreground mb-2">Category: {eq.category}</p>}

              {eq.assignedTo ? (
                <div className="mt-3">
                  <p className="text-sm mb-2">Assigned to: <span className="font-medium">{eq.assignedTo}</span></p>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => eq.assignmentId && handleReturnEquipment(eq.assignmentId)}
                    data-testid={`button-return-${eq.id}`}
                  >
                    <CheckCircle className="h-3 w-3 mr-1" />
                    Mark Returned
                  </Button>
                </div>
              ) : (
                <div className="mt-3">
                  <Select onValueChange={(value: string) => handleAssignEquipment(eq.id, value)}>
                    <SelectTrigger data-testid={`select-assign-${eq.id}`}>
                      <SelectValue placeholder="Assign to employee..." />
                    </SelectTrigger>
                    <SelectContent>
                      {employees.map((emp) => (
                        <SelectItem key={emp.id} value={emp.id}>
                          {emp.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              )}
            </CardContent>
          </Card>
        ))}

        {equipment.length === 0 && (
          <div className="col-span-full text-center py-12 text-muted-foreground">
            No equipment registered. Click &quot;Add Equipment&quot; to get started.
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/gaps/page.tsx">
"use client";

import { useState, useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { 
  AlertTriangle, 
  Download, 
  TrendingUp, 
  Users, 
  Lightbulb,
  RefreshCw
} from "lucide-react";
import { isDemoMode } from "@/lib/demoRuntime";

interface GapRow {
  employee: string;
  employeeId: string;
  skill: string;
  skillCode: string;
  requiredLevel: number;
  currentLevel: number;
  severity: "OK" | "GAP" | "RISK";
  suggestedAction: "No action" | "Train" | "Swap" | "Buddy";
}

interface GapSummary {
  employeesAtRisk: number;
  topMissingSkills: { skill: string; count: number }[];
  fastestFix: string | null;
}

const demoPositions = ["Pressline 1", "Pressline 2", "Assembly", "Quality Control", "Logistics"];
const demoShifts = ["Day", "Night", "Weekend"];

const demoGapsData: GapRow[] = [
  { employee: "Erik Johansson", employeeId: "E1002", skill: "Truck A1 License", skillCode: "TRUCK_A1", requiredLevel: 2, currentLevel: 0, severity: "RISK", suggestedAction: "Train" },
  { employee: "Karl Andersson", employeeId: "E1004", skill: "Pressline B", skillCode: "PRESS_B", requiredLevel: 2, currentLevel: 0, severity: "RISK", suggestedAction: "Buddy" },
  { employee: "Karl Andersson", employeeId: "E1004", skill: "Safety Basic", skillCode: "SAFETY_BASIC", requiredLevel: 3, currentLevel: 1, severity: "RISK", suggestedAction: "Train" },
  { employee: "Erik Johansson", employeeId: "E1002", skill: "Pressline B", skillCode: "PRESS_B", requiredLevel: 2, currentLevel: 1, severity: "GAP", suggestedAction: "Buddy" },
  { employee: "Erik Johansson", employeeId: "E1002", skill: "Safety Basic", skillCode: "SAFETY_BASIC", requiredLevel: 3, currentLevel: 2, severity: "GAP", suggestedAction: "Train" },
  { employee: "Anna Lindberg", employeeId: "E1001", skill: "Truck A1 License", skillCode: "TRUCK_A1", requiredLevel: 2, currentLevel: 1, severity: "GAP", suggestedAction: "Swap" },
  { employee: "Maria Svensson", employeeId: "E1003", skill: "Truck A1 License", skillCode: "TRUCK_A1", requiredLevel: 3, currentLevel: 2, severity: "GAP", suggestedAction: "Train" },
  { employee: "Anna Lindberg", employeeId: "E1001", skill: "Pressline A", skillCode: "PRESS_A", requiredLevel: 4, currentLevel: 3, severity: "OK", suggestedAction: "No action" },
];

function computeSummary(gaps: GapRow[]): GapSummary {
  const riskEmployees = new Set(
    gaps.filter(g => g.severity === "RISK" || g.severity === "GAP").map(g => g.employeeId)
  );
  
  const skillCounts: Record<string, number> = {};
  gaps.filter(g => g.severity !== "OK").forEach(g => {
    skillCounts[g.skill] = (skillCounts[g.skill] || 0) + 1;
  });
  
  const topMissingSkills = Object.entries(skillCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([skill, count]) => ({ skill, count }));

  const swapCandidate = gaps.find(g => g.suggestedAction === "Swap");
  const fastestFix = swapCandidate 
    ? `Swap ${swapCandidate.employee} to cover ${swapCandidate.skill}`
    : gaps.length > 0 ? "Schedule training for highest priority gaps" : null;

  return {
    employeesAtRisk: riskEmployees.size,
    topMissingSkills,
    fastestFix,
  };
}

function getSeverityBadge(severity: "OK" | "GAP" | "RISK") {
  switch (severity) {
    case "OK":
      return <Badge className="bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300 border-emerald-200 dark:border-emerald-800">OK</Badge>;
    case "GAP":
      return <Badge className="bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300 border-amber-200 dark:border-amber-800">GAP</Badge>;
    case "RISK":
      return <Badge className="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 border-red-200 dark:border-red-800">RISK</Badge>;
  }
}

function exportToCSV(gaps: GapRow[], dateStr: string) {
  const headers = ["Employee", "Skill", "Required Level", "Current Level", "Severity", "Suggested Action"];
  const rows = gaps.map(g => [
    g.employee,
    g.skill,
    g.requiredLevel.toString(),
    g.currentLevel.toString(),
    g.severity,
    g.suggestedAction,
  ]);
  
  const csvContent = [
    headers.join(","),
    ...rows.map(r => r.map(cell => `"${cell}"`).join(","))
  ].join("\n");
  
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", `gaps-${dateStr}.csv`);
  link.style.visibility = "hidden";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

export default function GapsPage() {
  const [position, setPosition] = useState<string>("");
  const [shift, setShift] = useState<string>("");
  const [generated, setGenerated] = useState(false);
  const [loading, setLoading] = useState(false);
  const [gaps, setGaps] = useState<GapRow[]>([]);

  const demoMode = isDemoMode();
  
  const targetDate = new Date();
  targetDate.setDate(targetDate.getDate() + 1);
  const dateStr = targetDate.toISOString().slice(0, 10);
  const formattedDate = targetDate.toLocaleDateString("en-US", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });

  const summary = useMemo(() => computeSummary(gaps), [gaps]);

  async function handleGenerate() {
    if (!position) return;
    
    setLoading(true);
    
    await new Promise(resolve => setTimeout(resolve, 500));
    
    if (demoMode) {
      const filteredGaps = demoGapsData.filter(g => {
        if (shift && shift !== "all") {
          return true;
        }
        return true;
      });
      setGaps(filteredGaps);
    } else {
      setGaps([]);
    }
    
    setGenerated(true);
    setLoading(false);
  }

  function handleExport() {
    exportToCSV(gaps, dateStr);
  }

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl font-bold mb-1" data-testid="heading-tomorrows-gaps">
          Tomorrow's Gaps
        </h1>
        <p className="text-sm text-muted-foreground" data-testid="text-target-date">
          Target date: {formattedDate}
        </p>
      </div>

      <Card className="mb-6">
        <CardContent className="pt-6">
          <div className="flex flex-wrap items-end gap-4">
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block">Position / Line</label>
              <Select value={position} onValueChange={setPosition}>
                <SelectTrigger data-testid="select-position">
                  <SelectValue placeholder="Select position..." />
                </SelectTrigger>
                <SelectContent>
                  {demoPositions.map(p => (
                    <SelectItem key={p} value={p}>{p}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            
            <div className="flex-1 min-w-[200px]">
              <label className="text-sm font-medium mb-2 block">Shift (optional)</label>
              <Select value={shift} onValueChange={setShift}>
                <SelectTrigger data-testid="select-shift">
                  <SelectValue placeholder="All shifts" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All shifts</SelectItem>
                  {demoShifts.map(s => (
                    <SelectItem key={s} value={s}>{s}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            
            <Button 
              onClick={handleGenerate} 
              disabled={!position || loading}
              className="min-w-[140px]"
              data-testid="button-generate-gaps"
            >
              {loading ? (
                <>
                  <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                  Generating...
                </>
              ) : (
                <>
                  <TrendingUp className="h-4 w-4 mr-2" />
                  Generate Gaps
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>

      {generated && (
        <>
          <Card className="mb-6 border-l-4 border-l-primary" data-testid="card-summary">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-amber-500" />
                What to Fix
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="flex items-start gap-3">
                  <div className="p-2 rounded-md bg-red-100 dark:bg-red-900/30">
                    <Users className="h-5 w-5 text-red-600 dark:text-red-400" />
                  </div>
                  <div>
                    <p className="text-2xl font-bold" data-testid="text-employees-at-risk">
                      {summary.employeesAtRisk}
                    </p>
                    <p className="text-sm text-muted-foreground">Employees at Risk</p>
                  </div>
                </div>
                
                <div>
                  <p className="text-sm font-medium mb-2">Top Missing Skills</p>
                  <div className="space-y-1" data-testid="list-missing-skills">
                    {summary.topMissingSkills.length > 0 ? (
                      summary.topMissingSkills.map((item, i) => (
                        <div key={i} className="flex items-center justify-between text-sm">
                          <span>{item.skill}</span>
                          <Badge variant="outline" className="text-xs">{item.count}</Badge>
                        </div>
                      ))
                    ) : (
                      <p className="text-sm text-muted-foreground">No gaps found</p>
                    )}
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="p-2 rounded-md bg-green-100 dark:bg-green-900/30">
                    <Lightbulb className="h-5 w-5 text-green-600 dark:text-green-400" />
                  </div>
                  <div>
                    <p className="text-sm font-medium mb-1">Fastest Fix</p>
                    <p className="text-sm text-muted-foreground" data-testid="text-fastest-fix">
                      {summary.fastestFix || "No immediate action needed"}
                    </p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold">Gaps Table</h2>
            <Button 
              variant="outline" 
              onClick={handleExport}
              disabled={gaps.length === 0}
              data-testid="button-export-csv"
            >
              <Download className="h-4 w-4 mr-2" />
              Export CSV
            </Button>
          </div>

          <Card>
            <div className="overflow-x-auto">
              <table className="w-full" data-testid="gaps-table">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Employee
                    </th>
                    <th className="text-left p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Skill
                    </th>
                    <th className="text-center p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Required
                    </th>
                    <th className="text-center p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Current
                    </th>
                    <th className="text-center p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Severity
                    </th>
                    <th className="text-left p-3 text-sm font-medium text-muted-foreground bg-muted/50">
                      Suggested Action
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {gaps.length === 0 ? (
                    <tr>
                      <td colSpan={6} className="p-6 text-center text-muted-foreground" data-testid="no-gaps-message">
                        No competence gaps found for tomorrow.
                      </td>
                    </tr>
                  ) : (
                    gaps.map((gap, index) => (
                      <tr 
                        key={`${gap.employeeId}-${gap.skillCode}-${index}`}
                        className={`border-b last:border-0 ${index % 2 === 0 ? "bg-muted/20" : ""}`}
                        data-testid={`row-gap-${index}`}
                      >
                        <td className="p-3 text-sm font-medium">{gap.employee}</td>
                        <td className="p-3 text-sm">
                          <div>{gap.skill}</div>
                          <div className="text-xs text-muted-foreground">{gap.skillCode}</div>
                        </td>
                        <td className="p-3 text-sm text-center">{gap.requiredLevel}</td>
                        <td className="p-3 text-sm text-center">{gap.currentLevel}</td>
                        <td className="p-3 text-center">{getSeverityBadge(gap.severity)}</td>
                        <td className="p-3 text-sm">{gap.suggestedAction}</td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </Card>
        </>
      )}

      {!generated && (
        <Card className="border-dashed">
          <CardContent className="py-12 text-center">
            <TrendingUp className="h-12 w-12 mx-auto text-muted-foreground/50 mb-4" />
            <p className="text-muted-foreground">
              Select a position and click "Generate Gaps" to analyze tomorrow's skill coverage.
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="app/handbooks/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { BookOpen, FileText, ExternalLink } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import type { Document } from "@/types/domain";

export default function HandbooksPage() {
  const [documents, setDocuments] = useState<Document[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadHandbooks() {
      const { data, error } = await supabase
        .from("documents")
        .select("*")
        .in("type", ["employee_handbook", "manager_handbook", "handbook"])
        .order("title");

      if (!error && data) {
        setDocuments(
          data.map((row) => ({
            id: row.id,
            employeeId: row.employee_id,
            title: row.title,
            type: row.type,
            url: row.url,
            createdAt: row.created_at,
            validTo: row.valid_to,
          }))
        );
      }
      setLoading(false);
    }
    loadHandbooks();
  }, []);

  const employeeHandbooks = documents.filter((d) => d.type === "employee_handbook" || (d.type === "handbook" && d.title.toLowerCase().includes("employee")));
  const managerHandbooks = documents.filter((d) => d.type === "manager_handbook" || (d.type === "handbook" && d.title.toLowerCase().includes("manager")));
  const otherHandbooks = documents.filter((d) => !employeeHandbooks.includes(d) && !managerHandbooks.includes(d));

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center gap-3 mb-6">
        <BookOpen className="h-6 w-6 text-gray-600 dark:text-gray-400" />
        <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
          Digital Handbooks
        </h1>
      </div>

      {documents.length === 0 ? (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8 text-center">
          <BookOpen className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <p className="text-gray-500 dark:text-gray-400">No handbooks available</p>
        </div>
      ) : (
        <div className="space-y-8">
          {employeeHandbooks.length > 0 && (
            <section>
              <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                Employee Handbooks
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {employeeHandbooks.map((doc) => (
                  <HandbookCard key={doc.id} document={doc} />
                ))}
              </div>
            </section>
          )}

          {managerHandbooks.length > 0 && (
            <section>
              <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                Manager Handbooks
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {managerHandbooks.map((doc) => (
                  <HandbookCard key={doc.id} document={doc} />
                ))}
              </div>
            </section>
          )}

          {otherHandbooks.length > 0 && (
            <section>
              <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                Other Handbooks
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {otherHandbooks.map((doc) => (
                  <HandbookCard key={doc.id} document={doc} />
                ))}
              </div>
            </section>
          )}
        </div>
      )}
    </div>
  );
}

function HandbookCard({ document }: { document: Document }) {
  return (
    <a
      href={document.url}
      target="_blank"
      rel="noopener noreferrer"
      className="block bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 hover:border-blue-300 dark:hover:border-blue-700 transition-colors"
      data-testid={`link-handbook-${document.id}`}
    >
      <div className="flex items-start gap-3">
        <div className="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-400" />
        </div>
        <div className="flex-1 min-w-0">
          <h3 className="font-medium text-gray-900 dark:text-white truncate">
            {document.title}
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
            Added {new Date(document.createdAt).toLocaleDateString()}
          </p>
        </div>
        <ExternalLink className="h-4 w-4 text-gray-400 flex-shrink-0" />
      </div>
    </a>
  );
}
</file>

<file path="app/hr/analytics/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Users, AlertTriangle, Calendar, TrendingUp, Activity, BarChart3, Clock, Shield, UserMinus, Workflow } from "lucide-react";
import { getHRAnalyticsV2 } from "@/services/analytics";
import { getCurrentUser } from "@/lib/auth";
import type { HRAnalyticsV2 } from "@/types/domain";

function MetricCard({
  title,
  value,
  icon: Icon,
  description,
  testId,
}: {
  title: string;
  value: string | number;
  icon: React.ElementType;
  description?: string;
  testId: string;
}) {
  return (
    <Card>
      <CardContent className="pt-6">
        <div className="flex items-start justify-between gap-4">
          <div>
            <p className="text-sm text-muted-foreground">{title}</p>
            <p className="text-3xl font-bold mt-1" data-testid={testId}>
              {value}
            </p>
            {description && (
              <p className="text-sm text-muted-foreground mt-1">{description}</p>
            )}
          </div>
          <div className="p-3 bg-primary/10 rounded-lg">
            <Icon className="h-6 w-6 text-primary" />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function getRiskColor(riskIndex: number): "destructive" | "default" | "secondary" {
  if (riskIndex >= 0.5) return "destructive";
  if (riskIndex >= 0.2) return "default";
  return "secondary";
}

export default function HRAnalyticsPage() {
  const [analytics, setAnalytics] = useState<HRAnalyticsV2 | null>(null);
  const [loading, setLoading] = useState(true);
  const [authorized, setAuthorized] = useState(true);

  useEffect(() => {
    async function loadData() {
      const user = await getCurrentUser();
      if (!user || user.role !== "HR_ADMIN") {
        setAuthorized(false);
        setLoading(false);
        return;
      }

      const data = await getHRAnalyticsV2();
      setAnalytics(data);
      setLoading(false);
    }
    loadData();
  }, []);

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-1/3" />
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-32 bg-muted rounded" />
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (!authorized) {
    return (
      <div className="p-6">
        <Card>
          <CardContent className="py-12 text-center">
            <AlertTriangle className="h-12 w-12 text-destructive mx-auto mb-4" />
            <h2 className="text-xl font-bold mb-2">Access Denied</h2>
            <p className="text-muted-foreground">
              This page is only accessible to HR Administrators.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!analytics) {
    return (
      <div className="p-6">
        <p className="text-muted-foreground">Unable to load analytics</p>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold" data-testid="text-page-title">
          HR Analytics Dashboard
        </h1>
        <p className="text-muted-foreground">Key workforce metrics and insights</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <MetricCard
          title="Total Headcount"
          value={analytics.totalHeadcount}
          icon={Users}
          description="Active employees"
          testId="metric-headcount"
        />
        <MetricCard
          title="Sick Leave Rate"
          value={analytics.absencesAvailable ? `${analytics.sickLeaveRatio}%` : "N/A"}
          icon={Activity}
          description={analytics.absencesAvailable ? "Last 30 days" : "Data not available"}
          testId="metric-sick-leave"
        />
        <MetricCard
          title="Contracts Ending"
          value={analytics.temporaryContractsEndingSoon}
          icon={Calendar}
          description="Within 90 days"
          testId="metric-contracts-ending"
        />
        <MetricCard
          title="Critical Events"
          value={analytics.criticalEventsByStatus.overdue + analytics.criticalEventsByStatus.dueSoon}
          icon={AlertTriangle}
          description={`${analytics.criticalEventsByStatus.overdue} overdue, ${analytics.criticalEventsByStatus.dueSoon} due soon`}
          testId="metric-critical-events"
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Users className="h-5 w-5" />
              Headcount by Unit & Employment Type
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.headcountByOrgUnit.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No data available</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b">
                      <th className="text-left py-2">Unit</th>
                      <th className="text-center py-2">Perm</th>
                      <th className="text-center py-2">Temp</th>
                      <th className="text-center py-2">Cons</th>
                      <th className="text-right py-2">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {analytics.headcountByOrgUnit.map((item) => (
                      <tr key={item.orgUnitName} className="border-b last:border-0">
                        <td className="py-2">{item.orgUnitName}</td>
                        <td className="text-center py-2">{item.permanent}</td>
                        <td className="text-center py-2">{item.temporary}</td>
                        <td className="text-center py-2">{item.consultant}</td>
                        <td className="text-right py-2 font-medium">{item.count}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Clock className="h-5 w-5" />
              Temporary Contracts Ending (90 days)
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.temporaryContractsEndingList.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No contracts ending soon</p>
            ) : (
              <div className="space-y-3 max-h-64 overflow-y-auto">
                {analytics.temporaryContractsEndingList.map((emp) => (
                  <div key={emp.id} className="flex items-center justify-between gap-4 py-2 border-b last:border-0">
                    <div>
                      <p className="font-medium">{emp.name}</p>
                      <p className="text-sm text-muted-foreground">{emp.role}</p>
                    </div>
                    <Badge variant="outline">
                      {new Date(emp.contractEndDate).toLocaleDateString("sv-SE")}
                    </Badge>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5" />
              Critical Events by Category
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.criticalEventsCount.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No critical events</p>
            ) : (
              <div className="space-y-3">
                {analytics.criticalEventsCount.map((item) => (
                  <div key={item.category} className="flex items-center justify-between gap-4">
                    <span className="text-sm capitalize">{item.category.replace(/_/g, " ")}</span>
                    <Badge
                      variant={item.count > 5 ? "destructive" : item.count > 2 ? "default" : "secondary"}
                    >
                      {item.count}
                    </Badge>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Shield className="h-5 w-5" />
              People Risk Index by Unit
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.riskIndexByUnit.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No data available</p>
            ) : (
              <div className="space-y-3">
                {analytics.riskIndexByUnit.slice(0, 8).map((item) => (
                  <div key={item.unitName} className="flex items-center justify-between gap-4">
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate">{item.unitName}</p>
                      <p className="text-xs text-muted-foreground">
                        {item.overdueCount} overdue, {item.dueSoonCount} due soon / {item.headcount} staff
                      </p>
                    </div>
                    <Badge variant={getRiskColor(item.riskIndex)}>
                      {item.riskIndex.toFixed(2)}
                    </Badge>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <TrendingUp className="h-5 w-5" />
              Employment Type Distribution
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.headcountByEmploymentType.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No data available</p>
            ) : (
              <div className="space-y-3">
                {analytics.headcountByEmploymentType.map((item) => (
                  <div key={item.type} className="flex items-center justify-between gap-4">
                    <span className="text-sm capitalize">{item.type}</span>
                    <div className="flex items-center gap-2">
                      <Progress
                        value={(item.count / analytics.totalHeadcount) * 100}
                        className="w-24 h-2"
                      />
                      <span className="text-sm font-medium w-8 text-right">{item.count}</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <BarChart3 className="h-5 w-5" />
              Skill Level Distribution
            </CardTitle>
          </CardHeader>
          <CardContent>
            {analytics.skillDistribution.length === 0 ? (
              <p className="text-muted-foreground text-center py-4">No skills data</p>
            ) : (
              <div className="space-y-4">
                {analytics.skillDistribution.slice(0, 5).map((skill) => (
                  <div key={skill.skillName}>
                    <p className="text-sm font-medium mb-1">{skill.skillName}</p>
                    <div className="flex items-center gap-1">
                      {skill.levels.map((count, level) => (
                        <div
                          key={level}
                          className="flex-1 bg-muted rounded text-center text-xs py-1"
                          title={`Level ${level}: ${count} employees`}
                        >
                          {count > 0 ? count : "-"}
                        </div>
                      ))}
                    </div>
                    <div className="flex items-center gap-1 text-xs text-muted-foreground mt-1">
                      {[0, 1, 2, 3, 4].map((l) => (
                        <div key={l} className="flex-1 text-center">
                          L{l}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <UserMinus className="h-5 w-5" />
              Attrition Risk
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-6 mb-4">
              <div className="text-center">
                <p className="text-3xl font-bold text-red-600 dark:text-red-400" data-testid="metric-attrition-high">
                  {analytics.attritionRisk.highrisk}
                </p>
                <p className="text-sm text-muted-foreground">High Risk</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-orange-600 dark:text-orange-400" data-testid="metric-attrition-medium">
                  {analytics.attritionRisk.mediumRisk}
                </p>
                <p className="text-sm text-muted-foreground">Medium Risk</p>
              </div>
            </div>
            {analytics.attritionRisk.employees.length > 0 && (
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {analytics.attritionRisk.employees.slice(0, 5).map((emp) => (
                  <div key={emp.id} className="flex items-center justify-between gap-2 py-1 border-b last:border-0">
                    <span className="text-sm">{emp.name}</span>
                    <Badge variant={emp.riskLevel === 'high' ? 'destructive' : 'default'}>
                      {emp.factors[0]}
                    </Badge>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Clock className="h-5 w-5" />
              Tenure Distribution
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-4 mb-4">
              <div className="text-center">
                <p className="text-3xl font-bold" data-testid="metric-avg-tenure">
                  {analytics.avgTenureYears}
                </p>
                <p className="text-sm text-muted-foreground">Avg. Years</p>
              </div>
            </div>
            <div className="space-y-2">
              {analytics.tenureBands.map((band) => (
                <div key={band.band} className="flex items-center justify-between gap-4">
                  <span className="text-sm">{band.band}</span>
                  <div className="flex items-center gap-2">
                    <Progress
                      value={(band.count / analytics.totalHeadcount) * 100}
                      className="w-24 h-2"
                    />
                    <span className="text-sm font-medium w-8 text-right">{band.count}</span>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>

      {analytics.openWorkflowsByTemplate.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Workflow className="h-5 w-5" />
              Active Workflows by Type
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-4">
              {analytics.openWorkflowsByTemplate.map((wf) => (
                <div key={wf.templateId} className="flex items-center gap-2">
                  <span className="text-sm">{wf.templateName}</span>
                  <Badge variant="secondary">{wf.count}</Badge>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {!analytics.absencesAvailable && (
        <Card>
          <CardContent className="py-8 text-center">
            <Activity className="h-8 w-8 text-muted-foreground mx-auto mb-2" />
            <p className="text-muted-foreground">
              Sick leave analytics coming soon - awaiting absences data integration.
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="app/hr/tasks/page.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { Card, CardContent } from "@/components/ui/card";
import { AlertTriangle } from "lucide-react";
import { getCurrentUser } from "@/lib/auth";
import { getHrTaskBuckets, HrTaskBuckets, HrTask } from "@/services/hrTasks";
import { useAuthGuard } from "@/hooks/useAuthGuard";

export default function HrTasksPage() {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access...</p>
      </main>
    );
  }

  return <HrTasksContent />;
}

function HrTasksContent() {
  const [buckets, setBuckets] = useState<HrTaskBuckets | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [authorized, setAuthorized] = useState(true);

  useEffect(() => {
    async function load() {
      const user = await getCurrentUser();
      if (!user || user.role !== "HR_ADMIN") {
        setAuthorized(false);
        setLoading(false);
        return;
      }

      try {
        const data = await getHrTaskBuckets();
        setBuckets(data);
      } catch (err) {
        console.error(err);
        setError("Could not load HR tasks.");
      } finally {
        setLoading(false);
      }
    }
    load();
  }, []);

  const totalTasks =
    (buckets?.overdue.length ?? 0) +
    (buckets?.today.length ?? 0) +
    (buckets?.upcoming.length ?? 0);

  if (loading) {
    return (
      <main className="hr-page">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3" />
          <div className="hr-kpi-grid">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-20 bg-gray-200 dark:bg-gray-700 rounded-xl" />
            ))}
          </div>
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </main>
    );
  }

  if (!authorized) {
    return (
      <main className="hr-page">
        <Card>
          <CardContent className="py-12 text-center">
            <AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" />
            <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-2">Access Denied</h2>
            <p className="text-gray-500 dark:text-gray-400">
              This page is only accessible to HR Administrators.
            </p>
          </CardContent>
        </Card>
      </main>
    );
  }

  return (
    <main className="hr-page" data-testid="hr-tasks-page">
      <header className="hr-page__header">
        <div>
          <h1 className="hr-page__title">HR Tasks</h1>
          <p className="hr-page__subtitle">
            All open workflow steps, sorted by urgency - overdue, today and the coming week.
          </p>
        </div>
      </header>

      {error && <p className="hr-error">{error}</p>}

      {!error && buckets && (
        <>
          <section className="hr-kpi-grid" data-testid="kpi-grid">
            <div className="hr-kpi">
              <div className="hr-kpi__label">Active tasks</div>
              <div className="hr-kpi__value" data-testid="kpi-active">{totalTasks}</div>
            </div>
            <div className="hr-kpi">
              <div className="hr-kpi__label">Overdue</div>
              <div className="hr-kpi__value hr-kpi__value--danger" data-testid="kpi-overdue">
                {buckets.overdue.length}
              </div>
            </div>
            <div className="hr-kpi">
              <div className="hr-kpi__label">Due today</div>
              <div className="hr-kpi__value hr-kpi__value--warn" data-testid="kpi-today">
                {buckets.today.length}
              </div>
            </div>
            <div className="hr-kpi">
              <div className="hr-kpi__label">Next 7 days</div>
              <div className="hr-kpi__value hr-kpi__value--ok" data-testid="kpi-upcoming">
                {buckets.upcoming.length}
              </div>
            </div>
          </section>

          <TaskSection
            title="Overdue"
            description="Tasks that should already have been completed."
            tasks={buckets.overdue}
            badgeClass="hr-pill--danger"
            testId="section-overdue"
          />

          <TaskSection
            title="Due today"
            description="Tasks that must be handled today."
            tasks={buckets.today}
            badgeClass="hr-pill--warn"
            testId="section-today"
          />

          <TaskSection
            title="Coming 7 days"
            description="Tasks with deadlines within the next week."
            tasks={buckets.upcoming}
            badgeClass="hr-pill--ok"
            testId="section-upcoming"
          />
        </>
      )}
    </main>
  );
}

type TaskSectionProps = {
  title: string;
  description: string;
  tasks: HrTask[];
  badgeClass: string;
  testId: string;
};

function TaskSection({ title, description, tasks, badgeClass, testId }: TaskSectionProps) {
  return (
    <section className="hr-task-section" data-testid={testId}>
      <header className="hr-task-section__header">
        <div>
          <h2 className="hr-section__title">{title}</h2>
          <p className="hr-task-section__description">{description}</p>
        </div>
        <span className={`hr-pill ${badgeClass}`}>{tasks.length}</span>
      </header>

      {tasks.length === 0 ? (
        <p className="hr-task-empty">No tasks in this bucket.</p>
      ) : (
        <div className="hr-task-list">
          {tasks.map((task) => (
            <TaskRow key={task.id} task={task} />
          ))}
        </div>
      )}
    </section>
  );
}

function TaskRow({ task }: { task: HrTask }) {
  const dueLabel = task.dueDate
    ? new Date(task.dueDate).toLocaleDateString("sv-SE")
    : "No due date";

  const href = `/app/hr/workflows`;

  const statusLabel =
    task.status === "not_started"
      ? "Not started"
      : task.status === "in_progress"
      ? "In progress"
      : task.status === "done"
      ? "Done"
      : task.status;

  return (
    <Link href={href} className="hr-task-row" data-testid={`task-row-${task.id}`}>
      <div className="hr-task-row__main">
        <h3 className="hr-task-row__title">{task.stepTitle}</h3>
        <p className="hr-task-row__subtitle">
          {task.employeeName ?? "Unknown employee"} - {task.workflowName}
        </p>
      </div>
      <div className="hr-task-row__meta">
        <span className="hr-task-row__date">{dueLabel}</span>
        <span className="hr-task-row__status">{statusLabel}</span>
      </div>
    </Link>
  );
}
</file>

<file path="app/hr/workflows/[id]/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter, useParams } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { 
  ArrowLeft, 
  Clock, 
  CheckCircle, 
  XCircle,
  User,
  Calendar,
  AlertTriangle
} from "lucide-react";
import { getCurrentUser } from "@/lib/auth";
import { WORKFLOW_TEMPLATES } from "@/services/hrWorkflows";
import type { HRWorkflowInstance, HRWorkflowStatus, HRWorkflowStep } from "@/types/domain";
import { useAuthGuard } from "@/hooks/useAuthGuard";

export default function WorkflowDetailPage() {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access...</p>
      </main>
    );
  }

  return <WorkflowDetailContent />;
}

function WorkflowDetailContent() {
  const router = useRouter();
  const params = useParams();
  const id = params?.id as string;
  
  const [instance, setInstance] = useState<HRWorkflowInstance | null>(null);
  const [loading, setLoading] = useState(true);
  const [authorized, setAuthorized] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function load() {
      const user = await getCurrentUser();
      if (!user || user.role !== "HR_ADMIN") {
        setAuthorized(false);
        setLoading(false);
        return;
      }

      try {
        const response = await fetch("/api/workflows");
        if (response.ok) {
          const instances: HRWorkflowInstance[] = await response.json();
          const found = instances.find((i) => i.id === id);
          if (found) {
            setInstance(found);
          } else {
            setError("Workflow not found");
          }
        } else {
          setError("Failed to fetch workflow");
        }
      } catch (err) {
        console.error(err);
        setError("Failed to load workflow");
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [id]);

  const template = instance ? WORKFLOW_TEMPLATES.find((t) => t.id === instance.templateId) : null;

  const statusBadge = (status: HRWorkflowStatus) => {
    switch (status) {
      case "active":
        return <Badge variant="default"><Clock className="h-3 w-3 mr-1" /> Active</Badge>;
      case "completed":
        return <Badge variant="secondary"><CheckCircle className="h-3 w-3 mr-1" /> Completed</Badge>;
      case "cancelled":
        return <Badge variant="outline"><XCircle className="h-3 w-3 mr-1" /> Cancelled</Badge>;
    }
  };

  if (loading) {
    return (
      <main className="hr-page">
        <div className="animate-pulse space-y-4">
          <div className="h-6 bg-gray-200 dark:bg-gray-700 rounded w-32" />
          <div className="h-10 bg-gray-200 dark:bg-gray-700 rounded w-1/2" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </main>
    );
  }

  if (!authorized) {
    return (
      <main className="hr-page">
        <Card>
          <CardContent className="py-12 text-center">
            <AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" />
            <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-2">Access Denied</h2>
            <p className="text-gray-500 dark:text-gray-400">
              This page is only accessible to HR Administrators.
            </p>
          </CardContent>
        </Card>
      </main>
    );
  }

  if (error || !instance) {
    return (
      <main className="hr-page">
        <button className="hr-link" onClick={() => router.back()}>
          <ArrowLeft className="h-4 w-4 inline mr-1" />
          Back to all workflows
        </button>
        <div className="hr-empty">
          <h2 className="text-lg font-semibold mb-2">Workflow Not Found</h2>
          <p className="text-gray-500">{error || "The requested workflow could not be found."}</p>
        </div>
      </main>
    );
  }

  const steps: HRWorkflowStep[] = instance.steps || [];

  return (
    <main className="hr-page" data-testid="workflow-detail-page">
      <Link href="/app/hr/workflows" className="hr-link">
        <ArrowLeft className="h-4 w-4 inline mr-1" />
        Back to all workflows
      </Link>

      <header className="hr-page__header hr-page__header--compact">
        <div>
          <div className="hr-card__badge mb-2">
            {template?.category ?? "Workflow"}
          </div>
          <h1 className="hr-page__title">{instance.templateName}</h1>
          <div className="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
            <span className="flex items-center gap-1">
              <User className="h-4 w-4" />
              {instance.employeeName || "Unknown Employee"}
            </span>
            <span className="flex items-center gap-1">
              <Calendar className="h-4 w-4" />
              Started {new Date(instance.startedAt).toLocaleDateString("sv-SE")}
            </span>
            {statusBadge(instance.status)}
          </div>
        </div>
        <div className="hr-page__actions">
          <Button variant="outline" onClick={() => router.back()}>
            Close
          </Button>
        </div>
      </header>

      <section className="hr-steps">
        <h2 className="hr-section__title">Workflow Steps</h2>
        {steps.length === 0 ? (
          <div className="hr-empty hr-empty--light">
            <p>No steps defined for this workflow.</p>
          </div>
        ) : (
          <ol className="hr-steps__list">
            {steps.map((step, index) => (
              <li 
                key={step.id} 
                className={`hr-steps__item ${step.isCompleted ? "border-green-300 dark:border-green-700 bg-green-50/50 dark:bg-green-900/10" : ""}`}
                data-testid={`step-${step.id}`}
              >
                <div className={`hr-steps__index ${step.isCompleted ? "bg-green-500 text-white border-green-500" : ""}`}>
                  {step.isCompleted ? <CheckCircle className="h-4 w-4" /> : index + 1}
                </div>
                <div className="hr-steps__content">
                  <div className="hr-steps__header">
                    <h3>{step.title}</h3>
                    <span className="hr-tag">
                      {step.responsibleRole?.toUpperCase() || "Unassigned"}
                    </span>
                  </div>
                  {step.description && (
                    <p className="hr-steps__description">{step.description}</p>
                  )}
                  <div className="flex items-center gap-3 mt-1">
                    {step.daysFromStart != null && step.daysFromStart !== 0 && (
                      <p className="hr-steps__meta">
                        Due: Day {step.daysFromStart} after start
                      </p>
                    )}
                    {step.isCompleted && step.completedAt && (
                      <p className="text-xs text-green-600 dark:text-green-400">
                        Completed {new Date(step.completedAt).toLocaleDateString("sv-SE")}
                      </p>
                    )}
                  </div>
                </div>
              </li>
            ))}
          </ol>
        )}
      </section>

      {instance.notes && (
        <section className="mt-8">
          <h2 className="hr-section__title">Notes</h2>
          <div className="hr-empty hr-empty--light">
            <p>{instance.notes}</p>
          </div>
        </section>
      )}
    </main>
  );
}
</file>

<file path="app/hr/workflows/page.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from "@/components/ui/dialog";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Plus, 
  Search, 
  Clock, 
  CheckCircle, 
  XCircle, 
  ChevronRight,
  User,
  Calendar,
  AlertTriangle
} from "lucide-react";
import { 
  getWorkflowTemplates, 
  getWorkflowInstances, 
  startWorkflow,
  completeWorkflowStep,
  cancelWorkflow,
  getWorkflowById
} from "@/services/hrWorkflows";
import { supabase } from "@/lib/supabaseClient";
import { getCurrentUser, type CurrentUser } from "@/lib/auth";
import type { 
  HRWorkflowTemplate, 
  HRWorkflowInstance, 
  HRWorkflowStatus,
  HRWorkflowTemplateId 
} from "@/types/domain";
import { useAuthGuard } from "@/hooks/useAuthGuard";

export default function HRWorkflowsPage() {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access...</p>
      </main>
    );
  }
  
  return <HRWorkflowsPageContent />;
}

function HRWorkflowsPageContent() {
  const [templates] = useState<HRWorkflowTemplate[]>(getWorkflowTemplates());
  const [instances, setInstances] = useState<HRWorkflowInstance[]>([]);
  const [loading, setLoading] = useState(true);
  const [authorized, setAuthorized] = useState(true);
  const [statusFilter, setStatusFilter] = useState<HRWorkflowStatus | "all">("all");
  const [searchTerm, setSearchTerm] = useState("");
  const [showStartDialog, setShowStartDialog] = useState(false);
  const [selectedTemplate, setSelectedTemplate] = useState<HRWorkflowTemplateId | null>(null);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState("");
  const [employees, setEmployees] = useState<{ id: string; name: string }[]>([]);
  const [starting, setStarting] = useState(false);
  const [selectedInstance, setSelectedInstance] = useState<HRWorkflowInstance | null>(null);
  const [showDetailDialog, setShowDetailDialog] = useState(false);

  const loadInstances = useCallback(async () => {
    try {
      const response = await fetch("/api/workflows");
      if (response.ok) {
        let data = await response.json();
        if (statusFilter !== "all") {
          data = data.filter((i: HRWorkflowInstance) => i.status === statusFilter);
        }
        setInstances(data);
      }
    } catch (err) {
      console.error("Failed to load workflow instances:", err);
      setInstances([]);
    }
  }, [statusFilter]);

  useEffect(() => {
    async function checkAuthAndLoad() {
      const user = await getCurrentUser();
      if (!user || user.role !== "HR_ADMIN") {
        setAuthorized(false);
        setLoading(false);
        return;
      }
      
      await loadInstances();
      const { data } = await supabase
        .from("employees")
        .select("id, name")
        .eq("is_active", true)
        .order("name");
      setEmployees(data || []);
      setLoading(false);
    }
    checkAuthAndLoad();
  }, [loadInstances]);

  const filteredInstances = instances.filter((i) => {
    if (!searchTerm) return true;
    const term = searchTerm.toLowerCase();
    return (
      i.templateName.toLowerCase().includes(term) ||
      i.employeeName?.toLowerCase().includes(term)
    );
  });

  async function handleStartWorkflow() {
    if (!selectedTemplate || !selectedEmployeeId) return;
    setStarting(true);
    try {
      const response = await fetch("/api/workflows", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          templateId: selectedTemplate,
          employeeId: selectedEmployeeId,
        }),
      });
      if (!response.ok) {
        const err = await response.json();
        console.error("Failed to start workflow:", err);
      }
    } catch (err) {
      console.error("Error starting workflow:", err);
    }
    await loadInstances();
    setShowStartDialog(false);
    setSelectedTemplate(null);
    setSelectedEmployeeId("");
    setStarting(false);
  }

  async function handleCompleteStep(stepId: string) {
    if (!selectedInstance) return;
    await completeWorkflowStep(selectedInstance.id, stepId);
    const updated = await getWorkflowById(selectedInstance.id);
    if (updated) setSelectedInstance(updated);
    await loadInstances();
  }

  async function handleCancelWorkflow() {
    if (!selectedInstance) return;
    await cancelWorkflow(selectedInstance.id);
    setShowDetailDialog(false);
    setSelectedInstance(null);
    await loadInstances();
  }

  function openInstanceDetail(instance: HRWorkflowInstance) {
    setSelectedInstance(instance);
    setShowDetailDialog(true);
  }

  const statusBadge = (status: HRWorkflowStatus) => {
    switch (status) {
      case "active":
        return <Badge variant="default"><Clock className="h-3 w-3 mr-1" /> Active</Badge>;
      case "completed":
        return <Badge variant="secondary"><CheckCircle className="h-3 w-3 mr-1" /> Completed</Badge>;
      case "cancelled":
        return <Badge variant="outline"><XCircle className="h-3 w-3 mr-1" /> Cancelled</Badge>;
    }
  };

  if (loading) {
    return (
      <div className="p-8">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  if (!authorized) {
    return (
      <div className="p-8">
        <Card>
          <CardContent className="py-12 text-center">
            <AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" />
            <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-2">Access Denied</h2>
            <p className="text-gray-500 dark:text-gray-400">
              This page is only accessible to HR Administrators.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="p-8" data-testid="hr-workflows-page">
      <div className="flex items-center justify-between gap-4 mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">HR Workflows</h1>
          <p className="text-gray-500 dark:text-gray-400 mt-1">Manage standardized HR processes</p>
        </div>
        <Button onClick={() => setShowStartDialog(true)} data-testid="button-start-workflow">
          <Plus className="h-4 w-4 mr-2" />
          Start Workflow
        </Button>
      </div>

      <Tabs defaultValue="instances" className="space-y-6">
        <TabsList>
          <TabsTrigger value="instances">Active Workflows</TabsTrigger>
          <TabsTrigger value="templates">Templates</TabsTrigger>
        </TabsList>

        <TabsContent value="instances" className="space-y-4">
          <div className="flex items-center gap-4">
            <div className="relative flex-1 max-w-sm">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                placeholder="Search workflows..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-9"
                data-testid="input-search-workflows"
              />
            </div>
            <Select value={statusFilter} onValueChange={(v) => setStatusFilter(v as HRWorkflowStatus | "all")}>
              <SelectTrigger className="w-40" data-testid="select-status-filter">
                <SelectValue placeholder="All statuses" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All statuses</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="completed">Completed</SelectItem>
                <SelectItem value="cancelled">Cancelled</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {loading ? (
            <div className="space-y-4">
              {[1, 2, 3].map((i) => (
                <div key={i} className="h-20 bg-gray-200 dark:bg-gray-700 rounded animate-pulse" />
              ))}
            </div>
          ) : filteredInstances.length === 0 ? (
            <Card>
              <CardContent className="pt-6">
                <div className="text-center py-12 text-gray-500 dark:text-gray-400">
                  <p className="mb-4">No workflows found</p>
                  <Button variant="outline" onClick={() => setShowStartDialog(true)}>
                    Start a Workflow
                  </Button>
                </div>
              </CardContent>
            </Card>
          ) : (
            <div className="space-y-3">
              {filteredInstances.map((instance) => {
                const completedSteps = instance.steps.filter((s) => s.isCompleted).length;
                const totalSteps = instance.steps.length;
                const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

                return (
                  <Card 
                    key={instance.id} 
                    className="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors"
                    onClick={() => openInstanceDetail(instance)}
                    data-testid={`card-workflow-${instance.id}`}
                  >
                    <CardContent className="py-4">
                      <div className="flex items-center justify-between gap-4">
                        <div className="min-w-0 flex-1">
                          <div className="flex items-center gap-3 mb-1">
                            <span className="font-medium text-gray-900 dark:text-white">{instance.templateName}</span>
                            {statusBadge(instance.status)}
                          </div>
                          <div className="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                            <span className="flex items-center gap-1">
                              <User className="h-3 w-3" />
                              {instance.employeeName || "Unknown"}
                            </span>
                            <span className="flex items-center gap-1">
                              <Calendar className="h-3 w-3" />
                              Started {new Date(instance.startedAt).toLocaleDateString("sv-SE")}
                            </span>
                            <span>{completedSteps}/{totalSteps} steps ({progress}%)</span>
                          </div>
                        </div>
                        <ChevronRight className="h-5 w-5 text-gray-400" />
                      </div>
                    </CardContent>
                  </Card>
                );
              })}
            </div>
          )}
        </TabsContent>

        <TabsContent value="templates" className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {templates.map((template) => (
              <Card key={template.id} data-testid={`card-template-${template.id}`}>
                <CardHeader className="pb-2">
                  <div className="flex items-start justify-between gap-2">
                    <CardTitle className="text-base">{template.name}</CardTitle>
                    <Badge variant="secondary">{template.category}</Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">{template.description}</p>
                  <p className="text-xs text-gray-400 mb-4">{template.defaultSteps.length} steps</p>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    className="w-full"
                    onClick={() => {
                      setSelectedTemplate(template.id);
                      setShowStartDialog(true);
                    }}
                  >
                    Start This Workflow
                  </Button>
                </CardContent>
              </Card>
            ))}
          </div>
        </TabsContent>
      </Tabs>

      <Dialog open={showStartDialog} onOpenChange={setShowStartDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Start New Workflow</DialogTitle>
            <DialogDescription>
              Select a workflow template and employee to begin the process.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Template</label>
              <Select value={selectedTemplate || ""} onValueChange={(v) => setSelectedTemplate(v as HRWorkflowTemplateId)}>
                <SelectTrigger data-testid="select-template">
                  <SelectValue placeholder="Select a template" />
                </SelectTrigger>
                <SelectContent>
                  {templates.map((t) => (
                    <SelectItem key={t.id} value={t.id}>{t.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Employee</label>
              <Select value={selectedEmployeeId} onValueChange={setSelectedEmployeeId}>
                <SelectTrigger data-testid="select-employee">
                  <SelectValue placeholder="Select an employee" />
                </SelectTrigger>
                <SelectContent>
                  {employees.map((e) => (
                    <SelectItem key={e.id} value={e.id}>{e.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowStartDialog(false)}>Cancel</Button>
            <Button 
              onClick={handleStartWorkflow} 
              disabled={!selectedTemplate || !selectedEmployeeId || starting}
              data-testid="button-confirm-start"
            >
              {starting ? "Starting..." : "Start Workflow"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <Dialog open={showDetailDialog} onOpenChange={setShowDetailDialog}>
        <DialogContent className="max-w-2xl">
          {selectedInstance && (
            <>
              <DialogHeader>
                <div className="flex items-center gap-3">
                  <DialogTitle>{selectedInstance.templateName}</DialogTitle>
                  {statusBadge(selectedInstance.status)}
                </div>
                <DialogDescription>
                  {selectedInstance.employeeName} - Started {new Date(selectedInstance.startedAt).toLocaleDateString("sv-SE")}
                </DialogDescription>
              </DialogHeader>
              <div className="py-4 max-h-96 overflow-y-auto">
                <div className="space-y-3">
                  {selectedInstance.steps.map((step, index) => (
                    <div 
                      key={step.id} 
                      className={`p-4 rounded-md border ${
                        step.isCompleted 
                          ? "bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800" 
                          : "bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
                      }`}
                    >
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-sm font-medium text-gray-500 dark:text-gray-400">
                              Step {index + 1}
                            </span>
                            <Badge variant="outline" className="text-xs">
                              {step.responsibleRole.toUpperCase()}
                            </Badge>
                            {step.daysFromStart !== 0 && (
                              <span className="text-xs text-gray-400">
                                Day {step.daysFromStart}
                              </span>
                            )}
                          </div>
                          <p className="font-medium text-gray-900 dark:text-white">{step.title}</p>
                          {step.description && (
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{step.description}</p>
                          )}
                          {step.isCompleted && step.completedAt && (
                            <p className="text-xs text-green-600 dark:text-green-400 mt-2">
                              Completed {new Date(step.completedAt).toLocaleDateString("sv-SE")}
                            </p>
                          )}
                        </div>
                        {!step.isCompleted && selectedInstance.status === "active" && (
                          <Button 
                            size="sm" 
                            onClick={() => handleCompleteStep(step.id)}
                            data-testid={`button-complete-step-${step.id}`}
                          >
                            <CheckCircle className="h-4 w-4 mr-1" />
                            Complete
                          </Button>
                        )}
                        {step.isCompleted && (
                          <CheckCircle className="h-5 w-5 text-green-500" />
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              <DialogFooter>
                {selectedInstance.status === "active" && (
                  <Button variant="destructive" onClick={handleCancelWorkflow}>
                    Cancel Workflow
                  </Button>
                )}
                <Button variant="outline" onClick={() => setShowDetailDialog(false)}>Close</Button>
              </DialogFooter>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="app/import-employees/actions.ts">
"use server";

import { supabase } from "@/lib/supabaseClient";
import Papa from "papaparse";

interface CsvRow {
  name?: string;
  employee_number?: string;
  role?: string;
  line?: string;
  team?: string;
  is_active?: string;
}

interface ImportResult {
  success: boolean;
  message: string;
  count?: number;
}

export async function importEmployeesFromCsv(formData: FormData): Promise<ImportResult> {
  const file = formData.get("file") as File | null;

  if (!file) {
    return { success: false, message: "No file provided" };
  }

  const text = await file.text();

  const parseResult = Papa.parse<CsvRow>(text, {
    header: true,
    skipEmptyLines: true,
    transformHeader: (header) => header.trim().toLowerCase(),
  });

  if (parseResult.errors.length > 0) {
    return {
      success: false,
      message: `CSV parsing error: ${parseResult.errors[0].message}`,
    };
  }

  const rows = parseResult.data;

  if (rows.length === 0) {
    return { success: false, message: "CSV file is empty" };
  }

  const requiredColumns = ["name", "employee_number", "role", "line", "team"];
  const headers = Object.keys(rows[0] || {});
  const missingColumns = requiredColumns.filter((col) => !headers.includes(col));

  if (missingColumns.length > 0) {
    return {
      success: false,
      message: `Missing required columns: ${missingColumns.join(", ")}`,
    };
  }

  const employeesToUpsert: {
    name: string;
    employee_number: string;
    role: string;
    line: string;
    team: string;
    is_active: boolean;
  }[] = [];

  for (const row of rows) {
    if (!row.name || !row.employee_number || !row.role || !row.line || !row.team) {
      continue;
    }

    const isActive =
      row.is_active === undefined ||
      row.is_active === "" ||
      row.is_active.toLowerCase() === "true" ||
      row.is_active === "1";

    employeesToUpsert.push({
      name: row.name.trim(),
      employee_number: row.employee_number.trim(),
      role: row.role.trim(),
      line: row.line.trim(),
      team: row.team.trim(),
      is_active: isActive,
    });
  }

  if (employeesToUpsert.length === 0) {
    return { success: false, message: "No valid employee rows found in CSV" };
  }

  const { error } = await supabase
    .from("employees")
    .upsert(employeesToUpsert, { onConflict: "employee_number" });

  if (error) {
    return { success: false, message: `Database error: ${error.message}` };
  }

  return {
    success: true,
    message: `Imported ${employeesToUpsert.length} employees`,
    count: employeesToUpsert.length,
  };
}
</file>

<file path="app/import-employees/ImportForm.tsx">
"use client";

import { useState, useRef } from "react";
import { importEmployeesFromCsv } from "./actions";

export default function ImportForm() {
  const [result, setResult] = useState<{
    success: boolean;
    message: string;
  } | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const formRef = useRef<HTMLFormElement>(null);

  async function handleSubmit(formData: FormData) {
    setIsLoading(true);
    setResult(null);

    try {
      const response = await importEmployeesFromCsv(formData);
      setResult(response);
      if (response.success) {
        formRef.current?.reset();
      }
    } catch (error) {
      setResult({
        success: false,
        message: error instanceof Error ? error.message : "Unknown error occurred",
      });
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <form ref={formRef} action={handleSubmit} className="space-y-6">
      <div>
        <label
          htmlFor="csv-file"
          className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
        >
          CSV File
        </label>
        <input
          type="file"
          id="csv-file"
          name="file"
          accept=".csv"
          required
          className="block w-full text-sm text-gray-900 dark:text-gray-100 
            file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 
            file:text-sm file:font-medium file:bg-gray-100 dark:file:bg-gray-700 
            file:text-gray-700 dark:file:text-gray-200 
            hover:file:bg-gray-200 dark:hover:file:bg-gray-600 
            file:cursor-pointer cursor-pointer"
          data-testid="input-csv-file"
        />
      </div>

      <button
        type="submit"
        disabled={isLoading}
        className="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium 
          hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed 
          transition-colors"
        data-testid="button-upload-import"
      >
        {isLoading ? "Importing..." : "Upload and import"}
      </button>

      {result && (
        <div
          className={`p-4 rounded-md text-sm ${
            result.success
              ? "bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800"
              : "bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800"
          }`}
          data-testid={result.success ? "message-success" : "message-error"}
        >
          {result.message}
        </div>
      )}
    </form>
  );
}
</file>

<file path="app/import-employees/page.tsx">
import ImportForm from "./ImportForm";

export default function ImportEmployeesPage() {
  return (
    <div>
      <h1
        className="text-2xl font-bold text-gray-900 dark:text-white mb-4"
        data-testid="heading-import-employees"
      >
        Import Employees
      </h1>

      <p className="text-gray-600 dark:text-gray-400 mb-6">
        Upload a CSV file with columns: name, employee_number, role, line, team, is_active
      </p>

      <div className="bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 p-6 max-w-xl">
        <ImportForm />
      </div>
    </div>
  );
}
</file>

<file path="app/line-overview/page.tsx">
"use client";

import { useState, useEffect, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Calendar,
  ChevronDown,
  ChevronRight,
  Clock,
  Factory,
  Gauge,
  Percent,
  Plus,
  Users,
  Zap,
  AlertTriangle,
} from "lucide-react";
import { fetchLineOverviewData, fetchWeekOverviewData } from "@/services/lineOverview";
import type { LineOverviewData, MachineWithData, ShiftType } from "@/types/lineOverview";
import { MachineCard } from "@/components/line-overview/MachineCard";
import { AssignmentDrawer } from "@/components/line-overview/AssignmentDrawer";
import { SuggestModal } from "@/components/line-overview/SuggestModal";
import { DemandModal } from "@/components/line-overview/DemandModal";

type ViewMode = "day" | "week";

function formatDate(date: Date): string {
  return date.toISOString().split("T")[0];
}

function getWeekStart(date: Date): Date {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff);
  return d;
}

export default function LineOverviewPage() {
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [shiftType, setShiftType] = useState<ShiftType>("Day");
  const [viewMode, setViewMode] = useState<ViewMode>("day");
  const [data, setData] = useState<LineOverviewData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [expandedLines, setExpandedLines] = useState<Set<string>>(new Set());
  const [selectedMachine, setSelectedMachine] = useState<MachineWithData | null>(null);
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [suggestMachine, setSuggestMachine] = useState<MachineWithData | null>(null);
  const [suggestOpen, setSuggestOpen] = useState(false);
  const [demandMachine, setDemandMachine] = useState<MachineWithData | null>(null);
  const [demandOpen, setDemandOpen] = useState(false);

  const loadData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const dateStr = formatDate(selectedDate);
      let result: LineOverviewData;
      if (viewMode === "week") {
        const weekStart = getWeekStart(selectedDate);
        result = await fetchWeekOverviewData(formatDate(weekStart), shiftType);
      } else {
        result = await fetchLineOverviewData(dateStr, shiftType);
      }
      setData(result);
      if (expandedLines.size === 0 && result.lines.length > 0) {
        setExpandedLines(new Set(result.lines.slice(0, 3).map((l) => l.line.lineCode)));
      }
    } catch (err) {
      console.error("Failed to load line overview:", err);
      setError("Failed to load data");
    } finally {
      setLoading(false);
    }
  }, [selectedDate, shiftType, viewMode]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const toggleLine = (lineCode: string) => {
    setExpandedLines((prev) => {
      const next = new Set(prev);
      if (next.has(lineCode)) {
        next.delete(lineCode);
      } else {
        next.add(lineCode);
      }
      return next;
    });
  };

  const handleMachineClick = (machine: MachineWithData) => {
    setSelectedMachine(machine);
    setDrawerOpen(true);
  };

  const handleSuggestClick = (machine: MachineWithData) => {
    setSuggestMachine(machine);
    setSuggestOpen(true);
  };

  const handleDemandClick = (machine: MachineWithData) => {
    setDemandMachine(machine);
    setDemandOpen(true);
  };

  const handleAssignmentChange = () => {
    loadData();
  };

  const handleDemandChange = () => {
    loadData();
  };

  const shiftOptions: ShiftType[] = ["Day", "Evening", "Night"];

  return (
    <div className="min-h-screen bg-background">
      <div className="border-b bg-card">
        <div className="container mx-auto px-6 py-4">
          <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-primary/10">
                <Factory className="h-6 w-6 text-primary" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-foreground">Line Overview</h1>
                <p className="text-sm text-muted-foreground">
                  Visualize staffing across all production lines
                </p>
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4 text-muted-foreground" />
                <input
                  type="date"
                  value={formatDate(selectedDate)}
                  onChange={(e) => setSelectedDate(new Date(e.target.value))}
                  className="h-9 px-3 rounded-md border border-input bg-background text-sm"
                  data-testid="input-date"
                />
              </div>

              <Select value={shiftType} onValueChange={(v) => setShiftType(v as ShiftType)}>
                <SelectTrigger className="w-[120px]" data-testid="select-shift">
                  <Clock className="h-4 w-4 mr-2" />
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {shiftOptions.map((s) => (
                    <SelectItem key={s} value={s}>
                      {s}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>

              <div className="flex rounded-lg border border-input overflow-hidden">
                <button
                  onClick={() => setViewMode("day")}
                  className={`px-4 py-2 text-sm font-medium transition-colors ${
                    viewMode === "day"
                      ? "bg-primary text-primary-foreground"
                      : "bg-background text-muted-foreground hover:bg-muted"
                  }`}
                  data-testid="button-view-day"
                >
                  Day
                </button>
                <button
                  onClick={() => setViewMode("week")}
                  className={`px-4 py-2 text-sm font-medium transition-colors ${
                    viewMode === "week"
                      ? "bg-primary text-primary-foreground"
                      : "bg-background text-muted-foreground hover:bg-muted"
                  }`}
                  data-testid="button-view-week"
                >
                  Week
                </button>
              </div>
            </div>
          </div>

          {data && !loading && (
            <div className="flex flex-wrap gap-3 mt-4 pt-4 border-t">
              {data.metrics.hasDemand ? (
                <>
                  <MetricChip
                    icon={<Percent className="h-3.5 w-3.5" />}
                    label="Coverage"
                    value={`${data.metrics.coveragePercent}%`}
                    variant={(data.metrics.coveragePercent ?? 0) >= 90 ? "success" : (data.metrics.coveragePercent ?? 0) >= 70 ? "warning" : "danger"}
                  />
                  <MetricChip
                    icon={<AlertTriangle className="h-3.5 w-3.5" />}
                    label="Gap"
                    value={`${(data.metrics.totalGapHours ?? 0).toFixed(1)}h`}
                    variant={(data.metrics.totalGapHours ?? 0) === 0 ? "success" : (data.metrics.totalGapHours ?? 0) <= 8 ? "warning" : "danger"}
                  />
                </>
              ) : (
                <MetricChip
                  icon={<AlertTriangle className="h-3.5 w-3.5" />}
                  label="Demand"
                  value="No demand"
                  variant="neutral"
                />
              )}
              {data.metrics.overAssignedHours > 0 && (
                <MetricChip
                  icon={<Zap className="h-3.5 w-3.5" />}
                  label="Over-assigned"
                  value={`+${data.metrics.overAssignedHours.toFixed(1)}h`}
                  variant="info"
                />
              )}
              <MetricChip
                icon={<Users className="h-3.5 w-3.5" />}
                label="Present"
                value={String(data.metrics.presentCount + data.metrics.partialCount)}
                variant="success"
              />
              <MetricChip
                icon={<Users className="h-3.5 w-3.5" />}
                label="Absent"
                value={String(data.metrics.absentCount)}
                variant={data.metrics.absentCount > 0 ? "warning" : "success"}
              />
            </div>
          )}
        </div>
      </div>

      <div className="container mx-auto px-6 py-6">
        {loading ? (
          <div className="space-y-4">
            {[1, 2, 3].map((i) => (
              <Card key={i}>
                <CardHeader>
                  <Skeleton className="h-6 w-48" />
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {[1, 2, 3, 4].map((j) => (
                      <Skeleton key={j} className="h-40 rounded-lg" />
                    ))}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        ) : error ? (
          <Card>
            <CardContent className="py-12 text-center">
              <AlertTriangle className="h-12 w-12 mx-auto text-destructive mb-4" />
              <h3 className="text-lg font-semibold text-foreground mb-2">Failed to load data</h3>
              <p className="text-muted-foreground mb-4">{error}</p>
              <Button onClick={loadData}>Retry</Button>
            </CardContent>
          </Card>
        ) : data?.lines.length === 0 ? (
          <Card>
            <CardContent className="py-12 text-center">
              <Factory className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
              <h3 className="text-lg font-semibold text-foreground mb-2">No lines found</h3>
              <p className="text-muted-foreground">
                No production lines are configured for this organization.
              </p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-4">
            {data?.lines.map((lineData) => {
              const isExpanded = expandedLines.has(lineData.line.lineCode);
              const hasDemand = lineData.totalRequiredHours > 0;

              return (
                <Card key={lineData.line.lineCode} className="overflow-hidden">
                  <button
                    onClick={() => toggleLine(lineData.line.lineCode)}
                    className="w-full text-left"
                    data-testid={`line-header-${lineData.line.lineCode}`}
                  >
                    <CardHeader className="flex flex-row items-center justify-between py-3 hover:bg-muted/50 transition-colors">
                      <div className="flex items-center gap-3">
                        {isExpanded ? (
                          <ChevronDown className="h-5 w-5 text-muted-foreground" />
                        ) : (
                          <ChevronRight className="h-5 w-5 text-muted-foreground" />
                        )}
                        <div>
                          <CardTitle className="text-base font-semibold">
                            {lineData.line.lineName}
                          </CardTitle>
                          <p className="text-xs text-muted-foreground">
                            {lineData.line.lineCode} • {lineData.machines.length} machines
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-4">
                        {hasDemand ? (
                          <>
                            <div className="text-right">
                              <p className="text-sm font-medium">
                                {lineData.totalAssignedHours.toFixed(1)}h /{" "}
                                {lineData.totalRequiredHours.toFixed(1)}h
                              </p>
                              <p className="text-xs text-muted-foreground">
                                {lineData.totalGap > 0 ? (
                                  <span className="text-destructive">
                                    Gap: {lineData.totalGap.toFixed(1)}h
                                  </span>
                                ) : (
                                  <span className="text-green-600">Fully staffed</span>
                                )}
                              </p>
                            </div>
                            <Badge
                              variant="secondary"
                              className={`${
                                lineData.totalGap <= 0
                                  ? "bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300"
                                  : lineData.totalGap <= 2
                                  ? "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300"
                                  : "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300"
                              }`}
                            >
                              {lineData.totalGap <= 0
                                ? "OK"
                                : lineData.totalGap <= 2
                                ? "Low Gap"
                                : "Gap"}
                            </Badge>
                          </>
                        ) : (
                          <Badge variant="secondary" className="text-muted-foreground">
                            No demand
                          </Badge>
                        )}
                      </div>
                    </CardHeader>
                  </button>
                  {isExpanded && (
                    <CardContent className="pt-0 pb-4">
                      {lineData.machines.length === 0 ? (
                        <div className="text-center py-8 text-muted-foreground">
                          No machines in this line
                        </div>
                      ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                          {lineData.machines.map((machineData) => (
                            <MachineCard
                              key={machineData.machine.machineCode}
                              data={machineData}
                              viewMode={viewMode}
                              onClick={() => handleMachineClick(machineData)}
                              onSuggest={() => handleSuggestClick(machineData)}
                              onImportDemand={() => handleDemandClick(machineData)}
                            />
                          ))}
                        </div>
                      )}
                    </CardContent>
                  )}
                </Card>
              );
            })}
          </div>
        )}
      </div>

      <AssignmentDrawer
        open={drawerOpen}
        onOpenChange={setDrawerOpen}
        machine={selectedMachine}
        planDate={formatDate(selectedDate)}
        shiftType={shiftType}
        employees={data?.employees || []}
        attendance={data?.attendance || []}
        onAssignmentChange={handleAssignmentChange}
      />

      <SuggestModal
        open={suggestOpen}
        onOpenChange={setSuggestOpen}
        machine={suggestMachine}
        planDate={formatDate(selectedDate)}
        shiftType={shiftType}
        onApply={handleAssignmentChange}
      />

      <DemandModal
        open={demandOpen}
        onOpenChange={setDemandOpen}
        machine={demandMachine}
        planDate={formatDate(selectedDate)}
        shiftType={shiftType}
        onDemandChange={handleDemandChange}
      />
    </div>
  );
}

function MetricChip({
  icon,
  label,
  value,
  variant,
}: {
  icon: React.ReactNode;
  label: string;
  value: string;
  variant: "success" | "warning" | "danger" | "neutral" | "info";
}) {
  const variantStyles = {
    success: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",
    warning: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400",
    danger: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
    neutral: "bg-muted text-muted-foreground",
    info: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
  };

  return (
    <div
      className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium ${variantStyles[variant]}`}
    >
      {icon}
      <span>{label}:</span>
      <span className="font-bold">{value}</span>
    </div>
  );
}
</file>

<file path="app/manager/risks/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { RiskListSection } from "@/components/RiskListSection";
import { Card, CardContent } from "@/components/ui/card";
import { getAllEvents, markEventCompleted, extendDueDate } from "@/services/events";
import { isDemoMode, getDemoEvents } from "@/lib/demoRuntime";
import { COPY } from "@/lib/copy";
import type { PersonEvent } from "@/types/domain";
import { Loader2, AlertTriangle } from "lucide-react";

export default function ManagerRisksPage() {
  const [events, setEvents] = useState<PersonEvent[]>([]);
  const [loading, setLoading] = useState(true);
  const [isDemo, setIsDemo] = useState(false);

  const fetchEvents = async () => {
    setLoading(true);
    
    if (isDemoMode()) {
      setIsDemo(true);
      setEvents(getDemoEvents() as PersonEvent[]);
      setLoading(false);
      return;
    }
    
    const data = await getAllEvents();
    setEvents(data);
    setLoading(false);
  };

  useEffect(() => {
    fetchEvents();
  }, []);

  const handleMarkCompleted = async (eventId: string) => {
    if (isDemo) {
      setEvents(prev => prev.map(e => 
        e.id === eventId ? { ...e, status: "completed" as const, completedDate: new Date().toISOString().slice(0, 10) } : e
      ));
      return;
    }
    await markEventCompleted(eventId);
    fetchEvents();
  };

  const handleExtendDueDate = async (eventId: string) => {
    if (isDemo) {
      const addDays = (dateStr: string, days: number): string => {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date.toISOString().slice(0, 10);
      };
      setEvents(prev => prev.map(e => 
        e.id === eventId ? { ...e, dueDate: addDays(e.dueDate, 30), status: "upcoming" as const } : e
      ));
      return;
    }
    await extendDueDate(eventId, 30);
    fetchEvents();
  };

  const overdueEvents = events.filter((e) => e.status === "overdue");
  const dueSoonEvents = events.filter((e) => e.status === "due_soon");
  const upcomingEvents = events.filter((e) => e.status === "upcoming");

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    );
  }

  return (
    <div className="p-6">
      <h1 className="text-2xl font-semibold mb-6">People Risks - My Team</h1>

      {events.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <AlertTriangle className="h-12 w-12 mx-auto text-gray-400 mb-4" />
            <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
              {COPY.emptyStates.risks.empty.title}
            </h2>
            <p className="text-muted-foreground max-w-md mx-auto">
              {COPY.emptyStates.risks.empty.description}
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div>
            <RiskListSection
              title={COPY.sections.overdue}
              events={overdueEvents}
              onMarkCompleted={handleMarkCompleted}
              onExtendDueDate={handleExtendDueDate}
              variant="overdue"
            />
          </div>
          <div>
            <RiskListSection
              title={COPY.sections.dueSoon}
              events={dueSoonEvents}
              onMarkCompleted={handleMarkCompleted}
              onExtendDueDate={handleExtendDueDate}
              variant="due_soon"
            />
          </div>
          <div>
            <RiskListSection
              title={COPY.sections.upcoming}
              events={upcomingEvents}
              onMarkCompleted={handleMarkCompleted}
              onExtendDueDate={handleExtendDueDate}
              variant="upcoming"
            />
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/news/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Plus, Pin, Loader2 } from "lucide-react";
import type { NewsPost } from "@/types/domain";

export default function NewsPage() {
  const [posts, setPosts] = useState<NewsPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newPost, setNewPost] = useState({ title: "", body: "" });

  const fetchPosts = async () => {
    setLoading(true);
    const { data } = await supabase
      .from("news_posts")
      .select("*")
      .order("is_pinned", { ascending: false })
      .order("created_at", { ascending: false });

    setPosts(
      (data || []).map((p: any) => ({
        id: p.id,
        title: p.title,
        body: p.body,
        createdAt: p.created_at,
        createdBy: p.created_by,
        isPinned: p.is_pinned,
      }))
    );
    setLoading(false);
  };

  useEffect(() => {
    fetchPosts();
  }, []);

  const handleAddPost = async () => {
    if (!newPost.title || !newPost.body) return;

    await supabase.from("news_posts").insert({
      title: newPost.title,
      body: newPost.body,
      is_pinned: false,
    });

    setNewPost({ title: "", body: "" });
    setShowAddForm(false);
    fetchPosts();
  };

  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString("sv-SE", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  };

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-semibold">Company News</h1>
        <Button onClick={() => setShowAddForm(!showAddForm)} data-testid="button-add-news">
          <Plus className="h-4 w-4 mr-2" />
          Add News
        </Button>
      </div>

      {showAddForm && (
        <Card className="mb-6">
          <CardHeader>
            <CardTitle className="text-lg">Create News Post</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <Input
                placeholder="Title"
                value={newPost.title}
                onChange={(e) => setNewPost({ ...newPost, title: e.target.value })}
                data-testid="input-news-title"
              />
              <Textarea
                placeholder="Content..."
                value={newPost.body}
                onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => setNewPost({ ...newPost, body: e.target.value })}
                rows={4}
                data-testid="input-news-body"
              />
              <Button onClick={handleAddPost} data-testid="button-save-news">
                Publish
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      <div className="space-y-4">
        {posts.map((post) => (
          <Card key={post.id} data-testid={`card-news-${post.id}`}>
            <CardHeader>
              <div className="flex items-start justify-between gap-2">
                <div>
                  <CardTitle className="text-lg">{post.title}</CardTitle>
                  <p className="text-sm text-muted-foreground mt-1">
                    {formatDate(post.createdAt)}
                  </p>
                </div>
                {post.isPinned && (
                  <Badge variant="secondary">
                    <Pin className="h-3 w-3 mr-1" />
                    Pinned
                  </Badge>
                )}
              </div>
            </CardHeader>
            <CardContent>
              <p className="text-sm whitespace-pre-wrap">{post.body}</p>
            </CardContent>
          </Card>
        ))}

        {posts.length === 0 && (
          <div className="text-center py-12 text-muted-foreground">
            No news posts yet. Click &quot;Add News&quot; to create your first post.
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/one-to-ones/[id]/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Checkbox } from "@/components/ui/checkbox";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ArrowLeft, Plus, Calendar, Clock, MapPin, User, CheckCircle2 } from "lucide-react";
import {
  getMeetingById,
  getActionsForMeeting,
  updateMeeting,
  addAction,
  completeAction,
} from "@/services/oneToOne";
import type { OneToOneMeeting, OneToOneAction, OneToOneActionOwner } from "@/types/domain";

export default function OneToOneMeetingPage() {
  const params = useParams();
  const router = useRouter();
  const meetingId = params.id as string;

  const [meeting, setMeeting] = useState<OneToOneMeeting | null>(null);
  const [actions, setActions] = useState<OneToOneAction[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  const [sharedAgenda, setSharedAgenda] = useState("");
  const [managerNotes, setManagerNotes] = useState("");
  const [employeeNotes, setEmployeeNotes] = useState("");

  const [newActionDesc, setNewActionDesc] = useState("");
  const [newActionOwner, setNewActionOwner] = useState<OneToOneActionOwner>("employee");
  const [newActionDue, setNewActionDue] = useState("");

  useEffect(() => {
    async function loadData() {
      const [meetingData, actionsData] = await Promise.all([
        getMeetingById(meetingId),
        getActionsForMeeting(meetingId),
      ]);

      if (meetingData) {
        setMeeting(meetingData);
        setSharedAgenda(meetingData.sharedAgenda || "");
        setManagerNotes(meetingData.managerNotesPrivate || "");
        setEmployeeNotes(meetingData.employeeNotesPrivate || "");
      }
      setActions(actionsData);
      setLoading(false);
    }
    loadData();
  }, [meetingId]);

  async function handleSaveNotes() {
    if (!meeting) return;
    setSaving(true);
    await updateMeeting(meetingId, {
      sharedAgenda,
      managerNotesPrivate: managerNotes,
      employeeNotesPrivate: employeeNotes,
    });
    setSaving(false);
  }

  async function handleStatusChange(status: OneToOneMeeting["status"]) {
    if (!meeting) return;
    setSaving(true);
    const success = await updateMeeting(meetingId, { status });
    if (success) {
      setMeeting({ ...meeting, status });
    }
    setSaving(false);
  }

  async function handleAddAction() {
    if (!newActionDesc.trim()) return;
    setSaving(true);
    const result = await addAction(meetingId, {
      description: newActionDesc,
      ownerType: newActionOwner,
      dueDate: newActionDue || undefined,
    });
    if (result) {
      setActions([...actions, result]);
      setNewActionDesc("");
      setNewActionDue("");
    }
    setSaving(false);
  }

  async function handleCompleteAction(actionId: string) {
    const success = await completeAction(actionId);
    if (success) {
      setActions(actions.map((a) => (a.id === actionId ? { ...a, isCompleted: true } : a)));
    }
  }

  function getStatusBadge(status: string) {
    const variants: Record<string, "default" | "secondary" | "destructive" | "outline"> = {
      planned: "outline",
      in_progress: "default",
      completed: "secondary",
      cancelled: "destructive",
    };
    return <Badge variant={variants[status] || "outline"}>{status.replace("_", " ")}</Badge>;
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-1/3" />
          <div className="h-64 bg-muted rounded" />
        </div>
      </div>
    );
  }

  if (!meeting) {
    return (
      <div className="p-6">
        <p className="text-muted-foreground">Meeting not found</p>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center gap-4">
        <Link href={`/app/employees/${meeting.employeeId}/one-to-ones`}>
          <Button variant="ghost" size="icon" data-testid="button-back">
            <ArrowLeft className="h-4 w-4" />
          </Button>
        </Link>
        <div className="flex-1">
          <div className="flex items-center gap-3 flex-wrap">
            <h1 className="text-2xl font-bold" data-testid="text-page-title">
              {meeting.templateName || "1:1 Meeting"}
            </h1>
            {getStatusBadge(meeting.status)}
          </div>
          <div className="flex items-center gap-4 text-muted-foreground mt-1 flex-wrap">
            <div className="flex items-center gap-2">
              <User className="h-4 w-4" />
              <span>{meeting.employeeName} with {meeting.managerName}</span>
            </div>
            <div className="flex items-center gap-2">
              <Calendar className="h-4 w-4" />
              <span>{new Date(meeting.scheduledAt).toLocaleDateString("sv-SE")}</span>
            </div>
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4" />
              <span>
                {new Date(meeting.scheduledAt).toLocaleTimeString("sv-SE", {
                  hour: "2-digit",
                  minute: "2-digit",
                })}
              </span>
            </div>
            {meeting.location && (
              <div className="flex items-center gap-2">
                <MapPin className="h-4 w-4" />
                <span>{meeting.location}</span>
              </div>
            )}
          </div>
        </div>
        <Select
          value={meeting.status}
          onValueChange={(v) => handleStatusChange(v as OneToOneMeeting["status"])}
        >
          <SelectTrigger className="w-40" data-testid="select-status">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="planned">Planned</SelectItem>
            <SelectItem value="in_progress">In Progress</SelectItem>
            <SelectItem value="completed">Completed</SelectItem>
            <SelectItem value="cancelled">Cancelled</SelectItem>
          </SelectContent>
        </Select>
      </div>

      <Tabs defaultValue="before" className="space-y-4">
        <TabsList>
          <TabsTrigger value="before" data-testid="tab-before">Before</TabsTrigger>
          <TabsTrigger value="during" data-testid="tab-during">During</TabsTrigger>
          <TabsTrigger value="after" data-testid="tab-after">After</TabsTrigger>
        </TabsList>

        <TabsContent value="before" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Shared Agenda</CardTitle>
            </CardHeader>
            <CardContent>
              <Textarea
                value={sharedAgenda}
                onChange={(e) => setSharedAgenda(e.target.value)}
                placeholder="Topics both parties want to discuss..."
                rows={4}
                data-testid="input-shared-agenda"
              />
            </CardContent>
          </Card>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Card>
              <CardHeader>
                <CardTitle>Employee Private Notes</CardTitle>
              </CardHeader>
              <CardContent>
                <Textarea
                  value={employeeNotes}
                  onChange={(e) => setEmployeeNotes(e.target.value)}
                  placeholder="Private notes for employee..."
                  rows={4}
                  data-testid="input-employee-notes"
                />
              </CardContent>
            </Card>
            <Card>
              <CardHeader>
                <CardTitle>Manager Private Notes</CardTitle>
              </CardHeader>
              <CardContent>
                <Textarea
                  value={managerNotes}
                  onChange={(e) => setManagerNotes(e.target.value)}
                  placeholder="Private notes for manager..."
                  rows={4}
                  data-testid="input-manager-notes"
                />
              </CardContent>
            </Card>
          </div>

          <div className="flex justify-end">
            <Button onClick={handleSaveNotes} disabled={saving} data-testid="button-save-notes">
              {saving ? "Saving..." : "Save Notes"}
            </Button>
          </div>
        </TabsContent>

        <TabsContent value="during" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Discussion Points & Agenda</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="bg-muted p-4 rounded-md whitespace-pre-wrap">
                {sharedAgenda || "No agenda set"}
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between gap-4">
              <CardTitle>Action Items</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex gap-2 flex-wrap">
                <Input
                  value={newActionDesc}
                  onChange={(e) => setNewActionDesc(e.target.value)}
                  placeholder="New action item..."
                  className="flex-1 min-w-48"
                  data-testid="input-new-action"
                />
                <Select
                  value={newActionOwner}
                  onValueChange={(v) => setNewActionOwner(v as OneToOneActionOwner)}
                >
                  <SelectTrigger className="w-32" data-testid="select-action-owner">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="employee">Employee</SelectItem>
                    <SelectItem value="manager">Manager</SelectItem>
                  </SelectContent>
                </Select>
                <Input
                  type="date"
                  value={newActionDue}
                  onChange={(e) => setNewActionDue(e.target.value)}
                  className="w-40"
                  data-testid="input-action-due"
                />
                <Button onClick={handleAddAction} disabled={!newActionDesc.trim()} data-testid="button-add-action">
                  <Plus className="h-4 w-4" />
                </Button>
              </div>

              {actions.length === 0 ? (
                <p className="text-muted-foreground text-center py-4">No action items yet</p>
              ) : (
                <div className="space-y-2">
                  {actions.map((action) => (
                    <div
                      key={action.id}
                      className={`flex items-start gap-3 p-3 rounded-md border ${
                        action.isCompleted ? "bg-muted/50" : ""
                      }`}
                    >
                      <Checkbox
                        checked={action.isCompleted}
                        onCheckedChange={() => !action.isCompleted && handleCompleteAction(action.id)}
                        data-testid={`checkbox-action-${action.id}`}
                      />
                      <div className="flex-1">
                        <p className={action.isCompleted ? "line-through text-muted-foreground" : ""}>
                          {action.description}
                        </p>
                        <div className="flex items-center gap-2 mt-1 text-sm text-muted-foreground">
                          <Badge variant="outline" className="text-xs">
                            {action.ownerType}
                          </Badge>
                          {action.dueDate && <span>Due: {action.dueDate}</span>}
                        </div>
                      </div>
                      {action.isCompleted && <CheckCircle2 className="h-4 w-4 text-green-600" />}
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="after" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Meeting Summary</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <h4 className="font-medium mb-2">Discussed Topics</h4>
                <div className="bg-muted p-4 rounded-md whitespace-pre-wrap">
                  {sharedAgenda || "No agenda recorded"}
                </div>
              </div>

              <div>
                <h4 className="font-medium mb-2">
                  Action Items ({actions.filter((a) => a.isCompleted).length}/{actions.length} completed)
                </h4>
                {actions.length === 0 ? (
                  <p className="text-muted-foreground">No action items</p>
                ) : (
                  <div className="space-y-2">
                    {actions.map((action) => (
                      <div
                        key={action.id}
                        className="flex items-center gap-3 p-2 rounded-md border"
                      >
                        {action.isCompleted ? (
                          <CheckCircle2 className="h-4 w-4 text-green-600" />
                        ) : (
                          <div className="h-4 w-4 rounded-full border-2" />
                        )}
                        <span className={action.isCompleted ? "line-through text-muted-foreground" : ""}>
                          {action.description}
                        </span>
                        <Badge variant="outline" className="ml-auto text-xs">
                          {action.ownerType}
                        </Badge>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {meeting.status !== "completed" && (
                <Button
                  onClick={() => handleStatusChange("completed")}
                  className="w-full"
                  data-testid="button-complete-meeting"
                >
                  Mark Meeting as Completed
                </Button>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
</file>

<file path="app/one-to-ones/page.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { format } from "date-fns";
import { Calendar, Users, Clock, MapPin, Plus, MessageSquare } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { supabase } from "@/lib/supabaseClient";
import { getAllMeetings, createMeeting } from "@/services/oneToOne";
import type { OneToOneMeeting, OneToOneMeetingStatus, Employee } from "@/types/domain";

const statusColors: Record<OneToOneMeetingStatus, string> = {
  planned: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
  in_progress: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",
  completed: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
  cancelled: "bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200",
};

const statusLabels: Record<OneToOneMeetingStatus, string> = {
  planned: "Planned",
  in_progress: "In Progress",
  completed: "Completed",
  cancelled: "Cancelled",
};

export default function OneToOnesListPage() {
  const [meetings, setMeetings] = useState<OneToOneMeeting[]>([]);
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState<string>("all");
  const [searchQuery, setSearchQuery] = useState("");
  const [dialogOpen, setDialogOpen] = useState(false);
  const [creating, setCreating] = useState(false);

  const [newMeeting, setNewMeeting] = useState({
    employeeId: "",
    managerId: "",
    scheduledAt: "",
    durationMinutes: "60",
    location: "",
    templateName: "Medarbetarsamtal",
    sharedAgenda: "",
  });

  useEffect(() => {
    async function loadData() {
      const [meetingsData, employeesRes] = await Promise.all([
        getAllMeetings(),
        supabase.from("employees").select("id, name, role").eq("is_active", true).order("name"),
      ]);
      
      setMeetings(meetingsData);
      setEmployees(
        (employeesRes.data || []).map((e) => ({
          id: e.id,
          name: e.name || "",
          employeeNumber: "",
          role: e.role || "",
          line: "",
          team: "",
          employmentType: "permanent" as const,
          isActive: true,
        }))
      );
      setLoading(false);
    }
    loadData();
  }, []);

  const filteredMeetings = meetings.filter((m) => {
    const matchesStatus = filterStatus === "all" || m.status === filterStatus;
    const matchesSearch =
      searchQuery === "" ||
      m.employeeName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      m.managerName?.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesStatus && matchesSearch;
  });

  async function handleCreateMeeting() {
    if (!newMeeting.employeeId || !newMeeting.managerId || !newMeeting.scheduledAt) {
      return;
    }
    
    setCreating(true);
    const result = await createMeeting({
      employeeId: newMeeting.employeeId,
      managerId: newMeeting.managerId,
      scheduledAt: new Date(newMeeting.scheduledAt).toISOString(),
      durationMinutes: parseInt(newMeeting.durationMinutes) || 60,
      location: newMeeting.location || undefined,
      templateName: newMeeting.templateName || undefined,
      sharedAgenda: newMeeting.sharedAgenda || undefined,
    });

    if (result) {
      const updatedMeetings = await getAllMeetings();
      setMeetings(updatedMeetings);
      setDialogOpen(false);
      setNewMeeting({
        employeeId: "",
        managerId: "",
        scheduledAt: "",
        durationMinutes: "60",
        location: "",
        templateName: "Medarbetarsamtal",
        sharedAgenda: "",
      });
    }
    setCreating(false);
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="h-8 w-48 bg-muted animate-pulse rounded mb-6" />
        <div className="space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="h-24 bg-muted animate-pulse rounded" />
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between gap-4 flex-wrap">
        <div className="flex items-center gap-2">
          <MessageSquare className="h-6 w-6 text-primary" />
          <h1 className="text-2xl font-bold" data-testid="text-page-title">
            1:1 Meetings
          </h1>
          <Badge variant="secondary" className="ml-2">
            {meetings.length} total
          </Badge>
        </div>

        <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
          <DialogTrigger asChild>
            <Button data-testid="button-schedule-meeting">
              <Plus className="h-4 w-4 mr-2" />
              Schedule Meeting
            </Button>
          </DialogTrigger>
          <DialogContent className="sm:max-w-[500px]">
            <DialogHeader>
              <DialogTitle>Schedule New 1:1 Meeting</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 pt-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="employee">Employee</Label>
                  <Select
                    value={newMeeting.employeeId}
                    onValueChange={(v) => setNewMeeting({ ...newMeeting, employeeId: v })}
                  >
                    <SelectTrigger data-testid="select-employee">
                      <SelectValue placeholder="Select employee" />
                    </SelectTrigger>
                    <SelectContent>
                      {employees.map((e) => (
                        <SelectItem key={e.id} value={e.id}>
                          {e.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="manager">Manager</Label>
                  <Select
                    value={newMeeting.managerId}
                    onValueChange={(v) => setNewMeeting({ ...newMeeting, managerId: v })}
                  >
                    <SelectTrigger data-testid="select-manager">
                      <SelectValue placeholder="Select manager" />
                    </SelectTrigger>
                    <SelectContent>
                      {employees.map((e) => (
                        <SelectItem key={e.id} value={e.id}>
                          {e.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="scheduledAt">Date & Time</Label>
                  <Input
                    id="scheduledAt"
                    type="datetime-local"
                    value={newMeeting.scheduledAt}
                    onChange={(e) => setNewMeeting({ ...newMeeting, scheduledAt: e.target.value })}
                    data-testid="input-scheduled-at"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="duration">Duration (min)</Label>
                  <Input
                    id="duration"
                    type="number"
                    value={newMeeting.durationMinutes}
                    onChange={(e) => setNewMeeting({ ...newMeeting, durationMinutes: e.target.value })}
                    data-testid="input-duration"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="location">Location</Label>
                  <Input
                    id="location"
                    value={newMeeting.location}
                    onChange={(e) => setNewMeeting({ ...newMeeting, location: e.target.value })}
                    placeholder="e.g. Conference Room A"
                    data-testid="input-location"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="template">Template</Label>
                  <Select
                    value={newMeeting.templateName}
                    onValueChange={(v) => setNewMeeting({ ...newMeeting, templateName: v })}
                  >
                    <SelectTrigger data-testid="select-template">
                      <SelectValue placeholder="Select template" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Medarbetarsamtal">Medarbetarsamtal</SelectItem>
                      <SelectItem value="Lönesamtal">Lönesamtal</SelectItem>
                      <SelectItem value="Check-in">Check-in</SelectItem>
                      <SelectItem value="Other">Other</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="agenda">Shared Agenda</Label>
                <Textarea
                  id="agenda"
                  value={newMeeting.sharedAgenda}
                  onChange={(e) => setNewMeeting({ ...newMeeting, sharedAgenda: e.target.value })}
                  placeholder="Add agenda items for the meeting..."
                  rows={3}
                  data-testid="textarea-agenda"
                />
              </div>

              <div className="flex justify-end gap-2 pt-4">
                <Button variant="outline" onClick={() => setDialogOpen(false)}>
                  Cancel
                </Button>
                <Button
                  onClick={handleCreateMeeting}
                  disabled={!newMeeting.employeeId || !newMeeting.managerId || !newMeeting.scheduledAt || creating}
                  data-testid="button-create-meeting"
                >
                  {creating ? "Creating..." : "Create Meeting"}
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      <div className="flex items-center gap-4 flex-wrap">
        <Input
          placeholder="Search by name..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="max-w-xs"
          data-testid="input-search"
        />
        <Select value={filterStatus} onValueChange={setFilterStatus}>
          <SelectTrigger className="w-40" data-testid="select-status-filter">
            <SelectValue placeholder="Filter by status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Statuses</SelectItem>
            <SelectItem value="planned">Planned</SelectItem>
            <SelectItem value="in_progress">In Progress</SelectItem>
            <SelectItem value="completed">Completed</SelectItem>
            <SelectItem value="cancelled">Cancelled</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {filteredMeetings.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <MessageSquare className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
            <p className="text-muted-foreground" data-testid="text-no-meetings">
              {meetings.length === 0
                ? "No meetings scheduled yet. Click 'Schedule Meeting' to create your first 1:1."
                : "No meetings match your filters."}
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-4">
          {filteredMeetings.map((meeting) => (
            <Link
              key={meeting.id}
              href={`/app/one-to-ones/${meeting.id}`}
              data-testid={`link-meeting-${meeting.id}`}
            >
              <Card className="hover-elevate cursor-pointer">
                <CardContent className="py-4">
                  <div className="flex items-start justify-between gap-4 flex-wrap">
                    <div className="space-y-2">
                      <div className="flex items-center gap-2 flex-wrap">
                        <Users className="h-4 w-4 text-muted-foreground" />
                        <span className="font-medium">{meeting.employeeName || "Unknown"}</span>
                        <span className="text-muted-foreground">with</span>
                        <span className="font-medium">{meeting.managerName || "Unknown"}</span>
                        {meeting.templateName && (
                          <Badge variant="outline" className="ml-2">
                            {meeting.templateName}
                          </Badge>
                        )}
                      </div>
                      <div className="flex items-center gap-4 text-sm text-muted-foreground flex-wrap">
                        <div className="flex items-center gap-1">
                          <Calendar className="h-4 w-4" />
                          {format(new Date(meeting.scheduledAt), "PPp")}
                        </div>
                        {meeting.durationMinutes && (
                          <div className="flex items-center gap-1">
                            <Clock className="h-4 w-4" />
                            {meeting.durationMinutes} min
                          </div>
                        )}
                        {meeting.location && (
                          <div className="flex items-center gap-1">
                            <MapPin className="h-4 w-4" />
                            {meeting.location}
                          </div>
                        )}
                      </div>
                    </div>
                    <Badge className={statusColors[meeting.status]}>
                      {statusLabels[meeting.status]}
                    </Badge>
                  </div>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/org/overview/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { 
  Building2, 
  Users, 
  User, 
  ChevronDown, 
  ChevronRight,
  Plus,
  Upload,
  Loader2
} from "lucide-react";
import { getOrgTree, createOrgUnit } from "@/services/org";
import { COPY } from "@/lib/copy";
import { isDemoMode, getDemoOrgUnits } from "@/lib/demoRuntime";
import { useOrg } from "@/hooks/useOrg";
import type { OrgUnit } from "@/types/domain";

function OrgUnitCard({
  unit,
  showEmployees,
  level = 0,
}: {
  unit: OrgUnit;
  showEmployees: boolean;
  level?: number;
}) {
  const [expanded, setExpanded] = useState(level < 2);

  const hasChildren = unit.children && unit.children.length > 0;
  const hasEmployees = unit.employees && unit.employees.length > 0;

  return (
    <div className={level > 0 ? "ml-6 border-l-2 border-muted pl-4" : ""}>
      <Card className="mb-3">
        <CardContent className="py-4">
          <div className="flex items-center gap-3">
            {(hasChildren || (showEmployees && hasEmployees)) ? (
              <Button
                variant="ghost"
                size="icon"
                className="h-6 w-6"
                onClick={() => setExpanded(!expanded)}
                data-testid={`button-toggle-${unit.id}`}
              >
                {expanded ? (
                  <ChevronDown className="h-4 w-4" />
                ) : (
                  <ChevronRight className="h-4 w-4" />
                )}
              </Button>
            ) : (
              <div className="w-6" />
            )}

            <Building2 className="h-5 w-5 text-muted-foreground" />

            <div className="flex-1">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="font-medium" data-testid={`text-unit-name-${unit.id}`}>
                  {unit.name}
                </span>
                {unit.code && (
                  <Badge variant="outline" className="text-xs">
                    {unit.code}
                  </Badge>
                )}
                {unit.type && (
                  <Badge variant="secondary" className="text-xs">
                    {unit.type}
                  </Badge>
                )}
              </div>
              {unit.managerName && (
                <p className="text-sm text-muted-foreground flex items-center gap-1 mt-1">
                  <User className="h-3 w-3" /> Manager: {unit.managerName}
                </p>
              )}
            </div>

            <div className="flex items-center gap-2 text-muted-foreground">
              <Users className="h-4 w-4" />
              <span className="text-sm" data-testid={`text-employee-count-${unit.id}`}>
                {unit.employeeCount || 0} employees
              </span>
            </div>
          </div>
        </CardContent>
      </Card>

      {expanded && (
        <>
          {showEmployees && hasEmployees && (
            <div className="ml-10 mb-3 space-y-1">
              {unit.employees?.map((emp) => (
                <div
                  key={emp.id}
                  className="flex items-center gap-2 text-sm text-muted-foreground p-2 rounded hover-elevate"
                >
                  <User className="h-4 w-4" />
                  <span>{emp.name}</span>
                  {emp.role && <Badge variant="outline" className="text-xs">{emp.role}</Badge>}
                </div>
              ))}
            </div>
          )}

          {hasChildren &&
            unit.children?.map((child) => (
              <OrgUnitCard
                key={child.id}
                unit={child}
                showEmployees={showEmployees}
                level={level + 1}
              />
            ))}
        </>
      )}
    </div>
  );
}

export default function OrgOverviewPage() {
  const router = useRouter();
  const { currentOrg } = useOrg();
  const [orgTree, setOrgTree] = useState<OrgUnit[]>([]);
  const [loading, setLoading] = useState(true);
  const [showEmployees, setShowEmployees] = useState(false);
  const [showComingSoonModal, setShowComingSoonModal] = useState(false);
  const [showCreateUnitModal, setShowCreateUnitModal] = useState(false);
  const [newUnitName, setNewUnitName] = useState("");
  const [newUnitCode, setNewUnitCode] = useState("");
  const [creating, setCreating] = useState(false);

  const loadData = async () => {
    if (isDemoMode()) {
      const allUnits = getDemoOrgUnits();
      const rootUnits = allUnits.filter(u => !u.parentId);
      const demoUnits: OrgUnit[] = rootUnits.map(u => ({
        ...u,
        children: allUnits.filter(c => c.parentId === u.id),
      }));
      setOrgTree(demoUnits);
      setLoading(false);
      return;
    }

    if (!currentOrg) {
      setLoading(false);
      return;
    }

    const tree = await getOrgTree(currentOrg.id);
    setOrgTree(tree);
    setLoading(false);
  };

  useEffect(() => {
    loadData();
  }, [currentOrg]);

  const handleCreateUnit = async () => {
    if (!newUnitName.trim() || !currentOrg) return;
    
    setCreating(true);
    const result = await createOrgUnit({
      name: newUnitName.trim(),
      code: newUnitCode.trim() || undefined,
      orgId: currentOrg.id,
    });
    
    if (result) {
      setNewUnitName("");
      setNewUnitCode("");
      setShowCreateUnitModal(false);
      await loadData();
    }
    setCreating(false);
  };

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-muted rounded w-1/3" />
          <div className="h-64 bg-muted rounded" />
        </div>
      </div>
    );
  }

  const totalEmployees = orgTree.reduce((sum, u) => sum + (u.employeeCount || 0), 0);

  if (orgTree.length === 0) {
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between gap-4 flex-wrap">
          <div>
            <h1 className="text-2xl font-bold" data-testid="text-page-title">
              Organization Overview
            </h1>
            <p className="text-muted-foreground">
              0 units, 0 employees
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Button onClick={() => setShowCreateUnitModal(true)} data-testid="button-create-unit">
              <Plus className="h-4 w-4 mr-2" />
              {COPY.actions.createUnit}
            </Button>
            <Button 
              variant="outline" 
              onClick={() => setShowComingSoonModal(true)} 
              data-testid="button-import-org"
            >
              <Upload className="h-4 w-4 mr-2" />
              {COPY.actions.importOrgStructure}
            </Button>
          </div>
        </div>

        <Card>
          <CardContent className="py-12 text-center">
            <Building2 className="h-12 w-12 mx-auto text-gray-400 mb-4" />
            <h2 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
              {COPY.emptyStates.organization.title}
            </h2>
            <p className="text-gray-500 dark:text-gray-400 mb-6 max-w-md mx-auto">
              {COPY.emptyStates.organization.description}
            </p>
            <Button onClick={() => setShowCreateUnitModal(true)} data-testid="button-create-unit-empty">
              <Plus className="h-4 w-4 mr-2" />
              {COPY.actions.createUnit}
            </Button>
          </CardContent>
        </Card>

        {showCreateUnitModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowCreateUnitModal(false)}>
            <Card className="max-w-md mx-4 w-full" onClick={(e) => e.stopPropagation()}>
              <CardHeader>
                <CardTitle>Create Organization Unit</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="unit-name">Unit Name *</Label>
                  <Input
                    id="unit-name"
                    placeholder="e.g., Manufacturing Division"
                    value={newUnitName}
                    onChange={(e) => setNewUnitName(e.target.value)}
                    data-testid="input-unit-name"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="unit-code">Code (optional)</Label>
                  <Input
                    id="unit-code"
                    placeholder="e.g., MFG"
                    value={newUnitCode}
                    onChange={(e) => setNewUnitCode(e.target.value)}
                    data-testid="input-unit-code"
                  />
                </div>
                <div className="flex gap-2 pt-2">
                  <Button onClick={handleCreateUnit} disabled={!newUnitName.trim() || creating} data-testid="button-confirm-create">
                    {creating && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                    Create Unit
                  </Button>
                  <Button variant="outline" onClick={() => setShowCreateUnitModal(false)}>Cancel</Button>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {showComingSoonModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <Card className="max-w-md mx-4">
              <CardHeader>
                <CardTitle>Coming Soon</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-muted-foreground mb-4">
                  CSV import for organization structure is coming soon.
                </p>
                <Button onClick={() => setShowComingSoonModal(false)}>Close</Button>
              </CardContent>
            </Card>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h1 className="text-2xl font-bold" data-testid="text-page-title">
            Organization Overview
          </h1>
          <p className="text-muted-foreground">
            {orgTree.length} units, {totalEmployees} total employees
          </p>
        </div>
        <div className="flex items-center gap-4 flex-wrap">
          <div className="flex items-center gap-2">
            <span className="text-sm text-muted-foreground">Show employees</span>
            <Switch
              checked={showEmployees}
              onCheckedChange={setShowEmployees}
              data-testid="switch-show-employees"
            />
          </div>
          <div className="flex items-center gap-2">
            <Button onClick={() => setShowCreateUnitModal(true)} data-testid="button-create-unit">
              <Plus className="h-4 w-4 mr-2" />
              {COPY.actions.createUnit}
            </Button>
            <Button 
              variant="outline" 
              onClick={() => setShowComingSoonModal(true)} 
              data-testid="button-import-org"
            >
              <Upload className="h-4 w-4 mr-2" />
              {COPY.actions.importOrgStructure}
            </Button>
          </div>
        </div>
      </div>

      <div className="space-y-4">
        {orgTree.map((unit) => (
          <OrgUnitCard key={unit.id} unit={unit} showEmployees={showEmployees} />
        ))}
      </div>

      {showCreateUnitModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowCreateUnitModal(false)}>
          <Card className="max-w-md mx-4 w-full" onClick={(e) => e.stopPropagation()}>
            <CardHeader>
              <CardTitle>Create Organization Unit</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="unit-name">Unit Name *</Label>
                <Input
                  id="unit-name"
                  placeholder="e.g., Manufacturing Division"
                  value={newUnitName}
                  onChange={(e) => setNewUnitName(e.target.value)}
                  data-testid="input-unit-name"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="unit-code">Code (optional)</Label>
                <Input
                  id="unit-code"
                  placeholder="e.g., MFG"
                  value={newUnitCode}
                  onChange={(e) => setNewUnitCode(e.target.value)}
                  data-testid="input-unit-code"
                />
              </div>
              <div className="flex gap-2 pt-2">
                <Button onClick={handleCreateUnit} disabled={!newUnitName.trim() || creating} data-testid="button-confirm-create">
                  {creating && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  Create Unit
                </Button>
                <Button variant="outline" onClick={() => setShowCreateUnitModal(false)}>Cancel</Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {showComingSoonModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <Card className="max-w-md mx-4">
            <CardHeader>
              <CardTitle>Coming Soon</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-muted-foreground mb-4">
                CSV import for organization structure is coming soon.
              </p>
              <Button onClick={() => setShowComingSoonModal(false)}>Close</Button>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/org/select/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useOrg } from '@/hooks/useOrg';
import { supabase } from '@/lib/supabaseClient';
import { Building2, Plus, ArrowRight, Loader2 } from 'lucide-react';

export default function OrgSelectPage() {
  const { memberships, isLoading, selectOrg, refreshMemberships } = useOrg();
  const router = useRouter();
  const [showCreate, setShowCreate] = useState(false);
  const [creating, setCreating] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');

  const handleSelectOrg = (orgId: string) => {
    selectOrg(orgId);
    router.push('/app');
  };

  const handleCreateOrg = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setCreating(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.access_token) {
        setError('Not authenticated');
        setCreating(false);
        return;
      }

      const res = await fetch('/api/org/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({ name, slug }),
      });

      const data = await res.json();

      if (!res.ok) {
        setError(data.error || 'Failed to create organization');
        setCreating(false);
        return;
      }

      // Refresh memberships and select new org
      await refreshMemberships();
      selectOrg(data.organization.id);
      router.push('/app');
    } catch (err) {
      console.error('Create org error:', err);
      setError('Failed to create organization');
      setCreating(false);
    }
  };

  const generateSlug = (value: string) => {
    return value
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .substring(0, 50);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background" data-testid="loading-orgs">
        <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-background p-4">
      <div className="w-full max-w-md space-y-6">
        <div className="text-center">
          <Building2 className="w-12 h-12 mx-auto text-muted-foreground mb-4" />
          <h1 className="text-2xl font-semibold text-foreground" data-testid="text-page-title">
            Select Organization
          </h1>
          <p className="text-muted-foreground mt-2">
            Choose an organization to continue
          </p>
        </div>

        {memberships.length > 0 && (
          <div className="space-y-2">
            {memberships.map((membership) => (
              <button
                key={membership.org_id}
                onClick={() => handleSelectOrg(membership.org_id)}
                className="w-full p-4 rounded-lg border border-border bg-card hover-elevate flex items-center justify-between group"
                data-testid={`button-select-org-${membership.org_id}`}
              >
                <div className="text-left">
                  <div className="font-medium text-foreground">
                    {membership.organization?.name}
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {membership.role.charAt(0).toUpperCase() + membership.role.slice(1)}
                  </div>
                </div>
                <ArrowRight className="w-5 h-5 text-muted-foreground group-hover:text-foreground transition-colors" />
              </button>
            ))}
          </div>
        )}

        <div className="border-t border-border pt-6">
          {!showCreate ? (
            <button
              onClick={() => setShowCreate(true)}
              className="w-full p-4 rounded-lg border border-dashed border-border hover-elevate flex items-center justify-center gap-2 text-muted-foreground hover:text-foreground"
              data-testid="button-show-create-org"
            >
              <Plus className="w-5 h-5" />
              Create New Organization
            </button>
          ) : (
            <form onSubmit={handleCreateOrg} className="space-y-4">
              <div>
                <label htmlFor="org-name" className="block text-sm font-medium text-foreground mb-1">
                  Organization Name
                </label>
                <input
                  id="org-name"
                  type="text"
                  value={name}
                  onChange={(e) => {
                    setName(e.target.value);
                    if (!slug || slug === generateSlug(name)) {
                      setSlug(generateSlug(e.target.value));
                    }
                  }}
                  placeholder="Acme Corporation"
                  className="w-full px-3 py-2 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
                  required
                  data-testid="input-org-name"
                />
              </div>

              <div>
                <label htmlFor="org-slug" className="block text-sm font-medium text-foreground mb-1">
                  URL Slug
                </label>
                <input
                  id="org-slug"
                  type="text"
                  value={slug}
                  onChange={(e) => setSlug(generateSlug(e.target.value))}
                  placeholder="acme-corp"
                  className="w-full px-3 py-2 rounded-md border border-input bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
                  required
                  pattern="^[a-z0-9-]+$"
                  data-testid="input-org-slug"
                />
                <p className="text-xs text-muted-foreground mt-1">
                  Lowercase letters, numbers, and hyphens only
                </p>
              </div>

              {error && (
                <p className="text-sm text-destructive" data-testid="text-error">
                  {error}
                </p>
              )}

              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() => {
                    setShowCreate(false);
                    setError(null);
                  }}
                  className="flex-1 px-4 py-2 rounded-md border border-border text-foreground hover-elevate"
                  data-testid="button-cancel-create"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={creating}
                  className="flex-1 px-4 py-2 rounded-md bg-primary text-primary-foreground hover-elevate disabled:opacity-50 flex items-center justify-center gap-2"
                  data-testid="button-create-org"
                >
                  {creating ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Creating...
                    </>
                  ) : (
                    'Create'
                  )}
                </button>
              </div>
            </form>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/safety/certificates/page.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { Shield, Search, AlertTriangle, CheckCircle } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import type { CertificateInfo } from "@/types/domain";

export default function SafetyCertificatesPage() {
  const [certificates, setCertificates] = useState<CertificateInfo[]>([]);
  const [loading, setLoading] = useState(true);
  const [lineFilter, setLineFilter] = useState("");
  const [skillFilter, setSkillFilter] = useState("");
  const [lines, setLines] = useState<string[]>([]);
  const [skills, setSkills] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    async function load() {
      const [certsRes, linesRes, skillsRes] = await Promise.all([
        supabase
          .from("employee_skills")
          .select(`
            employee_id,
            skill_id,
            level,
            employees!inner(id, name, line, team, is_active),
            skills!inner(id, name, code, category)
          `)
          .in("skills.category", ["safety", "certificate"]),
        supabase.from("employees").select("line").eq("is_active", true),
        supabase.from("skills").select("id, name").in("category", ["safety", "certificate"]),
      ]);

      const employeeIds = [...new Set((certsRes.data || []).map((s: Record<string, unknown>) => {
        const emp = s.employees as Record<string, unknown>;
        return emp?.id as string;
      }).filter(Boolean))];

      let trainingEvents: Record<string, unknown>[] = [];
      if (employeeIds.length > 0) {
        const { data: eventsData } = await supabase
          .from("person_events")
          .select("employee_id, category, completed_date, due_date")
          .eq("category", "training")
          .in("employee_id", employeeIds);
        trainingEvents = eventsData || [];
      }

      const trainingByEmployee = new Map<string, { completedDate?: string; dueDate?: string }>();
      for (const event of trainingEvents) {
        const empId = event.employee_id as string;
        if (!trainingByEmployee.has(empId)) {
          trainingByEmployee.set(empId, {
            completedDate: event.completed_date as string | undefined,
            dueDate: event.due_date as string | undefined,
          });
        } else {
          const existing = trainingByEmployee.get(empId)!;
          if (event.completed_date && (!existing.completedDate || event.completed_date > existing.completedDate)) {
            existing.completedDate = event.completed_date as string;
          }
          if (event.due_date && (!existing.dueDate || event.due_date > existing.dueDate)) {
            existing.dueDate = event.due_date as string;
          }
        }
      }

      const mappedCerts: CertificateInfo[] = (certsRes.data || [])
        .filter((row: Record<string, unknown>) => {
          const emp = row.employees as Record<string, unknown>;
          return emp?.is_active === true;
        })
        .map((row: Record<string, unknown>) => {
          const emp = row.employees as Record<string, unknown>;
          const skill = row.skills as Record<string, unknown>;
          const empId = emp?.id as string;
          const training = trainingByEmployee.get(empId);

          return {
            employeeId: empId,
            employeeName: emp?.name as string,
            line: emp?.line as string,
            team: emp?.team as string,
            skillId: skill?.id as string,
            skillName: skill?.name as string,
            skillCode: skill?.code as string,
            currentLevel: row.level as number,
            latestTrainingDate: training?.completedDate,
            nextDueDate: training?.dueDate,
          };
        });

      setCertificates(mappedCerts);
      setLines([...new Set((linesRes.data || []).map((r) => r.line).filter(Boolean))].sort());
      setSkills((skillsRes.data || []).map((s) => ({ id: s.id, name: s.name })));
      setLoading(false);
    }
    load();
  }, []);

  const filteredCerts = certificates.filter((c) => {
    const matchesLine = !lineFilter || c.line === lineFilter;
    const matchesSkill = !skillFilter || c.skillId === skillFilter;
    return matchesLine && matchesSkill;
  });

  const levelLabels = ["Not trained", "In training", "Can assist", "Trained", "Can train others"];

  function getLevelColor(level: number) {
    if (level >= 3) return "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400";
    if (level >= 2) return "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400";
    return "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
  }

  function getDueStatus(dueDate?: string) {
    if (!dueDate) return null;
    const due = new Date(dueDate);
    const today = new Date();
    const daysUntil = Math.ceil((due.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    if (daysUntil < 0) return { status: "overdue", label: "Overdue", color: "text-red-600 dark:text-red-400" };
    if (daysUntil <= 30) return { status: "soon", label: `Due in ${daysUntil}d`, color: "text-yellow-600 dark:text-yellow-400" };
    return { status: "ok", label: due.toLocaleDateString(), color: "text-gray-500 dark:text-gray-400" };
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <Shield className="h-6 w-6 text-gray-600 dark:text-gray-400" />
          <h1 className="text-2xl font-semibold text-gray-900 dark:text-white">
            Safety & Certificates
          </h1>
        </div>
        <span className="text-sm text-gray-500 dark:text-gray-400">
          {filteredCerts.length} records
        </span>
      </div>

      <div className="flex flex-wrap gap-3 mb-6">
        <select
          value={lineFilter}
          onChange={(e) => setLineFilter(e.target.value)}
          className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
          data-testid="select-line-filter"
        >
          <option value="">All Lines</option>
          {lines.map((line) => (
            <option key={line} value={line}>
              {line}
            </option>
          ))}
        </select>
        <select
          value={skillFilter}
          onChange={(e) => setSkillFilter(e.target.value)}
          className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
          data-testid="select-skill-filter"
        >
          <option value="">All Certificates</option>
          {skills.map((skill) => (
            <option key={skill.id} value={skill.id}>
              {skill.name}
            </option>
          ))}
        </select>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <table className="w-full">
          <thead>
            <tr className="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Employee
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Line / Team
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Certificate
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Level
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Last Training
              </th>
              <th className="text-left px-4 py-3 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Next Due
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
            {filteredCerts.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                  No certificates found
                </td>
              </tr>
            ) : (
              filteredCerts.map((cert, idx) => {
                const dueStatus = getDueStatus(cert.nextDueDate);
                return (
                  <tr
                    key={`${cert.employeeId}-${cert.skillId}-${idx}`}
                    className="hover:bg-gray-50 dark:hover:bg-gray-700/50"
                  >
                    <td className="px-4 py-3">
                      <Link
                        href={`/app/employees/${cert.employeeId}`}
                        className="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400"
                      >
                        {cert.employeeName}
                      </Link>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                      {cert.line || "-"} / {cert.team || "-"}
                    </td>
                    <td className="px-4 py-3">
                      <div>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">
                          {cert.skillName}
                        </span>
                        <span className="ml-2 text-xs text-gray-500 dark:text-gray-400">
                          {cert.skillCode}
                        </span>
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`px-2 py-1 text-xs rounded-full ${getLevelColor(cert.currentLevel)}`}>
                        {levelLabels[cert.currentLevel]}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                      {cert.latestTrainingDate
                        ? new Date(cert.latestTrainingDate).toLocaleDateString()
                        : "-"}
                    </td>
                    <td className="px-4 py-3">
                      {dueStatus ? (
                        <div className="flex items-center gap-1">
                          {dueStatus.status === "overdue" && (
                            <AlertTriangle className="h-4 w-4 text-red-500" />
                          )}
                          {dueStatus.status === "soon" && (
                            <AlertTriangle className="h-4 w-4 text-yellow-500" />
                          )}
                          {dueStatus.status === "ok" && (
                            <CheckCircle className="h-4 w-4 text-green-500" />
                          )}
                          <span className={`text-sm ${dueStatus.color}`}>{dueStatus.label}</span>
                        </div>
                      ) : (
                        <span className="text-sm text-gray-400">-</span>
                      )}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="app/settings/page.tsx">
'use client';

import { Settings, User, Bell, Palette, Globe } from 'lucide-react';

export default function SettingsPage() {
  return (
    <div className="p-6 max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-gray-900 dark:text-white" data-testid="text-page-title">
          Settings
        </h1>
        <p className="text-gray-600 dark:text-gray-400 mt-1">
          Manage your account and application preferences
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <User className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Profile</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Update your personal information and profile settings
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Bell className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Notifications</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Configure email and in-app notification preferences
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Palette className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Appearance</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Customize the look and feel of the application
              </p>
            </div>
          </div>
        </div>

        <div className="p-5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
          <div className="flex items-start gap-3">
            <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
              <Globe className="w-5 h-5 text-gray-600 dark:text-gray-300" />
            </div>
            <div>
              <h3 className="font-medium text-gray-900 dark:text-white">Language & Region</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                Set your preferred language and regional settings
              </p>
            </div>
          </div>
        </div>
      </div>

      <div className="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
        <p className="text-sm text-gray-500 dark:text-gray-400">
          Settings functionality is coming soon. Check back later for more options.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="app/setup/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { 
  CheckCircle2, 
  Circle, 
  Building2, 
  Users, 
  BookOpen, 
  Briefcase, 
  TrendingUp,
  ArrowRight 
} from "lucide-react";
import { COPY } from "@/lib/copy";
import { isDemoMode, DEMO_EMPLOYEES, DEMO_SKILLS, DEMO_POSITIONS, DEMO_ORG_UNITS } from "@/lib/demoData";

interface SetupStep {
  id: string;
  title: string;
  completed: boolean;
  icon: typeof Building2;
  action: () => void;
  buttonLabel: string;
  secondaryAction?: () => void;
  secondaryButtonLabel?: string;
}

const SETUP_STORAGE_KEY = "nadiplan_setup_progress";

function getStoredProgress(): Record<string, boolean> {
  if (typeof window === "undefined") return {};
  try {
    const stored = localStorage.getItem(SETUP_STORAGE_KEY);
    return stored ? JSON.parse(stored) : {};
  } catch {
    return {};
  }
}

function saveProgress(progress: Record<string, boolean>) {
  if (typeof window === "undefined") return;
  localStorage.setItem(SETUP_STORAGE_KEY, JSON.stringify(progress));
}

export default function SetupPage() {
  const router = useRouter();
  const [progress, setProgress] = useState<Record<string, boolean>>({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const stored = getStoredProgress();
    
    if (isDemoMode()) {
      setProgress({
        orgUnit: DEMO_ORG_UNITS.length >= 1,
        employees: DEMO_EMPLOYEES.length >= 1,
        skills: DEMO_SKILLS.length >= 3,
        positions: DEMO_POSITIONS.length >= 1,
        gaps: false,
      });
    } else {
      setProgress(stored);
    }
    setLoading(false);
  }, []);

  const markComplete = (stepId: string) => {
    const newProgress = { ...progress, [stepId]: true };
    setProgress(newProgress);
    saveProgress(newProgress);
  };

  const steps: SetupStep[] = [
    {
      id: "orgUnit",
      title: COPY.setup.steps.orgUnit.title,
      completed: progress.orgUnit ?? false,
      icon: Building2,
      action: () => router.push("/app/org/overview"),
      buttonLabel: COPY.setup.steps.orgUnit.button,
    },
    {
      id: "employees",
      title: COPY.setup.steps.employees.title,
      completed: progress.employees ?? false,
      icon: Users,
      action: () => router.push("/app/import-employees"),
      buttonLabel: COPY.setup.steps.employees.buttonPrimary,
      secondaryAction: () => router.push("/app/employees"),
      secondaryButtonLabel: COPY.setup.steps.employees.buttonSecondary,
    },
    {
      id: "skills",
      title: COPY.setup.steps.skills.title,
      completed: progress.skills ?? false,
      icon: BookOpen,
      action: () => router.push("/admin/competence"),
      buttonLabel: COPY.setup.steps.skills.button,
    },
    {
      id: "positions",
      title: COPY.setup.steps.positions.title,
      completed: progress.positions ?? false,
      icon: Briefcase,
      action: () => router.push("/admin/positions"),
      buttonLabel: COPY.setup.steps.positions.button,
    },
    {
      id: "gaps",
      title: COPY.setup.steps.gaps.title,
      completed: progress.gaps ?? false,
      icon: TrendingUp,
      action: () => {
        markComplete("gaps");
        router.push("/app/gaps");
      },
      buttonLabel: COPY.setup.steps.gaps.button,
    },
  ];

  const completedCount = steps.filter((s) => s.completed).length;
  const allComplete = completedCount === steps.length;

  if (loading) {
    return (
      <div className="p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 dark:bg-gray-700 rounded w-48" />
          <div className="h-64 bg-gray-200 dark:bg-gray-700 rounded" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 max-w-3xl mx-auto" data-testid="setup-page">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900 dark:text-white" data-testid="heading-setup">
          {COPY.setup.title}
        </h1>
        <p className="text-gray-500 dark:text-gray-400 mt-1">
          {COPY.setup.description}
        </p>
      </div>

      {allComplete && (
        <Card className="mb-6 border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20">
          <CardContent className="py-4">
            <div className="flex items-center gap-3">
              <CheckCircle2 className="h-6 w-6 text-green-600 dark:text-green-400" />
              <span className="font-medium text-green-700 dark:text-green-300" data-testid="text-setup-complete">
                {COPY.setup.complete}
              </span>
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <div className="flex items-center justify-between gap-2 flex-wrap">
            <CardTitle>Setup Checklist</CardTitle>
            <Badge variant={allComplete ? "default" : "secondary"}>
              {completedCount} / {steps.length} completed
            </Badge>
          </div>
          <CardDescription>
            Complete each step to unlock the full potential of your platform.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {steps.map((step) => (
            <div
              key={step.id}
              className={`flex items-center gap-4 p-4 rounded-md border ${
                step.completed
                  ? "bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800"
                  : "bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
              }`}
              data-testid={`setup-step-${step.id}`}
            >
              <div className="flex-shrink-0">
                {step.completed ? (
                  <CheckCircle2 className="h-6 w-6 text-green-600 dark:text-green-400" />
                ) : (
                  <Circle className="h-6 w-6 text-gray-300 dark:text-gray-600" />
                )}
              </div>
              <step.icon className="h-5 w-5 text-gray-500 dark:text-gray-400" />
              <div className="flex-1">
                <span
                  className={`font-medium ${
                    step.completed
                      ? "text-green-700 dark:text-green-300"
                      : "text-gray-900 dark:text-white"
                  }`}
                >
                  {step.title}
                </span>
              </div>
              <div className="flex items-center gap-2 flex-wrap">
                {step.secondaryAction && !step.completed && (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={step.secondaryAction}
                    data-testid={`button-${step.id}-secondary`}
                  >
                    {step.secondaryButtonLabel}
                  </Button>
                )}
                {!step.completed && (
                  <Button
                    size="sm"
                    onClick={step.action}
                    data-testid={`button-${step.id}`}
                  >
                    {step.buttonLabel}
                    <ArrowRight className="h-4 w-4 ml-1" />
                  </Button>
                )}
              </div>
            </div>
          ))}
        </CardContent>
      </Card>

      <div className="mt-6 flex justify-center">
        <Button variant="outline" onClick={() => router.push("/app/dashboard")}>
          Back to Dashboard
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="app/spaljisten/dashboard/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  Users,
  Layers,
  Wrench,
  TrendingUp,
  AlertTriangle,
  Download,
  ChevronDown,
  ChevronRight,
} from "lucide-react";

type SPArea = { id: string; areaCode: string; areaName: string };

type DashboardKPIs = {
  totalEmployees: number;
  totalSkills: number;
  totalAreas: number;
  totalRatings: number;
  averageIndependentRate: number;
  orgName: string;
  orgId: string;
};

type TopRiskSkill = {
  skillId: string;
  skillName: string;
  category: string;
  independentCount: number;
  totalRated: number;
  riskLevel: string;
};

type SkillGapData = {
  skillId: string;
  skillName: string;
  category: string;
  independentCount: number;
  totalEmployees: number;
  employees: { employeeId: string; employeeName: string; areaName: string; rating: number | null }[];
  riskLevel: "ok" | "warning" | "critical";
};

type DashboardData = {
  kpis: DashboardKPIs;
  topRiskSkills: TopRiskSkill[];
  skillGapTable: SkillGapData[];
  filterOptions: { areas: SPArea[] };
};

export default function SpaljistenDashboard() {
  const [data, setData] = useState<DashboardData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [selectedArea, setSelectedArea] = useState<string>("");
  const [expandedSkills, setExpandedSkills] = useState<Set<string>>(new Set());

  const fetchData = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (selectedArea) params.set("areaId", selectedArea);

      const response = await fetch(`/api/spaljisten/dashboard?${params.toString()}`);
      if (!response.ok) throw new Error("Failed to load dashboard");
      const json = await response.json();
      setData(json);
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load dashboard");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [selectedArea]);

  const handleExport = () => {
    const params = new URLSearchParams();
    if (selectedArea) params.set("areaId", selectedArea);
    window.open(`/api/spaljisten/export?${params.toString()}`, "_blank");
  };

  const toggleSkillExpand = (skillId: string) => {
    const newExpanded = new Set(expandedSkills);
    if (newExpanded.has(skillId)) {
      newExpanded.delete(skillId);
    } else {
      newExpanded.add(skillId);
    }
    setExpandedSkills(newExpanded);
  };

  const getRiskBadge = (level: "ok" | "warning" | "critical") => {
    switch (level) {
      case "critical":
        return <Badge variant="destructive">Critical</Badge>;
      case "warning":
        return <Badge className="bg-yellow-500 hover:bg-yellow-600">Warning</Badge>;
      default:
        return <Badge className="bg-green-500 hover:bg-green-600">OK</Badge>;
    }
  };

  if (loading && !data) {
    return (
      <div className="p-6 flex items-center justify-center min-h-[400px]">
        <div className="text-muted-foreground">Loading dashboard...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-6">
        <Card className="border-destructive">
          <CardContent className="pt-6 text-center">
            <p className="text-destructive">{error}</p>
            <Button onClick={fetchData} className="mt-4">
              Retry
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!data) return null;

  return (
    <div className="p-6 space-y-6">
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-3 mb-4" data-testid="banner-data-status">
        <div className="flex flex-wrap items-center gap-4 text-sm">
          <span className="font-bold text-blue-900 dark:text-blue-100">{data.kpis.orgName}</span>
          <span className="text-xs text-blue-600 dark:text-blue-400 font-mono">{data.kpis.orgId.slice(0, 8)}...</span>
          <span className="text-blue-700 dark:text-blue-300">
            Areas: {data.kpis.totalAreas}
          </span>
          <span className="text-blue-700 dark:text-blue-300">
            Employees: {data.kpis.totalEmployees}
          </span>
          <span className="text-blue-700 dark:text-blue-300">
            Skills: {data.kpis.totalSkills}
          </span>
          <span className="text-blue-700 dark:text-blue-300">
            Ratings: {data.kpis.totalRatings}
          </span>
        </div>
      </div>

      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold" data-testid="heading-dashboard">
            Skill Matrix Dashboard
          </h1>
          <p className="text-muted-foreground">
            Gap and risk analysis for {data.kpis.orgName}
          </p>
        </div>
        <Button onClick={handleExport} data-testid="button-export">
          <Download className="h-4 w-4 mr-2" />
          Export CSV
        </Button>
      </div>

      <div className="flex flex-wrap gap-4">
        <Select value={selectedArea || "all"} onValueChange={(v) => setSelectedArea(v === "all" ? "" : v)}>
          <SelectTrigger className="w-[200px]" data-testid="select-area">
            <SelectValue placeholder="All Areas" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Areas</SelectItem>
            {data.filterOptions.areas.map((area) => (
              <SelectItem key={area.id} value={area.id}>
                {area.areaName}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <Users className="h-8 w-8 text-blue-500" />
              <div>
                <p className="text-2xl font-bold" data-testid="kpi-employees">
                  {data.kpis.totalEmployees}
                </p>
                <p className="text-sm text-muted-foreground">Employees</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <Layers className="h-8 w-8 text-purple-500" />
              <div>
                <p className="text-2xl font-bold" data-testid="kpi-areas">
                  {data.kpis.totalAreas}
                </p>
                <p className="text-sm text-muted-foreground">Areas</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <Wrench className="h-8 w-8 text-orange-500" />
              <div>
                <p className="text-2xl font-bold" data-testid="kpi-skills">
                  {data.kpis.totalSkills}
                </p>
                <p className="text-sm text-muted-foreground">Skills</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-3">
              <TrendingUp className="h-8 w-8 text-green-500" />
              <div>
                <p className="text-2xl font-bold" data-testid="kpi-rate">
                  {data.kpis.averageIndependentRate}%
                </p>
                <p className="text-sm text-muted-foreground">Independent Rate</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-yellow-500" />
            Top 10 Risk Skills
          </CardTitle>
        </CardHeader>
        <CardContent>
          {data.topRiskSkills.length === 0 ? (
            <p className="text-muted-foreground text-center py-4">
              No risk data available. Import skill ratings first.
            </p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b">
                    <th className="text-left p-2">Skill</th>
                    <th className="text-left p-2">Category</th>
                    <th className="text-center p-2">Independent</th>
                    <th className="text-center p-2">Total Rated</th>
                    <th className="text-center p-2">Risk</th>
                  </tr>
                </thead>
                <tbody>
                  {data.topRiskSkills.map((skill, idx) => (
                    <tr key={skill.skillId} className="border-b hover-elevate">
                      <td className="p-2">
                        <span className="font-medium">{idx + 1}. </span>
                        {skill.skillName}
                        <span className="text-muted-foreground ml-1">({skill.skillId})</span>
                      </td>
                      <td className="p-2 text-muted-foreground">{skill.category}</td>
                      <td className="text-center p-2">{skill.independentCount}</td>
                      <td className="text-center p-2">{skill.totalRated}</td>
                      <td className="text-center p-2">
                        {getRiskBadge(skill.riskLevel as "ok" | "warning" | "critical")}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Skill Gap Details ({data.skillGapTable.length} skills with ratings)</CardTitle>
        </CardHeader>
        <CardContent>
          {data.skillGapTable.length === 0 ? (
            <p className="text-muted-foreground text-center py-4">
              No skill data available for the selected filters.
            </p>
          ) : (
            <div className="space-y-2">
              {data.skillGapTable.map((item) => (
                <div
                  key={item.skillId}
                  className="border rounded-md overflow-hidden"
                >
                  <button
                    className="w-full flex items-center justify-between p-3 hover-elevate text-left"
                    onClick={() => toggleSkillExpand(item.skillId)}
                    data-testid={`button-expand-${item.skillId}`}
                  >
                    <div className="flex items-center gap-3">
                      {expandedSkills.has(item.skillId) ? (
                        <ChevronDown className="h-4 w-4" />
                      ) : (
                        <ChevronRight className="h-4 w-4" />
                      )}
                      <div>
                        <span className="font-medium">{item.skillName}</span>
                        <span className="text-muted-foreground ml-2 text-sm">
                          ({item.skillId} • {item.category})
                        </span>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-sm">
                        {item.independentCount} / {item.totalEmployees} independent
                      </span>
                      {getRiskBadge(item.riskLevel)}
                    </div>
                  </button>

                  {expandedSkills.has(item.skillId) && (
                    <div className="border-t bg-muted/50 p-3">
                      {item.employees.length === 0 ? (
                        <p className="text-sm text-muted-foreground">No employees rated for this skill.</p>
                      ) : (
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                          {item.employees.map((emp) => (
                            <div
                              key={emp.employeeId}
                              className="flex items-center justify-between p-2 bg-background rounded border"
                            >
                              <div className="truncate mr-2">
                                <span className="text-sm">{emp.employeeName}</span>
                                <span className="text-xs text-muted-foreground block">{emp.areaName}</span>
                              </div>
                              <Badge
                                variant={
                                  emp.rating === null
                                    ? "outline"
                                    : emp.rating >= 3
                                    ? "default"
                                    : "secondary"
                                }
                                className={
                                  emp.rating !== null && emp.rating >= 3
                                    ? "bg-green-500"
                                    : emp.rating !== null && emp.rating < 3
                                    ? "bg-yellow-500"
                                    : ""
                                }
                              >
                                {emp.rating ?? "N"}
                              </Badge>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/spaljisten/import/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Upload, CheckCircle, XCircle, AlertCircle, FileText, Trash2, RefreshCw } from "lucide-react";

type ImportResult = {
  success: boolean;
  importType: string;
  totalRows: number;
  inserted: number;
  updated: number;
  failed: number;
  failedRows: { line: number; reason: string }[];
};

const IMPORT_TYPES = [
  { value: "areas", label: "Areas", order: 1, description: "Production areas / departments" },
  { value: "stations", label: "Stations", order: 2, description: "Work stations within areas" },
  { value: "employees", label: "Employees", order: 3, description: "Employee master data" },
  { value: "skills_catalog", label: "Skills Catalog", order: 4, description: "Skills/competencies list" },
  { value: "employee_skill_ratings", label: "Employee Skill Ratings", order: 5, description: "Skill matrix ratings" },
  { value: "area_leaders", label: "Area Leaders", order: 6, description: "Map leaders to areas" },
  { value: "rating_scales", label: "Rating Scales", order: 7, description: "Rating configuration (optional)" },
];

type DataCounts = {
  areas: number;
  stations: number;
  employees: number;
  skills: number;
  ratings: number;
};

export default function SpaljistenImportPage() {
  const [selectedType, setSelectedType] = useState<string>("");
  const [file, setFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [isResetting, setIsResetting] = useState(false);
  const [result, setResult] = useState<ImportResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [dataCounts, setDataCounts] = useState<DataCounts | null>(null);

  const fetchDataCounts = async () => {
    try {
      const res = await fetch("/api/spaljisten/reset");
      if (res.ok) {
        setDataCounts(await res.json());
      }
    } catch (err) {
      console.error("Failed to fetch data counts:", err);
    }
  };

  useEffect(() => {
    fetchDataCounts();
  }, []);

  const handleReset = async () => {
    if (!confirm("Are you sure you want to delete ALL Spaljisten data? This cannot be undone.")) {
      return;
    }
    setIsResetting(true);
    setError(null);
    try {
      const res = await fetch("/api/spaljisten/reset", { method: "DELETE" });
      const data = await res.json();
      if (!res.ok) {
        setError(data.error || "Reset failed");
      } else {
        setResult(null);
        fetchDataCounts();
        alert("Dataset reset successfully!");
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "Reset failed");
    } finally {
      setIsResetting(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0];
    if (f) {
      setFile(f);
      setResult(null);
      setError(null);
    }
  };

  const handleImport = async () => {
    if (!file || !selectedType) return;

    setIsUploading(true);
    setResult(null);
    setError(null);

    try {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("importType", selectedType);

      const response = await fetch("/api/spaljisten/import", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || "Import failed");
      } else {
        setResult(data);
        fetchDataCounts();
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "Import failed");
    } finally {
      setIsUploading(false);
    }
  };

  const getStatusColor = (result: ImportResult) => {
    if (result.failed > 0) return "destructive";
    if (result.updated > 0) return "default";
    return "default";
  };

  return (
    <div className="p-6 max-w-4xl mx-auto space-y-6">
      <div className="flex items-start justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold" data-testid="heading-import">
            Spaljisten Data Import
          </h1>
          <p className="text-muted-foreground mt-1">
            Import CSV files to populate the skill matrix. Import in order: Areas &rarr; Stations &rarr; Employees &rarr; Skills &rarr; Ratings.
          </p>
        </div>
        <Button
          variant="destructive"
          onClick={handleReset}
          disabled={isResetting}
          data-testid="button-reset"
        >
          <Trash2 className="h-4 w-4 mr-2" />
          {isResetting ? "Resetting..." : "Reset All Data"}
        </Button>
      </div>

      {dataCounts && (
        <Card>
          <CardContent className="pt-4">
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-6 text-sm">
                <span>Areas: <strong data-testid="count-areas">{dataCounts.areas}</strong></span>
                <span>Stations: <strong data-testid="count-stations">{dataCounts.stations}</strong></span>
                <span>Employees: <strong data-testid="count-employees">{dataCounts.employees}</strong></span>
                <span>Skills: <strong data-testid="count-skills">{dataCounts.skills}</strong></span>
                <span>Ratings: <strong data-testid="count-ratings">{dataCounts.ratings}</strong></span>
              </div>
              <Button size="sm" variant="ghost" onClick={fetchDataCounts} data-testid="button-refresh-counts">
                <RefreshCw className="h-4 w-4" />
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Upload className="h-5 w-5" />
            Upload CSV
          </CardTitle>
          <CardDescription>
            Select import type and upload your CSV file. Existing records will be updated (UPSERT).
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <label className="text-sm font-medium">Import Type</label>
            <Select value={selectedType} onValueChange={setSelectedType}>
              <SelectTrigger data-testid="select-import-type">
                <SelectValue placeholder="Select what to import..." />
              </SelectTrigger>
              <SelectContent>
                {IMPORT_TYPES.map((type) => (
                  <SelectItem key={type.value} value={type.value}>
                    <span className="font-medium">{type.order}. {type.label}</span>
                    <span className="text-muted-foreground text-xs ml-2">({type.description})</span>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium">CSV File</label>
            <div className="flex items-center gap-3">
              <input
                type="file"
                accept=".csv"
                onChange={handleFileChange}
                className="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-primary file:text-primary-foreground hover:file:bg-primary/90"
                data-testid="input-file"
              />
            </div>
            {file && (
              <p className="text-sm text-muted-foreground flex items-center gap-1">
                <FileText className="h-4 w-4" />
                {file.name} ({(file.size / 1024).toFixed(1)} KB)
              </p>
            )}
          </div>

          <Button
            onClick={handleImport}
            disabled={!file || !selectedType || isUploading}
            className="w-full"
            data-testid="button-import"
          >
            {isUploading ? "Importing..." : "Import"}
          </Button>
        </CardContent>
      </Card>

      {error && (
        <Card className="border-destructive">
          <CardContent className="pt-6">
            <div className="flex items-center gap-2 text-destructive">
              <XCircle className="h-5 w-5" />
              <span className="font-medium">Import Failed</span>
            </div>
            <p className="mt-2 text-sm">{error}</p>
          </CardContent>
        </Card>
      )}

      {result && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              {result.failed === 0 ? (
                <CheckCircle className="h-5 w-5 text-green-600" />
              ) : (
                <AlertCircle className="h-5 w-5 text-yellow-600" />
              )}
              Import Report
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="text-center p-3 bg-muted rounded-md">
                <p className="text-2xl font-bold">{result.totalRows}</p>
                <p className="text-sm text-muted-foreground">Total Rows</p>
              </div>
              <div className="text-center p-3 bg-green-50 dark:bg-green-950 rounded-md">
                <p className="text-2xl font-bold text-green-600">{result.inserted}</p>
                <p className="text-sm text-muted-foreground">Inserted</p>
              </div>
              <div className="text-center p-3 bg-blue-50 dark:bg-blue-950 rounded-md">
                <p className="text-2xl font-bold text-blue-600">{result.updated}</p>
                <p className="text-sm text-muted-foreground">Updated</p>
              </div>
              <div className="text-center p-3 bg-red-50 dark:bg-red-950 rounded-md">
                <p className="text-2xl font-bold text-red-600">{result.failed}</p>
                <p className="text-sm text-muted-foreground">Failed</p>
              </div>
            </div>

            {result.failedRows.length > 0 && (
              <div className="space-y-2">
                <h4 className="font-medium text-destructive">Failed Rows</h4>
                <div className="max-h-48 overflow-y-auto border rounded-md">
                  <table className="w-full text-sm">
                    <thead className="bg-muted sticky top-0">
                      <tr>
                        <th className="text-left p-2 w-20">Line</th>
                        <th className="text-left p-2">Reason</th>
                      </tr>
                    </thead>
                    <tbody>
                      {result.failedRows.map((row, idx) => (
                        <tr key={idx} className="border-t">
                          <td className="p-2 font-mono">{row.line}</td>
                          <td className="p-2 text-destructive">{row.reason}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <Badge variant={getStatusColor(result)} data-testid="badge-import-status">
              {result.success ? "Import Successful" : "Import Completed with Errors"}
            </Badge>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle>CSV Format Reference</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm">
          <div>
            <h4 className="font-medium">employees.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              employee_id, employee_name, email, area_code
            </code>
          </div>
          <div>
            <h4 className="font-medium">skills_catalog.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              skill_id, skill_name, station_code, category
            </code>
          </div>
          <div>
            <h4 className="font-medium">employee_skill_ratings.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              employee_id, skill_id, rating (0-4 or N for not assessed)
            </code>
          </div>
          <div>
            <h4 className="font-medium">areas.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              area_code, area_name
            </code>
          </div>
          <div>
            <h4 className="font-medium">stations.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              station_code, station_name, area_code
            </code>
          </div>
          <div>
            <h4 className="font-medium">area_leaders.csv</h4>
            <code className="block bg-muted p-2 rounded mt-1">
              area_code, employee_id, is_primary
            </code>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="app/tomorrows-gaps/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { getPositionCoverageForDate, PositionCoverageSummary } from "@/services/competence";
import { Loader2, AlertTriangle } from "lucide-react";
import { Progress } from "@/components/ui/progress";
import Link from "next/link";
import { useAuthGuard } from "@/hooks/useAuthGuard";

function getTomorrowDateString(): string {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  return tomorrow.toISOString().slice(0, 10);
}

function RiskBadge({ risk }: { risk: string }) {
  const variants: Record<string, string> = {
    HIGH: "hr-risk-pill hr-risk-pill--high",
    MEDIUM: "hr-risk-pill hr-risk-pill--medium",
    LOW: "hr-risk-pill hr-risk-pill--low",
  };

  return (
    <span className={variants[risk] || "hr-risk-pill"} data-testid={`risk-badge-${risk.toLowerCase()}`}>
      {risk}
    </span>
  );
}

function PositionCoverageCard({ position }: { position: PositionCoverageSummary }) {
  const coveragePercent = position.minHeadcount > 0 
    ? Math.round((position.availableCount / position.minHeadcount) * 100) 
    : 100;

  return (
    <div className="hr-card" data-testid={`card-position-${position.positionId}`}>
      <div className="flex items-center justify-between gap-2 flex-wrap mb-3">
        <h3 className="hr-card__title">{position.positionName}</h3>
        <RiskBadge risk={position.riskLevel} />
      </div>
      
      <div className="hr-emp-summary-grid">
        <div className="hr-emp-summary-card">
          <span className="hr-emp-summary-label">Min Required</span>
          <span className="hr-emp-summary-value">{position.minHeadcount}</span>
        </div>
        <div className="hr-emp-summary-card">
          <span className="hr-emp-summary-label">Fully Competent</span>
          <span className="hr-emp-summary-value">{position.availableCount}</span>
        </div>
        <div className="hr-emp-summary-card">
          <span className="hr-emp-summary-label">Gap</span>
          <span className={`hr-emp-summary-value ${position.gap > 0 ? 'text-red-600 dark:text-red-400' : ''}`}>
            {position.gap}
          </span>
        </div>
      </div>

      <div className="mt-4">
        <div className="flex items-center justify-between gap-2 mb-1">
          <span className="text-sm text-muted-foreground">Coverage</span>
          <span className="text-sm font-medium">{coveragePercent}%</span>
        </div>
        <Progress value={coveragePercent} className="h-2" />
      </div>

      {(position.site || position.department) && (
        <div className="flex items-center gap-2 mt-3 text-sm text-muted-foreground">
          {position.site && <span>{position.site}</span>}
          {position.site && position.department && <span>/</span>}
          {position.department && <span>{position.department}</span>}
        </div>
      )}

      <div className="mt-4 pt-3 border-t border-border">
        <Link 
          href="/competence/matrix" 
          className="text-sm text-primary hover:underline"
          data-testid={`link-matrix-${position.positionId}`}
        >
          View competence matrix
        </Link>
      </div>
    </div>
  );
}

export default function TomorrowsGapsPage() {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p>Checking access...</p>
      </main>
    );
  }

  return <TomorrowsGapsContent />;
}

function TomorrowsGapsContent() {
  const [positions, setPositions] = useState<PositionCoverageSummary[]>([]);
  const [effectiveDate, setEffectiveDate] = useState<string>("");
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchData() {
      setLoading(true);
      setError(null);
      
      const tomorrow = getTomorrowDateString();
      setEffectiveDate(tomorrow);
      
      try {
        const coverageData = await getPositionCoverageForDate(tomorrow);
        setPositions(coverageData);
      } catch (err) {
        console.error("Failed to load coverage data:", err);
        setError("Failed to load gap analysis data. Please try again.");
      } finally {
        setLoading(false);
      }
    }
    
    fetchData();
  }, []);

  const totalPositions = positions.length;
  const highRiskCount = positions.filter(p => p.riskLevel === "HIGH").length;
  const mediumRiskCount = positions.filter(p => p.riskLevel === "MEDIUM").length;
  const lowRiskCount = positions.filter(p => p.riskLevel === "LOW").length;
  const totalGap = positions.reduce((sum, p) => sum + p.gap, 0);

  if (loading) {
    return (
      <main className="hr-page">
        <header className="hr-page__header">
          <div>
            <h1 className="hr-page__title">Tomorrow&apos;s Gaps</h1>
            <p className="hr-page__subtitle">
              Coverage and risk per position based on minimum headcount and competence.
            </p>
          </div>
        </header>
        <div className="flex items-center justify-center gap-3 p-12">
          <Loader2 className="h-5 w-5 animate-spin" data-testid="loading-spinner" />
          <span className="text-muted-foreground">Calculating tomorrow&apos;s gaps...</span>
        </div>
      </main>
    );
  }

  if (error) {
    return (
      <main className="hr-page">
        <header className="hr-page__header">
          <div>
            <h1 className="hr-page__title">Tomorrow&apos;s Gaps</h1>
            <p className="hr-page__subtitle">
              Coverage and risk per position based on minimum headcount and competence.
            </p>
          </div>
        </header>
        <div className="hr-error" data-testid="error-message">
          <AlertTriangle className="h-4 w-4 inline-block mr-2" />
          {error}
        </div>
      </main>
    );
  }

  if (positions.length === 0) {
    return (
      <main className="hr-page">
        <header className="hr-page__header">
          <div>
            <h1 className="hr-page__title">Tomorrow&apos;s Gaps</h1>
            <p className="hr-page__subtitle">
              Coverage and risk per position based on minimum headcount and competence.
            </p>
          </div>
          <div className="tg-date-pill" data-testid="date-pill">
            Analyzing: {effectiveDate}
          </div>
        </header>
        <div className="hr-empty" data-testid="empty-state">
          <p className="font-medium mb-2">No positions with minimum headcount defined</p>
          <p className="text-sm text-muted-foreground">
            Add min_headcount to positions to see Tomorrow&apos;s Gaps analysis.
          </p>
        </div>
      </main>
    );
  }

  return (
    <main className="hr-page">
      <header className="hr-page__header">
        <div>
          <h1 className="hr-page__title">Tomorrow&apos;s Gaps</h1>
          <p className="hr-page__subtitle">
            Coverage and risk per position based on minimum headcount and competence.
          </p>
        </div>
        <div className="tg-date-pill" data-testid="date-pill">
          Analyzing: {effectiveDate}
        </div>
      </header>

      <div className="hr-kpi-grid" data-testid="summary-kpis">
        <div className="hr-kpi">
          <span className="hr-kpi__label">Total Positions</span>
          <span className="hr-kpi__value">{totalPositions}</span>
        </div>
        <div className="hr-kpi">
          <span className="hr-kpi__label">High Risk</span>
          <span className={`hr-kpi__value ${highRiskCount > 0 ? 'hr-kpi__value--danger' : ''}`}>
            {highRiskCount}
          </span>
        </div>
        <div className="hr-kpi">
          <span className="hr-kpi__label">Medium Risk</span>
          <span className={`hr-kpi__value ${mediumRiskCount > 0 ? 'hr-kpi__value--warn' : ''}`}>
            {mediumRiskCount}
          </span>
        </div>
        <div className="hr-kpi">
          <span className="hr-kpi__label">Low Risk</span>
          <span className="hr-kpi__value hr-kpi__value--ok">{lowRiskCount}</span>
        </div>
        <div className="hr-kpi">
          <span className="hr-kpi__label">Total Missing Headcount</span>
          <span className={`hr-kpi__value ${totalGap > 0 ? 'hr-kpi__value--danger' : ''}`}>
            {totalGap}
          </span>
        </div>
      </div>

      <div className="hr-grid mt-6" data-testid="positions-grid">
        {positions.map((position) => (
          <PositionCoverageCard key={position.positionId} position={position} />
        ))}
      </div>
    </main>
  );
}
</file>

<file path="app/layout.tsx">
"use client";

import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useState, useEffect } from "react";
import { 
  LayoutDashboard, 
  Grid3X3, 
  Upload, 
  Users, 
  Settings,
  ShieldAlert,
  Package,
  Newspaper,
  FileText,
  BookOpen,
  Shield,
  Building2,
  BarChart3,
  Workflow,
  LogOut,
  Wrench,
  TrendingUp,
  Clipboard,
  Bug,
  Gauge,
  Factory,
  Target
} from "lucide-react";
import { getCurrentUser, type CurrentUser } from "@/lib/auth";
import { useAuth } from "@/hooks/useAuth";
import { signOut } from "@/services/auth";
import { OrgProvider } from "@/components/OrgProvider";
import { DemoModeBanner } from "@/components/DemoModeBanner";
import { GlobalErrorHandler } from "@/components/GlobalErrorHandler";
import { COPY } from "@/lib/copy";

type NavItem = {
  name: string;
  href: string;
  icon: React.ComponentType<{ className?: string }>;
  hrAdminOnly?: boolean;
};

const coreNavItems: NavItem[] = [
  { name: "Cockpit", href: "/app/cockpit", icon: Gauge },
  { name: "Line Overview", href: "/app/line-overview", icon: Factory },
  { name: "Dashboard", href: "/app/dashboard", icon: LayoutDashboard },
  { name: "Employees", href: "/app/employees", icon: Users },
  { name: "Organization", href: "/app/org/overview", icon: Building2 },
  { name: "Competence Matrix", href: "/app/competence-matrix", icon: Grid3X3 },
  { name: "Tomorrow's Gaps", href: "/app/gaps", icon: TrendingUp },
  { name: "Setup", href: "/app/setup", icon: Clipboard },
  { name: "Admin", href: "/app/admin", icon: Wrench, hrAdminOnly: true },
];

const hrNavItems: NavItem[] = [
  { name: "Manager Risks", href: "/app/manager/risks", icon: ShieldAlert },
  { name: "HR Analytics", href: "/app/hr/analytics", icon: BarChart3, hrAdminOnly: true },
  { name: "HR Workflows", href: "/app/hr/workflows", icon: Workflow, hrAdminOnly: true },
  { name: "Import Employees", href: "/app/import-employees", icon: Upload, hrAdminOnly: true },
];

const moreNavItems: NavItem[] = [
  { name: "Safety / Certificates", href: "/app/safety/certificates", icon: Shield },
  { name: "Equipment", href: "/app/equipment", icon: Package },
  { name: "Handbooks", href: "/app/handbooks", icon: BookOpen },
  { name: "Documents", href: "/app/documents", icon: FileText },
  { name: "News", href: "/app/news", icon: Newspaper },
];

const spaljistenNavItems: NavItem[] = [
  { name: "SP Dashboard", href: "/app/spaljisten/dashboard", icon: Target },
  { name: "SP Import", href: "/app/spaljisten/import", icon: Upload },
];

const settingsNavItems: NavItem[] = [
  { name: "Settings", href: "/app/settings", icon: Settings },
  { name: "Debug", href: "/app/debug", icon: Bug },
];

// Dev mode flag - when true, all authenticated users can access Spaljisten pages
const SPALI_DEV_MODE = process.env.NEXT_PUBLIC_SPALI_DEV_MODE === "true";

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const router = useRouter();
  const { user: authUser, loading: authLoading, isAuthenticated } = useAuth(true);
  const [user, setUser] = useState<CurrentUser | null>(null);

  const isSpaljistenPage = pathname?.startsWith("/app/spaljisten");

  useEffect(() => {
    if (isAuthenticated) {
      getCurrentUser().then(setUser);
    }
  }, [isAuthenticated]);

  // In dev mode, no route guards - all authenticated users can access everything
  // In production mode, would check org membership in DB (not email domain)
  // For now, dev mode removes all restrictions

  async function handleSignOut() {
    try {
      await signOut();
      router.push("/login");
    } catch (err) {
      console.error("Sign out failed:", err);
    }
  }

  if (authLoading) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50 dark:bg-gray-900">
        <div className="text-gray-500 dark:text-gray-400">Loading...</div>
      </div>
    );
  }

  if (!isAuthenticated) {
    return null;
  }

  const filterItems = (items: NavItem[]) => 
    items.filter((item) => {
      if (item.hrAdminOnly && user?.role !== "HR_ADMIN") return false;
      return true;
    });

  // In dev mode: show all navigation including Spaljisten
  // On Spaljisten pages: show only Spaljisten nav (focused experience)
  const showOnlySpaljisten = !SPALI_DEV_MODE && isSpaljistenPage;
  const showSpaljistenNav = SPALI_DEV_MODE || isSpaljistenPage;

  const visibleCoreItems = showOnlySpaljisten ? [] : filterItems(coreNavItems);
  const visibleHrItems = showOnlySpaljisten ? [] : filterItems(hrNavItems);
  const visibleMoreItems = showOnlySpaljisten ? [] : moreNavItems;
  const visibleSettingsItems = showOnlySpaljisten ? [] : filterItems(settingsNavItems);
  const visibleSpaljistenItems = showSpaljistenNav ? spaljistenNavItems : [];

  const renderNavItem = (item: NavItem) => {
    const isActive = pathname === item.href || pathname?.startsWith(item.href + "/");
    const Icon = item.icon;

    return (
      <li key={item.name}>
        <Link
          href={item.href}
          className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors ${
            isActive
              ? "bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"
              : "text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50"
          }`}
          data-testid={`nav-${item.name.toLowerCase().replace(/\s+/g, "-")}`}
        >
          <Icon className="h-4 w-4" />
          {item.name}
        </Link>
      </li>
    );
  };

  return (
    <OrgProvider>
      <GlobalErrorHandler />
      <div className="flex flex-col h-screen bg-gray-50 dark:bg-gray-900">
        <DemoModeBanner />
          <div className="flex flex-1 overflow-hidden">
          <aside className="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <div className="p-6 border-b border-gray-200 dark:border-gray-700">
              <h1 className="text-lg font-semibold text-gray-900 dark:text-white">
                Industrial Competence
              </h1>
              <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Platform</p>
            </div>
            <nav className="flex-1 p-4 overflow-y-auto">
              {visibleCoreItems.length > 0 && (
                <div className="mb-4">
                  <p className="px-3 mb-2 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                    {COPY.nav.core}
                  </p>
                  <ul className="space-y-1">
                    {visibleCoreItems.map(renderNavItem)}
                  </ul>
                </div>
              )}

              {visibleHrItems.length > 0 && (
                <div className="mb-4">
                  <p className="px-3 mb-2 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                    HR Tools
                  </p>
                  <ul className="space-y-1">
                    {visibleHrItems.map(renderNavItem)}
                  </ul>
                </div>
              )}

              {visibleMoreItems.length > 0 && (
                <div className="mb-4">
                  <p className="px-3 mb-2 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                    More
                  </p>
                  <ul className="space-y-1">
                    {visibleMoreItems.map(renderNavItem)}
                  </ul>
                </div>
              )}

              {visibleSpaljistenItems.length > 0 && (
                <div className="mb-4">
                  <p className="px-3 mb-2 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                    Spaljisten
                  </p>
                  <ul className="space-y-1">
                    {visibleSpaljistenItems.map(renderNavItem)}
                  </ul>
                </div>
              )}

              {visibleSettingsItems.length > 0 && (
                <div className="pt-4 border-t border-gray-200 dark:border-gray-700">
                  <ul className="space-y-1">
                    {visibleSettingsItems.map(renderNavItem)}
                  </ul>
                </div>
              )}
            </nav>
          </aside>

          <div className="flex-1 flex flex-col overflow-hidden">
            <header className="h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-6">
              <div className="text-sm text-gray-500 dark:text-gray-400">
                {new Date().toLocaleDateString("en-US", {
                  weekday: "long",
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </div>
              <div className="flex items-center gap-3">
                <span className="text-sm text-gray-600 dark:text-gray-300" data-testid="text-user-email">
                  {authUser?.email || user?.email || "User"}
                </span>
                <button
                  onClick={handleSignOut}
                  className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors"
                  data-testid="button-signout"
                >
                  <LogOut className="h-4 w-4" />
                  Sign out
                </button>
              </div>
            </header>

            <main className="flex-1 overflow-auto">
              {children}
            </main>
            </div>
          </div>
        </div>
    </OrgProvider>
  );
}
</file>

<file path="app/page.tsx">
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export default function AppPage() {
  const router = useRouter();

  useEffect(() => {
    router.replace("/app/dashboard");
  }, [router]);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="animate-pulse text-muted-foreground">
        Loading dashboard...
      </div>
    </div>
  );
}
</file>

<file path="competence/matrix/page.tsx">
'use client';

import { useEffect, useState, useMemo } from 'react';
import {
  getAllPositions,
  getEmployeesForPosition,
  getEmployeeCompetenceProfile,
  PositionSummary,
  MatrixColumn,
  MatrixRow,
} from '@/services/competence';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useAuthGuard } from '@/hooks/useAuthGuard';
import { Download, Users, AlertTriangle, TrendingUp, Target } from 'lucide-react';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';

const DEMO_MODE = process.env.NEXT_PUBLIC_DEMO_MODE === 'true';

const DEMO_COMPETENCES = [
  { id: 'c1', label: 'Safety Training', requiredLevel: 3, groupName: 'Safety' },
  { id: 'c2', label: 'Machine Operation', requiredLevel: 4, groupName: 'Operations' },
  { id: 'c3', label: 'Quality Control', requiredLevel: 3, groupName: 'Quality' },
  { id: 'c4', label: 'First Aid', requiredLevel: 2, groupName: 'Safety' },
  { id: 'c5', label: 'Forklift Cert', requiredLevel: 3, groupName: 'Logistics' },
  { id: 'c6', label: 'Welding', requiredLevel: 4, groupName: 'Fabrication' },
  { id: 'c7', label: 'CNC Programming', requiredLevel: 3, groupName: 'Operations' },
  { id: 'c8', label: 'Lean Manufacturing', requiredLevel: 2, groupName: 'Process' },
];

const DEMO_EMPLOYEES = [
  { id: 'e1', name: 'Anna Lindqvist', levels: [3, 4, 3, 2, 3, 4, 3, 2] },
  { id: 'e2', name: 'Erik Johansson', levels: [3, 3, 2, 2, 2, 4, 3, 2] },
  { id: 'e3', name: 'Maria Svensson', levels: [2, 4, 3, 1, 3, 3, 2, 2] },
  { id: 'e4', name: 'Lars Andersson', levels: [3, 2, 3, 2, 3, 4, 1, 1] },
  { id: 'e5', name: 'Sofia Karlsson', levels: [3, 4, 2, 2, 2, 4, 3, 2] },
  { id: 'e6', name: 'Johan Eriksson', levels: [1, 3, 3, 2, 3, 2, 3, 2] },
  { id: 'e7', name: 'Karin Olsson', levels: [3, 4, 3, 2, 1, 4, 3, 2] },
  { id: 'e8', name: 'Peter Nilsson', levels: [3, 4, 3, 0, 3, 4, 3, 1] },
  { id: 'e9', name: 'Emma Larsson', levels: [2, 3, 2, 2, 2, 3, 2, 2] },
  { id: 'e10', name: 'Oscar Pettersson', levels: [3, 4, 3, 2, 3, 4, 3, 2] },
];

function computeStatus(current: number | null, required: number): 'OK' | 'GAP' | 'RISK' {
  if (current === null || current === 0) return 'RISK';
  if (current >= required) return 'OK';
  if (current >= required - 1) return 'GAP';
  return 'RISK';
}

function computeRiskLevel(statuses: ('OK' | 'GAP' | 'RISK')[]): 'LOW' | 'MEDIUM' | 'HIGH' {
  const riskCount = statuses.filter(s => s === 'RISK').length;
  const gapCount = statuses.filter(s => s === 'GAP').length;
  if (riskCount >= 2) return 'HIGH';
  if (riskCount >= 1 || gapCount >= 3) return 'MEDIUM';
  return 'LOW';
}

function generateDemoData(): { columns: MatrixColumn[], rows: MatrixRow[] } {
  const columns: MatrixColumn[] = DEMO_COMPETENCES.map(c => ({
    competenceId: c.id,
    label: c.label,
    groupName: c.groupName,
    requiredLevel: c.requiredLevel,
  }));

  const rows: MatrixRow[] = DEMO_EMPLOYEES.map(emp => {
    const items = emp.levels.map((level, idx) => {
      const required = DEMO_COMPETENCES[idx].requiredLevel;
      return {
        competenceId: DEMO_COMPETENCES[idx].id,
        status: computeStatus(level, required),
        level,
        requiredLevel: required,
      };
    });

    const statuses = items.map(i => i.status);
    const riskLevel = computeRiskLevel(statuses);

    return {
      employeeId: emp.id,
      employeeName: emp.name,
      riskLevel,
      items,
    };
  });

  return { columns, rows };
}

export default function CompetenceMatrixPage() {
  const { loading: authLoading } = useAuthGuard();

  if (authLoading) {
    return (
      <main className="hr-page">
        <p className="text-muted-foreground">Checking access...</p>
      </main>
    );
  }

  return <CompetenceMatrixContent />;
}

function CompetenceMatrixContent() {
  const [positions, setPositions] = useState<PositionSummary[]>([]);
  const [columns, setColumns] = useState<MatrixColumn[]>([]);
  const [rows, setRows] = useState<MatrixRow[]>([]);
  const [loadingMatrix, setLoadingMatrix] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const isDemoMode = useMemo(() => {
    if (typeof window === 'undefined') return DEMO_MODE;
    const urlParams = new URLSearchParams(window.location.search);
    return DEMO_MODE || urlParams.get('demo') === 'true';
  }, []);

  const [selectedPositionId, setSelectedPositionId] = useState<string | null>(null);
  const [loadingPositions, setLoadingPositions] = useState(true);

  useEffect(() => {
    if (isDemoMode) {
      const { columns: demoCols, rows: demoRows } = generateDemoData();
      setColumns(demoCols);
      setRows(demoRows);
      setPositions([{ id: 'demo', name: 'Demo Position', site: null, department: 'Demo' }]);
      setSelectedPositionId('demo');
      setLoadingPositions(false);
      return;
    }

    async function loadPositions() {
      try {
        const posData = await getAllPositions();
        setPositions(posData);
      } catch (err) {
        console.error(err);
        setError('Failed to load positions');
      } finally {
        setLoadingPositions(false);
      }
    }
    loadPositions();
  }, []);

  useEffect(() => {
    if (isDemoMode) return;
    if (!selectedPositionId) {
      setColumns([]);
      setRows([]);
      return;
    }

    async function loadMatrix() {
      setLoadingMatrix(true);
      setError(null);
      try {
        const employees = await getEmployeesForPosition(selectedPositionId!);
        
        if (employees.length === 0) {
          setColumns([]);
          setRows([]);
          setLoadingMatrix(false);
          return;
        }

        const profiles = await Promise.all(
          employees.map((emp) => getEmployeeCompetenceProfile(emp.id))
        );

        const firstProfile = profiles[0];
        const mandatoryItems = firstProfile.items.filter((item) => item.mandatory);

        const cols: MatrixColumn[] = mandatoryItems.map((item) => ({
          competenceId: item.competenceId,
          label: item.competenceName,
          groupName: item.groupName,
          requiredLevel: item.requiredLevel,
        }));

        const matrixRows: MatrixRow[] = profiles.map((profile) => {
          const itemMap = new Map(
            profile.items.map((item) => [item.competenceId, item])
          );

          return {
            employeeId: profile.employee.id,
            employeeName: profile.employee.name,
            riskLevel: profile.summary.riskLevel,
            items: cols.map((col) => {
              const item = itemMap.get(col.competenceId);
              return {
                competenceId: col.competenceId,
                status: item?.status ?? 'N/A',
                level: item?.employeeLevel ?? null,
                requiredLevel: col.requiredLevel,
              };
            }),
          };
        });

        setColumns(cols);
        setRows(matrixRows);
      } catch (err) {
        console.error(err);
        setError('Failed to load competence matrix');
      } finally {
        setLoadingMatrix(false);
      }
    }

    loadMatrix();
  }, [selectedPositionId]);

  const kpis = useMemo(() => {
    if (rows.length === 0) return null;

    const atRisk = rows.filter(r => r.riskLevel === 'HIGH').length;
    const gapSkills = new Map<string, number>();
    let totalOk = 0;
    let totalCells = 0;

    rows.forEach(row => {
      row.items.forEach((item, idx) => {
        totalCells++;
        if (item.status === 'OK') totalOk++;
        if (item.status === 'GAP' || item.status === 'RISK') {
          const label = columns[idx]?.label || 'Unknown';
          gapSkills.set(label, (gapSkills.get(label) || 0) + 1);
        }
      });
    });

    const topGap = Array.from(gapSkills.entries())
      .sort((a, b) => b[1] - a[1])[0];

    const avgReadiness = totalCells > 0 ? Math.round((totalOk / totalCells) * 100) : 0;

    return {
      atRisk,
      topGapSkill: topGap ? topGap[0] : 'None',
      topGapCount: topGap ? topGap[1] : 0,
      avgReadiness,
    };
  }, [rows, columns]);

  const handleExportCSV = () => {
    if (rows.length === 0 || columns.length === 0) return;

    const headers = ['Employee', 'Risk Level', ...columns.map(c => c.label)];
    const csvRows = rows.map(row => {
      const cells = row.items.map(item => 
        item.level !== null ? `${item.level}/${item.requiredLevel}` : '-'
      );
      return [row.employeeName, row.riskLevel, ...cells];
    });

    const csv = [headers, ...csvRows]
      .map(row => row.map(cell => `"${cell}"`).join(','))
      .join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'competence-matrix.csv';
    a.click();
    URL.revokeObjectURL(url);
  };

  const selectedPosition = positions.find((p) => p.id === selectedPositionId);

  return (
    <TooltipProvider>
      <main className="hr-page" data-testid="competence-matrix-page">
        {error && (
          <div className="p-3 mb-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 text-sm" data-testid="error-message">
            {error}
          </div>
        )}

        <header className="hr-page__header">
          <div>
            <h1 className="hr-page__title" data-testid="text-page-title">Competence Matrix</h1>
            <p className="hr-page__subtitle">
              Compare all employees in a position against the required competences.
            </p>
          </div>
        </header>

        <div className="p-4 mb-6 rounded-lg border border-border bg-card">
          <div className="flex flex-wrap items-center gap-4">
            <div className="min-w-[280px]">
              {loadingPositions ? (
                <p className="text-sm text-muted-foreground">Loading positions...</p>
              ) : (
                <Select
                  value={selectedPositionId ?? ''}
                  onValueChange={(val) => setSelectedPositionId(val || null)}
                >
                  <SelectTrigger data-testid="select-position">
                    <SelectValue placeholder="Select a position..." />
                  </SelectTrigger>
                  <SelectContent>
                    {positions.map((pos) => (
                      <SelectItem key={pos.id} value={pos.id} data-testid={`option-position-${pos.id}`}>
                        {pos.name}
                        {pos.department && ` (${pos.department})`}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              )}
            </div>

            {selectedPosition && !loadingMatrix && (
              <div className="flex items-center gap-2 text-sm text-muted-foreground" data-testid="text-employee-count">
                <Users className="w-4 h-4" />
                {rows.length} employee{rows.length !== 1 ? 's' : ''}
              </div>
            )}

            {rows.length > 0 && (
              <button
                onClick={handleExportCSV}
                className="ml-auto flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent transition-colors"
                data-testid="button-export-csv"
              >
                <Download className="w-4 h-4" />
                Export CSV
              </button>
            )}
          </div>
        </div>

        {kpis && selectedPositionId && !loadingMatrix && rows.length > 0 && (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" data-testid="kpi-grid">
            <div className="p-4 rounded-lg border border-border bg-card" data-testid="kpi-employees">
              <div className="flex items-center gap-2 text-muted-foreground text-sm mb-1">
                <Users className="w-4 h-4" />
                Total Employees
              </div>
              <div className="text-2xl font-semibold">{rows.length}</div>
            </div>
            <div className="p-4 rounded-lg border border-border bg-card" data-testid="kpi-at-risk">
              <div className="flex items-center gap-2 text-muted-foreground text-sm mb-1">
                <AlertTriangle className="w-4 h-4" />
                At Risk
              </div>
              <div className={`text-2xl font-semibold ${kpis.atRisk > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                {kpis.atRisk}
              </div>
            </div>
            <div className="p-4 rounded-lg border border-border bg-card" data-testid="kpi-top-gap">
              <div className="flex items-center gap-2 text-muted-foreground text-sm mb-1">
                <Target className="w-4 h-4" />
                Top Gap Skill
              </div>
              <div className="text-lg font-semibold truncate" title={kpis.topGapSkill}>
                {kpis.topGapSkill}
              </div>
              <div className="text-xs text-muted-foreground">{kpis.topGapCount} employees</div>
            </div>
            <div className="p-4 rounded-lg border border-border bg-card" data-testid="kpi-readiness">
              <div className="flex items-center gap-2 text-muted-foreground text-sm mb-1">
                <TrendingUp className="w-4 h-4" />
                Avg Readiness
              </div>
              <div className={`text-2xl font-semibold ${kpis.avgReadiness >= 80 ? 'text-green-600 dark:text-green-400' : kpis.avgReadiness >= 60 ? 'text-amber-600 dark:text-amber-400' : 'text-red-600 dark:text-red-400'}`}>
                {kpis.avgReadiness}%
              </div>
            </div>
          </div>
        )}

        {!selectedPositionId && !loadingPositions && (
          <div className="p-6 rounded-lg border border-dashed border-border bg-muted/50 text-center">
            <p className="text-muted-foreground">Select a position above to view the competence matrix.</p>
          </div>
        )}

        {selectedPositionId && loadingMatrix && (
          <div className="p-6 rounded-lg border border-dashed border-border bg-muted/50 text-center">
            <p className="text-muted-foreground">Loading competence matrix...</p>
          </div>
        )}

        {selectedPositionId && !loadingMatrix && rows.length === 0 && (
          <div className="p-6 rounded-lg border border-dashed border-border bg-muted/50 text-center">
            <p className="text-muted-foreground">No employees found for this position.</p>
          </div>
        )}

        {selectedPositionId && !loadingMatrix && rows.length > 0 && columns.length > 0 && (
          <div className="hr-matrix-wrapper" data-testid="matrix-container">
            <table className="hr-competence-table" data-testid="matrix-table">
              <thead>
                <tr>
                  <th style={{ minWidth: 160 }}>Employee</th>
                  <th style={{ minWidth: 80 }}>Risk</th>
                  {columns.map((col) => (
                    <th
                      key={col.competenceId}
                      style={{ minWidth: 100 }}
                    >
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <div className="hr-competence-name cursor-help">
                            <span className="max-w-[100px] overflow-hidden text-ellipsis whitespace-nowrap block">
                              {col.label.length > 12 ? col.label.slice(0, 12) + '...' : col.label}
                            </span>
                            {col.requiredLevel !== null && (
                              <span className="hr-level-chip">L{col.requiredLevel}</span>
                            )}
                          </div>
                        </TooltipTrigger>
                        <TooltipContent side="top" className="max-w-xs">
                          <div className="text-sm">
                            <strong>{col.label}</strong>
                            {col.groupName && <span className="text-muted-foreground"> ({col.groupName})</span>}
                            <br />
                            Required Level: {col.requiredLevel}
                          </div>
                        </TooltipContent>
                      </Tooltip>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {rows.map((row) => (
                  <tr key={row.employeeId} data-testid={`row-employee-${row.employeeId}`}>
                    <td className="text-left">
                      <span className="font-medium text-foreground">{row.employeeName}</span>
                    </td>
                    <td>
                      <span className={`hr-risk-pill hr-risk-pill--${row.riskLevel.toLowerCase()}`}>
                        {row.riskLevel}
                      </span>
                    </td>
                    {row.items.map((cell, idx) => (
                      <td key={columns[idx].competenceId}>
                        <div className="hr-matrix-cell">
                          <span className="hr-matrix-cell__levels">
                            <strong>{cell.level !== null ? cell.level : '-'}</strong>
                            <span>/</span>
                            <span>{cell.requiredLevel ?? columns[idx]?.requiredLevel ?? '-'}</span>
                          </span>
                          <span
                            className={`hr-status-badge hr-status-badge--${cell.status.toLowerCase()}`}
                          >
                            {cell.status}
                          </span>
                        </div>
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {selectedPositionId && !loadingMatrix && rows.length > 0 && columns.length === 0 && (
          <div className="p-6 rounded-lg border border-dashed border-border bg-muted/50 text-center">
            <p className="text-muted-foreground">No mandatory competences defined for this position.</p>
          </div>
        )}
      </main>
    </TooltipProvider>
  );
}
</file>

<file path="health/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { validatePublicEnv } from "@/lib/env";
import { supabase } from "@/lib/supabaseClient";
import { CheckCircle, XCircle, Loader2, RefreshCw } from "lucide-react";

interface HealthStatus {
  envPresent: boolean;
  missingEnvVars: string[];
  supabaseReachable: boolean | null;
  supabaseError: string | null;
  authStatus: boolean | null;
  userEmail: string | null;
  userRole: string | null;
  loading: boolean;
}

function StatusIcon({ status }: { status: boolean | null }) {
  if (status === null) {
    return <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />;
  }
  return status ? (
    <CheckCircle className="w-5 h-5 text-green-600" data-testid="icon-check" />
  ) : (
    <XCircle className="w-5 h-5 text-red-600" data-testid="icon-x" />
  );
}

function StatusRow({ 
  label, 
  status, 
  error,
  testId 
}: { 
  label: string; 
  status: boolean | null; 
  error?: string | null;
  testId: string;
}) {
  return (
    <div className="flex items-center justify-between py-3 border-b border-border last:border-0" data-testid={testId}>
      <span className="text-sm font-medium">{label}</span>
      <div className="flex items-center gap-2">
        {error && <span className="text-xs text-red-600 max-w-xs truncate">{error}</span>}
        <StatusIcon status={status} />
      </div>
    </div>
  );
}

export default function HealthPage() {
  const [health, setHealth] = useState<HealthStatus>({
    envPresent: false,
    missingEnvVars: [],
    supabaseReachable: null,
    supabaseError: null,
    authStatus: null,
    userEmail: null,
    userRole: null,
    loading: true,
  });

  async function checkHealth() {
    setHealth(prev => ({ ...prev, loading: true }));

    // Check env vars
    const envValidation = validatePublicEnv();
    
    let supabaseReachable = false;
    let supabaseError: string | null = null;
    let authStatus = false;
    let userEmail: string | null = null;
    let userRole: string | null = null;

    if (envValidation.valid) {
      // Test Supabase connection with a simple query
      try {
        const { error } = await supabase.from("profiles").select("id").limit(1);
        if (error) {
          // If table doesn't exist, that's still a successful connection
          if (error.code === "PGRST116" || error.message.includes("does not exist")) {
            supabaseReachable = true;
            supabaseError = "profiles table not found (run bootstrap)";
          } else {
            supabaseError = error.message;
          }
        } else {
          supabaseReachable = true;
        }
      } catch (err) {
        supabaseError = err instanceof Error ? err.message : "Connection failed";
      }

      // Check auth status
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          authStatus = true;
          userEmail = session.user.email || null;
          
          // Get user role from profiles
          const { data: profile } = await supabase
            .from("profiles")
            .select("role")
            .eq("id", session.user.id)
            .single();
          
          userRole = profile?.role || "not set";
        }
      } catch (err) {
        // Auth check failed
      }
    }

    setHealth({
      envPresent: envValidation.valid,
      missingEnvVars: envValidation.missing,
      supabaseReachable,
      supabaseError,
      authStatus,
      userEmail,
      userRole,
      loading: false,
    });
  }

  useEffect(() => {
    checkHealth();
  }, []);

  return (
    <div className="min-h-screen bg-background flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        <div className="bg-card rounded-lg border border-border shadow-sm p-6">
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-xl font-semibold">System Health</h1>
            <button
              onClick={checkHealth}
              disabled={health.loading}
              className="p-2 rounded-md hover:bg-accent transition-colors"
              data-testid="button-refresh"
            >
              <RefreshCw className={`w-4 h-4 ${health.loading ? 'animate-spin' : ''}`} />
            </button>
          </div>

          {!health.envPresent && health.missingEnvVars.length > 0 && (
            <div className="mb-4 p-3 bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800 rounded-md" data-testid="alert-missing-env">
              <p className="text-sm font-medium text-red-800 dark:text-red-200 mb-1">
                Missing Environment Variables
              </p>
              <ul className="text-xs text-red-700 dark:text-red-300">
                {health.missingEnvVars.map((v) => (
                  <li key={v} className="font-mono">{v}</li>
                ))}
              </ul>
            </div>
          )}

          <div className="space-y-0">
            <StatusRow
              label="Supabase env present"
              status={health.envPresent}
              testId="status-env"
            />
            <StatusRow
              label="Supabase reachable"
              status={health.supabaseReachable}
              error={health.supabaseError}
              testId="status-supabase"
            />
            <StatusRow
              label="Auth session exists"
              status={health.authStatus}
              testId="status-auth"
            />
          </div>

          {health.userEmail && (
            <div className="mt-4 pt-4 border-t border-border" data-testid="user-info">
              <p className="text-sm text-muted-foreground mb-1">Signed in as</p>
              <p className="text-sm font-medium" data-testid="text-user-email">{health.userEmail}</p>
              <p className="text-xs text-muted-foreground mt-1">
                Role: <span className="font-mono" data-testid="text-user-role">{health.userRole}</span>
              </p>
            </div>
          )}

          {!health.loading && health.envPresent && health.supabaseReachable && !health.authStatus && (
            <div className="mt-4 pt-4 border-t border-border">
              <a
                href="/login"
                className="block w-full text-center py-2 px-4 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:opacity-90 transition-opacity"
                data-testid="link-login"
              >
                Sign in
              </a>
            </div>
          )}
        </div>

        <p className="text-xs text-muted-foreground text-center mt-4">
          Industrial Competence Platform
        </p>
      </div>
    </div>
  );
}
</file>

<file path="lib/spaljistenAuth.ts">
import { createClient } from "@supabase/supabase-js";
import { cookies } from "next/headers";

const SPALJISTEN_ORG_ID = "a1b2c3d4-e5f6-7890-abcd-ef1234567890";

export async function verifySpaljistenAccess(): Promise<{ authorized: boolean; userId?: string; email?: string; error?: string }> {
  try {
    const cookieStore = await cookies();
    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

    if (!supabaseUrl || !supabaseAnonKey) {
      return { authorized: true };
    }

    const supabase = createClient(supabaseUrl, supabaseAnonKey, {
      global: {
        headers: {
          cookie: cookieStore.toString(),
        },
      },
    });

    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
      return { authorized: false, error: "Not authenticated" };
    }

    const isSpaljistenUser = user.email?.endsWith("@spaljisten.se");
    
    if (!isSpaljistenUser) {
      return { authorized: false, userId: user.id, email: user.email || undefined, error: "Not authorized for Spaljisten data" };
    }

    return { authorized: true, userId: user.id, email: user.email || undefined };
  } catch {
    return { authorized: true };
  }
}

export { SPALJISTEN_ORG_ID };
</file>

<file path="login/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { signInWithEmail, getSession } from '@/services/auth';
import { isSupabaseReady, supabase } from '@/lib/supabaseClient';
import { getRoleRedirectPath } from '@/hooks/useProfile';
import { Loader2 } from 'lucide-react';

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState('admin@nadiplan.test');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [checkingSession, setCheckingSession] = useState(true);
  const [supabaseConfigured, setSupabaseConfigured] = useState(true);
  const [bootstrapStatus, setBootstrapStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');
  const [bootstrapMessage, setBootstrapMessage] = useState<string | null>(null);
  const [showBootstrap, setShowBootstrap] = useState(false);

  useEffect(() => {
    const configured = isSupabaseReady();
    setSupabaseConfigured(configured);
    
    if (!configured) {
      console.error('Supabase not configured - env vars missing');
      setCheckingSession(false);
      return;
    }

    async function checkExistingSession() {
      try {
        const session = await getSession();
        if (session?.user) {
          // Get user role and redirect accordingly
          const { data: profile } = await supabase
            .from('profiles')
            .select('role')
            .eq('id', session.user.id)
            .single();
          
          const redirectPath = getRoleRedirectPath(profile?.role || null);
          router.replace(redirectPath);
        } else {
          setCheckingSession(false);
        }
      } catch (err) {
        console.error('Session check failed:', err);
        setCheckingSession(false);
      }
    }
    checkExistingSession();
  }, [router]);

  async function checkBootstrapStatus(userId: string): Promise<{ needsBootstrap: boolean; role: string | null }> {
    try {
      // Check if profiles table has any entries
      const { data: profiles, error } = await supabase
        .from('profiles')
        .select('id')
        .limit(1);

      if (error) {
        // Table might not exist - needs bootstrap
        return { needsBootstrap: true, role: null };
      }

      if (!profiles || profiles.length === 0) {
        // No profiles exist - this user can bootstrap
        return { needsBootstrap: true, role: null };
      }

      // Check if current user has a profile
      const { data: userProfile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', userId)
        .single();

      return { needsBootstrap: false, role: userProfile?.role || null };
    } catch {
      return { needsBootstrap: false, role: null };
    }
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErrorMsg(null);
    
    if (!supabaseConfigured) {
      setErrorMsg('Authentication service is not configured. Environment variables are missing.');
      return;
    }
    
    setLoading(true);

    try {
      const session = await signInWithEmail(email, password);
      
      if (session?.user) {
        // Check if bootstrap is needed or get role
        const { needsBootstrap, role } = await checkBootstrapStatus(session.user.id);
        
        if (needsBootstrap) {
          // Stay on login page to show bootstrap option
          setShowBootstrap(true);
          setLoading(false);
          return;
        }

        // Redirect based on role
        const redirectPath = getRoleRedirectPath(role);
        router.replace(redirectPath);
      }
    } catch (error: unknown) {
      console.error('Sign in error:', error);
      let message = 'Failed to sign in.';
      if (error instanceof Error) {
        if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {
          message = 'Unable to connect to authentication service. Please check your internet connection.';
        } else if (error.message.includes('placeholder')) {
          message = 'Authentication service is not configured. Please contact support.';
        } else if (error.message.includes('Invalid login credentials')) {
          message = 'Invalid email or password. Please try again.';
        } else {
          message = error.message;
        }
      }
      setErrorMsg(message);
      setLoading(false);
    }
  }

  async function handleBootstrap() {
    setBootstrapStatus('loading');
    setBootstrapMessage(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        setBootstrapStatus('error');
        setBootstrapMessage('Not authenticated');
        return;
      }

      const response = await fetch('/api/bootstrap', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
      });

      const data = await response.json();

      if (!response.ok) {
        setBootstrapStatus('error');
        setBootstrapMessage(data.error || 'Bootstrap failed');
        return;
      }

      setBootstrapStatus('success');
      setBootstrapMessage(data.message);
      setShowBootstrap(false);

      // Redirect to admin dashboard
      setTimeout(() => {
        router.replace('/app/admin');
      }, 1500);
    } catch (err) {
      setBootstrapStatus('error');
      setBootstrapMessage(err instanceof Error ? err.message : 'Bootstrap failed');
    }
  }

  if (checkingSession) {
    return (
      <main className="hr-page" style={{ maxWidth: 420, margin: '0 auto', paddingTop: 80 }}>
        <div className="flex items-center justify-center gap-2">
          <Loader2 className="w-4 h-4 animate-spin" />
          <p className="hr-page__subtitle">Loading...</p>
        </div>
      </main>
    );
  }

  return (
    <main className="hr-page" style={{ maxWidth: 420, margin: '0 auto', paddingTop: 80 }}>
      <h1 className="hr-page__title">Sign in</h1>
      <p className="hr-page__subtitle">
        Use your Nadiplan account to access HR dashboards.
      </p>

      <form onSubmit={handleSubmit} className="hr-card" style={{ marginTop: 16 }}>
        <div className="hr-form-field">
          <label className="hr-form-label">Email</label>
          <input
            type="email"
            className="hr-input"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            autoComplete="email"
            required
            data-testid="input-email"
          />
        </div>

        <div className="hr-form-field">
          <label className="hr-form-label">Password</label>
          <input
            type="password"
            className="hr-input"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            autoComplete="current-password"
            required
            data-testid="input-password"
          />
        </div>

        {errorMsg && (
          <p className="hr-error" style={{ marginTop: 8 }} data-testid="error-message">
            {errorMsg}
          </p>
        )}

        <button
          type="submit"
          className="hr-button hr-button--primary"
          disabled={loading}
          style={{ marginTop: 12, width: '100%' }}
          data-testid="button-signin"
        >
          {loading ? 'Signing in…' : 'Sign in'}
        </button>
      </form>

      {showBootstrap && (
        <div className="hr-card" style={{ marginTop: 16, padding: 16 }} data-testid="bootstrap-section">
          <h3 style={{ fontSize: 14, fontWeight: 600, marginBottom: 8 }}>
            Admin Setup Required
          </h3>
          <p style={{ fontSize: 13, color: 'var(--color-text-secondary)', marginBottom: 12 }}>
            No admin user exists. Click below to become the first admin.
          </p>
          
          {bootstrapMessage && (
            <p 
              className={bootstrapStatus === 'error' ? 'hr-error' : 'hr-success'}
              style={{ marginBottom: 8, fontSize: 13 }}
              data-testid="bootstrap-message"
            >
              {bootstrapMessage}
            </p>
          )}
          
          <button
            onClick={handleBootstrap}
            disabled={bootstrapStatus === 'loading' || bootstrapStatus === 'success'}
            className="hr-button hr-button--secondary"
            style={{ width: '100%' }}
            data-testid="button-bootstrap"
          >
            {bootstrapStatus === 'loading' ? (
              <span className="flex items-center justify-center gap-2">
                <Loader2 className="w-4 h-4 animate-spin" />
                Running Bootstrap...
              </span>
            ) : bootstrapStatus === 'success' ? (
              'Bootstrap Complete!'
            ) : (
              'Run Admin Bootstrap'
            )}
          </button>
        </div>
      )}

      <p style={{ marginTop: 16, fontSize: 13, color: 'var(--color-text-secondary)', textAlign: 'center' }}>
        Don&apos;t have an account?{' '}
        <a href="/signup" style={{ color: 'var(--color-primary)', textDecoration: 'underline' }} data-testid="link-signup">
          Sign up
        </a>
      </p>

      <p style={{ marginTop: 8, fontSize: 12, color: 'var(--color-text-tertiary)', textAlign: 'center' }}>
        <a href="/health" style={{ textDecoration: 'underline' }} data-testid="link-health">
          System Health Check
        </a>
      </p>
    </main>
  );
}
</file>

<file path="pricing/page.tsx">
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Check, Star } from "lucide-react";
import { pricingConfig, calculateYearlyCost } from "@/lib/pricing";
import Link from "next/link";
import { Header } from "@/components/layout/Header";
import { Footer } from "@/components/layout/Footer";

export default function PricingPage() {
  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("sv-SE", {
      style: "currency",
      currency: "SEK",
      minimumFractionDigits: 0,
    }).format(amount);
  };

  return (
    <main className="min-h-screen">
      <Header />
      <div className="pt-24 pb-16 px-6">
        <div className="max-w-5xl mx-auto">
          <div className="text-center mb-12">
            <h1 className="text-4xl font-bold mb-4">Simple, Transparent Pricing</h1>
            <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
              Purpose-built for industrial organizations. Lower cost than generic HR tools, 
              with specialized features for competence management, compliance, and people risk.
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <Card className="relative">
              <CardHeader>
                <CardTitle className="text-xl">Business</CardTitle>
                <div className="mt-4">
                  <span className="text-3xl font-bold">
                    {formatCurrency(pricingConfig.business.baseYearlySEK)}
                  </span>
                  <span className="text-muted-foreground">/year</span>
                </div>
                <p className="text-sm text-muted-foreground mt-2">
                  + {formatCurrency(pricingConfig.business.perEmployeeMonthlySEK)}/employee/month 
                  after {pricingConfig.business.maxIncludedEmployees} employees
                </p>
              </CardHeader>
              <CardContent>
                <ul className="space-y-3">
                  {pricingConfig.business.features.map((feature, i) => (
                    <li key={i} className="flex items-center gap-2 text-sm">
                      <Check className="h-4 w-4 text-green-600 flex-shrink-0" />
                      {feature}
                    </li>
                  ))}
                </ul>
                <Link 
                  href="/signup" 
                  className="block w-full mt-6 text-center py-2 px-4 border border-border rounded-md text-sm font-medium hover:bg-accent transition-colors"
                  data-testid="button-select-business"
                >
                  Get Started
                </Link>
              </CardContent>
            </Card>

            <Card className="relative border-primary">
              <div className="absolute -top-3 left-1/2 -translate-x-1/2">
                <Badge className="flex items-center gap-1">
                  <Star className="h-3 w-3" />
                  Most Popular
                </Badge>
              </div>
              <CardHeader>
                <CardTitle className="text-xl">Enterprise</CardTitle>
                <div className="mt-4">
                  <span className="text-3xl font-bold">
                    {formatCurrency(pricingConfig.enterprise.baseYearlySEK)}
                  </span>
                  <span className="text-muted-foreground">/year</span>
                </div>
                <p className="text-sm text-muted-foreground mt-2">
                  + {formatCurrency(pricingConfig.enterprise.perEmployeeMonthlySEK)}/employee/month 
                  after {pricingConfig.enterprise.maxIncludedEmployees} employees
                </p>
              </CardHeader>
              <CardContent>
                <ul className="space-y-3">
                  {pricingConfig.enterprise.features.map((feature, i) => (
                    <li key={i} className="flex items-center gap-2 text-sm">
                      <Check className="h-4 w-4 text-green-600 flex-shrink-0" />
                      {feature}
                    </li>
                  ))}
                </ul>
                <Link 
                  href="/signup" 
                  className="block w-full mt-6 text-center py-2 px-4 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:opacity-90 transition-opacity"
                  data-testid="button-select-enterprise"
                >
                  Get Started
                </Link>
              </CardContent>
            </Card>
          </div>

          <div className="text-center">
            <h2 className="text-xl font-semibold mb-4">Why Choose Us Over Generic HR Tools?</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
              <Card>
                <CardContent className="pt-6">
                  <h3 className="font-semibold mb-2">Industrial Focus</h3>
                  <p className="text-sm text-muted-foreground">
                    Built for manufacturing, logistics, and industrial operations. 
                    Not another generic HR SaaS.
                  </p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <h3 className="font-semibold mb-2">Competence Risk Engine</h3>
                  <p className="text-sm text-muted-foreground">
                    See skill gaps per line and team. Know exactly what training 
                    is needed before tomorrow&apos;s shift.
                  </p>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="pt-6">
                  <h3 className="font-semibold mb-2">Lower Cost</h3>
                  <p className="text-sm text-muted-foreground">
                    Up to 25% lower than competitors like Huma. 
                    No hidden fees, predictable pricing.
                  </p>
                </CardContent>
              </Card>
            </div>
          </div>

          <div className="mt-12 p-6 bg-muted rounded-lg text-center">
            <h3 className="font-semibold mb-2">Example: 100 Employees</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-md mx-auto text-sm">
              <div>
                <p className="text-muted-foreground">Business Plan</p>
                <p className="text-lg font-semibold">{formatCurrency(calculateYearlyCost("business", 100))}/year</p>
              </div>
              <div>
                <p className="text-muted-foreground">Enterprise Plan</p>
                <p className="text-lg font-semibold">{formatCurrency(calculateYearlyCost("enterprise", 100))}/year</p>
              </div>
            </div>
          </div>

          <div className="mt-12 text-center">
            <p className="text-muted-foreground mb-4">Ready to transform your competence management?</p>
            <Link 
              href="/signup" 
              className="inline-block py-3 px-8 bg-primary text-primary-foreground rounded-md font-medium hover:opacity-90 transition-opacity"
              data-testid="button-cta-signup"
            >
              Start Free Trial
            </Link>
          </div>
        </div>
      </div>
      <Footer />
    </main>
  );
}
</file>

<file path="signup/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { supabase, isSupabaseReady } from '@/lib/supabaseClient';
import { Loader2 } from 'lucide-react';
import Link from 'next/link';

export default function SignupPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const supabaseConfigured = isSupabaseReady();

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErrorMsg(null);

    if (!supabaseConfigured) {
      setErrorMsg('Authentication service is not configured.');
      return;
    }

    if (password !== confirmPassword) {
      setErrorMsg('Passwords do not match.');
      return;
    }

    if (password.length < 6) {
      setErrorMsg('Password must be at least 6 characters.');
      return;
    }

    setLoading(true);

    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
      });

      if (error) {
        if (error.message.includes('already registered')) {
          setErrorMsg('This email is already registered. Please sign in instead.');
        } else if (error.message.includes('valid email')) {
          setErrorMsg('Please enter a valid email address.');
        } else {
          setErrorMsg(error.message);
        }
        setLoading(false);
        return;
      }

      if (data.user) {
        setSuccess(true);
        setTimeout(() => {
          router.replace('/app/org/select');
        }, 1500);
      }
    } catch (error: unknown) {
      console.error('Sign up error:', error);
      setErrorMsg(error instanceof Error ? error.message : 'Failed to sign up.');
      setLoading(false);
    }
  }

  if (success) {
    return (
      <main className="hr-page" style={{ maxWidth: 420, margin: '0 auto', paddingTop: 80 }}>
        <div className="hr-card" style={{ textAlign: 'center', padding: 32 }}>
          <div className="flex items-center justify-center gap-2 mb-4">
            <Loader2 className="w-5 h-5 animate-spin text-green-600" />
          </div>
          <h2 style={{ fontSize: 18, fontWeight: 600, marginBottom: 8 }}>Account Created!</h2>
          <p style={{ fontSize: 14, color: 'var(--color-text-secondary)' }}>
            Redirecting to organization selection...
          </p>
        </div>
      </main>
    );
  }

  return (
    <main className="hr-page" style={{ maxWidth: 420, margin: '0 auto', paddingTop: 80 }}>
      <h1 className="hr-page__title">Create Account</h1>
      <p className="hr-page__subtitle">
        Sign up for Nadiplan to manage your industrial competencies.
      </p>

      <form onSubmit={handleSubmit} className="hr-card" style={{ marginTop: 16 }}>
        <div className="hr-form-field">
          <label className="hr-form-label">Email</label>
          <input
            type="email"
            className="hr-input"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            autoComplete="email"
            required
            data-testid="input-email"
          />
        </div>

        <div className="hr-form-field">
          <label className="hr-form-label">Password</label>
          <input
            type="password"
            className="hr-input"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            autoComplete="new-password"
            required
            minLength={6}
            data-testid="input-password"
          />
          <p style={{ fontSize: 11, color: 'var(--color-text-tertiary)', marginTop: 4 }}>
            Minimum 6 characters
          </p>
        </div>

        <div className="hr-form-field">
          <label className="hr-form-label">Confirm Password</label>
          <input
            type="password"
            className="hr-input"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            autoComplete="new-password"
            required
            data-testid="input-confirm-password"
          />
        </div>

        {errorMsg && (
          <p className="hr-error" style={{ marginTop: 8 }} data-testid="error-message">
            {errorMsg}
          </p>
        )}

        <button
          type="submit"
          className="hr-button hr-button--primary"
          disabled={loading}
          style={{ marginTop: 12, width: '100%' }}
          data-testid="button-signup"
        >
          {loading ? 'Creating account...' : 'Create Account'}
        </button>
      </form>

      <p style={{ marginTop: 16, fontSize: 13, color: 'var(--color-text-secondary)', textAlign: 'center' }}>
        Already have an account?{' '}
        <Link href="/login" style={{ color: 'var(--color-primary)', textDecoration: 'underline' }} data-testid="link-login">
          Sign in
        </Link>
      </p>

      <p style={{ marginTop: 8, fontSize: 12, color: 'var(--color-text-tertiary)', textAlign: 'center' }}>
        <Link href="/pricing" style={{ textDecoration: 'underline' }} data-testid="link-pricing">
          View Pricing
        </Link>
      </p>
    </main>
  );
}
</file>

<file path="globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --button-outline: rgba(0,0,0, .10);
  --badge-outline: rgba(0,0,0, .05);
  --opaque-button-border-intensity: -8;
  --elevate-1: rgba(0,0,0, .03);
  --elevate-2: rgba(0,0,0, .08);
  --background: 0 0% 100%;
  --foreground: 222 15% 12%;
  --border: 220 13% 91%;
  --card: 0 0% 98%;
  --card-foreground: 222 15% 12%;
  --card-border: 220 13% 94%;
  --popover: 0 0% 96%;
  --popover-foreground: 222 15% 12%;
  --popover-border: 220 13% 92%;
  --primary: 217 91% 48%;
  --primary-foreground: 210 40% 98%;
  --secondary: 220 14% 93%;
  --secondary-foreground: 222 15% 12%;
  --muted: 220 14% 94%;
  --muted-foreground: 222 15% 40%;
  --accent: 220 16% 94%;
  --accent-foreground: 222 15% 12%;
  --destructive: 0 84% 42%;
  --destructive-foreground: 0 0% 98%;
  --input: 220 13% 85%;
  --ring: 217 91% 48%;
  --chart-1: 217 91% 38%;
  --chart-2: 197 92% 35%;
  --chart-3: 173 80% 32%;
  --chart-4: 43 96% 38%;
  --chart-5: 27 87% 42%;
  --font-sans: 'Inter', sans-serif;
  --font-serif: 'IBM Plex Sans', sans-serif;
  --font-mono: Menlo, monospace;
  --radius: .5rem;

  --primary-border: hsl(var(--primary));
  --secondary-border: hsl(var(--secondary));
  --muted-border: hsl(var(--muted));
  --accent-border: hsl(var(--accent));
  --destructive-border: hsl(var(--destructive));

  /* Accessible status colors - AA compliant */
  --status-ok-bg: 142 76% 94%;
  --status-ok-text: 142 76% 22%;
  --status-ok-border: 142 76% 36%;
  --status-gap-bg: 38 92% 92%;
  --status-gap-text: 38 92% 25%;
  --status-gap-border: 38 92% 50%;
  --status-risk-bg: 0 84% 94%;
  --status-risk-text: 0 84% 28%;
  --status-risk-border: 0 84% 50%;
  --status-na-bg: 220 14% 94%;
  --status-na-text: 220 14% 40%;
  --status-na-border: 220 14% 70%;

  /* Surface hierarchy */
  --surface: 0 0% 100%;
  --surface-2: 220 14% 97%;
  --surface-3: 220 14% 94%;
}

.dark {
  --button-outline: rgba(255,255,255, .10);
  --badge-outline: rgba(255,255,255, .05);
  --opaque-button-border-intensity: 9;
  --elevate-1: rgba(255,255,255, .04);
  --elevate-2: rgba(255,255,255, .09);
  --background: 222 15% 8%;
  --foreground: 210 40% 96%;
  --border: 220 13% 18%;
  --card: 222 15% 10%;
  --card-foreground: 210 40% 96%;
  --card-border: 220 13% 14%;
  --popover: 222 15% 14%;
  --popover-foreground: 210 40% 96%;
  --popover-border: 220 13% 18%;
  --primary: 217 91% 48%;
  --primary-foreground: 210 40% 98%;
  --secondary: 222 15% 18%;
  --secondary-foreground: 210 40% 96%;
  --muted: 222 15% 16%;
  --muted-foreground: 210 40% 70%;
  --accent: 222 16% 16%;
  --accent-foreground: 210 40% 96%;
  --destructive: 0 84% 35%;
  --destructive-foreground: 0 0% 98%;
  --input: 220 13% 28%;
  --ring: 217 91% 52%;
  --chart-1: 217 91% 65%;
  --chart-2: 197 92% 60%;
  --chart-3: 173 80% 55%;
  --chart-4: 43 96% 62%;
  --chart-5: 27 87% 65%;

  /* Dark mode accessible status colors */
  --status-ok-bg: 142 76% 12%;
  --status-ok-text: 142 76% 75%;
  --status-ok-border: 142 76% 36%;
  --status-gap-bg: 38 92% 12%;
  --status-gap-text: 38 92% 72%;
  --status-gap-border: 38 92% 50%;
  --status-risk-bg: 0 84% 14%;
  --status-risk-text: 0 84% 75%;
  --status-risk-border: 0 84% 50%;
  --status-na-bg: 220 14% 16%;
  --status-na-text: 220 14% 70%;
  --status-na-border: 220 14% 35%;

  /* Surface hierarchy */
  --surface: 222 15% 8%;
  --surface-2: 222 15% 12%;
  --surface-3: 222 15% 16%;
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply font-sans antialiased bg-background text-foreground;
  }
}

@layer utilities {
  .hover-elevate:not(.no-default-hover-elevate),
  .active-elevate-2:not(.no-default-active-elevate) {
    position: relative;
    z-index: 0;
  }

  .hover-elevate:not(.no-default-hover-elevate)::after,
  .active-elevate-2:not(.no-default-active-elevate)::after {
    content: "";
    pointer-events: none;
    position: absolute;
    inset: 0px;
    border-radius: inherit;
    z-index: 999;
  }

  .hover-elevate:hover:not(.no-default-hover-elevate)::after {
    background-color: var(--elevate-1);
  }

  .active-elevate-2:active:not(.no-default-active-elevate)::after {
    background-color: var(--elevate-2);
  }
}

/* Apple-inspired HR Styles */
.hr-page {
  max-width: 1120px;
  margin: 0 auto;
  padding: 32px 16px 48px;
}

.hr-page__header {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 24px;
  margin-bottom: 32px;
}

.hr-page__header--compact {
  align-items: flex-start;
}

.hr-page__title {
  font-size: 2rem;
  font-weight: 600;
  letter-spacing: -0.03em;
  margin: 0 0 4px;
}

.hr-page__subtitle {
  margin: 0;
  color: hsl(var(--muted-foreground));
  max-width: 560px;
  font-size: 0.95rem;
}

.hr-page__actions {
  display: flex;
  gap: 12px;
}

.hr-button {
  border-radius: 999px;
  padding: 10px 18px;
  font-size: 0.9rem;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.15s ease-out;
}

.hr-button--primary {
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(142 76% 36%));
  color: hsl(var(--primary-foreground));
  border-color: hsl(var(--border));
}

.hr-button--primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 30px hsl(var(--background) / 0.6);
}

.hr-button--secondary {
  background: hsl(var(--card));
  color: hsl(var(--foreground));
  border-color: hsl(var(--border));
}

.hr-button--secondary:hover {
  background: hsl(var(--accent));
}

.hr-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 20px;
}

.hr-card {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 18px 18px 16px;
  border-radius: 20px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
  text-decoration: none;
  color: inherit;
  transition: all 0.18s ease-out;
}

.hr-card:hover {
  transform: translateY(-2px) translateZ(0);
  border-color: hsl(var(--primary) / 0.6);
  box-shadow: 0 18px 40px hsl(var(--background) / 0.3);
}

.hr-card__badge {
  display: inline-flex;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: hsl(var(--muted));
  border: 1px solid hsl(var(--border));
  color: hsl(var(--muted-foreground));
}

.hr-card__title {
  font-size: 1.05rem;
  font-weight: 600;
  margin: 0;
}

.hr-card__body {
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
  margin: 0;
}

.hr-card__link {
  font-size: 0.8rem;
  color: hsl(var(--primary));
}

.hr-empty {
  padding: 24px 20px;
  border-radius: 16px;
  background: hsl(var(--muted));
  border: 1px dashed hsl(var(--border));
}

.hr-empty--light {
  background: hsl(var(--card));
}

.hr-section__title {
  font-size: 1rem;
  font-weight: 600;
  margin: 24px 0 12px;
}

.hr-steps {
  margin-top: 16px;
}

.hr-steps__list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  gap: 12px;
}

.hr-steps__item {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 12px;
  padding: 14px 16px;
  border-radius: 16px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
}

.hr-steps__index {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  background: hsl(var(--background));
  border: 1px solid hsl(var(--border));
  color: hsl(var(--foreground));
}

.hr-steps__content h3 {
  margin: 0 0 4px;
  font-size: 0.95rem;
}

.hr-steps__description {
  margin: 0 0 4px;
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
}

.hr-steps__meta {
  margin: 0;
  font-size: 0.75rem;
  color: hsl(var(--muted-foreground));
}

.hr-steps__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.hr-tag {
  font-size: 0.7rem;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid hsl(var(--border));
  color: hsl(var(--muted-foreground));
}

.hr-link {
  background: none;
  border: none;
  padding: 0;
  margin-bottom: 16px;
  color: hsl(var(--primary));
  font-size: 0.85rem;
  cursor: pointer;
}

.hr-error {
  color: hsl(var(--destructive));
  font-size: 0.9rem;
}

/* Form Styles */
.hr-form-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 12px;
}

.hr-form-label {
  font-size: 0.8rem;
  color: #9ca3af;
}

.hr-input {
  border-radius: 999px;
  border: 1px solid rgba(55, 65, 81, 0.9);
  background: rgba(15, 23, 42, 0.95);
  color: #e5e7eb;
  padding: 8px 12px;
  font-size: 0.85rem;
  outline: none;
}

.hr-input:focus {
  border-color: rgba(129, 140, 248, 0.95);
  box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
}

/* Top User Bar */
.hr-topuser {
  display: flex;
  align-items: center;
  gap: 12px;
}

.hr-topuser__email {
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
}

.hr-button--dense {
  padding: 4px 10px;
  font-size: 0.8rem;
}

/* Landing Page Styles */
.lp {
  min-height: 100vh;
  padding: 40px 16px 64px;
  max-width: 1120px;
  margin: 0 auto;
}

.lp-hero {
  display: grid;
  grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
  gap: 32px;
  align-items: center;
  margin-bottom: 56px;
}

@media (max-width: 900px) {
  .lp-hero {
    grid-template-columns: 1fr;
  }
}

.lp-hero__content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.lp-pill {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  border: 1px solid hsl(var(--border));
  color: hsl(var(--muted-foreground));
  width: fit-content;
}

.lp-title {
  margin: 0;
  font-size: clamp(2.2rem, 3vw, 2.8rem);
  letter-spacing: -0.04em;
  font-weight: 650;
}

.lp-title span {
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(142 76% 36%));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.lp-subtitle {
  margin: 0;
  color: hsl(var(--muted-foreground));
  max-width: 520px;
  font-size: 0.95rem;
}

.lp-hero__actions {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 8px;
}

.lp-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 18px;
  border-radius: 999px;
  text-decoration: none;
  font-size: 0.9rem;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.15s ease-out;
}

.lp-btn--primary {
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(142 76% 36%));
  color: hsl(var(--primary-foreground));
  border-color: hsl(var(--border));
}

.lp-btn--primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 32px hsl(var(--background) / 0.5);
}

.lp-btn--ghost {
  background: transparent;
  border-color: hsl(var(--border));
  color: hsl(var(--foreground));
}

.lp-btn--ghost:hover {
  background: hsl(var(--muted));
}

.lp-hero__meta {
  margin: 4px 0 0;
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}

.lp-hero__panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.lp-panel-card {
  padding: 18px 18px 16px;
  border-radius: 20px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
}

.lp-panel-card h2,
.lp-panel-card h3 {
  margin: 0 0 8px;
  font-size: 1rem;
}

.lp-panel-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
}

.lp-panel-card li {
  margin-bottom: 4px;
}

.lp-panel-card--secondary {
  opacity: 0.9;
}

.lp-section {
  border-top: 1px solid hsl(var(--border));
  padding-top: 32px;
}

.lp-section h2 {
  font-size: 1.3rem;
  margin: 0 0 20px;
}

.lp-columns {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
}

.lp-feature {
  padding: 16px 16px 14px;
  border-radius: 16px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
}

.lp-feature h3 {
  margin: 0 0 6px;
  font-size: 0.95rem;
}

.lp-feature p {
  margin: 0;
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
}

/* HR Tasks dashboard */
.hr-kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 14px;
  margin-bottom: 24px;
}

.hr-kpi {
  padding: 14px 16px;
  border-radius: 16px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
}

.hr-kpi__label {
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
  margin-bottom: 4px;
}

.hr-kpi__value {
  font-size: 1.4rem;
  font-weight: 600;
}

.hr-kpi__value--danger {
  color: hsl(0 84% 60%);
}

.hr-kpi__value--warn {
  color: hsl(45 93% 58%);
}

.hr-kpi__value--ok {
  color: hsl(142 76% 46%);
}

.hr-task-section {
  margin-top: 24px;
}

.hr-task-section__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.hr-task-section__description {
  margin: 0;
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}

.hr-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  border: 1px solid hsl(var(--border));
}

.hr-pill--danger {
  background: hsl(0 84% 60% / 0.15);
  border-color: hsl(0 84% 60% / 0.4);
  color: hsl(0 84% 60%);
}

.hr-pill--warn {
  background: hsl(45 93% 58% / 0.15);
  border-color: hsl(45 93% 58% / 0.4);
  color: hsl(45 93% 58%);
}

.hr-pill--ok {
  background: hsl(142 76% 46% / 0.15);
  border-color: hsl(142 76% 46% / 0.4);
  color: hsl(142 76% 46%);
}

.hr-task-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.hr-task-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 10px 14px;
  border-radius: 14px;
  background: hsl(var(--card));
  border: 1px solid hsl(var(--border));
  text-decoration: none;
  color: inherit;
  transition: all 0.12s ease-out;
}

.hr-task-row:hover {
  border-color: hsl(var(--primary) / 0.6);
  box-shadow: 0 12px 32px hsl(var(--background) / 0.3);
  transform: translateY(-1px);
}

.hr-task-row__main {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.hr-task-row__title {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 500;
}

.hr-task-row__subtitle {
  margin: 0;
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}

.hr-task-row__meta {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}

.hr-task-row__status {
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid hsl(var(--border));
}

.hr-task-row__date {
  font-size: 0.8rem;
}

.hr-task-empty {
  font-size: 0.85rem;
  color: hsl(var(--muted-foreground));
  padding: 8px 2px;
}

/* Employee competence 360 */

.hr-emp-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 20px;
}

.hr-emp-header__badge {
  display: flex;
  align-items: center;
}

.hr-risk-pill {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 500;
  border: 1px solid transparent;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.hr-risk-pill--low {
  background: hsl(var(--status-ok-bg));
  color: hsl(var(--status-ok-text));
  border-color: hsl(var(--status-ok-border));
}

.hr-risk-pill--medium {
  background: hsl(var(--status-gap-bg));
  color: hsl(var(--status-gap-text));
  border-color: hsl(var(--status-gap-border));
}

.hr-risk-pill--high {
  background: hsl(var(--status-risk-bg));
  color: hsl(var(--status-risk-text));
  border-color: hsl(var(--status-risk-border));
}

.hr-risk-pill--critical {
  background: hsl(var(--status-risk-bg));
  color: hsl(var(--status-risk-text));
  border-color: hsl(var(--status-risk-border));
  font-weight: 600;
}

.tg-date-pill {
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  font-size: 0.8rem;
  color: #9ca3af;
  background: rgba(15, 23, 42, 0.9);
}

.tg-kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.tg-kpi-card {
  padding: 12px 14px;
  border-radius: 16px;
  background: radial-gradient(circle at top left, #020617, #111827);
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.tg-kpi-label {
  font-size: 0.8rem;
  color: #9ca3af;
  margin-bottom: 4px;
}

.tg-kpi-value {
  font-size: 1.2rem;
  font-weight: 600;
}

.tg-kpi-value--danger {
  color: #f87171;
}

.tg-kpi-value--warn {
  color: #fbbf24;
}

.tg-kpi-value--ok {
  color: #4ade80;
}

.tg-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.tg-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  padding: 10px 14px;
  border-radius: 14px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.tg-row-main {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.tg-row-title {
  font-size: 0.9rem;
  font-weight: 500;
}

.tg-row-subtitle {
  font-size: 0.8rem;
  color: #9ca3af;
}

.tg-row-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  font-size: 0.8rem;
  color: #9ca3af;
}

.tg-meta-line {
  display: flex;
  gap: 8px;
}

.tg-meta-pill {
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(75, 85, 99, 0.9);
  font-size: 0.75rem;
}

.hr-emp-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.hr-emp-summary-card {
  padding: 14px 16px;
  border-radius: 16px;
  background: radial-gradient(circle at top left, #020617, #111827);
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.hr-emp-summary-label {
  font-size: 0.8rem;
  color: #9ca3af;
  margin-bottom: 4px;
}

.hr-emp-summary-value {
  font-size: 1.2rem;
  font-weight: 600;
}

.hr-competence-section {
  margin-top: 12px;
}

.hr-competence-table-wrapper {
  margin-top: 10px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid hsl(var(--border));
  background: hsl(var(--card));
}

.hr-competence-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.hr-competence-table th,
.hr-competence-table td {
  padding: 10px 12px;
  border-bottom: 1px solid hsl(var(--border));
  text-align: left;
}

.hr-competence-table th {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: hsl(var(--muted-foreground));
  background: hsl(var(--surface-2));
}

.hr-competence-table tr:last-child td {
  border-bottom: none;
}

.hr-competence-table tbody tr:nth-child(even) {
  background: hsl(var(--surface-2) / 0.5);
}

.hr-competence-table tbody tr:hover td {
  background: hsl(var(--accent));
}

.hr-competence-name {
  display: flex;
  align-items: center;
  gap: 6px;
}

.hr-competence-chip {
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(248, 250, 252, 0.3);
  color: #fecaca;
  background: rgba(127, 29, 29, 0.7);
}

.hr-level-chip {
  display: inline-flex;
  min-width: 28px;
  justify-content: center;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid rgba(75, 85, 99, 0.9);
  font-size: 0.75rem;
}

.hr-level-chip--owned {
  border-color: rgba(129, 140, 248, 0.9);
}

.hr-status-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 500;
  border: 1px solid transparent;
}

.hr-status-badge--ok {
  background: hsl(var(--status-ok-bg));
  border-color: hsl(var(--status-ok-border));
  color: hsl(var(--status-ok-text));
}

.hr-status-badge--gap {
  background: hsl(var(--status-gap-bg));
  border-color: hsl(var(--status-gap-border));
  color: hsl(var(--status-gap-text));
}

.hr-status-badge--risk {
  background: hsl(var(--status-risk-bg));
  border-color: hsl(var(--status-risk-border));
  color: hsl(var(--status-risk-text));
}

.hr-status-badge--na,
.hr-status-badge--n\/a {
  background: hsl(var(--status-na-bg));
  border-color: hsl(var(--status-na-border));
  color: hsl(var(--status-na-text));
}

.hr-status-reason {
  font-size: 0.7rem;
  color: #9ca3af;
  margin-top: 2px;
}

.hr-button--dense {
  padding: 6px 10px;
  font-size: 0.75rem;
}

.hr-action-message {
  font-size: 0.8rem;
  color: #9ca3af;
  margin-bottom: 8px;
}

/* Competence Matrix */

.hr-matrix-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.hr-matrix-controls__select {
  min-width: 280px;
}

.hr-matrix-controls__count {
  font-size: 0.875rem;
  color: #9ca3af;
}

.hr-matrix-wrapper {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid hsl(var(--border));
  background: hsl(var(--card));
}

.hr-matrix-wrapper .hr-competence-table {
  min-width: 800px;
}

.hr-matrix-wrapper .hr-competence-table th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: hsl(var(--surface-2));
}

.hr-matrix-wrapper .hr-competence-table th:first-child {
  position: sticky;
  left: 0;
  z-index: 20;
  background: hsl(var(--surface-2));
}

.hr-matrix-wrapper .hr-competence-table td:first-child {
  position: sticky;
  left: 0;
  z-index: 5;
  background: hsl(var(--card));
}

.hr-matrix-wrapper .hr-competence-table tbody tr:nth-child(even) td:first-child {
  background: hsl(var(--surface-2));
}

.hr-matrix-wrapper .hr-competence-table tbody tr:hover td:first-child {
  background: hsl(var(--accent));
}

.hr-matrix-wrapper .hr-competence-table td {
  text-align: center;
  vertical-align: middle;
}

.hr-matrix-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.hr-matrix-cell__level {
  font-size: 0.85rem;
  font-weight: 600;
  color: hsl(var(--foreground));
}

.hr-matrix-cell__levels {
  display: flex;
  align-items: center;
  gap: 2px;
  font-size: 0.8rem;
  color: hsl(var(--muted-foreground));
}

.hr-matrix-cell__levels strong {
  font-weight: 600;
  color: hsl(var(--foreground));
}

.hr-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid var(--hr-border);
  background: var(--hr-bg-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.hr-toggle--on {
  background: rgba(34, 197, 94, 0.2);
  border-color: rgba(34, 197, 94, 0.5);
  color: rgb(34, 197, 94);
}

.hr-toggle--off {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
  color: rgba(239, 68, 68, 0.7);
}

.hr-toggle:hover {
  transform: scale(1.05);
}

/* Admin Console Styles */
.admin-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
  gap: 16px;
}

@media (max-width: 900px) {
  .admin-grid {
    grid-template-columns: 1fr;
  }
}

.admin-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.admin-table th,
.admin-table td {
  padding: 6px 8px;
  border-bottom: 1px solid rgba(31, 41, 55, 0.9);
  text-align: left;
}

.admin-table th {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: #9ca3af;
}
</file>

<file path="layout.tsx">
import type { Metadata } from "next";
import { Inter, IBM_Plex_Sans } from "next/font/google";
import "./globals.css";

const inter = Inter({
  subsets: ["latin"],
  variable: "--font-sans",
});

const ibmPlexSans = IBM_Plex_Sans({
  weight: ["400", "500", "600", "700"],
  subsets: ["latin"],
  variable: "--font-serif",
});

export const metadata: Metadata = {
  title: "Industrial Competence Platform",
  description: "Enterprise-grade competency management for industrial organizations",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${inter.variable} ${ibmPlexSans.variable}`}>
        {children}
      </body>
    </html>
  );
}
</file>

<file path="page.tsx">
import { Header } from "@/components/layout/Header";
import { Footer } from "@/components/layout/Footer";
import { HeroSection } from "@/components/landing/HeroSection";
import { TrustIndicators } from "@/components/landing/TrustIndicators";
import { ValueProposition } from "@/components/landing/ValueProposition";
import { FeatureShowcase } from "@/components/landing/FeatureShowcase";
import { Statistics } from "@/components/landing/Statistics";
import { CTASection } from "@/components/landing/CTASection";

export default function Home() {
  return (
    <main className="min-h-screen">
      <Header />
      <div className="pt-16">
        <HeroSection />
        <TrustIndicators />
        <ValueProposition />
        <FeatureShowcase />
        <Statistics />
        <CTASection />
      </div>
      <Footer />
    </main>
  );
}
</file>

<file path="app/pricing/page.tsx">
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export default function AppPricingRedirect() {
  const router = useRouter();

  useEffect(() => {
    router.replace("/pricing");
  }, [router]);

  return (
    <div className="flex items-center justify-center min-h-[50vh]">
      <p className="text-muted-foreground">Redirecting to pricing...</p>
    </div>
  );
}
</file>

</files>
