# P0.8 Action Gravity – Verification Notes

## Summary

- **DB:** `public.compliance_actions` table with RLS (org members read; admin/hr insert/update). Indexes on `(org_id, status)`, `(org_id, employee_id)`, `(org_id, compliance_id)`.
- **API:** `POST /api/compliance/actions/create`, `GET /api/compliance/actions?employeeId=...`, `POST /api/compliance/actions/[id]/done`.
- **UI:** ComplianceDrawer shows recommended action buttons per item (by status) and an Actions list with “Mark done”.

## Apply migration

```bash
# If using Supabase CLI
supabase db push

# Or run the migration file manually against your DB
psql $DATABASE_URL -f supabase/migrations/20260203150000_compliance_actions.sql
```

## cURL examples

Assume `BASE=http://localhost:5001` and you have a session cookie or dev bearer token.

### Create action (admin/HR)

```bash
curl -s -X POST "$BASE/api/compliance/actions/create" \
  -H "Content-Type: application/json" \
  -H "Cookie: <your-session-cookie>" \
  -d '{
    "employee_id": "<uuid>",
    "compliance_code": "FORKLIFT",
    "action_type": "request_renewal",
    "due_date": "2025-03-01",
    "notes": "Optional note"
  }'
# Expected: {"ok":true,"action_id":"<uuid>"}
```

### List actions for employee

```bash
curl -s "$BASE/api/compliance/actions?employeeId=<employee-uuid>" \
  -H "Cookie: <your-session-cookie>"
# Expected: {"ok":true,"actions":[{...}]}
```

### Mark action done

```bash
curl -s -X POST "$BASE/api/compliance/actions/<action-id>/done" \
  -H "Cookie: <your-session-cookie>"
# Expected: {"ok":true,"action_id":"<action-id>"}
```

## UI verification

1. Open Compliance Matrix, click a cell → ComplianceDrawer opens for that employee.
2. **Recommended actions:** For each compliance item, buttons depend on status:
   - Missing/expired/overdue → “Request renewal”, “Request evidence”
   - Expiring → “Request renewal”, “Notify employee”
   - Waived → “Waived review”
3. Click a recommended button → POST create → toast “X created” → Actions list refreshes.
4. **Actions list:** Section “Actions” shows open + done with status pill; for open items, “Mark done” calls POST `.../done` and refreshes.

## Build

```bash
rm -rf .next && npm run build
# Must complete successfully.
```
