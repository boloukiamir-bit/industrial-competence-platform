module.exports=[69400,e=>{"use strict";var t=e.i(47909),a=e.i(74017),i=e.i(96250),n=e.i(59756),r=e.i(61916),o=e.i(14444),s=e.i(10680),l=e.i(19163),d=e.i(16795),u=e.i(87718),m=e.i(95169),c=e.i(47587),p=e.i(66012),g=e.i(70101),y=e.i(26937),f=e.i(10372),_=e.i(93695);e.i(52474);var h=e.i(5232),v=e.i(89171),w=e.i(27269);async function E(e=7){let t=new Date,a=new Date(t.getTime()+24*e*36e5),{data:i,error:n}=await w.supabase.from("one_to_one_meetings").select("*, employee:employee_id(name, email), manager:manager_id(name, email)").eq("status","planned").gte("scheduled_at",t.toISOString()).lte("scheduled_at",a.toISOString()).order("scheduled_at",{ascending:!0});return n?(console.error("Error fetching upcoming meetings:",n),[]):(i||[]).map(e=>({id:e.id,employeeId:e.employee_id,employeeName:e.employee?.name||void 0,managerId:e.manager_id||void 0,managerName:e.manager?.name||void 0,scheduledAt:e.scheduled_at,durationMinutes:e.duration_minutes||void 0,location:e.location||void 0,status:e.status,templateName:e.template_name||void 0,sharedAgenda:e.shared_agenda||void 0,employeeNotesPrivate:e.employee_notes_private||void 0,managerNotesPrivate:e.manager_notes_private||void 0,createdAt:e.created_at,updatedAt:e.updated_at||void 0}))}async function R(){let e=new Date().toISOString().split("T")[0],{data:t,error:a}=await w.supabase.from("one_to_one_actions").select("*, meeting:meeting_id(employee:employee_id(email), manager:manager_id(email))").eq("is_completed",!1).lt("due_date",e);return a?(console.error("Error fetching overdue actions:",a),[]):(t||[]).map(e=>({id:e.id,meetingId:e.meeting_id,description:e.description,ownerType:e.owner_type,isCompleted:e.is_completed,dueDate:e.due_date||void 0,createdAt:e.created_at,completedAt:e.completed_at||void 0,employeeEmail:e.meeting?.employee?.email||void 0,managerEmail:e.meeting?.manager?.email||void 0}))}async function S(e){let{data:t,error:a}=await w.supabase.from("person_events").select("id, title, category, due_date, employee_id, employees:employee_id(name, email)").neq("status","completed");if(a||!t)return console.error("Error fetching due events:",a),0;let i=0,n=new Date(e.getTime()-864e5).toISOString();for(let e of t){let t=e.employees,a=Array.isArray(t)?t[0]:t,r=a?.email;if(!r)continue;let{data:o}=await w.supabase.from("email_outbox").select("id").eq("to_email",r).gte("created_at",n).filter("meta->>event_id","eq",String(e.id)).filter("meta->>type","eq","due_event").in("status",["pending","sent"]).limit(1);if(o&&o.length>0)continue;let s=`Action required: ${e.title}`,l=`Hello ${a?.name||""},

You have an upcoming HR task that requires attention:

Category: ${e.category}
Task: ${e.title}
Due date: ${e.due_date}

This is an automated reminder.

Best regards,
Industrial Competence Platform`,{error:d}=await w.supabase.from("email_outbox").insert({to_email:r,subject:s,body:l,status:"pending",meta:{event_id:String(e.id),type:"due_event"}});d?console.error("Error inserting notification:",d):i++}return i}async function A(e){let t=e.toISOString().split("T")[0],a=new Date(e.getTime()+6048e5).toISOString().split("T")[0],{data:i,error:n}=await w.supabase.from("person_events").select(`
      id, title, category, due_date, status,
      owner_manager_id,
      manager:owner_manager_id(id, name, email),
      employees:employee_id(name)
    `).neq("status","completed");if(n||!i)return console.error("Error fetching events for manager digest:",n),0;let r={};for(let e of i){let i=e.manager,n=Array.isArray(i)?i[0]:i;if(!n?.id||!n?.email)continue;let o=e.employees,s=Array.isArray(o)?o[0]:o;if(!e.due_date)continue;let l=e.due_date<t,d=e.due_date>=t&&e.due_date<=a;if(!l&&!d)continue;r[n.id]||(r[n.id]={managerId:n.id,managerName:n.name||"Manager",managerEmail:n.email,overdueByCategory:{},dueSoonByCategory:{},criticalItems:[]});let u=r[n.id],m=e.category||"other";l?u.overdueByCategory[m]=(u.overdueByCategory[m]||0)+1:d&&(u.dueSoonByCategory[m]=(u.dueSoonByCategory[m]||0)+1),u.criticalItems.push({title:e.title,employeeName:s?.name||"Unknown",dueDate:e.due_date,isOverdue:l})}let o=0;for(let e of Object.values(r)){let t=Object.values(e.overdueByCategory).reduce((e,t)=>e+t,0),a=Object.values(e.dueSoonByCategory).reduce((e,t)=>e+t,0);if(0===t&&0===a)continue;let i=Object.entries(e.overdueByCategory).map(([e,t])=>`  - ${e}: ${t}`).join("\n"),n=Object.entries(e.dueSoonByCategory).map(([e,t])=>`  - ${e}: ${t}`).join("\n"),r=e.criticalItems.sort((e,t)=>e.isOverdue===t.isOverdue?0:e.isOverdue?-1:1).slice(0,5).map(e=>`  - ${e.title} (${e.employeeName}) - Due: ${e.dueDate}${e.isOverdue?" [OVERDUE]":""}`).join("\n"),s=`Hello ${e.managerName},

Here is your weekly summary of people-related tasks requiring attention:

OVERDUE (${t} total):
${i||"  None"}

DUE SOON - Next 7 days (${a} total):
${n||"  None"}

TOP 5 CRITICAL ITEMS:
${r||"  None"}

Please log in to the platform to take action.

Best regards,
Industrial Competence Platform`,{error:l}=await w.supabase.from("email_outbox").insert({to_email:e.managerEmail,subject:"Weekly People Risk Digest",body:s,status:"pending",meta:{type:"manager_digest",manager_id:e.managerId}});l?console.error("Error inserting manager digest:",l):o++}return o}async function C(e){let t=await E(7),a=new Date(e.getTime()-864e5).toISOString(),i=0;for(let e of t){let{data:t}=await w.supabase.from("employees").select("email").eq("id",e.employeeId).single(),{data:n}=await w.supabase.from("employees").select("email").eq("id",e.managerId).single(),r=new Date(e.scheduledAt).toLocaleDateString("sv-SE"),o=new Date(e.scheduledAt).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});if(t?.email){let{data:n}=await w.supabase.from("email_outbox").select("id").eq("to_email",t.email).gte("created_at",a).filter("meta->>meeting_id","eq",String(e.id)).filter("meta->>type","eq","upcoming_1to1_employee").in("status",["pending","sent"]).limit(1);if(!n||0===n.length){let a=`Upcoming 1:1 Meeting on ${r}`,n=`
Hello ${e.employeeName||""},

You have an upcoming 1:1 meeting scheduled:

Date: ${r}
Time: ${o}
${e.location?`Location: ${e.location}`:""}
${e.templateName?`Type: ${e.templateName}`:""}

${e.sharedAgenda?`Agenda:
${e.sharedAgenda}`:"Please prepare any topics you would like to discuss."}

Best regards,
Industrial Competence Platform
        `.trim(),{error:s}=await w.supabase.from("email_outbox").insert({to_email:t.email,subject:a,body:n,status:"pending",meta:{meeting_id:String(e.id),type:"upcoming_1to1_employee"}});s?console.error("Error inserting employee meeting notification:",s):i++}}if(n?.email){let{data:t}=await w.supabase.from("email_outbox").select("id").eq("to_email",n.email).gte("created_at",a).filter("meta->>meeting_id","eq",String(e.id)).filter("meta->>type","eq","upcoming_1to1_manager").in("status",["pending","sent"]).limit(1);if(!t||0===t.length){let t=`Upcoming 1:1 with ${e.employeeName} on ${r}`,a=`
Hello ${e.managerName||""},

You have an upcoming 1:1 meeting with ${e.employeeName}:

Date: ${r}
Time: ${o}
${e.location?`Location: ${e.location}`:""}
${e.templateName?`Type: ${e.templateName}`:""}

${e.sharedAgenda?`Agenda:
${e.sharedAgenda}`:""}

Best regards,
Industrial Competence Platform
        `.trim(),{error:s}=await w.supabase.from("email_outbox").insert({to_email:n.email,subject:t,body:a,status:"pending",meta:{meeting_id:String(e.id),type:"upcoming_1to1_manager"}});s?console.error("Error inserting manager meeting notification:",s):i++}}}return i}async function b(e){let t=await R(),a=new Date(e.getTime()-864e5).toISOString(),i=0;for(let e of t){let t="employee"===e.ownerType?e.employeeEmail:e.managerEmail;if(t){let{data:n}=await w.supabase.from("email_outbox").select("id").eq("to_email",t).gte("created_at",a).filter("meta->>action_id","eq",String(e.id)).filter("meta->>type","eq","overdue_action").in("status",["pending","sent"]).limit(1);if(n&&n.length>0)continue;let r=`[Overdue Action] ${e.description.substring(0,50)}...`,o=`
Hello,

You have an overdue action item from a 1:1 meeting:

Action: ${e.description}
Due Date: ${e.dueDate}

Please complete this action as soon as possible.

Best regards,
Industrial Competence Platform
      `.trim(),{error:s}=await w.supabase.from("email_outbox").insert({to_email:t,subject:r,body:o,status:"pending",meta:{action_id:String(e.id),type:"overdue_action"}});s?console.error("Error inserting overdue action notification:",s):i++}}return i}async function $(){let e=new Date;try{let[t,a,i,n]=await Promise.all([S(e),C(e),b(e),A(e)]);return v.NextResponse.json({success:!0,referenceDate:e.toISOString(),notifications:{dueEvents:t,upcomingOneToOnes:a,overdueActions:i,managerDigests:n,total:t+a+i+n}})}catch(e){return console.error("Error running daily notifications:",e),v.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function O(){return $()}e.s(["GET",()=>$,"POST",()=>O],39952);var N=e.i(39952);let T=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/daily-notifications/route",pathname:"/api/cron/daily-notifications",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cron/daily-notifications/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:x,workUnitAsyncStorage:I,serverHooks:D}=T;function P(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:I})}async function q(e,t,i){T.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/cron/daily-notifications/route";v=v.replace(/\/index$/,"")||"/";let w=await T.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:E,params:R,nextConfig:S,parsedUrl:A,isDraftMode:C,prerenderManifest:b,routerServerContext:$,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,resolvedPathname:x,clientReferenceManifest:I,serverActionsManifest:D}=w,P=(0,l.normalizeAppPath)(v),q=!!(b.dynamicRoutes[P]||b.routes[x]),H=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,A,!1):t.end("This page could not be found"),null);if(q&&!C){let e=!!b.routes[x],t=b.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await H();throw new _.NoFallbackError}}let k=null;!q||T.isDev||C||(k="/index"===(k=x)?"/":k);let U=!0===T.isDev||!q,B=q&&!U;D&&I&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:I,serverActionsManifest:D,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:D})});let M=e.method||"GET",j=(0,r.getTracer)(),L=j.getActiveScopeSpan(),F={params:R,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>T.onRequestError(e,t,i,$)},sharedContext:{buildId:E}},K=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let o=async e=>T.handle(G,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${v}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var r,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&O&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(K,V,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,i=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:O})},$),t}},u=await T.handleResponse({req:e,nextConfig:S,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:s});if(!q)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",O?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&q||m.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,y.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,V,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};L?await l(L):await j.withPropagatedContext(e.headers,()=>j.trace(m.BaseServerSpan.handleRequest,{spanName:`${M} ${v}`,kind:r.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:O})}),q)throw t;return await (0,p.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>P,"routeModule",()=>T,"serverHooks",()=>D,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>I],69400)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_313f45e7.js.map