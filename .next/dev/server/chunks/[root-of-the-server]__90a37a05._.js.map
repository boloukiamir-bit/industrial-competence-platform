{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/templates/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { cookies } from \"next/headers\";\n\nasync function getOrgId(request: NextRequest): Promise<string | null> {\n  const orgId = request.headers.get(\"x-org-id\");\n  if (orgId) return orgId;\n  \n  const cookieStore = await cookies();\n  const orgCookie = cookieStore.get(\"current_org_id\");\n  return orgCookie?.value || null;\n}\n\nconst VALID_CATEGORIES = [\"Production\", \"Safety\", \"HR\", \"Quality\", \"Maintenance\", \"Competence\"];\nconst VALID_OWNER_ROLES = [\"HR\", \"Supervisor\", \"IT\", \"Quality\", \"Maintenance\", \"Employee\"];\n\nexport async function GET(request: NextRequest) {\n  try {\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const templatesResult = await pool.query(\n      `SELECT id, name, description, category, is_active, created_at \n       FROM wf_templates \n       WHERE org_id = $1 AND is_active = true \n       ORDER BY name`,\n      [orgId]\n    );\n\n    const templates = await Promise.all(\n      templatesResult.rows.map(async (template) => {\n        const stepsResult = await pool.query(\n          `SELECT id, step_no, title, owner_role, default_due_days, required \n           FROM wf_template_steps \n           WHERE template_id = $1 \n           ORDER BY step_no`,\n          [template.id]\n        );\n        return {\n          ...template,\n          stepCount: stepsResult.rows.length,\n          steps: stepsResult.rows,\n        };\n      })\n    );\n\n    return NextResponse.json({ templates });\n  } catch (err) {\n    console.error(\"Templates error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch templates\" },\n      { status: 500 }\n    );\n  }\n}\n\ntype StepInput = {\n  step_no: number;\n  title: string;\n  description?: string;\n  owner_role: string;\n  default_due_days: number;\n  required: boolean;\n};\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect();\n  \n  try {\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    // Check that org has at least one admin/hr member who could create templates\n    // NOTE: In production, this should verify the authenticated user's role via session.\n    // For demo, we check that the org exists and has admin/hr members.\n    const membershipResult = await client.query(\n      `SELECT role FROM memberships WHERE org_id = $1 AND is_active = true AND role IN ('admin', 'hr') LIMIT 1`,\n      [orgId]\n    );\n    \n    if (membershipResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Only admins and HR can create templates\" }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const { name, category, description, steps } = body as {\n      name: string;\n      category: string;\n      description?: string;\n      steps: StepInput[];\n    };\n\n    if (!name || !name.trim()) {\n      return NextResponse.json({ error: \"Template name is required\" }, { status: 400 });\n    }\n\n    if (!category || !VALID_CATEGORIES.includes(category)) {\n      return NextResponse.json({ error: `Category must be one of: ${VALID_CATEGORIES.join(\", \")}` }, { status: 400 });\n    }\n\n    if (!steps || !Array.isArray(steps) || steps.length === 0) {\n      return NextResponse.json({ error: \"At least one step is required\" }, { status: 400 });\n    }\n\n    for (let i = 0; i < steps.length; i++) {\n      const step = steps[i];\n      if (!step.title || !step.title.trim()) {\n        return NextResponse.json({ error: `Step ${i + 1} title is required` }, { status: 400 });\n      }\n      if (!step.owner_role || !VALID_OWNER_ROLES.includes(step.owner_role)) {\n        return NextResponse.json({ error: `Step ${i + 1} owner_role must be one of: ${VALID_OWNER_ROLES.join(\", \")}` }, { status: 400 });\n      }\n      if (step.step_no !== i + 1) {\n        return NextResponse.json({ error: \"Step numbers must be continuous starting from 1\" }, { status: 400 });\n      }\n      if (typeof step.default_due_days !== \"number\" || step.default_due_days < 0) {\n        return NextResponse.json({ error: `Step ${i + 1} due days must be a non-negative number` }, { status: 400 });\n      }\n    }\n\n    await client.query(\"BEGIN\");\n\n    const templateResult = await client.query(\n      `INSERT INTO wf_templates (org_id, name, description, category, is_active)\n       VALUES ($1, $2, $3, $4, true)\n       RETURNING id`,\n      [orgId, name.trim(), description?.trim() || null, category]\n    );\n\n    const templateId = templateResult.rows[0].id;\n\n    for (const step of steps) {\n      await client.query(\n        `INSERT INTO wf_template_steps (template_id, step_no, title, description, owner_role, default_due_days, required)\n         VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n        [\n          templateId,\n          step.step_no,\n          step.title.trim(),\n          step.description?.trim() || null,\n          step.owner_role,\n          step.default_due_days || 0,\n          step.required ?? false,\n        ]\n      );\n    }\n\n    await client.query(\n      `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, metadata)\n       VALUES ($1, 'template', $2, 'created', $3)`,\n      [orgId, templateId, JSON.stringify({ name, category, stepCount: steps.length })]\n    );\n\n    await client.query(\"COMMIT\");\n\n    return NextResponse.json({ \n      success: true, \n      templateId,\n      message: \"Template created successfully\" \n    });\n  } catch (err) {\n    await client.query(\"ROLLBACK\");\n    console.error(\"Create template error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to create template\" },\n      { status: 500 }\n    );\n  } finally {\n    client.release();\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;AAEA,eAAe,SAAS,OAAoB;IAC1C,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC;IAClC,IAAI,OAAO,OAAO;IAElB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,YAAY,YAAY,GAAG,CAAC;IAClC,OAAO,WAAW,SAAS;AAC7B;AAEA,MAAM,mBAAmB;IAAC;IAAc;IAAU;IAAM;IAAW;IAAe;CAAa;AAC/F,MAAM,oBAAoB;IAAC;IAAM;IAAc;IAAM;IAAW;IAAe;CAAW;AAEnF,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,QAAQ,MAAM,SAAS;QAC7B,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,kBAAkB,MAAM,4HAAI,CAAC,KAAK,CACtC,CAAC;;;oBAGa,CAAC,EACf;YAAC;SAAM;QAGT,MAAM,YAAY,MAAM,QAAQ,GAAG,CACjC,gBAAgB,IAAI,CAAC,GAAG,CAAC,OAAO;YAC9B,MAAM,cAAc,MAAM,4HAAI,CAAC,KAAK,CAClC,CAAC;;;2BAGgB,CAAC,EAClB;gBAAC,SAAS,EAAE;aAAC;YAEf,OAAO;gBACL,GAAG,QAAQ;gBACX,WAAW,YAAY,IAAI,CAAC,MAAM;gBAClC,OAAO,YAAY,IAAI;YACzB;QACF;QAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAU;IACvC,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAA4B,GAC1E;YAAE,QAAQ;QAAI;IAElB;AACF;AAWO,eAAe,KAAK,OAAoB;IAC7C,MAAM,SAAS,MAAM,4HAAI,CAAC,OAAO;IAEjC,IAAI;QACF,MAAM,QAAQ,MAAM,SAAS;QAC7B,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,6EAA6E;QAC7E,qFAAqF;QACrF,mEAAmE;QACnE,MAAM,mBAAmB,MAAM,OAAO,KAAK,CACzC,CAAC,uGAAuG,CAAC,EACzG;YAAC;SAAM;QAGT,IAAI,iBAAiB,IAAI,CAAC,MAAM,KAAK,GAAG;YACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0C,GAAG;gBAAE,QAAQ;YAAI;QAC/F;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE,WAAW,EAAE,KAAK,EAAE,GAAG;QAO/C,IAAI,CAAC,QAAQ,CAAC,KAAK,IAAI,IAAI;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,IAAI,CAAC,YAAY,CAAC,iBAAiB,QAAQ,CAAC,WAAW;YACrD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,CAAC,yBAAyB,EAAE,iBAAiB,IAAI,CAAC,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC/G;QAEA,IAAI,CAAC,SAAS,CAAC,MAAM,OAAO,CAAC,UAAU,MAAM,MAAM,KAAK,GAAG;YACzD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC,GAAG;gBAAE,QAAQ;YAAI;QACrF;QAEA,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK;YACrC,MAAM,OAAO,KAAK,CAAC,EAAE;YACrB,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,KAAK,CAAC,IAAI,IAAI;gBACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO,CAAC,KAAK,EAAE,IAAI,EAAE,kBAAkB,CAAC;gBAAC,GAAG;oBAAE,QAAQ;gBAAI;YACvF;YACA,IAAI,CAAC,KAAK,UAAU,IAAI,CAAC,kBAAkB,QAAQ,CAAC,KAAK,UAAU,GAAG;gBACpE,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO,CAAC,KAAK,EAAE,IAAI,EAAE,4BAA4B,EAAE,kBAAkB,IAAI,CAAC,OAAO;gBAAC,GAAG;oBAAE,QAAQ;gBAAI;YAChI;YACA,IAAI,KAAK,OAAO,KAAK,IAAI,GAAG;gBAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAkD,GAAG;oBAAE,QAAQ;gBAAI;YACvG;YACA,IAAI,OAAO,KAAK,gBAAgB,KAAK,YAAY,KAAK,gBAAgB,GAAG,GAAG;gBAC1E,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO,CAAC,KAAK,EAAE,IAAI,EAAE,uCAAuC,CAAC;gBAAC,GAAG;oBAAE,QAAQ;gBAAI;YAC5G;QACF;QAEA,MAAM,OAAO,KAAK,CAAC;QAEnB,MAAM,iBAAiB,MAAM,OAAO,KAAK,CACvC,CAAC;;mBAEY,CAAC,EACd;YAAC;YAAO,KAAK,IAAI;YAAI,aAAa,UAAU;YAAM;SAAS;QAG7D,MAAM,aAAa,eAAe,IAAI,CAAC,EAAE,CAAC,EAAE;QAE5C,KAAK,MAAM,QAAQ,MAAO;YACxB,MAAM,OAAO,KAAK,CAChB,CAAC;4CACmC,CAAC,EACrC;gBACE;gBACA,KAAK,OAAO;gBACZ,KAAK,KAAK,CAAC,IAAI;gBACf,KAAK,WAAW,EAAE,UAAU;gBAC5B,KAAK,UAAU;gBACf,KAAK,gBAAgB,IAAI;gBACzB,KAAK,QAAQ,IAAI;aAClB;QAEL;QAEA,MAAM,OAAO,KAAK,CAChB,CAAC;iDAC0C,CAAC,EAC5C;YAAC;YAAO;YAAY,KAAK,SAAS,CAAC;gBAAE;gBAAM;gBAAU,WAAW,MAAM,MAAM;YAAC;SAAG;QAGlF,MAAM,OAAO,KAAK,CAAC;QAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA,SAAS;QACX;IACF,EAAE,OAAO,KAAK;QACZ,MAAM,OAAO,KAAK,CAAC;QACnB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAA4B,GAC1E;YAAE,QAAQ;QAAI;IAElB,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}}]
}