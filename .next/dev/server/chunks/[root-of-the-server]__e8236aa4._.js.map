{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/orgSession.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport pool from \"@/lib/pgClient\";\n\nexport type OrgSessionResult = {\n  success: true;\n  userId: string;\n  orgId: string;\n  role: string;\n} | {\n  success: false;\n  error: string;\n  status: 401 | 403;\n};\n\nexport async function getOrgIdFromSession(request: NextRequest): Promise<OrgSessionResult> {\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    return { success: false, error: \"Supabase not configured\", status: 401 };\n  }\n\n  const authHeader = request.headers.get(\"Authorization\");\n  let accessToken: string | undefined;\n\n  if (authHeader?.startsWith(\"Bearer \")) {\n    accessToken = authHeader.substring(7);\n  }\n\n  if (!accessToken) {\n    const cookieStore = await cookies();\n    const sbAccessToken = cookieStore.get(\"sb-access-token\")?.value;\n    \n    if (sbAccessToken) {\n      accessToken = sbAccessToken;\n    }\n  }\n\n  if (!accessToken) {\n    return { success: false, error: \"Not authenticated - access token required\", status: 401 };\n  }\n\n  const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n    global: {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    },\n  });\n\n  const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);\n\n  if (authError || !user) {\n    return { success: false, error: \"Invalid or expired session\", status: 401 };\n  }\n\n  const userId = user.id;\n\n  const cookieStore = await cookies();\n  const preferredOrgId = cookieStore.get(\"current_org_id\")?.value;\n\n  let membershipQuery: string;\n  let membershipParams: (string | undefined)[];\n\n  if (preferredOrgId) {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active' AND org_id = $2\n      LIMIT 1\n    `;\n    membershipParams = [userId, preferredOrgId];\n  } else {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active'\n      ORDER BY created_at ASC\n      LIMIT 1\n    `;\n    membershipParams = [userId];\n  }\n\n  const membershipResult = await pool.query(membershipQuery, membershipParams);\n\n  if (membershipResult.rows.length === 0) {\n    if (preferredOrgId) {\n      const fallbackResult = await pool.query(\n        `SELECT org_id, role FROM memberships WHERE user_id = $1 AND status = 'active' ORDER BY created_at ASC LIMIT 1`,\n        [userId]\n      );\n      \n      if (fallbackResult.rows.length === 0) {\n        return { success: false, error: \"No active organization membership\", status: 403 };\n      }\n      \n      return {\n        success: true,\n        userId,\n        orgId: fallbackResult.rows[0].org_id,\n        role: fallbackResult.rows[0].role,\n      };\n    }\n    \n    return { success: false, error: \"No active organization membership\", status: 403 };\n  }\n\n  return {\n    success: true,\n    userId,\n    orgId: membershipResult.rows[0].org_id,\n    role: membershipResult.rows[0].role,\n  };\n}\n\nexport function isAdminOrHr(role: string): boolean {\n  return role === \"admin\" || role === \"hr\";\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;;;;;;;;AAaO,eAAe,oBAAoB,OAAoB;IAC5D,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI;IAEJ,IAAI,YAAY,WAAW,YAAY;QACrC,cAAc,WAAW,SAAS,CAAC;IACrC;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC,oBAAoB;QAE1D,IAAI,eAAe;YACjB,cAAc;QAChB;IACF;IAEA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA6C,QAAQ;QAAI;IAC3F;IAEA,MAAM,WAAW,IAAA,yLAAY,EAAC,aAAa,iBAAiB;QAC1D,QAAQ;YACN,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,aAAa;YACxC;QACF;IACF;IAEA,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC;IAEzE,IAAI,aAAa,CAAC,MAAM;QACtB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA8B,QAAQ;QAAI;IAC5E;IAEA,MAAM,SAAS,KAAK,EAAE;IAEtB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,iBAAiB,YAAY,GAAG,CAAC,mBAAmB;IAE1D,IAAI;IACJ,IAAI;IAEJ,IAAI,gBAAgB;QAClB,kBAAkB,CAAC;;;;;IAKnB,CAAC;QACD,mBAAmB;YAAC;YAAQ;SAAe;IAC7C,OAAO;QACL,kBAAkB,CAAC;;;;;;IAMnB,CAAC;QACD,mBAAmB;YAAC;SAAO;IAC7B;IAEA,MAAM,mBAAmB,MAAM,4HAAI,CAAC,KAAK,CAAC,iBAAiB;IAE3D,IAAI,iBAAiB,IAAI,CAAC,MAAM,KAAK,GAAG;QACtC,IAAI,gBAAgB;YAClB,MAAM,iBAAiB,MAAM,4HAAI,CAAC,KAAK,CACrC,CAAC,6GAA6G,CAAC,EAC/G;gBAAC;aAAO;YAGV,IAAI,eAAe,IAAI,CAAC,MAAM,KAAK,GAAG;gBACpC,OAAO;oBAAE,SAAS;oBAAO,OAAO;oBAAqC,QAAQ;gBAAI;YACnF;YAEA,OAAO;gBACL,SAAS;gBACT;gBACA,OAAO,eAAe,IAAI,CAAC,EAAE,CAAC,MAAM;gBACpC,MAAM,eAAe,IAAI,CAAC,EAAE,CAAC,IAAI;YACnC;QACF;QAEA,OAAO;YAAE,SAAS;YAAO,OAAO;YAAqC,QAAQ;QAAI;IACnF;IAEA,OAAO;QACL,SAAS;QACT;QACA,OAAO,iBAAiB,IAAI,CAAC,EAAE,CAAC,MAAM;QACtC,MAAM,iBAAiB,IAAI,CAAC,EAAE,CAAC,IAAI;IACrC;AACF;AAEO,SAAS,YAAY,IAAY;IACtC,OAAO,SAAS,WAAW,SAAS;AACtC"}},
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/setup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { PoolClient } from \"pg\";\nimport { getOrgIdFromSession, isAdminOrHr } from \"@/lib/orgSession\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getOrgIdFromSession(request);\n    if (!session.success) {\n      return NextResponse.json({ error: session.error }, { status: session.status });\n    }\n\n    const { orgId, role, userId } = session;\n\n    if (!isAdminOrHr(role)) {\n      return NextResponse.json({ error: \"Only admins and HR can seed templates\" }, { status: 403 });\n    }\n\n    const existingResult = await pool.query(\n      `SELECT COUNT(*) as count FROM wf_templates WHERE org_id = $1`,\n      [orgId]\n    );\n\n    if (parseInt(existingResult.rows[0].count) > 0) {\n      return NextResponse.json({ \n        error: \"Templates already exist for this organization. Use force=true to replace them.\",\n        existingCount: parseInt(existingResult.rows[0].count)\n      }, { status: 409 });\n    }\n\n    const client = await pool.connect();\n    \n    try {\n      await client.query(\"BEGIN\");\n\n      const templateId1 = await seedTemplate(client, orgId, {\n        name: \"Cross-training Workflow\",\n        description: \"Start cross-training for an employee to address skill gaps at a critical station\",\n        category: \"Competence\",\n        steps: [\n          { step_no: 1, title: \"Identify training needs\", description: \"Assess current skill level and define target competence\", owner_role: \"Supervisor\", default_due_days: 2, required: true },\n          { step_no: 2, title: \"Assign trainer/mentor\", description: \"Select experienced employee to provide training\", owner_role: \"Supervisor\", default_due_days: 3, required: true },\n          { step_no: 3, title: \"Create training schedule\", description: \"Plan training sessions and timeline\", owner_role: \"HR\", default_due_days: 5, required: true },\n          { step_no: 4, title: \"Conduct training\", description: \"Employee completes hands-on training at station\", owner_role: \"Supervisor\", default_due_days: 14, required: true },\n          { step_no: 5, title: \"Assess competence\", description: \"Evaluate employee skill level after training\", owner_role: \"Supervisor\", default_due_days: 2, required: true },\n          { step_no: 6, title: \"Update skill matrix\", description: \"Record new competence level in system\", owner_role: \"HR\", default_due_days: 1, required: true },\n        ],\n      });\n\n      const templateId2 = await seedTemplate(client, orgId, {\n        name: \"Onboarding - New Employee\",\n        description: \"Standard onboarding process for new employees\",\n        category: \"HR\",\n        steps: [\n          { step_no: 1, title: \"Prepare workstation\", description: \"Set up computer, desk, and access cards\", owner_role: \"HR\", default_due_days: 1, required: true },\n          { step_no: 2, title: \"IT account setup\", description: \"Create email, system accounts, and permissions\", owner_role: \"IT\", default_due_days: 2, required: true },\n          { step_no: 3, title: \"Safety training\", description: \"Complete mandatory safety orientation\", owner_role: \"Supervisor\", default_due_days: 3, required: true },\n          { step_no: 4, title: \"Equipment training\", description: \"Train on primary equipment and tools\", owner_role: \"Supervisor\", default_due_days: 7, required: true },\n          { step_no: 5, title: \"Meet the team\", description: \"Introduction to team members and key contacts\", owner_role: \"Supervisor\", default_due_days: 3, required: true },\n          { step_no: 6, title: \"HR documentation\", description: \"Complete all employment paperwork\", owner_role: \"HR\", default_due_days: 5, required: true },\n          { step_no: 7, title: \"First week check-in\", description: \"Manager check-in after first week\", owner_role: \"Supervisor\", default_due_days: 7, required: true },\n          { step_no: 8, title: \"30-day review\", description: \"Performance review at 30 days\", owner_role: \"Supervisor\", default_due_days: 30, required: true },\n        ],\n      });\n\n      const templateId3 = await seedTemplate(client, orgId, {\n        name: \"Incident Response\",\n        description: \"Handle and follow up on safety incidents and near-misses\",\n        category: \"Safety\",\n        steps: [\n          { step_no: 1, title: \"Incident report\", description: \"Document incident details and immediate response\", owner_role: \"Supervisor\", default_due_days: 0, required: true },\n          { step_no: 2, title: \"Root cause analysis\", description: \"Investigate and identify root causes\", owner_role: \"Supervisor\", default_due_days: 3, required: true },\n          { step_no: 3, title: \"Corrective actions\", description: \"Define and implement corrective measures\", owner_role: \"Supervisor\", default_due_days: 7, required: true },\n          { step_no: 4, title: \"Follow-up verification\", description: \"Verify corrective actions are effective\", owner_role: \"Supervisor\", default_due_days: 14, required: true },\n          { step_no: 5, title: \"Close case\", description: \"Document outcomes and close case\", owner_role: \"HR\", default_due_days: 1, required: true },\n        ],\n      });\n\n      await client.query(\n        `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, actor_user_id, metadata)\n         VALUES ($1, 'setup', $2, 'templates_seeded', $3, $4)`,\n        [orgId, orgId, userId, JSON.stringify({ templateCount: 3, templateIds: [templateId1, templateId2, templateId3] })]\n      );\n\n      await client.query(\"COMMIT\");\n\n      return NextResponse.json({\n        success: true,\n        message: \"Templates seeded successfully\",\n        templates: [\n          { id: templateId1, name: \"Cross-training Workflow\" },\n          { id: templateId2, name: \"Onboarding - New Employee\" },\n          { id: templateId3, name: \"Incident Response\" },\n        ],\n      });\n    } catch (err) {\n      await client.query(\"ROLLBACK\");\n      throw err;\n    } finally {\n      client.release();\n    }\n  } catch (err) {\n    console.error(\"Setup error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to seed templates\" },\n      { status: 500 }\n    );\n  }\n}\n\ntype TemplateInput = {\n  name: string;\n  description: string;\n  category: string;\n  steps: {\n    step_no: number;\n    title: string;\n    description: string;\n    owner_role: string;\n    default_due_days: number;\n    required: boolean;\n  }[];\n};\n\nasync function seedTemplate(client: PoolClient, orgId: string, template: TemplateInput): Promise<string> {\n  const result = await client.query(\n    `INSERT INTO wf_templates (org_id, name, description, category, is_active)\n     VALUES ($1, $2, $3, $4, true)\n     RETURNING id`,\n    [orgId, template.name, template.description, template.category]\n  );\n\n  const templateId = result.rows[0].id;\n\n  for (const step of template.steps) {\n    await client.query(\n      `INSERT INTO wf_template_steps (template_id, step_no, title, description, owner_role, default_due_days, required)\n       VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n      [templateId, step.step_no, step.title, step.description, step.owner_role, step.default_due_days, step.required]\n    );\n  }\n\n  return templateId;\n}\n"],"names":[],"mappings":"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"}}]
}