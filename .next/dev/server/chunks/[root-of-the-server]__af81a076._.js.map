{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/instances/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { cookies } from \"next/headers\";\n\nasync function getOrgId(request: NextRequest): Promise<string | null> {\n  const orgId = request.headers.get(\"x-org-id\");\n  if (orgId) return orgId;\n  \n  const cookieStore = await cookies();\n  const orgCookie = cookieStore.get(\"current_org_id\");\n  return orgCookie?.value || null;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const searchParams = request.nextUrl.searchParams;\n    const status = searchParams.get(\"status\");\n    \n    let query = `\n      SELECT i.id, i.template_id, i.employee_id, i.employee_name, \n             i.status, i.start_date, i.due_date, i.completed_at, i.created_at,\n             i.shift_date, i.shift_type, i.area_code,\n             t.name as template_name, t.category as template_category\n      FROM wf_instances i\n      LEFT JOIN wf_templates t ON t.id = i.template_id\n      WHERE i.org_id = $1\n    `;\n    const params: any[] = [orgId];\n\n    if (status && status !== \"all\") {\n      query += ` AND i.status = $2`;\n      params.push(status);\n    }\n    query += ` ORDER BY i.created_at DESC`;\n\n    const instancesResult = await pool.query(query, params);\n\n    const instances = await Promise.all(\n      instancesResult.rows.map(async (inst) => {\n        const tasksResult = await pool.query(\n          `SELECT status FROM wf_instance_tasks WHERE instance_id = $1`,\n          [inst.id]\n        );\n        const totalTasks = tasksResult.rows.length;\n        const doneTasks = tasksResult.rows.filter((t: any) => t.status === \"done\").length;\n\n        return {\n          id: inst.id,\n          templateId: inst.template_id,\n          templateName: inst.template_name || \"Unknown\",\n          templateCategory: inst.template_category || \"general\",\n          employeeId: inst.employee_id,\n          employeeName: inst.employee_name,\n          shiftDate: inst.shift_date,\n          shiftType: inst.shift_type,\n          areaCode: inst.area_code,\n          status: inst.status,\n          startDate: inst.start_date,\n          dueDate: inst.due_date,\n          completedAt: inst.completed_at,\n          createdAt: inst.created_at,\n          progress: {\n            total: totalTasks,\n            done: doneTasks,\n            percent: totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0,\n          },\n        };\n      })\n    );\n\n    const countResult = await pool.query(\n      `SELECT \n         COUNT(*) FILTER (WHERE status = 'active') as active,\n         COUNT(*) FILTER (WHERE status = 'completed') as completed,\n         COUNT(*) FILTER (WHERE status = 'cancelled') as cancelled\n       FROM wf_instances WHERE org_id = $1`,\n      [orgId]\n    );\n    \n    const statusCounts = {\n      active: parseInt(countResult.rows[0]?.active || 0),\n      completed: parseInt(countResult.rows[0]?.completed || 0),\n      cancelled: parseInt(countResult.rows[0]?.cancelled || 0),\n    };\n\n    return NextResponse.json({ instances, statusCounts });\n  } catch (err) {\n    console.error(\"Instances error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch instances\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const body = await request.json();\n    const { templateId, employeeId, employeeName, startDate, shiftDate, shiftType, areaCode } = body;\n\n    if (!templateId) {\n      return NextResponse.json(\n        { error: \"templateId is required\" },\n        { status: 400 }\n      );\n    }\n\n    const templateResult = await pool.query(\n      `SELECT id, name FROM wf_templates WHERE id = $1 AND org_id = $2`,\n      [templateId, orgId]\n    );\n\n    if (templateResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Template not found\" }, { status: 404 });\n    }\n\n    const template = templateResult.rows[0];\n\n    const stepsResult = await pool.query(\n      `SELECT step_no, title, description, owner_role, default_due_days, required \n       FROM wf_template_steps \n       WHERE template_id = $1 \n       ORDER BY step_no`,\n      [templateId]\n    );\n\n    const steps = stepsResult.rows;\n    const start = startDate ? new Date(startDate) : new Date();\n    const maxDueDays = steps.length > 0 ? Math.max(...steps.map((s: any) => s.default_due_days)) : 30;\n    const dueDate = new Date(start.getTime() + maxDueDays * 24 * 60 * 60 * 1000);\n\n    const instanceResult = await pool.query(\n      `INSERT INTO wf_instances (org_id, template_id, employee_id, employee_name, status, start_date, due_date, shift_date, shift_type, area_code)\n       VALUES ($1, $2, $3, $4, 'active', $5, $6, $7, $8, $9)\n       RETURNING id`,\n      [\n        orgId, \n        templateId, \n        employeeId || null, \n        employeeName || null, \n        start.toISOString().split(\"T\")[0], \n        dueDate.toISOString().split(\"T\")[0],\n        shiftDate || null,\n        shiftType || null,\n        areaCode || null\n      ]\n    );\n\n    const instanceId = instanceResult.rows[0].id;\n\n    for (const step of steps) {\n      const taskDueDate = new Date(start.getTime() + step.default_due_days * 24 * 60 * 60 * 1000);\n      await pool.query(\n        `INSERT INTO wf_instance_tasks (instance_id, step_no, title, description, owner_role, due_date, status)\n         VALUES ($1, $2, $3, $4, $5, $6, 'todo')`,\n        [instanceId, step.step_no, step.title, step.description, step.owner_role, taskDueDate.toISOString().split(\"T\")[0]]\n      );\n    }\n\n    await pool.query(\n      `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, metadata)\n       VALUES ($1, 'instance', $2, 'created', $3)`,\n      [orgId, instanceId, JSON.stringify({ templateId, templateName: template.name, employeeId, employeeName, taskCount: steps.length })]\n    );\n\n    return NextResponse.json({\n      success: true,\n      instance: {\n        id: instanceId,\n        templateName: template.name,\n        employeeName,\n        status: \"active\",\n        taskCount: steps.length,\n      },\n    });\n  } catch (err) {\n    console.error(\"Instance creation error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to create instance\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}