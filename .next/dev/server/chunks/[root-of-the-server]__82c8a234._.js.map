{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/spaljisten/dashboard/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const areaId = searchParams.get(\"areaId\") || undefined;\n    const stationId = searchParams.get(\"stationId\") || undefined;\n\n    const client = await pool.connect();\n    try {\n      const [areasRes, stationsRes, employeesRes, skillsRes, ratingsRes] = await Promise.all([\n        client.query(\"SELECT id, org_id, area_code, area_name FROM sp_areas WHERE org_id = $1 ORDER BY area_name\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, area_id, station_code, station_name FROM sp_stations WHERE org_id = $1 ORDER BY station_name\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, employee_id, employee_name, is_active FROM sp_employees WHERE org_id = $1 AND is_active = true\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, skill_id, skill_name, station_id FROM sp_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, employee_id, skill_id, rating FROM sp_employee_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n      ]);\n\n      const areas = areasRes.rows;\n      const stations = stationsRes.rows;\n      const employees = employeesRes.rows;\n      const skills = skillsRes.rows;\n      const ratings = ratingsRes.rows;\n\n      const totalEmployees = employees.length;\n      const totalStations = stations.length;\n      const totalSkills = skills.length;\n\n      const independentRatings = ratings.filter((r) => r.rating !== null && r.rating >= 3);\n      const totalRatings = ratings.filter((r) => r.rating !== null).length;\n      const averageIndependentRate = totalRatings > 0 ? Math.round((independentRatings.length / totalRatings) * 100) : 0;\n\n      const kpis = { totalEmployees, totalStations, totalSkills, totalRatings, averageIndependentRate };\n\n      const stationRisks: { stationCode: string; stationName: string; independentCount: number; totalSkills: number; riskScore: number }[] = [];\n      for (const station of stations) {\n        const stationSkills = skills.filter((s) => s.station_id === station.id);\n        if (stationSkills.length === 0) continue;\n        const skillIds = stationSkills.map((s) => s.skill_id);\n        const stationRatings = ratings.filter((r) => skillIds.includes(r.skill_id) && r.rating !== null && r.rating >= 3);\n        const independentCount = stationRatings.length;\n        const riskScore = stationSkills.length - independentCount;\n        stationRisks.push({\n          stationCode: station.station_code,\n          stationName: station.station_name,\n          independentCount,\n          totalSkills: stationSkills.length,\n          riskScore,\n        });\n      }\n      const topRiskStations = stationRisks.sort((a, b) => b.riskScore - a.riskScore).slice(0, 10);\n\n      let filteredStations = stations;\n      if (areaId) filteredStations = filteredStations.filter((s) => s.area_id === areaId);\n      if (stationId) filteredStations = filteredStations.filter((s) => s.id === stationId);\n\n      const filteredStationIds = new Set(filteredStations.map((s) => s.id));\n      const filteredSkills = skills.filter((s) => filteredStationIds.has(s.station_id));\n\n      const stationMap = new Map(stations.map((s) => [s.id, s]));\n      const employeeMap = new Map(employees.map((e) => [e.employee_id, e.employee_name]));\n\n      const skillGapData = filteredSkills.map((skill) => {\n        const station = stationMap.get(skill.station_id);\n        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);\n        const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;\n        const totalEmployeesForSkill = skillRatings.length;\n\n        const employeeDetails = skillRatings.map((r) => ({\n          employeeId: r.employee_id,\n          employeeName: employeeMap.get(r.employee_id) || r.employee_id,\n          rating: r.rating,\n        }));\n\n        let riskLevel: \"ok\" | \"warning\" | \"critical\" = \"ok\";\n        if (independentCount === 0) riskLevel = \"critical\";\n        else if (independentCount < 2) riskLevel = \"warning\";\n\n        return {\n          stationCode: station?.station_code || \"N/A\",\n          stationName: station?.station_name || \"Unknown\",\n          skillId: skill.skill_id,\n          skillName: skill.skill_name,\n          independentCount,\n          totalEmployees: totalEmployeesForSkill,\n          employees: employeeDetails,\n          riskLevel,\n        };\n      }).sort((a, b) => {\n        const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };\n        if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];\n        return a.independentCount - b.independentCount;\n      });\n\n      const filterOptions = {\n        areas: areas.map((a) => ({ id: a.id, areaCode: a.area_code, areaName: a.area_name })),\n        stations: stations.map((s) => ({ id: s.id, stationCode: s.station_code, stationName: s.station_name, areaId: s.area_id })),\n      };\n\n      return NextResponse.json({ kpis, topRiskStations, skillGapTable: skillGapData, filterOptions });\n    } finally {\n      client.release();\n    }\n  } catch (error) {\n    console.error(\"Dashboard error:\", error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Failed to load dashboard\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}