{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/spaljisten/dashboard/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\nconst ORG_NAME = \"Spaljisten\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const areaId = searchParams.get(\"areaId\") || undefined;\n\n    const client = await pool.connect();\n    try {\n      const [areasRes, employeesRes, skillsRes, ratingsRes] = await Promise.all([\n        client.query(\"SELECT id, org_id, area_code, area_name FROM sp_areas WHERE org_id = $1 ORDER BY area_name\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, employee_id, employee_name, area_id, is_active FROM sp_employees WHERE org_id = $1 AND is_active = true\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, skill_id, skill_name, category FROM sp_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, org_id, employee_id, skill_id, rating FROM sp_employee_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n      ]);\n\n      const areas = areasRes.rows;\n      const employees = employeesRes.rows;\n      const skills = skillsRes.rows;\n      const ratings = ratingsRes.rows;\n\n      const totalEmployees = employees.length;\n      const totalSkills = skills.length;\n      const totalAreas = areas.length;\n\n      const independentRatings = ratings.filter((r) => r.rating !== null && r.rating >= 3);\n      const totalRatings = ratings.filter((r) => r.rating !== null).length;\n      const averageIndependentRate = totalRatings > 0 ? Math.round((independentRatings.length / totalRatings) * 100) : 0;\n\n      const kpis = { \n        totalEmployees, \n        totalSkills, \n        totalAreas,\n        totalRatings, \n        averageIndependentRate,\n        orgName: ORG_NAME,\n        orgId: SPALJISTEN_ORG_ID\n      };\n\n      const employeeMap = new Map(employees.map((e) => [e.employee_id, { name: e.employee_name, areaId: e.area_id }]));\n      const areaMap = new Map(areas.map((a) => [a.id, a.area_name]));\n\n      const skillRisks: { skillId: string; skillName: string; category: string; independentCount: number; totalRated: number; riskLevel: string }[] = [];\n      \n      for (const skill of skills) {\n        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);\n        \n        let filteredSkillRatings = skillRatings;\n        if (areaId) {\n          filteredSkillRatings = skillRatings.filter((r) => {\n            const emp = employeeMap.get(r.employee_id);\n            return emp && emp.areaId === areaId;\n          });\n        }\n        \n        const independentCount = filteredSkillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;\n        const totalRated = filteredSkillRatings.filter((r) => r.rating !== null).length;\n        \n        let riskLevel: \"ok\" | \"warning\" | \"critical\" = \"ok\";\n        if (independentCount === 0) riskLevel = \"critical\";\n        else if (independentCount < 2) riskLevel = \"warning\";\n\n        skillRisks.push({\n          skillId: skill.skill_id,\n          skillName: skill.skill_name,\n          category: skill.category || \"general\",\n          independentCount,\n          totalRated,\n          riskLevel,\n        });\n      }\n\n      const topRiskSkills = skillRisks\n        .filter((s) => s.totalRated > 0)\n        .sort((a, b) => {\n          const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };\n          if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];\n          return a.independentCount - b.independentCount;\n        })\n        .slice(0, 10);\n\n      const skillGapData = skills.map((skill) => {\n        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);\n        \n        let filteredSkillRatings = skillRatings;\n        if (areaId) {\n          filteredSkillRatings = skillRatings.filter((r) => {\n            const emp = employeeMap.get(r.employee_id);\n            return emp && emp.areaId === areaId;\n          });\n        }\n        \n        const independentCount = filteredSkillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;\n        const totalEmployeesForSkill = filteredSkillRatings.length;\n\n        const employeeDetails = filteredSkillRatings.map((r) => {\n          const emp = employeeMap.get(r.employee_id);\n          return {\n            employeeId: r.employee_id,\n            employeeName: emp?.name || r.employee_id,\n            areaName: emp?.areaId ? areaMap.get(emp.areaId) || \"Unknown\" : \"Unknown\",\n            rating: r.rating,\n          };\n        });\n\n        let riskLevel: \"ok\" | \"warning\" | \"critical\" = \"ok\";\n        if (independentCount === 0) riskLevel = \"critical\";\n        else if (independentCount < 2) riskLevel = \"warning\";\n\n        return {\n          skillId: skill.skill_id,\n          skillName: skill.skill_name,\n          category: skill.category || \"general\",\n          independentCount,\n          totalEmployees: totalEmployeesForSkill,\n          employees: employeeDetails,\n          riskLevel,\n        };\n      })\n      .filter((s) => s.totalEmployees > 0)\n      .sort((a, b) => {\n        const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };\n        if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];\n        return a.independentCount - b.independentCount;\n      });\n\n      const filterOptions = {\n        areas: areas.map((a) => ({ id: a.id, areaCode: a.area_code, areaName: a.area_name })),\n      };\n\n      return NextResponse.json({ \n        kpis, \n        topRiskSkills, \n        skillGapTable: skillGapData, \n        filterOptions \n      });\n    } finally {\n      client.release();\n    }\n  } catch (error) {\n    console.error(\"Dashboard error:\", error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Failed to load dashboard\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}