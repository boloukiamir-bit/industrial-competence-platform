{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/orgSession.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport pool from \"@/lib/pgClient\";\n\nexport type OrgSessionResult = {\n  success: true;\n  userId: string;\n  orgId: string;\n  role: string;\n} | {\n  success: false;\n  error: string;\n  status: 401 | 403;\n};\n\nexport async function getOrgIdFromSession(request: NextRequest): Promise<OrgSessionResult> {\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    return { success: false, error: \"Supabase not configured\", status: 401 };\n  }\n\n  const authHeader = request.headers.get(\"Authorization\");\n  let accessToken: string | undefined;\n\n  if (authHeader?.startsWith(\"Bearer \")) {\n    accessToken = authHeader.substring(7);\n  }\n\n  if (!accessToken) {\n    const cookieStore = await cookies();\n    const sbAccessToken = cookieStore.get(\"sb-access-token\")?.value;\n    \n    if (sbAccessToken) {\n      accessToken = sbAccessToken;\n    }\n  }\n\n  if (!accessToken) {\n    return { success: false, error: \"Not authenticated - access token required\", status: 401 };\n  }\n\n  const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n    global: {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    },\n  });\n\n  const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);\n\n  if (authError || !user) {\n    return { success: false, error: \"Invalid or expired session\", status: 401 };\n  }\n\n  const userId = user.id;\n\n  const cookieStore = await cookies();\n  const preferredOrgId = cookieStore.get(\"current_org_id\")?.value;\n\n  let membershipQuery: string;\n  let membershipParams: (string | undefined)[];\n\n  if (preferredOrgId) {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active' AND org_id = $2\n      LIMIT 1\n    `;\n    membershipParams = [userId, preferredOrgId];\n  } else {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active'\n      ORDER BY created_at ASC\n      LIMIT 1\n    `;\n    membershipParams = [userId];\n  }\n\n  const membershipResult = await pool.query(membershipQuery, membershipParams);\n\n  if (membershipResult.rows.length === 0) {\n    if (preferredOrgId) {\n      const fallbackResult = await pool.query(\n        `SELECT org_id, role FROM memberships WHERE user_id = $1 AND status = 'active' ORDER BY created_at ASC LIMIT 1`,\n        [userId]\n      );\n      \n      if (fallbackResult.rows.length === 0) {\n        return { success: false, error: \"No active organization membership\", status: 403 };\n      }\n      \n      return {\n        success: true,\n        userId,\n        orgId: fallbackResult.rows[0].org_id,\n        role: fallbackResult.rows[0].role,\n      };\n    }\n    \n    return { success: false, error: \"No active organization membership\", status: 403 };\n  }\n\n  return {\n    success: true,\n    userId,\n    orgId: membershipResult.rows[0].org_id,\n    role: membershipResult.rows[0].role,\n  };\n}\n\nexport function isAdminOrHr(role: string): boolean {\n  return role === \"admin\" || role === \"hr\";\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;;;;;;;;AAaO,eAAe,oBAAoB,OAAoB;IAC5D,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI;IAEJ,IAAI,YAAY,WAAW,YAAY;QACrC,cAAc,WAAW,SAAS,CAAC;IACrC;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC,oBAAoB;QAE1D,IAAI,eAAe;YACjB,cAAc;QAChB;IACF;IAEA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA6C,QAAQ;QAAI;IAC3F;IAEA,MAAM,WAAW,IAAA,yLAAY,EAAC,aAAa,iBAAiB;QAC1D,QAAQ;YACN,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,aAAa;YACxC;QACF;IACF;IAEA,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC;IAEzE,IAAI,aAAa,CAAC,MAAM;QACtB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA8B,QAAQ;QAAI;IAC5E;IAEA,MAAM,SAAS,KAAK,EAAE;IAEtB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,iBAAiB,YAAY,GAAG,CAAC,mBAAmB;IAE1D,IAAI;IACJ,IAAI;IAEJ,IAAI,gBAAgB;QAClB,kBAAkB,CAAC;;;;;IAKnB,CAAC;QACD,mBAAmB;YAAC;YAAQ;SAAe;IAC7C,OAAO;QACL,kBAAkB,CAAC;;;;;;IAMnB,CAAC;QACD,mBAAmB;YAAC;SAAO;IAC7B;IAEA,MAAM,mBAAmB,MAAM,4HAAI,CAAC,KAAK,CAAC,iBAAiB;IAE3D,IAAI,iBAAiB,IAAI,CAAC,MAAM,KAAK,GAAG;QACtC,IAAI,gBAAgB;YAClB,MAAM,iBAAiB,MAAM,4HAAI,CAAC,KAAK,CACrC,CAAC,6GAA6G,CAAC,EAC/G;gBAAC;aAAO;YAGV,IAAI,eAAe,IAAI,CAAC,MAAM,KAAK,GAAG;gBACpC,OAAO;oBAAE,SAAS;oBAAO,OAAO;oBAAqC,QAAQ;gBAAI;YACnF;YAEA,OAAO;gBACL,SAAS;gBACT;gBACA,OAAO,eAAe,IAAI,CAAC,EAAE,CAAC,MAAM;gBACpC,MAAM,eAAe,IAAI,CAAC,EAAE,CAAC,IAAI;YACnC;QACF;QAEA,OAAO;YAAE,SAAS;YAAO,OAAO;YAAqC,QAAQ;QAAI;IACnF;IAEA,OAAO;QACL,SAAS;QACT;QACA,OAAO,iBAAiB,IAAI,CAAC,EAAE,CAAC,MAAM;QACtC,MAAM,iBAAiB,IAAI,CAAC,EAAE,CAAC,IAAI;IACrC;AACF;AAEO,SAAS,YAAY,IAAY;IACtC,OAAO,SAAS,WAAW,SAAS;AACtC"}},
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/dashboard/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { getOrgIdFromSession } from \"@/lib/orgSession\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getOrgIdFromSession(request);\n    if (!session.success) {\n      return NextResponse.json({ error: session.error }, { status: session.status });\n    }\n\n    const { orgId } = session;\n\n    const activeResult = await pool.query(`\n      SELECT COUNT(*) as count \n      FROM wf_instances \n      WHERE org_id = $1 AND status = 'active'\n    `, [orgId]);\n\n    const overdueResult = await pool.query(`\n      SELECT COUNT(*) as count \n      FROM wf_instance_tasks t\n      JOIN wf_instances i ON i.id = t.instance_id\n      WHERE i.org_id = $1 \n        AND i.status = 'active'\n        AND t.status != 'done'\n        AND t.due_date < CURRENT_DATE\n    `, [orgId]);\n\n    const byTemplateResult = await pool.query(`\n      SELECT \n        wt.name as template_name,\n        wt.category,\n        COUNT(i.id) as count\n      FROM wf_instances i\n      LEFT JOIN wf_templates wt ON wt.id = i.template_id\n      WHERE i.org_id = $1 AND i.status = 'active'\n      GROUP BY wt.name, wt.category\n      ORDER BY count DESC\n    `, [orgId]);\n\n    type InstanceRow = {\n      id: string;\n      employee_name: string | null;\n      status: string;\n      start_date: string;\n      due_date: string;\n      updated_at: string;\n      area_code: string | null;\n      template_name: string | null;\n      template_category: string | null;\n      total_tasks: string;\n      done_tasks: string;\n    };\n\n    const recentResult = await pool.query(`\n      SELECT \n        i.id,\n        i.employee_name,\n        i.status,\n        i.start_date,\n        i.due_date,\n        i.updated_at,\n        i.area_code,\n        wt.name as template_name,\n        wt.category as template_category,\n        (SELECT COUNT(*) FROM wf_instance_tasks WHERE instance_id = i.id) as total_tasks,\n        (SELECT COUNT(*) FROM wf_instance_tasks WHERE instance_id = i.id AND status = 'done') as done_tasks\n      FROM wf_instances i\n      LEFT JOIN wf_templates wt ON wt.id = i.template_id\n      WHERE i.org_id = $1\n      ORDER BY i.updated_at DESC\n      LIMIT 10\n    `, [orgId]);\n\n    const completedTodayResult = await pool.query(`\n      SELECT COUNT(*) as count \n      FROM wf_instances \n      WHERE org_id = $1 \n        AND status = 'completed'\n        AND completed_at::date = CURRENT_DATE\n    `, [orgId]);\n\n    return NextResponse.json({\n      activeWorkflows: parseInt(activeResult.rows[0].count),\n      overdueTasks: parseInt(overdueResult.rows[0].count),\n      completedToday: parseInt(completedTodayResult.rows[0].count),\n      byTemplate: byTemplateResult.rows.map((row: { template_name: string | null; category: string | null; count: string }) => ({\n        templateName: row.template_name || \"Unknown\",\n        category: row.category,\n        count: parseInt(row.count),\n      })),\n      recentInstances: recentResult.rows.map((row: InstanceRow) => ({\n        id: row.id,\n        employeeName: row.employee_name,\n        status: row.status,\n        startDate: row.start_date,\n        dueDate: row.due_date,\n        updatedAt: row.updated_at,\n        areaCode: row.area_code,\n        templateName: row.template_name,\n        templateCategory: row.template_category,\n        progress: {\n          total: parseInt(row.total_tasks),\n          done: parseInt(row.done_tasks),\n          percent: parseInt(row.total_tasks) > 0 ? Math.round((parseInt(row.done_tasks) / parseInt(row.total_tasks)) * 100) : 0,\n        },\n      })),\n    });\n  } catch (err) {\n    console.error(\"Dashboard error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch dashboard\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,0IAAmB,EAAC;QAC1C,IAAI,CAAC,QAAQ,OAAO,EAAE;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,QAAQ,KAAK;YAAC,GAAG;gBAAE,QAAQ,QAAQ,MAAM;YAAC;QAC9E;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG;QAElB,MAAM,eAAe,MAAM,4HAAI,CAAC,KAAK,CAAC,CAAC;;;;IAIvC,CAAC,EAAE;YAAC;SAAM;QAEV,MAAM,gBAAgB,MAAM,4HAAI,CAAC,KAAK,CAAC,CAAC;;;;;;;;IAQxC,CAAC,EAAE;YAAC;SAAM;QAEV,MAAM,mBAAmB,MAAM,4HAAI,CAAC,KAAK,CAAC,CAAC;;;;;;;;;;IAU3C,CAAC,EAAE;YAAC;SAAM;QAgBV,MAAM,eAAe,MAAM,4HAAI,CAAC,KAAK,CAAC,CAAC;;;;;;;;;;;;;;;;;;IAkBvC,CAAC,EAAE;YAAC;SAAM;QAEV,MAAM,uBAAuB,MAAM,4HAAI,CAAC,KAAK,CAAC,CAAC;;;;;;IAM/C,CAAC,EAAE;YAAC;SAAM;QAEV,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,iBAAiB,SAAS,aAAa,IAAI,CAAC,EAAE,CAAC,KAAK;YACpD,cAAc,SAAS,cAAc,IAAI,CAAC,EAAE,CAAC,KAAK;YAClD,gBAAgB,SAAS,qBAAqB,IAAI,CAAC,EAAE,CAAC,KAAK;YAC3D,YAAY,iBAAiB,IAAI,CAAC,GAAG,CAAC,CAAC,MAAkF,CAAC;oBACxH,cAAc,IAAI,aAAa,IAAI;oBACnC,UAAU,IAAI,QAAQ;oBACtB,OAAO,SAAS,IAAI,KAAK;gBAC3B,CAAC;YACD,iBAAiB,aAAa,IAAI,CAAC,GAAG,CAAC,CAAC,MAAqB,CAAC;oBAC5D,IAAI,IAAI,EAAE;oBACV,cAAc,IAAI,aAAa;oBAC/B,QAAQ,IAAI,MAAM;oBAClB,WAAW,IAAI,UAAU;oBACzB,SAAS,IAAI,QAAQ;oBACrB,WAAW,IAAI,UAAU;oBACzB,UAAU,IAAI,SAAS;oBACvB,cAAc,IAAI,aAAa;oBAC/B,kBAAkB,IAAI,iBAAiB;oBACvC,UAAU;wBACR,OAAO,SAAS,IAAI,WAAW;wBAC/B,MAAM,SAAS,IAAI,UAAU;wBAC7B,SAAS,SAAS,IAAI,WAAW,IAAI,IAAI,KAAK,KAAK,CAAC,AAAC,SAAS,IAAI,UAAU,IAAI,SAAS,IAAI,WAAW,IAAK,OAAO;oBACtH;gBACF,CAAC;QACH;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAA4B,GAC1E;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}