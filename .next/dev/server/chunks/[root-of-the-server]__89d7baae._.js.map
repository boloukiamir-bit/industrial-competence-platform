{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/line-overview/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst DEMO_ORG_ID = \"f607f244-da91-41d9-a648-d02a1591105c\";\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nfunction shiftParamToDbValue(shift: string): string {\n  const map: Record<string, string> = {\n    day: \"Day\",\n    evening: \"Evening\",\n    night: \"Night\",\n  };\n  return map[shift.toLowerCase()] || \"Day\";\n}\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  const date = searchParams.get(\"date\") || new Date().toISOString().split(\"T\")[0];\n  const shift = shiftParamToDbValue(searchParams.get(\"shift\") || \"day\");\n\n  try {\n    const [linesRes, machinesRes, demandRes, assignmentsRes, attendanceRes, employeesRes] = await Promise.all([\n      supabaseAdmin.from(\"pl_lines\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).order(\"line_code\"),\n      supabaseAdmin.from(\"pl_machines\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).order(\"machine_code\"),\n      supabaseAdmin.from(\"pl_machine_demand\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).eq(\"plan_date\", date).eq(\"shift_type\", shift),\n      supabaseAdmin.from(\"pl_assignment_segments\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).eq(\"plan_date\", date).eq(\"shift_type\", shift),\n      supabaseAdmin.from(\"pl_attendance\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).eq(\"plan_date\", date).eq(\"shift_type\", shift),\n      supabaseAdmin.from(\"pl_employees\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID),\n    ]);\n\n    if (linesRes.error) throw linesRes.error;\n    if (machinesRes.error) throw machinesRes.error;\n    if (demandRes.error) throw demandRes.error;\n    if (assignmentsRes.error) throw assignmentsRes.error;\n    if (attendanceRes.error) throw attendanceRes.error;\n    if (employeesRes.error) throw employeesRes.error;\n\n    const lines = linesRes.data || [];\n    const machines = machinesRes.data || [];\n    const demands = demandRes.data || [];\n    const assignments = assignmentsRes.data || [];\n    const attendance = attendanceRes.data || [];\n    const employees = employeesRes.data || [];\n\n    const demandMap = new Map(demands.map((d) => [d.machine_code, d]));\n    const employeeMap = new Map(employees.map((e) => [e.employee_code, e]));\n    \n    const assignmentsByMachine = new Map<string, typeof assignments>();\n    assignments.forEach((a) => {\n      const list = assignmentsByMachine.get(a.machine_code) || [];\n      list.push(a);\n      assignmentsByMachine.set(a.machine_code, list);\n    });\n\n    const presentCount = attendance.filter((a) => a.status === \"present\").length;\n    const absentCount = attendance.filter((a) => a.status === \"absent\").length;\n\n    let totalRequired = 0;\n    let totalAssigned = 0;\n    let totalGap = 0;\n\n    const lineData = lines.map((line) => {\n      const lineMachines = machines.filter((m) => m.line_code === line.line_code);\n\n      const machineData = lineMachines.map((machine) => {\n        const demand = demandMap.get(machine.machine_code);\n        const machineAssignments = assignmentsByMachine.get(machine.machine_code) || [];\n\n        const requiredHours = demand?.required_hours || 0;\n        let assignedHours = 0;\n        const assignedPeople: Array<{\n          assignmentId: string;\n          employeeId: string;\n          employeeCode: string;\n          employeeName: string;\n          startTime: string;\n          endTime: string;\n          hours: number;\n        }> = [];\n\n        machineAssignments.forEach((a) => {\n          const start = new Date(`2000-01-01T${a.start_time}`);\n          const end = new Date(`2000-01-01T${a.end_time}`);\n          const hours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);\n          assignedHours += hours;\n\n          const emp = employeeMap.get(a.employee_code);\n          if (emp) {\n            assignedPeople.push({\n              assignmentId: a.id,\n              employeeId: emp.id,\n              employeeCode: emp.employee_code,\n              employeeName: emp.full_name,\n              startTime: a.start_time,\n              endTime: a.end_time,\n              hours,\n            });\n          }\n        });\n\n        const gap = requiredHours - assignedHours;\n        totalRequired += requiredHours;\n        totalAssigned += assignedHours;\n        if (gap > 0) totalGap += gap;\n\n        let status: \"ok\" | \"partial\" | \"gap\" = \"ok\";\n        if (requiredHours > 0) {\n          if (assignedHours === 0) status = \"gap\";\n          else if (assignedHours < requiredHours) status = \"partial\";\n        }\n\n        return {\n          machine: {\n            id: machine.id,\n            machineCode: machine.machine_code,\n            machineName: machine.machine_name,\n            lineCode: machine.line_code,\n          },\n          requiredHours,\n          assignedHours,\n          gap,\n          status,\n          assignedPeople,\n        };\n      });\n\n      const lineRequired = machineData.reduce((sum, m) => sum + m.requiredHours, 0);\n      const lineAssigned = machineData.reduce((sum, m) => sum + m.assignedHours, 0);\n      const lineGap = machineData.reduce((sum, m) => sum + Math.max(0, m.gap), 0);\n\n      return {\n        line: {\n          id: line.id,\n          lineCode: line.line_code,\n          lineName: line.line_name,\n        },\n        machines: machineData,\n        totalRequired: lineRequired,\n        totalAssigned: lineAssigned,\n        totalGap: lineGap,\n      };\n    });\n\n    const coveragePercent = totalRequired > 0 ? Math.round((totalAssigned / totalRequired) * 100) : 100;\n\n    return NextResponse.json({\n      lines: lineData,\n      kpis: {\n        coveragePercent,\n        gapHours: totalGap,\n        overtimeHours: 0,\n        presentCount,\n        absentCount,\n      },\n      employees: employees.map((e) => ({\n        id: e.id,\n        employeeCode: e.employee_code,\n        fullName: e.full_name,\n      })),\n    });\n  } catch (error) {\n    console.error(\"Line overview fetch error:\", error);\n    return NextResponse.json({ error: \"Failed to fetch data\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}