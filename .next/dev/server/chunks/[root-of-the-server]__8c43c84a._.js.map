{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/spaljisten/dashboard/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ntype Area = { id: string; org_id: string; area_code: string; area_name: string };\ntype Station = { id: string; org_id: string; area_id: string | null; station_code: string; station_name: string };\ntype Employee = { id: string; org_id: string; employee_id: string; employee_name: string; is_active: boolean };\ntype Skill = { id: string; org_id: string; skill_id: string; skill_name: string; station_id: string | null };\ntype Rating = { id: string; org_id: string; employee_id: string; skill_id: string; rating: number | null };\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const areaId = searchParams.get(\"areaId\") || undefined;\n    const stationId = searchParams.get(\"stationId\") || undefined;\n\n    const { data: rpcData, error: rpcError } = await supabaseAdmin.rpc(\"get_sp_dashboard_data\", {\n      p_org_id: SPALJISTEN_ORG_ID,\n    });\n\n    if (rpcError) throw rpcError;\n\n    const areas: Area[] = rpcData?.areas || [];\n    const stations: Station[] = rpcData?.stations || [];\n    const employees: Employee[] = rpcData?.employees || [];\n    const skills: Skill[] = rpcData?.skills || [];\n    const ratings: Rating[] = rpcData?.ratings || [];\n\n    const totalEmployees = employees.length;\n    const totalStations = stations.length;\n    const totalSkills = skills.length;\n\n    const independentRatings = ratings.filter((r) => r.rating !== null && r.rating >= 3);\n    const totalRatings = ratings.filter((r) => r.rating !== null).length;\n    const averageIndependentRate = totalRatings > 0 ? Math.round((independentRatings.length / totalRatings) * 100) : 0;\n\n    const kpis = { totalEmployees, totalStations, totalSkills, averageIndependentRate };\n\n    const stationRisks: { stationCode: string; stationName: string; independentCount: number; totalSkills: number; riskScore: number }[] = [];\n    for (const station of stations) {\n      const stationSkills = skills.filter((s) => s.station_id === station.id);\n      if (stationSkills.length === 0) continue;\n      const skillIds = stationSkills.map((s) => s.skill_id);\n      const stationRatings = ratings.filter((r) => skillIds.includes(r.skill_id) && r.rating !== null && r.rating >= 3);\n      const independentCount = stationRatings.length;\n      const riskScore = stationSkills.length - independentCount;\n      stationRisks.push({\n        stationCode: station.station_code,\n        stationName: station.station_name,\n        independentCount,\n        totalSkills: stationSkills.length,\n        riskScore,\n      });\n    }\n    const topRiskStations = stationRisks.sort((a, b) => b.riskScore - a.riskScore).slice(0, 10);\n\n    let filteredStations = stations;\n    if (areaId) filteredStations = filteredStations.filter((s) => s.area_id === areaId);\n    if (stationId) filteredStations = filteredStations.filter((s) => s.id === stationId);\n\n    const filteredStationIds = new Set(filteredStations.map((s) => s.id));\n    const filteredSkills = skills.filter((s) => filteredStationIds.has(s.station_id || \"\"));\n\n    const stationMap = new Map(stations.map((s) => [s.id, s]));\n    const employeeMap = new Map(employees.map((e) => [e.employee_id, e.employee_name]));\n\n    const skillGapData = filteredSkills.map((skill) => {\n      const station = stationMap.get(skill.station_id || \"\");\n      const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);\n      const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;\n      const totalEmployeesForSkill = skillRatings.length;\n\n      const employeeDetails = skillRatings.map((r) => ({\n        employeeId: r.employee_id,\n        employeeName: employeeMap.get(r.employee_id) || r.employee_id,\n        rating: r.rating,\n      }));\n\n      let riskLevel: \"ok\" | \"warning\" | \"critical\" = \"ok\";\n      if (independentCount === 0) riskLevel = \"critical\";\n      else if (independentCount < 2) riskLevel = \"warning\";\n\n      return {\n        stationCode: station?.station_code || \"N/A\",\n        stationName: station?.station_name || \"Unknown\",\n        skillId: skill.skill_id,\n        skillName: skill.skill_name,\n        independentCount,\n        totalEmployees: totalEmployeesForSkill,\n        employees: employeeDetails,\n        riskLevel,\n      };\n    }).sort((a, b) => {\n      const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };\n      if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];\n      return a.independentCount - b.independentCount;\n    });\n\n    const filterOptions = {\n      areas: areas.map((a) => ({ id: a.id, areaCode: a.area_code, areaName: a.area_name })),\n      stations: stations.map((s) => ({ id: s.id, stationCode: s.station_code, stationName: s.station_name, areaId: s.area_id })),\n    };\n\n    return NextResponse.json({ kpis, topRiskStations, skillGapData, filterOptions });\n  } catch (error) {\n    console.error(\"Dashboard error:\", error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Failed to load dashboard\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}