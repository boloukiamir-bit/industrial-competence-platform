{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/spaljisten/admin/dedupe-areas/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\n\nfunction normalizeAreaCode(raw: string): string {\n  return raw\n    .trim()\n    .toLowerCase()\n    .replace(/\\s+/g, \"_\")\n    .replace(/å/g, \"a\")\n    .replace(/ä/g, \"a\")\n    .replace(/ö/g, \"o\");\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect();\n  \n  try {\n    await client.query(\"BEGIN\");\n\n    const areasRes = await client.query(\n      \"SELECT id, area_code, area_name FROM sp_areas WHERE org_id = $1\",\n      [SPALJISTEN_ORG_ID]\n    );\n\n    const areas = areasRes.rows as { id: string; area_code: string; area_name: string }[];\n    \n    const areaNameMap = new Map<string, { keptId: string; keptCode: string; duplicateIds: string[] }>();\n    \n    for (const area of areas) {\n      const normalizedName = area.area_name.trim().toLowerCase();\n      const normalizedCode = normalizeAreaCode(area.area_code);\n      \n      if (!areaNameMap.has(normalizedName)) {\n        areaNameMap.set(normalizedName, { keptId: area.id, keptCode: area.area_code, duplicateIds: [] });\n      } else {\n        const existing = areaNameMap.get(normalizedName)!;\n        const existingNormalized = normalizeAreaCode(existing.keptCode);\n        \n        if (area.area_code === normalizedCode && existing.keptCode !== existingNormalized) {\n          existing.duplicateIds.push(existing.keptId);\n          existing.keptId = area.id;\n          existing.keptCode = area.area_code;\n        } else {\n          existing.duplicateIds.push(area.id);\n        }\n      }\n    }\n\n    let stationsUpdated = 0;\n    let employeesUpdated = 0;\n    let areasDeleted = 0;\n\n    for (const [, data] of areaNameMap) {\n      if (data.duplicateIds.length === 0) continue;\n\n      for (const dupId of data.duplicateIds) {\n        const stationsResult = await client.query(\n          \"UPDATE sp_stations SET area_id = $1 WHERE area_id = $2 AND org_id = $3\",\n          [data.keptId, dupId, SPALJISTEN_ORG_ID]\n        );\n        stationsUpdated += stationsResult.rowCount || 0;\n\n        const employeesResult = await client.query(\n          \"UPDATE sp_employees SET area_id = $1 WHERE area_id = $2 AND org_id = $3\",\n          [data.keptId, dupId, SPALJISTEN_ORG_ID]\n        );\n        employeesUpdated += employeesResult.rowCount || 0;\n\n        await client.query(\n          \"DELETE FROM sp_areas WHERE id = $1 AND org_id = $2\",\n          [dupId, SPALJISTEN_ORG_ID]\n        );\n        areasDeleted++;\n      }\n    }\n\n    await client.query(\"COMMIT\");\n\n    const finalCount = await client.query(\n      \"SELECT COUNT(*) as count FROM sp_areas WHERE org_id = $1\",\n      [SPALJISTEN_ORG_ID]\n    );\n\n    return NextResponse.json({\n      success: true,\n      message: \"Duplicate areas cleaned up successfully\",\n      stats: {\n        areasDeleted,\n        stationsUpdated,\n        employeesUpdated,\n        finalAreaCount: parseInt(finalCount.rows[0].count)\n      }\n    });\n\n  } catch (error) {\n    await client.query(\"ROLLBACK\");\n    console.error(\"Dedupe error:\", error);\n    return NextResponse.json(\n      { success: false, error: error instanceof Error ? error.message : \"Dedupe failed\" },\n      { status: 500 }\n    );\n  } finally {\n    client.release();\n  }\n}\n\nexport async function GET() {\n  const client = await pool.connect();\n  \n  try {\n    const areasRes = await client.query(\n      \"SELECT id, area_code, area_name FROM sp_areas WHERE org_id = $1 ORDER BY area_name\",\n      [SPALJISTEN_ORG_ID]\n    );\n\n    const areas = areasRes.rows;\n    const duplicates: { area_name: string; codes: string[] }[] = [];\n    \n    const nameGroups = new Map<string, string[]>();\n    for (const area of areas) {\n      const normalizedName = area.area_name.trim().toLowerCase();\n      if (!nameGroups.has(normalizedName)) {\n        nameGroups.set(normalizedName, []);\n      }\n      nameGroups.get(normalizedName)!.push(area.area_code);\n    }\n\n    for (const [name, codes] of nameGroups) {\n      if (codes.length > 1) {\n        duplicates.push({ area_name: name, codes });\n      }\n    }\n\n    return NextResponse.json({\n      totalAreas: areas.length,\n      duplicateGroups: duplicates.length,\n      duplicates,\n      areas: areas.map(a => ({ id: a.id, code: a.area_code, name: a.area_name }))\n    });\n\n  } finally {\n    client.release();\n  }\n}\n"],"names":[],"mappings":"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"}}]
}