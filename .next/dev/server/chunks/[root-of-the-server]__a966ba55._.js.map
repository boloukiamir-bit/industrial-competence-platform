{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/debug/schema/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!,\n  { auth: { persistSession: false } }\n);\n\nexport async function GET(request: NextRequest) {\n  const authHeader = request.headers.get('Authorization');\n  if (!authHeader?.startsWith('Bearer ')) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  const orgId = request.nextUrl.searchParams.get('orgId');\n  if (!orgId) {\n    return NextResponse.json({ error: 'orgId required' }, { status: 400 });\n  }\n\n  const results: {\n    tables: Record<string, { exists: boolean; hasOrgId: boolean; rlsEnabled: boolean | null }>;\n    nullOrgIdCounts: Record<string, number>;\n    errors: string[];\n  } = {\n    tables: {},\n    nullOrgIdCounts: {},\n    errors: [],\n  };\n\n  const tablesToCheck = ['employees', 'org_units'];\n\n  for (const table of tablesToCheck) {\n    try {\n      const { data: columnsData, error: columnsError } = await supabaseAdmin.rpc('get_table_columns', {\n        table_name: table,\n      });\n\n      if (columnsError) {\n        const { data: fallbackData, error: fallbackError } = await supabaseAdmin\n          .from(table)\n          .select('*')\n          .limit(1);\n\n        if (fallbackError) {\n          if (fallbackError.code === '42P01') {\n            results.tables[table] = { exists: false, hasOrgId: false, rlsEnabled: null };\n          } else {\n            results.errors.push(`${table}: ${fallbackError.message}`);\n            results.tables[table] = { exists: true, hasOrgId: false, rlsEnabled: null };\n          }\n          continue;\n        }\n\n        const hasOrgId = fallbackData && fallbackData.length > 0 \n          ? 'org_id' in fallbackData[0] \n          : true;\n        \n        results.tables[table] = { exists: true, hasOrgId, rlsEnabled: null };\n      } else {\n        const columns = Array.isArray(columnsData) ? columnsData : [];\n        const hasOrgId = columns.some((c: { column_name: string }) => c.column_name === 'org_id');\n        results.tables[table] = { exists: true, hasOrgId, rlsEnabled: null };\n      }\n\n      const { count: nullCount, error: nullError } = await supabaseAdmin\n        .from(table)\n        .select('id', { count: 'exact', head: true })\n        .is('org_id', null);\n\n      if (!nullError && nullCount !== null) {\n        results.nullOrgIdCounts[table] = nullCount;\n      }\n    } catch (err) {\n      results.errors.push(`${table}: ${err instanceof Error ? err.message : 'Unknown error'}`);\n    }\n  }\n\n  try {\n    const { data: rlsData, error: rlsError } = await supabaseAdmin.rpc('check_rls_status', {\n      table_names: tablesToCheck,\n    });\n\n    if (!rlsError && rlsData) {\n      for (const row of rlsData) {\n        if (results.tables[row.tablename]) {\n          results.tables[row.tablename].rlsEnabled = row.rowsecurity;\n        }\n      }\n    }\n  } catch {\n    for (const table of tablesToCheck) {\n      if (results.tables[table]) {\n        results.tables[table].rlsEnabled = null;\n      }\n    }\n  }\n\n  return NextResponse.json(results);\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,gBAAgB,IAAA,yLAAY,gFAEhC,QAAQ,GAAG,CAAC,yBAAyB,EACrC;IAAE,MAAM;QAAE,gBAAgB;IAAM;AAAE;AAG7B,eAAe,IAAI,OAAoB;IAC5C,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,CAAC,YAAY,WAAW,YAAY;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,MAAM,QAAQ,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;IAC/C,IAAI,CAAC,OAAO;QACV,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtE;IAEA,MAAM,UAIF;QACF,QAAQ,CAAC;QACT,iBAAiB,CAAC;QAClB,QAAQ,EAAE;IACZ;IAEA,MAAM,gBAAgB;QAAC;QAAa;KAAY;IAEhD,KAAK,MAAM,SAAS,cAAe;QACjC,IAAI;YACF,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,cAAc,GAAG,CAAC,qBAAqB;gBAC9F,YAAY;YACd;YAEA,IAAI,cAAc;gBAChB,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,cACxD,IAAI,CAAC,OACL,MAAM,CAAC,KACP,KAAK,CAAC;gBAET,IAAI,eAAe;oBACjB,IAAI,cAAc,IAAI,KAAK,SAAS;wBAClC,QAAQ,MAAM,CAAC,MAAM,GAAG;4BAAE,QAAQ;4BAAO,UAAU;4BAAO,YAAY;wBAAK;oBAC7E,OAAO;wBACL,QAAQ,MAAM,CAAC,IAAI,CAAC,GAAG,MAAM,EAAE,EAAE,cAAc,OAAO,EAAE;wBACxD,QAAQ,MAAM,CAAC,MAAM,GAAG;4BAAE,QAAQ;4BAAM,UAAU;4BAAO,YAAY;wBAAK;oBAC5E;oBACA;gBACF;gBAEA,MAAM,WAAW,gBAAgB,aAAa,MAAM,GAAG,IACnD,YAAY,YAAY,CAAC,EAAE,GAC3B;gBAEJ,QAAQ,MAAM,CAAC,MAAM,GAAG;oBAAE,QAAQ;oBAAM;oBAAU,YAAY;gBAAK;YACrE,OAAO;gBACL,MAAM,UAAU,MAAM,OAAO,CAAC,eAAe,cAAc,EAAE;gBAC7D,MAAM,WAAW,QAAQ,IAAI,CAAC,CAAC,IAA+B,EAAE,WAAW,KAAK;gBAChF,QAAQ,MAAM,CAAC,MAAM,GAAG;oBAAE,QAAQ;oBAAM;oBAAU,YAAY;gBAAK;YACrE;YAEA,MAAM,EAAE,OAAO,SAAS,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,cAClD,IAAI,CAAC,OACL,MAAM,CAAC,MAAM;gBAAE,OAAO;gBAAS,MAAM;YAAK,GAC1C,EAAE,CAAC,UAAU;YAEhB,IAAI,CAAC,aAAa,cAAc,MAAM;gBACpC,QAAQ,eAAe,CAAC,MAAM,GAAG;YACnC;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,MAAM,CAAC,IAAI,CAAC,GAAG,MAAM,EAAE,EAAE,eAAe,QAAQ,IAAI,OAAO,GAAG,iBAAiB;QACzF;IACF;IAEA,IAAI;QACF,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,cAAc,GAAG,CAAC,oBAAoB;YACrF,aAAa;QACf;QAEA,IAAI,CAAC,YAAY,SAAS;YACxB,KAAK,MAAM,OAAO,QAAS;gBACzB,IAAI,QAAQ,MAAM,CAAC,IAAI,SAAS,CAAC,EAAE;oBACjC,QAAQ,MAAM,CAAC,IAAI,SAAS,CAAC,CAAC,UAAU,GAAG,IAAI,WAAW;gBAC5D;YACF;QACF;IACF,EAAE,OAAM;QACN,KAAK,MAAM,SAAS,cAAe;YACjC,IAAI,QAAQ,MAAM,CAAC,MAAM,EAAE;gBACzB,QAAQ,MAAM,CAAC,MAAM,CAAC,UAAU,GAAG;YACrC;QACF;IACF;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;AAC3B"}}]
}