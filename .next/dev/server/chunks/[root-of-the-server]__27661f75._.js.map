{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/admin/members/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nfunction getServiceSupabase() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\n  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  \n  if (!url || !serviceKey) {\n    throw new Error('Missing Supabase configuration');\n  }\n  \n  return createClient(url, serviceKey, {\n    auth: { autoRefreshToken: false, persistSession: false }\n  });\n}\n\nasync function getCurrentUser(request: NextRequest) {\n  const authHeader = request.headers.get('authorization');\n  if (!authHeader?.startsWith('Bearer ')) {\n    return null;\n  }\n  \n  const token = authHeader.substring(7);\n  const supabase = getServiceSupabase();\n  \n  const { data: { user }, error } = await supabase.auth.getUser(token);\n  if (error || !user) {\n    return null;\n  }\n  \n  return user;\n}\n\nasync function isOrgAdmin(supabase: ReturnType<typeof getServiceSupabase>, orgId: string, userId: string) {\n  const { data } = await supabase\n    .from('memberships')\n    .select('role')\n    .eq('org_id', orgId)\n    .eq('user_id', userId)\n    .eq('status', 'active')\n    .single();\n  \n  return data?.role === 'admin';\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await getCurrentUser(request);\n    if (!user) {\n      return NextResponse.json({ \n        error: 'Unauthorized', \n        code: 'AUTH_REQUIRED',\n        message: 'Authentication required'\n      }, { status: 401 });\n    }\n\n    const { searchParams } = new URL(request.url);\n    const orgId = searchParams.get('orgId');\n\n    if (!orgId) {\n      return NextResponse.json({ \n        error: 'Missing orgId', \n        code: 'MISSING_ORG',\n        message: 'Organization ID is required'\n      }, { status: 400 });\n    }\n\n    const supabase = getServiceSupabase();\n\n    const isAdmin = await isOrgAdmin(supabase, orgId, user.id);\n    if (!isAdmin) {\n      return NextResponse.json({ \n        error: 'Forbidden', \n        code: 'NOT_ADMIN',\n        message: 'Admin access required'\n      }, { status: 403 });\n    }\n\n    const { data: members, error: memberError } = await supabase\n      .from('memberships')\n      .select('user_id, role, status, created_at')\n      .eq('org_id', orgId);\n\n    if (memberError) {\n      console.error('Error fetching members:', memberError);\n      return NextResponse.json({ \n        error: 'Database error', \n        code: 'DB_ERROR',\n        message: memberError.message,\n        hint: memberError.hint || null\n      }, { status: 500 });\n    }\n\n    const userIds = (members || []).map(m => m.user_id);\n    \n    let profilesMap: Record<string, string> = {};\n    if (userIds.length > 0) {\n      const { data: profiles } = await supabase\n        .from('profiles')\n        .select('id, email')\n        .in('id', userIds);\n      \n      if (profiles) {\n        profilesMap = Object.fromEntries(profiles.map(p => [p.id, p.email]));\n      }\n    }\n\n    const enrichedMembers = (members || []).map(member => ({\n      ...member,\n      email: profilesMap[member.user_id] || null\n    }));\n\n    const { data: invites, error: inviteError } = await supabase\n      .from('invites')\n      .select('id, email, role, created_at, expires_at, accepted_at')\n      .eq('org_id', orgId)\n      .is('accepted_at', null)\n      .gt('expires_at', new Date().toISOString());\n\n    if (inviteError) {\n      console.error('Error fetching invites:', inviteError);\n    }\n\n    return NextResponse.json({ \n      success: true, \n      members: enrichedMembers,\n      invites: invites || [],\n      counts: {\n        total: enrichedMembers.length,\n        active: enrichedMembers.filter(m => m.status === 'active').length,\n        disabled: enrichedMembers.filter(m => m.status === 'disabled').length,\n        pendingInvites: (invites || []).length\n      }\n    });\n  } catch (error) {\n    console.error('Members error:', error);\n    return NextResponse.json({ \n      error: 'Internal server error', \n      code: 'INTERNAL_ERROR',\n      message: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}