{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/orgSession.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport pool from \"@/lib/pgClient\";\n\nexport type OrgSessionResult = {\n  success: true;\n  userId: string;\n  orgId: string;\n  role: string;\n} | {\n  success: false;\n  error: string;\n  status: 401 | 403;\n};\n\nexport async function getOrgIdFromSession(request: NextRequest): Promise<OrgSessionResult> {\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    return { success: false, error: \"Supabase not configured\", status: 401 };\n  }\n\n  const authHeader = request.headers.get(\"Authorization\");\n  let accessToken: string | undefined;\n\n  if (authHeader?.startsWith(\"Bearer \")) {\n    accessToken = authHeader.substring(7);\n  }\n\n  if (!accessToken) {\n    const cookieStore = await cookies();\n    const sbAccessToken = cookieStore.get(\"sb-access-token\")?.value;\n    \n    if (sbAccessToken) {\n      accessToken = sbAccessToken;\n    }\n  }\n\n  if (!accessToken) {\n    return { success: false, error: \"Not authenticated - access token required\", status: 401 };\n  }\n\n  const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n    global: {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    },\n  });\n\n  const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);\n\n  if (authError || !user) {\n    return { success: false, error: \"Invalid or expired session\", status: 401 };\n  }\n\n  const userId = user.id;\n\n  const cookieStore = await cookies();\n  const preferredOrgId = cookieStore.get(\"current_org_id\")?.value;\n\n  let membershipQuery: string;\n  let membershipParams: (string | undefined)[];\n\n  if (preferredOrgId) {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active' AND org_id = $2\n      LIMIT 1\n    `;\n    membershipParams = [userId, preferredOrgId];\n  } else {\n    membershipQuery = `\n      SELECT org_id, role \n      FROM memberships \n      WHERE user_id = $1 AND status = 'active'\n      ORDER BY created_at ASC\n      LIMIT 1\n    `;\n    membershipParams = [userId];\n  }\n\n  const membershipResult = await pool.query(membershipQuery, membershipParams);\n\n  if (membershipResult.rows.length === 0) {\n    if (preferredOrgId) {\n      const fallbackResult = await pool.query(\n        `SELECT org_id, role FROM memberships WHERE user_id = $1 AND status = 'active' ORDER BY created_at ASC LIMIT 1`,\n        [userId]\n      );\n      \n      if (fallbackResult.rows.length === 0) {\n        return { success: false, error: \"No active organization membership\", status: 403 };\n      }\n      \n      return {\n        success: true,\n        userId,\n        orgId: fallbackResult.rows[0].org_id,\n        role: fallbackResult.rows[0].role,\n      };\n    }\n    \n    return { success: false, error: \"No active organization membership\", status: 403 };\n  }\n\n  return {\n    success: true,\n    userId,\n    orgId: membershipResult.rows[0].org_id,\n    role: membershipResult.rows[0].role,\n  };\n}\n\nexport function isAdminOrHr(role: string): boolean {\n  return role === \"admin\" || role === \"hr\";\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;;;;;;;;AAaO,eAAe,oBAAoB,OAAoB;IAC5D,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI;IAEJ,IAAI,YAAY,WAAW,YAAY;QACrC,cAAc,WAAW,SAAS,CAAC;IACrC;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC,oBAAoB;QAE1D,IAAI,eAAe;YACjB,cAAc;QAChB;IACF;IAEA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA6C,QAAQ;QAAI;IAC3F;IAEA,MAAM,WAAW,IAAA,yLAAY,EAAC,aAAa,iBAAiB;QAC1D,QAAQ;YACN,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,aAAa;YACxC;QACF;IACF;IAEA,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC;IAEzE,IAAI,aAAa,CAAC,MAAM;QACtB,OAAO;YAAE,SAAS;YAAO,OAAO;YAA8B,QAAQ;QAAI;IAC5E;IAEA,MAAM,SAAS,KAAK,EAAE;IAEtB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,iBAAiB,YAAY,GAAG,CAAC,mBAAmB;IAE1D,IAAI;IACJ,IAAI;IAEJ,IAAI,gBAAgB;QAClB,kBAAkB,CAAC;;;;;IAKnB,CAAC;QACD,mBAAmB;YAAC;YAAQ;SAAe;IAC7C,OAAO;QACL,kBAAkB,CAAC;;;;;;IAMnB,CAAC;QACD,mBAAmB;YAAC;SAAO;IAC7B;IAEA,MAAM,mBAAmB,MAAM,4HAAI,CAAC,KAAK,CAAC,iBAAiB;IAE3D,IAAI,iBAAiB,IAAI,CAAC,MAAM,KAAK,GAAG;QACtC,IAAI,gBAAgB;YAClB,MAAM,iBAAiB,MAAM,4HAAI,CAAC,KAAK,CACrC,CAAC,6GAA6G,CAAC,EAC/G;gBAAC;aAAO;YAGV,IAAI,eAAe,IAAI,CAAC,MAAM,KAAK,GAAG;gBACpC,OAAO;oBAAE,SAAS;oBAAO,OAAO;oBAAqC,QAAQ;gBAAI;YACnF;YAEA,OAAO;gBACL,SAAS;gBACT;gBACA,OAAO,eAAe,IAAI,CAAC,EAAE,CAAC,MAAM;gBACpC,MAAM,eAAe,IAAI,CAAC,EAAE,CAAC,IAAI;YACnC;QACF;QAEA,OAAO;YAAE,SAAS;YAAO,OAAO;YAAqC,QAAQ;QAAI;IACnF;IAEA,OAAO;QACL,SAAS;QACT;QACA,OAAO,iBAAiB,IAAI,CAAC,EAAE,CAAC,MAAM;QACtC,MAAM,iBAAiB,IAAI,CAAC,EAAE,CAAC,IAAI;IACrC;AACF;AAEO,SAAS,YAAY,IAAY;IACtC,OAAO,SAAS,WAAW,SAAS;AACtC"}},
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/instances/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { getOrgIdFromSession } from \"@/lib/orgSession\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getOrgIdFromSession(request);\n    if (!session.success) {\n      return NextResponse.json({ error: session.error }, { status: session.status });\n    }\n\n    const { orgId } = session;\n\n    const searchParams = request.nextUrl.searchParams;\n    const status = searchParams.get(\"status\");\n    \n    let query = `\n      SELECT i.id, i.template_id, i.employee_id, i.employee_name, \n             i.status, i.start_date, i.due_date, i.completed_at, i.created_at,\n             i.shift_date, i.shift_type, i.area_code,\n             t.name as template_name, t.category as template_category\n      FROM wf_instances i\n      LEFT JOIN wf_templates t ON t.id = i.template_id\n      WHERE i.org_id = $1\n    `;\n    const params: (string | null)[] = [orgId];\n\n    if (status && status !== \"all\") {\n      query += ` AND i.status = $2`;\n      params.push(status);\n    }\n    query += ` ORDER BY i.created_at DESC`;\n\n    const instancesResult = await pool.query(query, params);\n\n    const instances = await Promise.all(\n      instancesResult.rows.map(async (inst) => {\n        const tasksResult = await pool.query(\n          `SELECT status FROM wf_instance_tasks WHERE instance_id = $1`,\n          [inst.id]\n        );\n        const totalTasks = tasksResult.rows.length;\n        const doneTasks = tasksResult.rows.filter((t: { status: string }) => t.status === \"done\").length;\n\n        return {\n          id: inst.id,\n          templateId: inst.template_id,\n          templateName: inst.template_name || \"Unknown\",\n          templateCategory: inst.template_category || \"general\",\n          employeeId: inst.employee_id,\n          employeeName: inst.employee_name,\n          shiftDate: inst.shift_date,\n          shiftType: inst.shift_type,\n          areaCode: inst.area_code,\n          status: inst.status,\n          startDate: inst.start_date,\n          dueDate: inst.due_date,\n          completedAt: inst.completed_at,\n          createdAt: inst.created_at,\n          progress: {\n            total: totalTasks,\n            done: doneTasks,\n            percent: totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0,\n          },\n        };\n      })\n    );\n\n    const countResult = await pool.query(\n      `SELECT \n         COUNT(*) FILTER (WHERE status = 'active') as active,\n         COUNT(*) FILTER (WHERE status = 'completed') as completed,\n         COUNT(*) FILTER (WHERE status = 'cancelled') as cancelled\n       FROM wf_instances WHERE org_id = $1`,\n      [orgId]\n    );\n    \n    const statusCounts = {\n      active: parseInt(countResult.rows[0]?.active || 0),\n      completed: parseInt(countResult.rows[0]?.completed || 0),\n      cancelled: parseInt(countResult.rows[0]?.cancelled || 0),\n    };\n\n    return NextResponse.json({ instances, statusCounts });\n  } catch (err) {\n    console.error(\"Instances error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch instances\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getOrgIdFromSession(request);\n    if (!session.success) {\n      return NextResponse.json({ error: session.error }, { status: session.status });\n    }\n\n    const { orgId, userId } = session;\n\n    const body = await request.json();\n    const { templateId, employeeId, employeeName, startDate, shiftDate, shiftType, areaCode } = body;\n\n    if (!templateId) {\n      return NextResponse.json(\n        { error: \"templateId is required\" },\n        { status: 400 }\n      );\n    }\n\n    const templateResult = await pool.query(\n      `SELECT id, name FROM wf_templates WHERE id = $1 AND org_id = $2`,\n      [templateId, orgId]\n    );\n\n    if (templateResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Template not found\" }, { status: 404 });\n    }\n\n    const template = templateResult.rows[0];\n\n    const stepsResult = await pool.query(\n      `SELECT step_no, title, description, owner_role, default_due_days, required \n       FROM wf_template_steps \n       WHERE template_id = $1 \n       ORDER BY step_no`,\n      [templateId]\n    );\n\n    const steps = stepsResult.rows;\n    const start = startDate ? new Date(startDate) : new Date();\n    const maxDueDays = steps.length > 0 ? Math.max(...steps.map((s: { default_due_days: number }) => s.default_due_days)) : 30;\n    const dueDate = new Date(start.getTime() + maxDueDays * 24 * 60 * 60 * 1000);\n\n    const instanceResult = await pool.query(\n      `INSERT INTO wf_instances (org_id, template_id, employee_id, employee_name, status, start_date, due_date, shift_date, shift_type, area_code)\n       VALUES ($1, $2, $3, $4, 'active', $5, $6, $7, $8, $9)\n       RETURNING id`,\n      [\n        orgId, \n        templateId, \n        employeeId || null, \n        employeeName || null, \n        start.toISOString().split(\"T\")[0], \n        dueDate.toISOString().split(\"T\")[0],\n        shiftDate || null,\n        shiftType || null,\n        areaCode || null\n      ]\n    );\n\n    const instanceId = instanceResult.rows[0].id;\n\n    for (const step of steps) {\n      const taskDueDate = new Date(start.getTime() + step.default_due_days * 24 * 60 * 60 * 1000);\n      await pool.query(\n        `INSERT INTO wf_instance_tasks (instance_id, step_no, title, description, owner_role, due_date, status)\n         VALUES ($1, $2, $3, $4, $5, $6, 'todo')`,\n        [instanceId, step.step_no, step.title, step.description, step.owner_role, taskDueDate.toISOString().split(\"T\")[0]]\n      );\n    }\n\n    await pool.query(\n      `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, actor_user_id, metadata)\n       VALUES ($1, 'instance', $2, 'created', $3, $4)`,\n      [orgId, instanceId, userId, JSON.stringify({ templateId, templateName: template.name, employeeId, employeeName, taskCount: steps.length })]\n    );\n\n    return NextResponse.json({\n      success: true,\n      instance: {\n        id: instanceId,\n        templateName: template.name,\n        employeeName,\n        status: \"active\",\n        taskCount: steps.length,\n      },\n    });\n  } catch (err) {\n    console.error(\"Instance creation error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to create instance\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}