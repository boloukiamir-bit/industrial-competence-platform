{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/instances/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { cookies } from \"next/headers\";\n\nasync function getOrgId(request: NextRequest): Promise<string | null> {\n  const orgId = request.headers.get(\"x-org-id\");\n  if (orgId) return orgId;\n  \n  const cookieStore = await cookies();\n  const orgCookie = cookieStore.get(\"current_org_id\");\n  return orgCookie?.value || null;\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params;\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const instanceResult = await pool.query(\n      `SELECT i.id, i.template_id, i.employee_id, i.employee_name, \n              i.status, i.start_date, i.due_date, i.completed_at, i.created_at,\n              i.shift_date, i.shift_type, i.area_code, i.metadata,\n              i.supervisor_signed_by, i.supervisor_signed_at, i.supervisor_comment,\n              i.hr_signed_by, i.hr_signed_at, i.hr_comment, i.requires_hr_signoff,\n              t.name as template_name, t.description as template_description, t.category as template_category\n       FROM wf_instances i\n       LEFT JOIN wf_templates t ON t.id = i.template_id\n       WHERE i.id = $1 AND i.org_id = $2`,\n      [id, orgId]\n    );\n\n    if (instanceResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Instance not found\" }, { status: 404 });\n    }\n\n    const inst = instanceResult.rows[0];\n\n    const tasksResult = await pool.query(\n      `SELECT id, step_no, title, description, owner_role, owner_user_id, \n              due_date, status, completed_at, completed_by, notes, evidence_url\n       FROM wf_instance_tasks \n       WHERE instance_id = $1 \n       ORDER BY step_no`,\n      [id]\n    );\n\n    const auditResult = await pool.query(\n      `SELECT id, action, actor_email, metadata, created_at \n       FROM wf_audit_log \n       WHERE entity_id = $1 \n       ORDER BY created_at DESC \n       LIMIT 50`,\n      [id]\n    );\n\n    const tasks = tasksResult.rows;\n    const totalTasks = tasks.length;\n    const doneTasks = tasks.filter((t: any) => t.status === \"done\").length;\n\n    return NextResponse.json({\n      id: inst.id,\n      templateId: inst.template_id,\n      templateName: inst.template_name || \"Unknown\",\n      templateDescription: inst.template_description,\n      templateCategory: inst.template_category,\n      employeeId: inst.employee_id,\n      employeeName: inst.employee_name,\n      shiftDate: inst.shift_date,\n      shiftType: inst.shift_type,\n      areaCode: inst.area_code,\n      metadata: inst.metadata,\n      status: inst.status,\n      startDate: inst.start_date,\n      dueDate: inst.due_date,\n      completedAt: inst.completed_at,\n      createdAt: inst.created_at,\n      supervisorSignedBy: inst.supervisor_signed_by,\n      supervisorSignedAt: inst.supervisor_signed_at,\n      supervisorComment: inst.supervisor_comment,\n      hrSignedBy: inst.hr_signed_by,\n      hrSignedAt: inst.hr_signed_at,\n      hrComment: inst.hr_comment,\n      requiresHrSignoff: inst.requires_hr_signoff,\n      tasks,\n      progress: {\n        total: totalTasks,\n        done: doneTasks,\n        percent: totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0,\n      },\n      auditLog: auditResult.rows,\n    });\n  } catch (err) {\n    console.error(\"Instance error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch instance\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params;\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const body = await request.json();\n    const { status } = body;\n\n    if (!status || ![\"active\", \"completed\", \"cancelled\"].includes(status)) {\n      return NextResponse.json({ error: \"Invalid status\" }, { status: 400 });\n    }\n\n    const completedAt = status === \"completed\" ? new Date().toISOString() : null;\n\n    const result = await pool.query(\n      `UPDATE wf_instances \n       SET status = $1, completed_at = $2, updated_at = NOW()\n       WHERE id = $3 AND org_id = $4\n       RETURNING id, status`,\n      [status, completedAt, id, orgId]\n    );\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: \"Instance not found\" }, { status: 404 });\n    }\n\n    await pool.query(\n      `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, metadata)\n       VALUES ($1, 'instance', $2, $3, $4)`,\n      [orgId, id, `status_changed_to_${status}`, JSON.stringify({ newStatus: status })]\n    );\n\n    return NextResponse.json({ success: true, instance: result.rows[0] });\n  } catch (err) {\n    console.error(\"Instance update error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to update instance\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}