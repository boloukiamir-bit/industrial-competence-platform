{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/line-overview/suggestions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\n\nconst DEMO_ORG_ID = \"f607f244-da91-41d9-a648-d02a1591105c\";\n\nconst supabaseAdmin = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nfunction shiftParamToDbValue(shift: string): string {\n  const map: Record<string, string> = {\n    day: \"Day\",\n    evening: \"Evening\",\n    night: \"Night\",\n  };\n  return map[shift.toLowerCase()] || \"Day\";\n}\n\nconst suggestionsSchema = z.object({\n  machineCode: z.string(),\n  date: z.string(),\n  shift: z.string(),\n  hoursNeeded: z.number().positive(),\n});\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const parsed = suggestionsSchema.safeParse(body);\n\n    if (!parsed.success) {\n      return NextResponse.json({ error: \"Invalid input\", details: parsed.error.issues }, { status: 400 });\n    }\n\n    const { date, shift, hoursNeeded } = parsed.data;\n    const shiftType = shiftParamToDbValue(shift);\n\n    const [employeesRes, attendanceRes, assignmentsRes] = await Promise.all([\n      supabaseAdmin.from(\"pl_employees\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID),\n      supabaseAdmin.from(\"pl_attendance\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).eq(\"plan_date\", date).eq(\"shift_type\", shiftType),\n      supabaseAdmin.from(\"pl_assignment_segments\").select(\"*\").eq(\"org_id\", DEMO_ORG_ID).eq(\"plan_date\", date).eq(\"shift_type\", shiftType),\n    ]);\n\n    if (employeesRes.error) throw employeesRes.error;\n    if (attendanceRes.error) throw attendanceRes.error;\n    if (assignmentsRes.error) throw assignmentsRes.error;\n\n    const employees = employeesRes.data || [];\n    const attendance = attendanceRes.data || [];\n    const assignments = assignmentsRes.data || [];\n\n    const attendanceMap = new Map(attendance.map((a) => [a.employee_code, a]));\n\n    const suggestions = employees\n      .filter((emp) => {\n        const att = attendanceMap.get(emp.employee_code);\n        return !att || att.status === \"present\";\n      })\n      .map((emp) => {\n        const empAssignments = assignments.filter((a) => a.employee_code === emp.employee_code);\n        let currentHours = 0;\n        empAssignments.forEach((a) => {\n          const start = new Date(`2000-01-01T${a.start_time}`);\n          const end = new Date(`2000-01-01T${a.end_time}`);\n          currentHours += (end.getTime() - start.getTime()) / (1000 * 60 * 60);\n        });\n\n        const score = 100 - (currentHours / 8) * 50;\n        const availableHours = Math.max(0, 8 - currentHours);\n\n        return {\n          employee: {\n            id: emp.id,\n            employeeCode: emp.employee_code,\n            fullName: emp.full_name,\n          },\n          currentHours,\n          availableHours,\n          score,\n        };\n      })\n      .filter((s) => s.availableHours > 0)\n      .sort((a, b) => b.score - a.score)\n      .slice(0, 3);\n\n    return NextResponse.json({ suggestions });\n  } catch (error) {\n    console.error(\"Suggestions error:\", error);\n    return NextResponse.json({ error: \"Failed to get suggestions\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}