{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/spaljisten/export/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const areaId = searchParams.get(\"areaId\") || undefined;\n    const stationId = searchParams.get(\"stationId\") || undefined;\n\n    const client = await pool.connect();\n    try {\n      const [stationsRes, skillsRes, ratingsRes, employeesRes, areasRes] = await Promise.all([\n        client.query(\"SELECT id, area_id, station_code, station_name FROM sp_stations WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT skill_id, skill_name, station_id, category FROM sp_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT employee_id, skill_id, rating FROM sp_employee_skills WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT employee_id, employee_name FROM sp_employees WHERE org_id = $1 AND is_active = true\", [SPALJISTEN_ORG_ID]),\n        client.query(\"SELECT id, area_code, area_name FROM sp_areas WHERE org_id = $1\", [SPALJISTEN_ORG_ID]),\n      ]);\n\n      const stations = stationsRes.rows;\n      const skills = skillsRes.rows;\n      const ratings = ratingsRes.rows;\n      const employees = employeesRes.rows;\n      const areas = areasRes.rows;\n\n      const stationMap = new Map(stations.map((s) => [s.id, s]));\n      const areaMap = new Map(areas.map((a) => [a.id, a.area_name]));\n\n      const getSkillAreaId = (skill: { station_id: string | null }) => {\n        if (!skill.station_id) return null;\n        const station = stationMap.get(skill.station_id);\n        return station?.area_id || null;\n      };\n\n      let filteredSkills = skills;\n      if (areaId) {\n        filteredSkills = skills.filter((skill) => getSkillAreaId(skill) === areaId);\n      }\n      if (stationId) {\n        filteredSkills = filteredSkills.filter((s) => s.station_id === stationId);\n      }\n\n      const employeeMap = new Map(employees.map((e) => [e.employee_id, e.employee_name]));\n\n      const gapData = filteredSkills.map((skill) => {\n        const station = stationMap.get(skill.station_id);\n        const skillRatings = ratings.filter((r) => r.skill_id === skill.skill_id);\n        const independentCount = skillRatings.filter((r) => r.rating !== null && r.rating >= 3).length;\n        const totalEmployeesForSkill = skillRatings.length;\n\n        const employeeDetails = skillRatings.map((r) => ({\n          employeeId: r.employee_id,\n          employeeName: employeeMap.get(r.employee_id) || r.employee_id,\n          rating: r.rating,\n        }));\n\n        let riskLevel: \"ok\" | \"warning\" | \"critical\" = \"ok\";\n        if (independentCount === 0) riskLevel = \"critical\";\n        else if (independentCount < 2) riskLevel = \"warning\";\n\n        return {\n          stationCode: station?.station_code || \"N/A\",\n          stationName: station?.station_name || \"Unknown\",\n          skillId: skill.skill_id,\n          skillName: skill.skill_name,\n          independentCount,\n          totalEmployees: totalEmployeesForSkill,\n          employees: employeeDetails,\n          riskLevel,\n        };\n      })\n      .filter((s) => s.totalEmployees > 0)\n      .sort((a, b) => {\n        const order: Record<string, number> = { critical: 0, warning: 1, ok: 2 };\n        if (a.riskLevel !== b.riskLevel) return order[a.riskLevel] - order[b.riskLevel];\n        return a.independentCount - b.independentCount;\n      });\n\n      const headers = [\n        \"Station Code\",\n        \"Station Name\",\n        \"Skill ID\",\n        \"Skill Name\",\n        \"Independent Count (>=3)\",\n        \"Total Employees\",\n        \"Risk Level\",\n        \"Employee Names\",\n      ];\n\n      const rows = gapData.map((item) => [\n        item.stationCode,\n        item.stationName,\n        item.skillId,\n        item.skillName,\n        item.independentCount.toString(),\n        item.totalEmployees.toString(),\n        item.riskLevel.toUpperCase(),\n        item.employees.map((e) => `${e.employeeName} (${e.rating ?? \"N\"})`).join(\"; \"),\n      ]);\n\n      const escapeCsvField = (field: string): string => {\n        if (field.includes(\",\") || field.includes('\"') || field.includes(\"\\n\")) {\n          return `\"${field.replace(/\"/g, '\"\"')}\"`;\n        }\n        return field;\n      };\n\n      const csvContent = [\n        headers.map(escapeCsvField).join(\",\"),\n        ...rows.map((row) => row.map(escapeCsvField).join(\",\")),\n      ].join(\"\\n\");\n\n      const timestamp = new Date().toISOString().split(\"T\")[0];\n      const filename = `skill-gap-report-${timestamp}.csv`;\n\n      return new NextResponse(csvContent, {\n        status: 200,\n        headers: {\n          \"Content-Type\": \"text/csv; charset=utf-8\",\n          \"Content-Disposition\": `attachment; filename=\"${filename}\"`,\n        },\n      });\n    } finally {\n      client.release();\n    }\n  } catch (error) {\n    console.error(\"Export error:\", error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : \"Export failed\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}