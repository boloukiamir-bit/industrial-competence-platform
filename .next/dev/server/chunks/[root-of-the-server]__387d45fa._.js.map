{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/hr/analytics/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport type { HRAnalyticsV2 } from \"@/types/domain\";\n\nconst SPALJISTEN_ORG_ID = \"a1b2c3d4-e5f6-7890-abcd-ef1234567890\";\n\nasync function getSpaljistenAnalytics(): Promise<HRAnalyticsV2> {\n  try {\n    const employeesResult = await pool.query(\n      `SELECT e.id, e.employee_name as name, e.email, a.area_name \n       FROM sp_employees e \n       LEFT JOIN sp_areas a ON e.area_id = a.id\n       WHERE e.org_id = $1`,\n      [SPALJISTEN_ORG_ID]\n    );\n    const employees = employeesResult.rows;\n    const totalHeadcount = employees.length;\n\n    const areaData: Record<string, { count: number; permanent: number; temporary: number; consultant: number }> = {};\n    for (const emp of employees) {\n      const area = emp.area_name || \"Unassigned\";\n      if (!areaData[area]) {\n        areaData[area] = { count: 0, permanent: 0, temporary: 0, consultant: 0 };\n      }\n      areaData[area].count++;\n      areaData[area].permanent++;\n    }\n    const headcountByOrgUnit = Object.entries(areaData).map(([orgUnitName, data]) => ({\n      orgUnitName,\n      count: data.count,\n      permanent: data.permanent,\n      temporary: data.temporary,\n      consultant: data.consultant,\n    }));\n\n    const skillsResult = await pool.query(`\n      SELECT \n        sk.skill_name,\n        es.rating\n      FROM sp_employee_skills es\n      JOIN sp_skills sk ON es.skill_id = sk.skill_id\n      WHERE es.org_id = $1\n      ORDER BY sk.skill_name\n    `, [SPALJISTEN_ORG_ID]);\n\n    const skillLevels: Record<string, number[]> = {};\n    for (const row of skillsResult.rows) {\n      const skillName = row.skill_name || \"Unknown\";\n      if (!skillLevels[skillName]) {\n        skillLevels[skillName] = [0, 0, 0, 0, 0];\n      }\n      const level = row.rating as number;\n      if (level >= 0 && level <= 4) {\n        skillLevels[skillName][level]++;\n      }\n    }\n    const skillDistribution = Object.entries(skillLevels)\n      .slice(0, 10)\n      .map(([skillName, levels]) => ({\n        skillName,\n        levels,\n      }));\n\n    const riskResult = await pool.query(`\n      SELECT \n        st.station_name,\n        a.area_name,\n        COUNT(DISTINCT CASE WHEN es.rating >= 3 THEN es.employee_id END) as independent_count\n      FROM sp_stations st\n      LEFT JOIN sp_areas a ON st.area_id = a.id\n      LEFT JOIN sp_skills sk ON sk.station_id = st.id\n      LEFT JOIN sp_employee_skills es ON es.skill_id = sk.skill_id\n      WHERE st.org_id = $1\n      GROUP BY st.station_name, a.area_name\n    `, [SPALJISTEN_ORG_ID]);\n\n    let overdueCount = 0;\n    let dueSoonCount = 0;\n    const criticalEventsCounts: Record<string, number> = {};\n\n    for (const row of riskResult.rows) {\n      const independentCount = parseInt(row.independent_count || \"0\", 10);\n      if (independentCount === 0) {\n        overdueCount++;\n        criticalEventsCounts[\"Training\"] = (criticalEventsCounts[\"Training\"] || 0) + 1;\n      } else if (independentCount < 2) {\n        dueSoonCount++;\n        criticalEventsCounts[\"Medical Check\"] = (criticalEventsCounts[\"Medical Check\"] || 0) + 1;\n      }\n    }\n\n    const criticalEventsCount = Object.entries(criticalEventsCounts).map(([category, count]) => ({\n      category,\n      count,\n    }));\n\n    return {\n      totalHeadcount,\n      headcountByOrgUnit,\n      headcountByEmploymentType: [{ type: \"permanent\", count: totalHeadcount }],\n      sickLeaveRatio: 0,\n      temporaryContractsEndingSoon: 0,\n      temporaryContractsEndingList: [],\n      criticalEventsCount,\n      criticalEventsByStatus: { overdue: overdueCount, dueSoon: dueSoonCount },\n      skillDistribution,\n      riskIndexByUnit: headcountByOrgUnit.map(unit => ({\n        unitName: unit.orgUnitName,\n        headcount: unit.count,\n        overdueCount: 0,\n        dueSoonCount: 0,\n        riskIndex: 0,\n      })),\n      absencesAvailable: false,\n      attritionRisk: {\n        highrisk: 0,\n        mediumRisk: 0,\n        employees: [],\n      },\n      tenureBands: [],\n      avgTenureYears: 0,\n      openWorkflowsByTemplate: [],\n      skillGapSummary: { criticalGaps: overdueCount, trainingNeeded: dueSoonCount, wellStaffed: 0 },\n    };\n  } catch (err) {\n    console.error(\"Spaljisten analytics error:\", err);\n    throw err;\n  }\n}\n\nexport async function GET() {\n  try {\n    const analytics = await getSpaljistenAnalytics();\n    return NextResponse.json(analytics);\n  } catch (err) {\n    console.error(\"Analytics API error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to fetch analytics\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}