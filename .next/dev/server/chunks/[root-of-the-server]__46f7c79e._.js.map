{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/pgClient.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.DATABASE_URL?.includes(\"localhost\") ? false : { rejectUnauthorized: false },\n});\n\nexport default pool;\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,QAAQ,GAAG,CAAC,YAAY,EAAE,SAAS,eAAe,QAAQ;QAAE,oBAAoB;IAAM;AAC7F;uCAEe"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/workflows/instances/%5Bid%5D/tasks/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport pool from \"@/lib/pgClient\";\nimport { cookies } from \"next/headers\";\n\nasync function getOrgId(request: NextRequest): Promise<string | null> {\n  const orgId = request.headers.get(\"x-org-id\");\n  if (orgId) return orgId;\n  \n  const cookieStore = await cookies();\n  const orgCookie = cookieStore.get(\"current_org_id\");\n  return orgCookie?.value || null;\n}\n\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: instanceId } = await params;\n    const orgId = await getOrgId(request);\n    if (!orgId) {\n      return NextResponse.json({ error: \"Organization ID required\" }, { status: 400 });\n    }\n\n    const body = await request.json();\n    const { taskId, status, ownerUserId } = body;\n\n    if (!taskId) {\n      return NextResponse.json({ error: \"taskId is required\" }, { status: 400 });\n    }\n\n    const instanceResult = await pool.query(\n      `SELECT id, org_id FROM wf_instances WHERE id = $1 AND org_id = $2`,\n      [instanceId, orgId]\n    );\n\n    if (instanceResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Instance not found\" }, { status: 404 });\n    }\n\n    if (status && ![\"todo\", \"in_progress\", \"done\", \"blocked\"].includes(status)) {\n      return NextResponse.json({ error: \"Invalid status\" }, { status: 400 });\n    }\n\n    const completedAt = status === \"done\" ? new Date().toISOString() : null;\n\n    let updateQuery = `UPDATE wf_instance_tasks SET updated_at = NOW()`;\n    const updateParams: any[] = [];\n    let paramIndex = 1;\n\n    if (status) {\n      updateQuery += `, status = $${paramIndex}`;\n      updateParams.push(status);\n      paramIndex++;\n      updateQuery += `, completed_at = $${paramIndex}`;\n      updateParams.push(completedAt);\n      paramIndex++;\n    }\n\n    if (ownerUserId !== undefined) {\n      updateQuery += `, owner_user_id = $${paramIndex}`;\n      updateParams.push(ownerUserId);\n      paramIndex++;\n    }\n\n    updateQuery += ` WHERE id = $${paramIndex} AND instance_id = $${paramIndex + 1} RETURNING id, title, status`;\n    updateParams.push(taskId, instanceId);\n\n    const taskResult = await pool.query(updateQuery, updateParams);\n\n    if (taskResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Task not found\" }, { status: 404 });\n    }\n\n    const task = taskResult.rows[0];\n\n    await pool.query(\n      `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, metadata)\n       VALUES ($1, 'task', $2, $3, $4)`,\n      [\n        orgId,\n        taskId,\n        status ? `status_changed_to_${status}` : \"updated\",\n        JSON.stringify({ instanceId, taskTitle: task.title, newStatus: status, ownerUserId }),\n      ]\n    );\n\n    const allTasksResult = await pool.query(\n      `SELECT status FROM wf_instance_tasks WHERE instance_id = $1`,\n      [instanceId]\n    );\n\n    const allDone = allTasksResult.rows.length > 0 && allTasksResult.rows.every((t: any) => t.status === \"done\");\n\n    if (allDone) {\n      await pool.query(\n        `UPDATE wf_instances SET status = 'completed', completed_at = NOW(), updated_at = NOW() WHERE id = $1`,\n        [instanceId]\n      );\n\n      await pool.query(\n        `INSERT INTO wf_audit_log (org_id, entity_type, entity_id, action, metadata)\n         VALUES ($1, 'instance', $2, 'auto_completed', $3)`,\n        [orgId, instanceId, JSON.stringify({ reason: \"All tasks completed\" })]\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      task,\n      instanceAutoCompleted: allDone,\n    });\n  } catch (err) {\n    console.error(\"Task update error:\", err);\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : \"Failed to update task\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,eAAe,SAAS,OAAoB;IAC1C,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC;IAClC,IAAI,OAAO,OAAO;IAElB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,YAAY,YAAY,GAAG,CAAC;IAClC,OAAO,WAAW,SAAS;AAC7B;AAEO,eAAe,MACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,IAAI,UAAU,EAAE,GAAG,MAAM;QACjC,MAAM,QAAQ,MAAM,SAAS;QAC7B,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,WAAW,EAAE,GAAG;QAExC,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,iBAAiB,MAAM,4HAAI,CAAC,KAAK,CACrC,CAAC,iEAAiE,CAAC,EACnE;YAAC;YAAY;SAAM;QAGrB,IAAI,eAAe,IAAI,CAAC,MAAM,KAAK,GAAG;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,IAAI,UAAU,CAAC;YAAC;YAAQ;YAAe;YAAQ;SAAU,CAAC,QAAQ,CAAC,SAAS;YAC1E,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,cAAc,WAAW,SAAS,IAAI,OAAO,WAAW,KAAK;QAEnE,IAAI,cAAc,CAAC,+CAA+C,CAAC;QACnE,MAAM,eAAsB,EAAE;QAC9B,IAAI,aAAa;QAEjB,IAAI,QAAQ;YACV,eAAe,CAAC,YAAY,EAAE,YAAY;YAC1C,aAAa,IAAI,CAAC;YAClB;YACA,eAAe,CAAC,kBAAkB,EAAE,YAAY;YAChD,aAAa,IAAI,CAAC;YAClB;QACF;QAEA,IAAI,gBAAgB,WAAW;YAC7B,eAAe,CAAC,mBAAmB,EAAE,YAAY;YACjD,aAAa,IAAI,CAAC;YAClB;QACF;QAEA,eAAe,CAAC,aAAa,EAAE,WAAW,oBAAoB,EAAE,aAAa,EAAE,4BAA4B,CAAC;QAC5G,aAAa,IAAI,CAAC,QAAQ;QAE1B,MAAM,aAAa,MAAM,4HAAI,CAAC,KAAK,CAAC,aAAa;QAEjD,IAAI,WAAW,IAAI,CAAC,MAAM,KAAK,GAAG;YAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,OAAO,WAAW,IAAI,CAAC,EAAE;QAE/B,MAAM,4HAAI,CAAC,KAAK,CACd,CAAC;sCAC+B,CAAC,EACjC;YACE;YACA;YACA,SAAS,CAAC,kBAAkB,EAAE,QAAQ,GAAG;YACzC,KAAK,SAAS,CAAC;gBAAE;gBAAY,WAAW,KAAK,KAAK;gBAAE,WAAW;gBAAQ;YAAY;SACpF;QAGH,MAAM,iBAAiB,MAAM,4HAAI,CAAC,KAAK,CACrC,CAAC,2DAA2D,CAAC,EAC7D;YAAC;SAAW;QAGd,MAAM,UAAU,eAAe,IAAI,CAAC,MAAM,GAAG,KAAK,eAAe,IAAI,CAAC,KAAK,CAAC,CAAC,IAAW,EAAE,MAAM,KAAK;QAErG,IAAI,SAAS;YACX,MAAM,4HAAI,CAAC,KAAK,CACd,CAAC,oGAAoG,CAAC,EACtG;gBAAC;aAAW;YAGd,MAAM,4HAAI,CAAC,KAAK,CACd,CAAC;0DACiD,CAAC,EACnD;gBAAC;gBAAO;gBAAY,KAAK,SAAS,CAAC;oBAAE,QAAQ;gBAAsB;aAAG;QAE1E;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA,uBAAuB;QACzB;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,eAAe,QAAQ,IAAI,OAAO,GAAG;QAAwB,GACtE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}